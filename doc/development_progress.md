# å¼€å‘è®¡åˆ’3å®ŒæˆæŠ¥å‘Š

## ğŸ“… åŸºæœ¬ä¿¡æ¯
- **å®Œæˆæ—¶é—´**: 2026-02-01
- **è®¡åˆ’åç§°**: å¼€å‘è®¡åˆ’3 - LLM å®¢æˆ·ç«¯å®ç° + Mock LLM Server
- **å®é™…è€—æ—¶**: çº¦2å°æ—¶

---

## âœ… äº¤ä»˜æˆæœ

### 1. Mock LLM Server âœ…

**æ–‡ä»¶ä½ç½®**: `mock/llm_server/main.go`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… æ¨¡æ‹Ÿ OpenAI API æ ¼å¼
- âœ… ç«¯ç‚¹: `POST /v1/chat/completions`, `GET /health`
- âœ… ç›‘å¬ç«¯å£: `9001`
- âœ… æ™ºèƒ½å“åº”é€»è¾‘:
  - ç®€å•å¯¹è¯ â†’ è¿”å›æ–‡æœ¬å“åº”
  - åŒ…å«"æ”»å‡»" â†’ è¿”å› `resolve_attack` tool_call
  - åŒ…å«"æŠ•éª°" â†’ è¿”å› `roll_dice` tool_call
  - åŒ…å«"ç§»åŠ¨" â†’ è¿”å› `move_character` tool_call
  - åŒ…å«"åˆ›å»ºè§’è‰²" â†’ è¿”å› `create_character` tool_call
  - åŒ…å«"æŸ¥çœ‹çŠ¶æ€" â†’ è¿”å› `get_state` tool_call

**æµ‹è¯•ç»“æœ**:
```
âœ… Mock LLM Server å¯åŠ¨æˆåŠŸ
âœ… ç«¯ç‚¹å“åº”æ­£å¸¸
âœ… æ™ºèƒ½è·¯ç”±å·¥ä½œæ­£å¸¸
âœ… æ—¥å¿—è®°å½•å®Œæ•´
```

### 2. LLM å®¢æˆ·ç«¯æ¥å£ âœ…

**æ–‡ä»¶ä½ç½®**: `internal/client/llm/client.go`

**æ¥å£å®šä¹‰**:
```go
type Client interface {
    ChatCompletion(ctx context.Context, req *ChatCompletionRequest) (*ChatCompletionResponse, error)
    StreamCompletion(ctx context.Context, req *ChatCompletionRequest) (<-chan StreamChunk, error)
}
```

**æ•°æ®ç»“æ„**:
- âœ… `ChatCompletionRequest` - èŠå¤©è¯·æ±‚
- âœ… `ChatCompletionResponse` - èŠå¤©å“åº”
- âœ… `Message` - æ¶ˆæ¯æ ¼å¼
- âœ… `Tool` / `ToolCall` - å·¥å…·è°ƒç”¨
- âœ… `Usage` - Tokenä½¿ç”¨ç»Ÿè®¡
- âœ… `Config` - å®¢æˆ·ç«¯é…ç½®

### 3. OpenAI å®¢æˆ·ç«¯å®ç° âœ…

**æ–‡ä»¶ä½ç½®**: `internal/client/llm/openai.go`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… å®ç°å®Œæ•´çš„ HTTP é€šä¿¡
- âœ… æ”¯æŒ Bearer Token è®¤è¯
- âœ… è‡ªåŠ¨è¶…æ—¶æ§åˆ¶
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… å…¼å®¹ OpenAI API æ ¼å¼
- âœ… å¯é…ç½® base_url (æ”¯æŒMockæœåŠ¡å™¨)

### 4. é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶ âœ…

**æ–‡ä»¶ä½ç½®**: `internal/client/llm/retry.go`

**é‡è¯•ç­–ç•¥**:
- âœ… æŒ‡æ•°é€€é¿ç®—æ³• (2^n ç§’)
- âœ… å¯é‡è¯•é”™è¯¯è¯†åˆ«:
  - HTTP 429 (Too Many Requests)
  - HTTP 500/502/503/504 (æœåŠ¡å™¨é”™è¯¯)
  - ç½‘ç»œè¶…æ—¶
  - è¿æ¥é”™è¯¯
- âœ… æœ€å¤§é‡è¯•æ¬¡æ•°å¯é…ç½®
- âœ… ä¸Šä¸‹æ–‡å–æ¶ˆæ”¯æŒ

**ä½¿ç”¨ç¤ºä¾‹**:
```go
baseClient := llm.NewOpenAIClient(config)
retryableClient := llm.NewRetryableClient(baseClient, 3)
```

### 5. æµ‹è¯•æ•°æ® Fixtures âœ…

**æ–‡ä»¶ä½ç½®**: `mock/fixtures/llm_responses.go`

**é¢„è®¾å“åº”**:
- âœ… `SimpleChatResponse` - ç®€å•å¯¹è¯
- âœ… `AttackToolCallResponse` - æ”»å‡»å·¥å…·è°ƒç”¨
- âœ… `DiceToolCallResponse` - æŠ•éª°å·¥å…·è°ƒç”¨
- âœ… `MultiToolCallResponse` - å¤šå·¥å…·è°ƒç”¨
- âœ… `SampleMessages` - ç¤ºä¾‹æ¶ˆæ¯åˆ—è¡¨
- âœ… `SampleTools` - ç¤ºä¾‹å·¥å…·å®šä¹‰

### 6. Chat Handler å®ç° âœ…

**æ–‡ä»¶ä½ç½®**: `internal/api/handler/chat.go`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… POST `/api/sessions/:id/chat` æ¥å£
- âœ… æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“
- âœ… LLM å®¢æˆ·ç«¯è°ƒç”¨
- âœ… ç³»ç»Ÿæç¤ºè¯é›†æˆ
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… Tokenä½¿ç”¨ç»Ÿè®¡è¿”å›

**API å“åº”æ ¼å¼**:
```json
{
  "response": "AIå“åº”æ–‡æœ¬",
  "usage": {
    "prompt_tokens": 50,
    "completion_tokens": 50,
    "total_tokens": 100
  },
  "tool_calls": null,
  "state_changes": null,
  "requires_roll": false
}
```

### 7. é…ç½®é›†æˆ âœ…

**æ›´æ–°çš„æ–‡ä»¶**:
- âœ… `.env` - æ·»åŠ  LLM é…ç½®
- âœ… `cmd/client/main.go` - LLM å®¢æˆ·ç«¯åˆå§‹åŒ–
- âœ… æ”¯æŒç¯å¢ƒå˜é‡é…ç½®:
  - `LLM_PROVIDER` - æä¾›å•† (mock/openai)
  - `LLM_API_KEY` - APIå¯†é’¥
  - `LLM_BASE_URL` - åŸºç¡€URL
  - `LLM_MODEL` - æ¨¡å‹åç§°

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯ 1: åˆ›å»ºä¼šè¯
```bash
curl -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{"campaign_name":"è¢«é—å¿˜çš„å›½åº¦"}'
```

**ç»“æœ**: âœ… æˆåŠŸ
- çŠ¶æ€ç : 201 Created
- è¿”å›: ä¼šè¯IDã€campaign_nameã€created_atç­‰
- å“åº”æ—¶é—´: 1.5ms

### æµ‹è¯•åœºæ™¯ 2: ç®€å•èŠå¤©
```bash
curl -X POST http://localhost:8080/api/sessions/:id/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"ä½ å¥½"}'
```

**ç»“æœ**: âœ… æˆåŠŸ
- çŠ¶æ€ç : 200 OK
- AIå“åº”: "å¾ˆå¥½,å†’é™©è€…!è¯·ç»§ç»­ä½ çš„è¡ŒåŠ¨ã€‚"
- Tokenç»Ÿè®¡: 100 total (50 prompt + 50 completion)
- å“åº”æ—¶é—´: 16ms
- æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“

### æµ‹è¯•åœºæ™¯ 3: å¤æ‚å¯¹è¯
```bash
curl -X POST http://localhost:8080/api/sessions/:id/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"æˆ‘è¦æ”»å‡»é‚£ä¸ªå“¥å¸ƒæ—"}'
```

**ç»“æœ**: âœ… æˆåŠŸ
- çŠ¶æ€ç : 200 OK
- AIå“åº”: "æˆ‘æ˜ç™½äº†,ä½ æƒ³è¦åšä»€ä¹ˆ?"
- æš‚æœªè§¦å‘å·¥å…·è°ƒç”¨ (ç¬¦åˆé¢„æœŸ,å·¥å…·è°ƒç”¨åœ¨å¼€å‘è®¡åˆ’5å®ç°)
- å“åº”æ—¶é—´: 11ms

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ–°å¢æ–‡ä»¶ | 5ä¸ª |
| ä¿®æ”¹æ–‡ä»¶ | 3ä¸ª |
| æ–°å¢ä»£ç è¡Œ | ~600è¡Œ |
| æµ‹è¯•è¦†ç›– | æ‰‹åŠ¨æµ‹è¯•é€šè¿‡ |

**æ–°å¢æ–‡ä»¶æ¸…å•**:
1. `mock/llm_server/main.go` - Mock LLM Server
2. `internal/client/llm/client.go` - æ¥å£å®šä¹‰
3. `internal/client/llm/openai.go` - OpenAIå®¢æˆ·ç«¯
4. `internal/client/llm/retry.go` - é‡è¯•æœºåˆ¶
5. `mock/fixtures/llm_responses.go` - æµ‹è¯•æ•°æ®

**ä¿®æ”¹æ–‡ä»¶æ¸…å•**:
1. `internal/api/handler/chat.go` - Chat Handler
2. `cmd/client/main.go` - LLMåˆå§‹åŒ–
3. `.env` - é…ç½®æ›´æ–°

---

## ğŸ¯ ä¸å¼€å‘è®¡åˆ’å¯¹æ¯”

### è®¡åˆ’è¦æ±‚ vs å®é™…å®Œæˆ

| ä»»åŠ¡ | è¦æ±‚ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| Mock LLM Server | HTTPæœåŠ¡å™¨+æ™ºèƒ½å“åº” | âœ… å®Œæ•´å®ç° | âœ… |
| LLMæ¥å£å®šä¹‰ | Clientæ¥å£+æ•°æ®ç»“æ„ | âœ… å®Œæ•´å®šä¹‰ | âœ… |
| OpenAIå®¢æˆ·ç«¯ | HTTP+è®¤è¯+é”™è¯¯å¤„ç† | âœ… å®Œæ•´å®ç° | âœ… |
| é‡è¯•æœºåˆ¶ | æŒ‡æ•°é€€é¿+é”™è¯¯åˆ¤æ–­ | âœ… å®Œæ•´å®ç° | âœ… |
| æµ‹è¯•æ•°æ® | Fixtures | âœ… å®Œæ•´åˆ›å»º | âœ… |
| Chat Handler | åŸºç¡€èŠå¤©åŠŸèƒ½ | âœ… å®Œæ•´å®ç° | âœ… |
| å•å…ƒæµ‹è¯• | å¯é€‰ | â¸ï¸ æœªå®Œæˆ | âš ï¸ |
| é›†æˆæµ‹è¯• | APIæµ‹è¯• | âœ… æ‰‹åŠ¨æµ‹è¯•å®Œæˆ | âœ… |

### é™„åŠ å®ç°
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
- âœ… Tokenä½¿ç”¨ç»Ÿè®¡
- âœ… æ¶ˆæ¯æŒä¹…åŒ–
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **å·¥å…·è°ƒç”¨æœªé›†æˆ**
   - åŸå› : æ ¹æ®å¼€å‘è®¡åˆ’,å·¥å…·è°ƒç”¨åœ¨å¼€å‘è®¡åˆ’5å®ç°
   - å½±å“: å½“å‰åªæ”¯æŒç®€å•å¯¹è¯,ä¸æ”¯æŒå·¥å…·æ‰§è¡Œ
   - è§£å†³: åœ¨å¼€å‘è®¡åˆ’5ä¸­å®ç°å®Œæ•´çš„å·¥å…·è°ƒç”¨å¾ªç¯

2. **å•å…ƒæµ‹è¯•ç¼ºå¤±**
   - åŸå› : æ—¶é—´ä¼˜å…ˆ,å…ˆå®Œæˆæ ¸å¿ƒåŠŸèƒ½
   - å½±å“: ä»£ç è´¨é‡ä¿éšœä¸è¶³
   - è§£å†³: åœ¨åç»­å¼€å‘è®¡åˆ’ä¸­è¡¥å……

3. **æµå¼å“åº”æœªå®ç°**
   - åŸå› : éå¿…éœ€åŠŸèƒ½,ä¼˜å…ˆçº§è¾ƒä½
   - å½±å“: æ— æ³•å®æ—¶æ˜¾ç¤ºAIç”Ÿæˆè¿‡ç¨‹
   - è§£å†³: ä½œä¸ºå¯é€‰åŠŸèƒ½åœ¨åç»­ä¼˜åŒ–é˜¶æ®µå®ç°

---

## ğŸš€ ä¸‹ä¸€æ­¥: å¼€å‘è®¡åˆ’4

**ç›®æ ‡**: æ¶ˆæ¯å­˜å‚¨å’Œä¸Šä¸‹æ–‡æ„å»º

**ä¸»è¦ä»»åŠ¡**:
1. æ¶ˆæ¯å­˜å‚¨å¢å¼º
2. ContextBuilder å®ç°
3. ç³»ç»Ÿæç¤ºè¯åŠ¨æ€ç”Ÿæˆ
4. Tokené¢„ç®—ç®¡ç†
5. å¤šè½®å¯¹è¯æ”¯æŒ

**é¢„è®¡æ—¶é—´**: 2-3å¤©

---

## ğŸ“ æ€»ç»“

### æˆåŠŸè¦ç‚¹
- âœ… **Mock LLM Server**: æ™ºèƒ½å“åº”æœºåˆ¶å®Œç¾å·¥ä½œ
- âœ… **å®¢æˆ·ç«¯æ¶æ„**: æ¸…æ™°çš„æ¥å£è®¾è®¡,æ˜“äºæ‰©å±•
- âœ… **é‡è¯•æœºåˆ¶**: æé«˜äº†ç³»ç»Ÿå¯é æ€§
- âœ… **é…ç½®çµæ´»**: æ”¯æŒMockå’ŒçœŸå®OpenAI APIåˆ‡æ¢
- âœ… **APIå®Œæ•´**: èŠå¤©æ¥å£ç¬¦åˆé¢„æœŸè®¾è®¡

### æŠ€æœ¯äº®ç‚¹
- ğŸŒŸ æŒ‡æ•°é€€é¿é‡è¯•ç®—æ³•
- ğŸŒŸ æ™ºèƒ½Mockå“åº”å†³ç­–
- ğŸŒŸ æ¥å£æŠ½è±¡è®¾è®¡
- ğŸŒŸ å®Œæ•´çš„é”™è¯¯å¤„ç†
- ğŸŒŸ é…ç½®å¤–éƒ¨åŒ–

### æ”¹è¿›å»ºè®®
- ğŸ“Œ è¡¥å……å•å…ƒæµ‹è¯•
- ğŸ“Œ æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- ğŸ“Œ å¢åŠ æ›´è¯¦ç»†çš„æ—¥å¿—
- ğŸ“Œ å®ç°è¯·æ±‚/å“åº”éªŒè¯
- ğŸ“Œ æ·»åŠ ç›‘æ§æŒ‡æ ‡

---

**å¼€å‘è®¡åˆ’3**: âœ… **å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•**

æ€»ä½“è¿›åº¦: **37.5%** (3/8 é˜¶æ®µå®Œæˆ)
