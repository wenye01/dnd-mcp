# DND MCP Client - ä»»åŠ¡å››æ€»ç»“

## HTTP API - æ¶ˆæ¯ç®¡ç†

### æ¦‚è¿°

ä»»åŠ¡å››å®ç°äº†æ¶ˆæ¯ç®¡ç†çš„ REST API,æä¾›å®Œæ•´çš„æ¶ˆæ¯ CRUD åŠŸèƒ½,æ”¯æŒé€šè¿‡ HTTP æ¥å£ç®¡ç†ä¼šè¯æ¶ˆæ¯ã€‚

### æ¶æ„è¯´æ˜

**âš ï¸ é‡è¦ï¼šå½“å‰å®ç°é‡‡ç”¨ç®€åŒ–æ¶æ„**

ä¸ºäº†å¿«é€Ÿè¿­ä»£å’Œäº¤ä»˜å¯è¿è¡Œçš„ç³»ç»Ÿï¼Œä»»åŠ¡å››é‡‡ç”¨äº†**ç®€åŒ–çš„æ¶æ„è®¾è®¡**ï¼Œä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰çš„å®Œæ•´æ¶æ„å­˜åœ¨å·®å¼‚ã€‚

#### å½“å‰å®ç°çš„ç®€åŒ–æ¶æ„

```
Handler (message.go)
  â†“ ç›´æ¥è°ƒç”¨
Store (redis/message.go)
  â†“
Models
```

**å®é™…ä¾èµ–å…³ç³»**:
```go
// Handler ç›´æ¥ä¾èµ– Store
handler.SendMessage(messageStore, llmClient)
  â†“
messageStore.Create(message)  // Redis æ“ä½œ
```

#### è®¾è®¡æ–‡æ¡£å®šä¹‰çš„å®Œæ•´æ¶æ„

```
Handler
  â†“
ChatService (service/chat.go)    â† âŒ å½“å‰æœªå®ç°
  â†“
MessageRepository (repository/)  â† âŒ å½“å‰æœªå®ç°
  â†“
Store (redis/message.go)
  â†“
Models
```

**è®¾è®¡æ–‡æ¡£çš„ä¾èµ–å…³ç³»**:
```go
// Handler ä¾èµ– Service
handler.SendMessage(chatService)
  â†“
chatService.SendMessage(messageRepo, llmClient)
  â†“
messageRepo.Save(message)  // æ¥å£
  â†“
redisStore.Create(message)  // å®ç°
```

#### ç®€åŒ–çš„åŸå› 

1. **å¿«é€Ÿè¿­ä»£**: ä¼˜å…ˆäº¤ä»˜åŠŸèƒ½ï¼Œå¿«é€ŸéªŒè¯éœ€æ±‚
2. **ä¸šåŠ¡é€»è¾‘ç®€å•**: æ¶ˆæ¯å‘é€é€»è¾‘ç›¸å¯¹ç›´æ¥ï¼ˆä¿å­˜æ¶ˆæ¯ + è°ƒç”¨ Mock LLMï¼‰
3. **å•ä¸€å­˜å‚¨**: å½“å‰åªä½¿ç”¨ Redisï¼ŒRepository æŠ½è±¡ä»·å€¼æœ‰é™
4. **å­¦ä¹ æ›²çº¿**: ç®€åŒ–æ¶æ„æ›´æ˜“äºç†è§£å’Œè°ƒè¯•

#### ç®€åŒ–çš„å½±å“

**ä¼˜ç‚¹** âœ…:
- å¼€å‘é€Ÿåº¦å¿«ï¼Œä»£ç ç®€æ´
- è°ƒç”¨é“¾è·¯çŸ­ï¼Œæ˜“äºè¿½è¸ª
- é€‚åˆå¿«é€ŸåŸå‹å¼€å‘

**ç¼ºç‚¹** âŒ:
- ä¸šåŠ¡é€»è¾‘æ•£è½åœ¨ Handler ä¸­
- è¿åä¾èµ–å€’ç½®åŸåˆ™ï¼ˆHandler ä¾èµ–å…·ä½“ Storeï¼‰
- éš¾ä»¥å•å…ƒæµ‹è¯•ï¼ˆéš¾ä»¥ Mock Store å±‚ï¼‰
- ä¸ç¬¦åˆè®¾è®¡æ–‡æ¡£æ¶æ„

#### æœªæ¥æ”¹è¿›è®¡åˆ’

**çŸ­æœŸï¼ˆå½“å‰ï¼‰**:
- âœ… ä¿æŒç®€åŒ–æ¶æ„ï¼ŒåŠŸèƒ½å®Œæ•´

**ä¸­æœŸï¼ˆä»»åŠ¡å…­/ä¸ƒï¼‰**:
- âš ï¸ è¯„ä¼°ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦
- âš ï¸ å¦‚æœ LLM/MCP é›†æˆåé€»è¾‘å˜å¤æ‚ï¼Œæ·»åŠ  ChatService
- âš ï¸ å¦‚æœéœ€è¦å¤šç§å­˜å‚¨ï¼Œæ·»åŠ  MessageRepository æ¥å£

**é•¿æœŸï¼ˆç”Ÿäº§å‰ï¼‰**:
- ğŸ¯ è¡¥å…… ChatServiceï¼Œå°è£…æ¶ˆæ¯å‘é€é€»è¾‘
- ğŸ¯ è¡¥å…… MessageRepositoryï¼ŒæŠ½è±¡æ•°æ®è®¿é—®
- ğŸ¯ ç¬¦åˆè®¾è®¡æ–‡æ¡£çš„å®Œæ•´æ¶æ„

**è¯¦ç»†è¯´æ˜**: å‚è§ `doc/æ¶æ„ç®€åŒ–è¯´æ˜.md`

---

### æ ¸å¿ƒåŠŸèƒ½

#### 1. å‘é€æ¶ˆæ¯ API (éœ€æ±‚ 4.1)

**å®ç°å†…å®¹:**

- **Handler å®ç°** (`internal/api/handler/message.go`)
  
  - `SendMessage` - å‘é€æ¶ˆæ¯å¹¶è·å– AI å“åº”(ä½¿ç”¨ Mock LLM)
  - å‚æ•°éªŒè¯: content, player_id å¿…å¡«
  - æ”¯æŒ stream å‚æ•°(é¢„ç•™,å½“å‰å›ºå®šä¸º false)
  - ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Redis
  - è°ƒç”¨ Mock LLM è·å–åŠ©æ‰‹å“åº”
  - ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯åˆ° Redis
  - è¿”å›å®Œæ•´å“åº”æ¶ˆæ¯

- **è¯·æ±‚å“åº”æ ¼å¼:**
  
  ```json
  // è¯·æ±‚
  POST /api/sessions/{session_id}/chat
  {
    "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
    "player_id": "player-123",
    "stream": false
  }
  
  // å“åº” 200 OK
  {
    "id": "msg-uuid-xxx",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
    "created_at": "2025-02-03T10:05:30Z"
  }
  ```

- **Mock LLM å®ç°** (`internal/llm/mock.go`)
  
  - æ¥å£å®šä¹‰: `LLMClient`
  - Mock å®ç°: `MockLLMClient`
  - é¢„è®¾å“åº”: `"è¿™æ˜¯ Mock LLM çš„å“åº”"`
  - æ”¯æŒé…ç½®åˆ‡æ¢: `LLM_PROVIDER=mock` (é»˜è®¤)

**CLI æµ‹è¯•:**

```bash
# å¯åŠ¨æœåŠ¡å™¨
./bin/dnd-client.exe server start

# å‘é€æ¶ˆæ¯
curl -X POST http://localhost:8080/api/sessions/{session-id}/chat \
  -H "Content-Type: application/json" \
  -d '{"content":"ä½ å¥½","player_id":"player-123"}'
```

#### 2. è·å–æ¶ˆæ¯å†å² API (éœ€æ±‚ 4.2)

**å®ç°å†…å®¹:**

- **Handler å®ç°** (`internal/api/handler/message.go`)
  
  - `GetMessages` - è·å–ä¼šè¯æ¶ˆæ¯å†å²
  - æŸ¥è¯¢å‚æ•°:
    - `limit`: è¿”å›æ¶ˆæ¯æ•°é‡,é»˜è®¤ 50,æœ€å¤§ 100
    - `role`: è§’è‰²è¿‡æ»¤(user|assistant|system|tool)
    - `since`: èµ·å§‹æ—¶é—´(RFC3339 æ ¼å¼)
  - æŒ‰æ—¶é—´å‡åºæ’åˆ—(ä»æ—§åˆ°æ–°)
  - ç›´æ¥è¿”å›æ•°ç»„,æ— åˆ†é¡µ

- **æŸ¥è¯¢é€»è¾‘:**
  
  ```go
  // ä» Redis ZREVRANGE è·å–æ¶ˆæ¯
  messages, err := messageStore.List(ctx, sessionID, limit)
  
  // è§’è‰²è¿‡æ»¤
  if role != "" {
      messages = filterByRole(messages, role)
  }
  
  // æ—¶é—´è¿‡æ»¤
  if since != "" {
      sinceTime, _ := time.Parse(time.RFC3339, since)
      messages = filterByTime(messages, sinceTime)
  }
  
  // è¿”å›æ•°ç»„
  c.JSON(http.StatusOK, toMessageResponses(messages))
  ```

**CLI æµ‹è¯•:**

```bash
# è·å–æœ€è¿‘ 50 æ¡æ¶ˆæ¯
curl http://localhost:8080/api/sessions/{session-id}/messages

# è·å–æœ€è¿‘ 20 æ¡ç”¨æˆ·æ¶ˆæ¯
curl "http://localhost:8080/api/sessions/{session-id}/messages?limit=20&role=user"

# è·å–æŒ‡å®šæ—¶é—´ä¹‹åçš„æ¶ˆæ¯
curl "http://localhost:8080/api/sessions/{session-id}/messages?since=2025-02-03T10:00:00Z"
```

#### 3. è·å–å•æ¡æ¶ˆæ¯ API (éœ€æ±‚ 4.3)

**å®ç°å†…å®¹:**

- **Handler å®ç°** (`internal/api/handler/message.go`)
  - `GetMessage` - è·å–å•æ¡æ¶ˆæ¯è¯¦æƒ…
  - UUID æ ¼å¼éªŒè¯
  - ä» Redis æŸ¥è¯¢æ¶ˆæ¯
  - æ¶ˆæ¯ä¸å­˜åœ¨è¿”å› 404

**CLI æµ‹è¯•:**

```bash
# è·å–å•æ¡æ¶ˆæ¯
curl http://localhost:8080/api/sessions/{session-id}/messages/{message-id}
```

#### 4. è·¯ç”±æ³¨å†Œ (éœ€æ±‚ 4.1-4.3)

**å®ç°ä½ç½®:** `internal/api/router.go`

```go
// æ¶ˆæ¯è·¯ç”±
messages := api.Group("/sessions/:sessionId/messages")
{
    messages.POST("", handler.SendMessage(sessionStore, messageStore, llmClient))
    messages.GET("", handler.GetMessages(messageStore))
    messages.GET("/:messageId", handler.GetMessage(messageStore))
}
```

### æŠ€æœ¯äº®ç‚¹

1. **éµå¾ªè§„èŒƒ,å¤ç”¨å·²æœ‰å®ç°**
   
   - å¤ç”¨ä»»åŠ¡ä¸€çš„ `models.Message` æ¨¡å‹
   - å¤ç”¨ä»»åŠ¡ä¸€çš„ `store.MessageStore` æ¥å£
   - å¤ç”¨ä»»åŠ¡ä¸‰çš„ HTTP æœåŠ¡å™¨å’Œä¸­é—´ä»¶
   - ä¸ä¿®æ”¹å·²å®Œæˆçš„ä»»åŠ¡ä»£ç 

2. **ä¾èµ–æ³¨å…¥,ä¾¿äºæµ‹è¯•**
   
   - Handler é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ store
   - LLM Client é€šè¿‡æ¥å£æ³¨å…¥
   - æ”¯æŒ Mock å®ç°,ä¾¿äºå•å…ƒæµ‹è¯•

3. **Mock LLM è®¾è®¡**
   
   - æ¥å£åŒ–è®¾è®¡: `LLMClient` æ¥å£
   - Mock å®ç°: `MockLLMClient`
   - é¢„ç•™æ‰©å±•: åç»­å¯æ¥å…¥çœŸå® LLM(ä»»åŠ¡å…­)
   - é…ç½®åˆ‡æ¢: é€šè¿‡ç¯å¢ƒå˜é‡ `LLM_PROVIDER` æ§åˆ¶

4. **é”™è¯¯å¤„ç†è§„èŒƒ**
   
   - éµå¾ª `doc/è§„èŒƒ.md` çš„é”™è¯¯å¤„ç†åŸåˆ™
   - é”™è¯¯åº”è¯¥è¿”å›,ä¸æ˜¯è®°å½•æ—¥å¿—åè¿”å› nil
   - ç»“æ„åŒ–é”™è¯¯å“åº”æ ¼å¼
   - æ¸…æ™°çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯

5. **å‚æ•°éªŒè¯å®Œæ•´**
   
   - ä½¿ç”¨ Gin binding éªŒè¯å¿…å¡«å­—æ®µ
   - è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘éªŒè¯
   - UUID æ ¼å¼éªŒè¯
   - å‚æ•°èŒƒå›´éªŒè¯(limit 1-100)

6. **æŸ¥è¯¢å‚æ•°è®¾è®¡**
   
   - æ”¯æŒåˆ†é¡µå‚æ•°(limit)
   - æ”¯æŒè¿‡æ»¤å‚æ•°(role, since)
   - æä¾›åˆç†é»˜è®¤å€¼
   - å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º

### æ–‡ä»¶æ¸…å•

**æ–°å¢æ–‡ä»¶:**

```
internal/api/handler/
  â””â”€â”€ message.go         # æ¶ˆæ¯ Handler

internal/llm/
  â”œâ”€â”€ client.go          # LLM å®¢æˆ·ç«¯æ¥å£
  â”œâ”€â”€ mock.go            # Mock LLM å®ç°
  â””â”€â”€ types.go           # LLM ç±»å‹å®šä¹‰

pkg/config/
  â””â”€â”€ config.go          # æ‰©å±• LLM é…ç½®

internal/api/
  â””â”€â”€ router.go          # æ³¨å†Œæ¶ˆæ¯è·¯ç”±
```

**ä¿®æ”¹æ–‡ä»¶:**

```
internal/cli/
  â””â”€â”€ server.go          # åˆå§‹åŒ– LLM Client

go.mod
  â””â”€â”€ æ·»åŠ  LLM ç›¸å…³ä¾èµ–(å¦‚éœ€è¦)
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. å‘é€æ¶ˆæ¯

```bash
# å‘é€æ¶ˆæ¯
curl -X POST http://localhost:8080/api/sessions/{session-id}/chat \
  -H "Content-Type: application/json" \
  -d '{
    "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
    "player_id": "player-123"
  }'

# å“åº”
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",
  "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
  "created_at": "2025-02-03T10:05:30Z"
}
```

#### 2. è·å–æ¶ˆæ¯å†å²

```bash
# è·å–æœ€è¿‘ 50 æ¡æ¶ˆæ¯
curl http://localhost:8080/api/sessions/{session-id}/messages

# å“åº”
[
  {
    "id": "msg-uuid-1",
    "session_id": "session-uuid-xxx",
    "role": "user",
    "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
    "player_id": "player-123",
    "created_at": "2025-02-03T10:05:00Z"
  },
  {
    "id": "msg-uuid-2",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
    "created_at": "2025-02-03T10:05:30Z"
  }
]
```

#### 3. è·å–å•æ¡æ¶ˆæ¯

```bash
# è·å–å•æ¡æ¶ˆæ¯
curl http://localhost:8080/api/sessions/{session-id}/messages/{message-id}

# å“åº”
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",
  "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
  "created_at": "2025-02-03T10:05:30Z"
}
```

### æµ‹è¯•è¦†ç›–

- âœ… å‚æ•°éªŒè¯(å¿…å¡«å­—æ®µã€æ ¼å¼ã€èŒƒå›´)
- âœ… å‘é€æ¶ˆæ¯(ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ã€ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯)
- âœ… Mock LLM å“åº”
- âœ… è·å–æ¶ˆæ¯å†å²(limit, role, since è¿‡æ»¤)
- âœ… è·å–å•æ¡æ¶ˆæ¯
- âœ… æ¶ˆæ¯ä¸å­˜åœ¨è¿”å› 404
- âœ… ä¼šè¯ä¸å­˜åœ¨è¿”å› 404
- âœ… é”™è¯¯å¤„ç†(Redis è¿æ¥å¤±è´¥)

### æ€§èƒ½æŒ‡æ ‡

**API æ€§èƒ½:**

| æ“ä½œ     | é¢„æœŸå“åº”æ—¶é—´ | è¯´æ˜                    |
| ------ | ------ | --------------------- |
| å‘é€æ¶ˆæ¯   | < 20ms | å« Redis æ“ä½œ + Mock LLM |
| è·å–æ¶ˆæ¯å†å² | < 10ms | å« Redis æŸ¥è¯¢            |
| è·å–å•æ¡æ¶ˆæ¯ | < 5ms  | å« Redis æŸ¥è¯¢            |

**æµ‹è¯•ç¯å¢ƒ:

- Redis 7 (æœ¬åœ°)

### æ€»ç»“

ä»»åŠ¡å››æˆåŠŸå®ç°äº†æ¶ˆæ¯ç®¡ç† REST API,åŒ…æ‹¬:

1. âœ… **å‘é€æ¶ˆæ¯ API** - æ”¯æŒå‘é€æ¶ˆæ¯å¹¶è·å– AI å“åº”(ä½¿ç”¨ Mock LLM)
2. âœ… **è·å–æ¶ˆæ¯å†å² API** - æ”¯æŒåˆ†é¡µå’Œè¿‡æ»¤
3. âœ… **è·å–å•æ¡æ¶ˆæ¯ API** - æ”¯æŒæŸ¥è¯¢æ¶ˆæ¯è¯¦æƒ…
4. âœ… **Mock LLM å®ç°** - æ¥å£åŒ–è®¾è®¡,ä¾¿äºæ‰©å±•
5. âœ… **è·¯ç”±æ³¨å†Œ** - å®Œæ•´çš„ REST API è·¯ç”±
6. âœ… **é”™è¯¯å¤„ç†** - è§„èŒƒçš„é”™è¯¯å“åº”æ ¼å¼
7. âœ… **å‚æ•°éªŒè¯** - å®Œæ•´çš„è¾“å…¥éªŒè¯

æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡ç¼–è¯‘æµ‹è¯•,ä¸¥æ ¼éµå¾ª `doc/è§„èŒƒ.md` çš„è¦æ±‚,å¤ç”¨ä»»åŠ¡ä¸€ã€äºŒã€ä¸‰çš„å®ç°,ä¸ä¿®æ”¹å·²æœ‰ä»£ç ã€‚

---

**å¼€å‘å®Œæˆæ—¶é—´:** 2025-02-04
**å¼€å‘è€…:** Claude (Anthropic)
**çŠ¶æ€:** âœ… å·²å®Œæˆ
