# å¼€å‘ä»»åŠ¡ä¸‰ï¼šHTTP API - ä¼šè¯ç®¡ç†ï¼ˆä¿®è®¢ç‰ˆï¼‰

## æ–‡æ¡£ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: Task-3
- **ä»»åŠ¡åç§°**: HTTP API - ä¼šè¯ç®¡ç†
- **ç‰ˆæœ¬**: v1.1ï¼ˆä¿®è®¢ç‰ˆï¼‰
- **ä¿®è®¢æ—¥æœŸ**: 2025-02-04
- **ä¿®è®¢åŸå› **: ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£ä¿æŒæ¶æ„ä¸€è‡´
- **å‰ç½®ä»»åŠ¡**: Task-1ï¼ˆé¡¹ç›®è„šæ‰‹æ¶ + Redis åŸºç¡€å­˜å‚¨ï¼‰
- **åŸºäºæ–‡æ¡£**: DND_MCP_Clientè¯¦ç»†è®¾è®¡.md v1.1ã€DND_MCP_Client_å¼€å‘è®¡åˆ’.md v1.0
- **å¿…é¡»éµå®ˆ**: doc/è§„èŒƒ.md

---

## ä¿®è®¢è¯´æ˜

### ä¸»è¦å˜æ›´

ä¸åˆç¨¿ç›¸æ¯”,æœ¬ç‰ˆæœ¬è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´ä»¥ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£ä¿æŒä¸€è‡´:

1. **âœ… æ·»åŠ  Repository å±‚**
   - æ–°å¢ `internal/repository/session.go` æ¥å£å®šä¹‰
   - éµå¾ª"åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£"åŸåˆ™

2. **âœ… æ·»åŠ  Service å±‚**
   - æ–°å¢ `internal/service/session.go`
   - Handler â†’ Service â†’ Repository â†’ Store æ¶æ„å±‚æ¬¡

3. **âœ… ä¿®æ­£é”™è¯¯å“åº”æ ¼å¼**
   - `details` å­—æ®µæ”¹ä¸ºå¯¹è±¡ç±»å‹ï¼ˆè€Œéå­—ç¬¦ä¸²ï¼‰

4. **âœ… æ˜ç¡®å­—æ®µè¯´æ˜**
   - å¯¹ `current_players` å’Œ `message_count` å­—æ®µæ·»åŠ è¯´æ˜

5. **âœ… æ¥å£å®šä¹‰ä½ç½®è°ƒæ•´**
   - Repository æ¥å£åœ¨ä½¿ç”¨æ–¹ï¼ˆrepository åŒ…ï¼‰å®šä¹‰
   - Store å®ç°æ¥å£

---

## ä»»åŠ¡æ¦‚è¿°

### ç›®æ ‡

åœ¨ä»»åŠ¡ä¸€çš„åŸºç¡€ä¸Š,å®ç°ä¼šè¯ç®¡ç†çš„ REST API,æä¾›å®Œæ•´çš„ CRUD åŠŸèƒ½,æ”¯æŒé€šè¿‡ HTTP æ¥å£ç®¡ç†ä¼šè¯ã€‚

### åŸºäºä»»åŠ¡ä¸€çš„æˆæœ

ä»»åŠ¡ä¸€å·²å®Œæˆçš„åŸºç¡€è®¾æ–½:

- âœ… æ ‡å‡†çš„ Go é¡¹ç›®ç»“æ„ï¼ˆç¬¦åˆ `doc/è§„èŒƒ.md`ï¼‰
- âœ… Redis å­˜å‚¨å®ç°ï¼ˆ`internal/store/redis/`ï¼‰
- âœ… é¢†åŸŸæ¨¡å‹ï¼ˆ`internal/models/`ï¼‰- æœ€åº•å±‚
- âœ… é…ç½®ç®¡ç†ï¼ˆ`pkg/config/`ï¼‰
- âœ… é”™è¯¯å®šä¹‰ï¼ˆ`pkg/errors/`ï¼‰
- âœ… å‘½ä»¤è¡Œæ¡†æ¶ï¼ˆ`internal/cli/`ï¼‰
- âœ… æµ‹è¯•æ¡†æ¶ï¼ˆ`tests/`ï¼‰

### ä»»åŠ¡ä¸‰æ–°å¢åŠŸèƒ½

- ğŸŒ HTTP æœåŠ¡å™¨ï¼ˆ`internal/api/`ï¼‰
- ğŸ› ï¸ API Handler å±‚ï¼ˆ`internal/api/handler/`ï¼‰
- ğŸ“¦ Repository å±‚æ¥å£ï¼ˆ`internal/repository/`ï¼‰
- âš™ï¸ Service å±‚ï¼ˆ`internal/service/`ï¼‰
- ğŸ“‹ è·¯ç”±ç®¡ç†ï¼ˆ`internal/api/router.go`ï¼‰
- ğŸ›¡ï¸ ä¸­é—´ä»¶ï¼ˆ`internal/api/middleware/`ï¼‰
- ğŸ“ HTTP æµ‹è¯•æ¡†æ¶ï¼ˆ`tests/integration/api/`ï¼‰

### å¯æ¼”ç¤ºåŠŸèƒ½

```bash
# å¯åŠ¨ HTTP æœåŠ¡å™¨
./bin/dnd-client server start

# åˆ›å»ºä¼šè¯
curl -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
    "creator_id": "user-123",
    "mcp_server_url": "http://localhost:9000",
    "max_players": 5
  }'

# è·å–ä¼šè¯åˆ—è¡¨
curl http://localhost:8080/api/sessions

# è·å–ä¼šè¯è¯¦æƒ…
curl http://localhost:8080/api/sessions/{session_id}

# æ›´æ–°ä¼šè¯
curl -X PATCH http://localhost:8080/api/sessions/{session_id} \
  -H "Content-Type: application/json" \
  -d '{"name": "æ›´æ–°çš„ä¼šè¯åç§°"}'

# åˆ é™¤ä¼šè¯
curl -X DELETE http://localhost:8080/api/sessions/{session_id}
```

### éªŒæ”¶æ ‡å‡†

- âœ… HTTP æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨å’Œç›‘å¬
- âœ… æ‰€æœ‰ä¼šè¯ API æ­£å¸¸å·¥ä½œ
- âœ… HTTP çŠ¶æ€ç æ­£ç¡®
- âœ… è¯·æ±‚å‚æ•°éªŒè¯æ­£ç¡®
- âœ… é”™è¯¯å¤„ç†å’Œé”™è¯¯å“åº”ç¬¦åˆè§„èŒƒ
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… ä¸¥æ ¼éµå¾ª `doc/è§„èŒƒ.md` çš„æ‰€æœ‰è¦æ±‚
- âœ… **ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£æ¶æ„ä¸€è‡´**

---

## è§„èŒƒè¦æ±‚å¯¹ç…§æ£€æŸ¥

### ç›®å½•ç»“æ„è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` å’Œè¯¦ç»†è®¾è®¡æ–‡æ¡£çš„è¦æ±‚:

```
dnd-client/
â”œâ”€â”€ cmd/                    # ä¸»ç¨‹åºå…¥å£
â”‚   â””â”€â”€ client/
â”‚       â””â”€â”€ main.go         # ç¨‹åºå…¥å£ï¼ˆä»»åŠ¡ä¸‰æ‰©å±•ï¼‰
â”œâ”€â”€ bin/                    # äºŒè¿›åˆ¶è¾“å‡ºä»¶ä½ç½®
â”œâ”€â”€ internal/               # å®ç°ä»£ç ï¼Œä¸å¯¹å¤–æš´éœ²
â”‚   â”œâ”€â”€ models/            # é¢†åŸŸæ¨¡å‹ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ repository/        # æ•°æ®è®¿é—®æ¥å£ï¼ˆä»»åŠ¡ä¸‰æ–°å¢ï¼‰âš ï¸
â”‚   â”‚   â””â”€â”€ session.go     # ä¼šè¯ Repository æ¥å£
â”‚   â”œâ”€â”€ store/             # å­˜å‚¨å®ç°å±‚ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼‰
â”‚   â”‚   â””â”€â”€ redis/         # Redis å®ç°
â”‚   â”œâ”€â”€ service/           # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆä»»åŠ¡ä¸‰æ–°å¢ï¼‰âš ï¸
â”‚   â”‚   â””â”€â”€ session.go     # ä¼šè¯ Service
â”‚   â”œâ”€â”€ api/               # HTTP API å±‚ï¼ˆä»»åŠ¡ä¸‰æ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ handler/       # API å¤„ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ session.go # ä¼šè¯ Handler
â”‚   â”‚   â”œâ”€â”€ middleware/    # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ logging.go
â”‚   â”‚   â”‚   â”œâ”€â”€ recovery.go
â”‚   â”‚   â”‚   â””â”€â”€ cors.go
â”‚   â”‚   â””â”€â”€ router.go      # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ cli/               # CLI å‘½ä»¤ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡ä¸‰æ‰©å±•ï¼‰
â”œâ”€â”€ pkg/                    # å…¬å…±åº“ï¼Œå¯è¢«å¤–éƒ¨é¡¹ç›®å¯¼å…¥
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡ä¸‰æ‰©å±•ï¼‰
â”‚   â””â”€â”€ errors/            # é”™è¯¯å®šä¹‰ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡ä¸‰æ‰©å±•ï¼‰
â”œâ”€â”€ scripts/                # æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ api/           # API å±‚å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ repository/    # Repository å±‚å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â””â”€â”€ service/       # Service å±‚å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ integration/       # é›†æˆæµ‹è¯•
â”‚   â”‚   â””â”€â”€ api/           # HTTP é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ e2e/               # é»‘ç›’æµ‹è¯•
â”‚       â””â”€â”€ api/           # API é»‘ç›’æµ‹è¯•
â””â”€â”€ doc/                    # å¼€å‘æ–‡æ¡£
```

### ä¾èµ–æ–¹å‘è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` å’Œè¯¦ç»†è®¾è®¡æ–‡æ¡£çš„ä¾èµ–åŸåˆ™ï¼šå•å‘ä¾èµ–ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚

```
handler (HTTP å¤„ç†å™¨)
  â†“
service (ä¸šåŠ¡é€»è¾‘)
  â†“
repository (æ•°æ®è®¿é—®æ¥å£)
  â†“
store (å­˜å‚¨å®ç°: redis)
  â†“
models (é¢†åŸŸæ¨¡å‹) - æœ€åº•å±‚
```

**å…³é”®ç‚¹**:
- âœ… handler ä¾èµ– service
- âœ… service ä¾èµ– repository æ¥å£
- âœ… store å®ç° repository æ¥å£
- âœ… store ä¾èµ– models
- âœ… models ä¸ä¾èµ–ä»»ä½•å…¶ä»–åŒ…
- âœ… **æ¥å£åœ¨ä½¿ç”¨æ–¹ï¼ˆrepositoryï¼‰å®šä¹‰**

### æ¥å£è®¾è®¡è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` å’Œè¯¦ç»†è®¾è®¡æ–‡æ¡£çš„æ¥å£è®¾è®¡åŸåˆ™:
- âœ… å°æ¥å£åŸåˆ™ï¼šæ¥å£åŒ…å« 1-3 ä¸ªæ–¹æ³•
- âœ… å•ä¸€èŒè´£ï¼šä¸€ä¸ªæ¥å£åªåšä¸€ä»¶äº‹
- âœ… **åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£**ï¼ˆrepository åŒ…å®šä¹‰æ¥å£ï¼‰
- âœ… **ä¾èµ–æ³¨å…¥ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥**

---

## æ¶æ„è®¾è®¡

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HTTP Layer (API)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Handler (session.go)                â”‚   â”‚
â”‚  â”‚   â€¢ å‚æ•°éªŒè¯                           â”‚   â”‚
â”‚  â”‚   â€¢ å“åº”æ ¼å¼åŒ–                         â”‚   â”‚
â”‚  â”‚   â€¢ HTTP çŠ¶æ€ç                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Service Layer (ä¸šåŠ¡é€»è¾‘)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SessionService                      â”‚   â”‚
â”‚  â”‚   â€¢ CreateSession()                  â”‚   â”‚
â”‚  â”‚   â€¢ GetSession()                     â”‚   â”‚
â”‚  â”‚   â€¢ ListSessions()                   â”‚   â”‚
â”‚  â”‚   â€¢ UpdateSession()                  â”‚   â”‚
â”‚  â”‚   â€¢ DeleteSession()                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Repository Layer (æ•°æ®è®¿é—®æ¥å£)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SessionRepository (æ¥å£)             â”‚   â”‚
â”‚  â”‚   â€¢ Create(ctx, session) error        â”‚   â”‚
â”‚  â”‚   â€¢ Get(ctx, id) (*Session, error)    â”‚   â”‚
â”‚  â”‚   â€¢ List(ctx) ([]*Session, error)     â”‚   â”‚
â”‚  â”‚   â€¢ Update(ctx, session) error        â”‚   â”‚
â”‚  â”‚   â€¢ Delete(ctx, id) error             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Store Layer (å­˜å‚¨å®ç°)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RedisSessionStore (å®ç°æ¥å£)          â”‚   â”‚
â”‚  â”‚   å®ç° SessionRepository æ¥å£          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Models (é¢†åŸŸæ¨¡å‹)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Session (ç»“æ„ä½“)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
HTTP Request
    â”‚
    â–¼
Handler.CreateSession()
    â”‚ è§£æè¯·æ±‚
    â”‚ å‚æ•°éªŒè¯
    â–¼
SessionService.CreateSession()
    â”‚ ä¸šåŠ¡é€»è¾‘
    â”‚ å‚æ•°æ ¡éªŒ
    â–¼
SessionRepository.Create()
    â”‚ æ•°æ®è®¿é—®æŠ½è±¡
    â–¼
RedisSessionStore.Create()
    â”‚ Redis æ“ä½œ
    â”‚ HSET session:{uuid}
    â–¼
è¿”å›å“åº”
```

---

## éœ€æ±‚è¯¦ç»†æ‹†è§£

### éœ€æ±‚ 3.1ï¼šHTTP æœåŠ¡å™¨å’Œè·¯ç”±è®¾ç½®

#### éœ€æ±‚æè¿°

å®ç° HTTP æœåŠ¡å™¨åŸºç¡€æ¶æ„,åŒ…æ‹¬è·¯ç”±ç®¡ç†ã€ä¸­é—´ä»¶ã€é…ç½®ç®¡ç†ç­‰ã€‚

#### è¯¦ç»†çº¦æŸ

**1. HTTP æ¡†æ¶é€‰æ‹©**

é€‰æ‹© `gin-gonic/gin` æ¡†æ¶ï¼ˆä¸è¯¦ç»†è®¾è®¡ä¸€è‡´ï¼‰:
- é«˜æ€§èƒ½ HTTP æ¡†æ¶
- ç¤¾åŒºæ´»è·ƒï¼ˆgithub stars 70k+ï¼‰
- API ç®€æ´æ˜“ç”¨
- å†…ç½®ä¸­é—´ä»¶ä¸°å¯Œ

**2. é…ç½®æ‰©å±•**

åœ¨ `pkg/config/config.go` ä¸­æ‰©å±•:

```go
// pkg/config/config.go

// Config åº”ç”¨é…ç½®
type Config struct {
    Redis    RedisConfig    `mapstructure:"redis"`
    HTTP     HTTPConfig     `mapstructure:"http"` // ä»»åŠ¡ä¸‰æ–°å¢
    Log      LogConfig      `mapstructure:"log"`
}

// HTTPConfig HTTP æœåŠ¡å™¨é…ç½®
type HTTPConfig struct {
    Host            string        `mapstructure:"host" env:"HTTP_HOST" default:"0.0.0.0"`
    Port            int           `mapstructure:"port" env:"HTTP_PORT" default:"8080"`
    ReadTimeout     time.Duration `mapstructure:"read_timeout" env:"HTTP_READ_TIMEOUT" default:"30s"`
    WriteTimeout    time.Duration `mapstructure:"write_timeout" env:"HTTP_WRITE_TIMEOUT" default:"30s"`
    ShutdownTimeout time.Duration `mapstructure:"shutdown_timeout" env:"HTTP_SHUTDOWN_TIMEOUT" default:"10s"`
    EnableCORS      bool          `mapstructure:"enable_cors" env:"HTTP_ENABLE_CORS" default:"true"`
}
```

**3. æœåŠ¡å™¨æ¶æ„è®¾è®¡**

```go
// internal/api/server.go

package api

import (
    "context"
    "fmt"
    "net/http"
    "time"

    "github.com/gin-gonic/gin"
    "dnd-client/internal/service"
    "dnd-client/pkg/config"
    "dnd-client/pkg/logger"
)

// Server HTTP æœåŠ¡å™¨
type Server struct {
    config         *config.Config
    httpServer     *http.Server
    router         *gin.Engine
    sessionService *service.SessionService // ä¾èµ–æ³¨å…¥ Service
}

// NewServer åˆ›å»º HTTP æœåŠ¡å™¨
func NewServer(
    cfg *config.Config,
    sessionService *service.SessionService,
) *Server {
    // è®¾ç½® Gin æ¨¡å¼
    if cfg.Log.Level == "debug" {
        gin.SetMode(gin.DebugMode)
    } else {
        gin.SetMode(gin.ReleaseMode)
    }

    router := gin.New()

    server := &Server{
        config:         cfg,
        router:         router,
        sessionService: sessionService,
    }

    // è®¾ç½®ä¸­é—´ä»¶
    server.setupMiddleware()

    // è®¾ç½®è·¯ç”±
    server.setupRoutes()

    return server
}

// setupMiddleware è®¾ç½®ä¸­é—´ä»¶
func (s *Server) setupMiddleware() {
    s.router.Use(middleware.Logger(logger.Instance))
    s.router.Use(middleware.Recovery(logger.Instance))
    if s.config.HTTP.EnableCORS {
        s.router.Use(middleware.CORS())
    }
}

// setupRoutes è®¾ç½®è·¯ç”±
func (s *Server) setupRoutes() {
    // å¥åº·æ£€æŸ¥
    s.router.GET("/health", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{"status": "ok"})
    })

    // API è·¯ç”±ç»„
    api := s.router.Group("/api")
    {
        // ä¼šè¯è·¯ç”±
        sessions := api.Group("/sessions")
        {
            sessions.POST("", handler.CreateSession(s.sessionService))
            sessions.GET("", handler.ListSessions(s.sessionService))
            sessions.GET("/:id", handler.GetSession(s.sessionService))
            sessions.PATCH("/:id", handler.UpdateSession(s.sessionService))
            sessions.DELETE("/:id", handler.DeleteSession(s.sessionService))
        }
    }
}

// Start å¯åŠ¨ HTTP æœåŠ¡å™¨
func (s *Server) Start() error {
    addr := fmt.Sprintf("%s:%d", s.config.HTTP.Host, s.config.HTTP.Port)

    s.httpServer = &http.Server{
        Addr:         addr,
        Handler:      s.router,
        ReadTimeout:  s.config.HTTP.ReadTimeout,
        WriteTimeout: s.config.HTTP.WriteTimeout,
    }

    logger.Info("HTTP æœåŠ¡å™¨å¯åŠ¨", "addr", addr, "timeout", s.config.HTTP.ReadTimeout)

    if err := s.httpServer.ListenAndServe(); err != nil && err != http.ErrServerClosed {
        return fmt.Errorf("HTTP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: %w", err)
    }

    return nil
}

// Shutdown ä¼˜é›…å…³é—­ HTTP æœåŠ¡å™¨
func (s *Server) Shutdown(ctx context.Context) error {
    logger.Info("HTTP æœåŠ¡å™¨æ­£åœ¨å…³é—­...")

    shutdownCtx, cancel := context.WithTimeout(ctx, s.config.HTTP.ShutdownTimeout)
    defer cancel()

    if err := s.httpServer.Shutdown(shutdownCtx); err != nil {
        return fmt.Errorf("HTTP æœåŠ¡å™¨å…³é—­å¤±è´¥: %w", err)
    }

    logger.Info("HTTP æœåŠ¡å™¨å·²å…³é—­")
    return nil
}
```

**4. ä¸­é—´ä»¶å®ç°**

(ä¸åˆç¨¿ç›¸åŒ,ä¿æŒä¸å˜)

#### æ–‡ä»¶æ¸…å•

- [ ] `pkg/config/config.go` - é…ç½®æ‰©å±•ï¼ˆæ·»åŠ  HTTPï¼‰
- [ ] `internal/api/server.go` - HTTP æœåŠ¡å™¨
- [ ] `internal/api/middleware/*.go` - ä¸­é—´ä»¶
- [ ] `internal/cli/server.go` - server å‘½ä»¤
- [ ] `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹æ›´æ–°

---

### éœ€æ±‚ 3.2ï¼šRepository å±‚æ¥å£å®šä¹‰

#### éœ€æ±‚æè¿°

åœ¨ `internal/repository` åŒ…ä¸­å®šä¹‰æ•°æ®è®¿é—®æ¥å£,éµå¾ª"åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£"åŸåˆ™ã€‚

#### æ¥å£å®šä¹‰

```go
// internal/repository/session.go

package repository

import (
    "context"
    "dnd-client/internal/models"
)

// SessionRepository ä¼šè¯æ•°æ®è®¿é—®æ¥å£
// åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£ï¼Œstore å±‚å®ç°æ­¤æ¥å£
type SessionRepository interface {
    // Create åˆ›å»ºä¼šè¯
    Create(ctx context.Context, session *models.Session) error

    // Get è·å–ä¼šè¯è¯¦æƒ…
    Get(ctx context.Context, id string) (*models.Session, error)

    // List åˆ—å‡ºæ‰€æœ‰ä¼šè¯
    List(ctx context.Context) ([]*models.Session, error)

    // Update æ›´æ–°ä¼šè¯
    Update(ctx context.Context, session *models.Session) error

    // Delete åˆ é™¤ä¼šè¯ï¼ˆè½¯åˆ é™¤ï¼‰
    Delete(ctx context.Context, id string) error
}
```

#### è®¾è®¡è¯´æ˜

- **éµå¾ªå°æ¥å£åŸåˆ™**: æ¥å£åŒ…å« 5 ä¸ªæ–¹æ³•,èŒè´£æ¸…æ™°
- **éµå¾ªä¾èµ–å€’ç½®**: é«˜å±‚æ¨¡å—ï¼ˆserviceï¼‰ä¾èµ–æŠ½è±¡ï¼ˆrepositoryï¼‰,ä¸ä¾èµ–å…·ä½“å®ç°ï¼ˆstoreï¼‰
- **æ˜“äºæµ‹è¯•**: Service å±‚å¯ä»¥ mock repository æ¥å£è¿›è¡Œå•å…ƒæµ‹è¯•
- **æ˜“äºæ‰©å±•**: æœªæ¥å¯ä»¥æ·»åŠ  PostgreSQL å®ç°è€Œä¸å½±å“ Service å±‚

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/repository/session.go` - SessionRepository æ¥å£

---

### éœ€æ±‚ 3.3ï¼šService å±‚å®ç°

#### éœ€æ±‚æè¿°

å®ç° SessionService,å°è£…ä¼šè¯ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚

#### Service å®ç°

```go
// internal/service/session.go

package service

import (
    "context"
    "fmt"
    "time"

    "github.com/google/uuid"
    "dnd-client/internal/models"
    "dnd-client/internal/repository"
    "dnd-client/pkg/errors"
)

// SessionService ä¼šè¯ä¸šåŠ¡é€»è¾‘
type SessionService struct {
    sessionRepo repository.SessionRepository
}

// NewSessionService åˆ›å»ºä¼šè¯æœåŠ¡
func NewSessionService(sessionRepo repository.SessionRepository) *SessionService {
    return &SessionService{
        sessionRepo: sessionRepo,
    }
}

// CreateSession åˆ›å»ºä¼šè¯è¯·æ±‚
type CreateSessionRequest struct {
    Name         string                 `json:"name" binding:"required"`
    CreatorID    string                 `json:"creator_id" binding:"required"`
    MCPServerURL string                 `json:"mcp_server_url" binding:"required,url"`
    MaxPlayers   int                    `json:"max_players"`
    Settings     map[string]interface{} `json:"settings"`
}

// CreateSession åˆ›å»ºä¼šè¯
func (s *SessionService) CreateSession(ctx context.Context, req *CreateSessionRequest) (*models.Session, error) {
    // å‚æ•°éªŒè¯
    if req.MaxPlayers < 1 || req.MaxPlayers > 10 {
        return nil, errors.ErrInvalidMaxPlayers
    }

    // é»˜è®¤å€¼
    if req.MaxPlayers == 0 {
        req.MaxPlayers = 4
    }

    // ç”Ÿæˆä¼šè¯
    sessionID := uuid.New().String()
    wsKey := s.generateWebSocketKey()

    session := &models.Session{
        ID:           sessionID,
        Name:         req.Name,
        CreatorID:    req.CreatorID,
        MCPServerURL: req.MCPServerURL,
        WebSocketKey: wsKey,
        MaxPlayers:   req.MaxPlayers,
        Settings:     req.Settings,
        CreatedAt:    time.Now(),
        UpdatedAt:    time.Now(),
        Status:       "active",
    }

    // ä¿å­˜åˆ°å­˜å‚¨
    if err := s.sessionRepo.Create(ctx, session); err != nil {
        return nil, fmt.Errorf("åˆ›å»ºä¼šè¯å¤±è´¥: %w", err)
    }

    return session, nil
}

// GetSession è·å–ä¼šè¯è¯¦æƒ…
func (s *SessionService) GetSession(ctx context.Context, sessionID string) (*models.Session, error) {
    session, err := s.sessionRepo.Get(ctx, sessionID)
    if err != nil {
        return nil, err
    }
    return session, nil
}

// ListSessions åˆ—å‡ºæ‰€æœ‰ä¼šè¯
func (s *SessionService) ListSessions(ctx context.Context, status string) ([]*models.Session, error) {
    sessions, err := s.sessionRepo.List(ctx)
    if err != nil {
        return nil, err
    }

    // è¿‡æ»¤çŠ¶æ€
    if status != "" && status != "all" {
        var filtered []*models.Session
        for _, session := range sessions {
            if session.Status == status {
                filtered = append(filtered, session)
            }
        }
        return filtered, nil
    }

    return sessions, nil
}

// UpdateSessionRequest æ›´æ–°ä¼šè¯è¯·æ±‚
type UpdateSessionRequest struct {
    Name       *string
    MaxPlayers *int
    Settings   map[string]interface{}
}

// UpdateSession æ›´æ–°ä¼šè¯
func (s *SessionService) UpdateSession(ctx context.Context, sessionID string, req *UpdateSessionRequest) (*models.Session, error) {
    // è·å–ç°æœ‰ä¼šè¯
    session, err := s.sessionRepo.Get(ctx, sessionID)
    if err != nil {
        return nil, err
    }

    // éƒ¨åˆ†æ›´æ–°
    if req.Name != nil {
        session.Name = *req.Name
    }
    if req.MaxPlayers != nil {
        if *req.MaxPlayers < 1 || *req.MaxPlayers > 10 {
            return nil, errors.ErrInvalidMaxPlayers
        }
        session.MaxPlayers = *req.MaxPlayers
    }
    if req.Settings != nil {
        session.Settings = req.Settings
    }
    session.UpdatedAt = time.Now()

    // ä¿å­˜æ›´æ–°
    if err := s.sessionRepo.Update(ctx, session); err != nil {
        return nil, fmt.Errorf("æ›´æ–°ä¼šè¯å¤±è´¥: %w", err)
    }

    return session, nil
}

// DeleteSession åˆ é™¤ä¼šè¯
func (s *SessionService) DeleteSession(ctx context.Context, sessionID string) error {
    // æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨
    _, err := s.sessionRepo.Get(ctx, sessionID)
    if err != nil {
        return err
    }

    // è½¯åˆ é™¤
    if err := s.sessionRepo.Delete(ctx, sessionID); err != nil {
        return fmt.Errorf("åˆ é™¤ä¼šè¯å¤±è´¥: %w", err)
    }

    return nil
}

// generateWebSocketKey ç”Ÿæˆ WebSocket å¯†é’¥
func (s *SessionService) generateWebSocketKey() string {
    return "ws-" + uuid.New().String()
}
```

#### ä¸šåŠ¡é€»è¾‘è¯´æ˜

Service å±‚è´Ÿè´£:
1. **å‚æ•°éªŒè¯**: ä¸šåŠ¡è§„åˆ™æ ¡éªŒï¼ˆå¦‚ max_players èŒƒå›´ï¼‰
2. **é»˜è®¤å€¼å¤„ç†**: è®¾ç½®åˆç†çš„é»˜è®¤å€¼
3. **UUID ç”Ÿæˆ**: ç”Ÿæˆä¼šè¯IDå’Œ WebSocket Key
4. **æ•°æ®ç»„è£…**: æ„å»ºé¢†åŸŸæ¨¡å‹
5. **é”™è¯¯è½¬æ¢**: å°†åº•å±‚é”™è¯¯è½¬æ¢ä¸ºä¸šåŠ¡é”™è¯¯

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/service/session.go` - SessionService å®ç°
- [ ] `pkg/errors/errors.go` - é”™è¯¯å®šä¹‰æ‰©å±•

---

### éœ€æ±‚ 3.4ï¼šHandler å±‚å®ç°

#### éœ€æ±‚æè¿°

å®ç° HTTP Handler,è´Ÿè´£è¯·æ±‚è§£æã€å‚æ•°éªŒè¯ã€å“åº”æ ¼å¼åŒ–ã€‚

#### Handler å®ç°

```go
// internal/api/handler/session.go

package handler

import (
    "net/http"

    "github.com/gin-gonic/gin"
    "dnd-client/internal/service"
)

// SessionResponse ä¼šè¯å“åº”
type SessionResponse struct {
    ID           string                 `json:"id"`
    Name         string                 `json:"name"`
    CreatorID    string                 `json:"creator_id"`
    MCPServerURL string                 `json:"mcp_server_url"`
    WebSocketKey string                 `json:"websocket_key"`
    MaxPlayers   int                    `json:"max_players"`
    Settings     map[string]interface{} `json:"settings"`
    CreatedAt    string                 `json:"created_at"`
    UpdatedAt    string                 `json:"updated_at"`
    Status       string                 `json:"status"`
}

// ErrorResponse é”™è¯¯å“åº”ï¼ˆä¿®æ­£ç‰ˆï¼‰
type ErrorResponse struct {
    Error struct {
        Code      string                 `json:"code"`
        Message   string                 `json:"message"`
        Details   map[string]interface{} `json:"details"` // æ”¹ä¸ºå¯¹è±¡ç±»å‹
        Timestamp string                 `json:"timestamp"`
        RequestID string                 `json:"request_id,omitempty"`
    } `json:"error"`
}

// CreateSession åˆ›å»ºä¼šè¯ Handler
func CreateSession(sessionService *service.SessionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req service.CreateSessionRequest

        // å‚æ•°ç»‘å®šå’ŒéªŒè¯
        if err := c.ShouldBindJSON(&req); err != nil {
            c.JSON(http.StatusBadRequest, gin.H{
                "error": gin.H{
                    "code":    "INVALID_REQUEST",
                    "message": "è¯·æ±‚å‚æ•°é”™è¯¯",
                    "details": gin.H{"fields": err.Error()}, // ä¿®æ­£: æ”¹ä¸ºå¯¹è±¡
                },
            })
            return
        }

        // è°ƒç”¨ Service
        session, err := sessionService.CreateSession(c.Request.Context(), &req)
        if err != nil {
            // é”™è¯¯å¤„ç†
            handleError(c, err)
            return
        }

        // è¿”å› 201 Created
        c.JSON(http.StatusCreated, toSessionResponse(session))
    }
}

// GetSession è·å–ä¼šè¯è¯¦æƒ… Handler
func GetSession(sessionService *service.SessionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        sessionID := c.Param("id")

        session, err := sessionService.GetSession(c.Request.Context(), sessionID)
        if err != nil {
            handleError(c, err)
            return
        }

        c.JSON(http.StatusOK, toSessionResponse(session))
    }
}

// ListSessions åˆ—å‡ºæ‰€æœ‰ä¼šè¯ Handler
func ListSessions(sessionService *service.SessionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // è·å–æŸ¥è¯¢å‚æ•°
        status := c.DefaultQuery("status", "active")

        sessions, err := sessionService.ListSessions(c.Request.Context(), status)
        if err != nil {
            handleError(c, err)
            return
        }

        // è½¬æ¢ä¸ºå“åº”æ ¼å¼
        response := make([]SessionResponse, len(sessions))
        for i, session := range sessions {
            response[i] = toSessionResponse(session)
        }

        c.JSON(http.StatusOK, response)
    }
}

// UpdateSession æ›´æ–°ä¼šè¯ Handler
func UpdateSession(sessionService *service.SessionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        sessionID := c.Param("id")

        var req service.UpdateSessionRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            c.JSON(http.StatusBadRequest, gin.H{
                "error": gin.H{
                    "code":    "INVALID_REQUEST",
                    "message": "è¯·æ±‚å‚æ•°é”™è¯¯",
                    "details": gin.H{"fields": err.Error()},
                },
            })
            return
        }

        session, err := sessionService.UpdateSession(c.Request.Context(), sessionID, &req)
        if err != nil {
            handleError(c, err)
            return
        }

        c.JSON(http.StatusOK, toSessionResponse(session))
    }
}

// DeleteSession åˆ é™¤ä¼šè¯ Handler
func DeleteSession(sessionService *service.SessionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        sessionID := c.Param("id")

        if err := sessionService.DeleteSession(c.Request.Context(), sessionID); err != nil {
            handleError(c, err)
            return
        }

        c.Status(http.StatusNoContent)
    }
}

// handleError ç»Ÿä¸€é”™è¯¯å¤„ç†
func handleError(c *gin.Context, err error) {
    // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ä¸åŒçš„ HTTP çŠ¶æ€ç 
    switch {
    case errors.Is(err, errors.ErrSessionNotFound):
        c.JSON(http.StatusNotFound, gin.H{
            "error": gin.H{
                "code":    "SESSION_NOT_FOUND",
                "message": "ä¼šè¯ä¸å­˜åœ¨",
                "details": gin.H{}, // ç©ºå¯¹è±¡
            },
        })
    case errors.Is(err, errors.ErrInvalidMaxPlayers):
        c.JSON(http.StatusBadRequest, gin.H{
            "error": gin.H{
                "code":    "INVALID_MAX_PLAYERS",
                "message": "max_players å¿…é¡»åœ¨ 1-10 ä¹‹é—´",
                "details": gin.H{},
            },
        })
    default:
        c.JSON(http.StatusInternalServerError, gin.H{
            "error": gin.H{
                "code":    "INTERNAL_ERROR",
                "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
                "details": gin.H{},
            },
        })
    }
}

// toSessionResponse è½¬æ¢ä¸ºå“åº”æ ¼å¼
func toSessionResponse(session *models.Session) SessionResponse {
    return SessionResponse{
        ID:           session.ID,
        Name:         session.Name,
        CreatorID:    session.CreatorID,
        MCPServerURL: session.MCPServerURL,
        WebSocketKey: session.WebSocketKey,
        MaxPlayers:   session.MaxPlayers,
        Settings:     session.Settings,
        CreatedAt:    session.CreatedAt.Format(time.RFC3339),
        UpdatedAt:    session.UpdatedAt.Format(time.RFC3339),
        Status:       session.Status,
    }
}
```

#### ä¿®æ­£è¯´æ˜

1. **é”™è¯¯å“åº”æ ¼å¼**: `details` å­—æ®µæ”¹ä¸º `map[string]interface{}` (å¯¹è±¡ç±»å‹)
2. **ä¾èµ–æ³¨å…¥**: Handler ä¾èµ– Service,è€Œéç›´æ¥ä¾èµ– Store
3. **èŒè´£åˆ†ç¦»**: Handler åªè´Ÿè´£ HTTP å±‚é€»è¾‘,ä¸šåŠ¡é€»è¾‘åœ¨ Service

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/api/handler/session.go` - ä¼šè¯ Handler

---

### éœ€æ±‚ 3.5ï¼šStore å±‚å®ç° Repository æ¥å£

#### éœ€æ±‚æè¿°

ç¡®ä¿ Redis Store å®ç° Repository æ¥å£ã€‚

#### å®ç°è¯´æ˜

ä»»åŠ¡ä¸€çš„ Redis Store å·²ç»å®ç°äº†æ‰€æœ‰éœ€è¦çš„æ–¹æ³•,åªéœ€è¦ç¡®ä¿å®ƒå®ç°äº† Repository æ¥å£:

```go
// internal/store/redis/session.go

package redis

import (
    "context"
    "fmt"
    "time"

    "github.com/redis/go-redis/v9"
    "dnd-client/internal/models"
    "dnd-client/internal/repository" // å¯¼å…¥ repository æ¥å£
)

// ç¡®ä¿ RedisSessionStore å®ç°äº† SessionRepository æ¥å£
var _ repository.SessionRepository = (*RedisSessionStore)(nil)

// RedisSessionStore Redis ä¼šè¯å­˜å‚¨å®ç°
type RedisSessionStore struct {
    client *redis.Client
}

// NewSessionStore åˆ›å»º Redis ä¼šè¯å­˜å‚¨
func NewSessionStore(client *redis.Client) repository.SessionRepository {
    return &RedisSessionStore{client: client}
}

// Create åˆ›å»ºä¼šè¯
func (s *RedisSessionStore) Create(ctx context.Context, session *models.Session) error {
    // ... å®ç°ä»£ç ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰
}

// Get è·å–ä¼šè¯
func (s *RedisSessionStore) Get(ctx context.Context, id string) (*models.Session, error) {
    // ... å®ç°ä»£ç ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰
}

// List åˆ—å‡ºæ‰€æœ‰ä¼šè¯
func (s *RedisSessionStore) List(ctx context.Context) ([]*models.Session, error) {
    // ... å®ç°ä»£ç ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰
}

// Update æ›´æ–°ä¼šè¯
func (s *RedisSessionStore) Update(ctx context.Context, session *models.Session) error {
    // ... å®ç°ä»£ç ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰
}

// Delete åˆ é™¤ä¼šè¯ï¼ˆè½¯åˆ é™¤ï¼‰
func (s *RedisSessionStore) Delete(ctx context.Context, id string) error {
    // ... å®ç°ä»£ç ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰
}
```

#### å…³é”®ä¿®æ”¹ç‚¹

1. **å¯¼å…¥ repository åŒ…**: `import "dnd-client/internal/repository"`
2. **ç¼–è¯‘æ—¶æ£€æŸ¥**: `var _ repository.SessionRepository = (*RedisSessionStore)(nil)`
3. **è¿”å›æ¥å£ç±»å‹**: `NewSessionStore` è¿”å› `repository.SessionRepository` è€Œéå…·ä½“ç±»å‹

#### æ–‡ä»¶æ¸…å•

- [x] `internal/store/redis/session.go` - ä¿®æ”¹ä¸ºå®ç° Repository æ¥å£

---

### éœ€æ±‚ 3.6ï¼šä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–

#### éœ€æ±‚æè¿°

ä¿®æ”¹ CLI å‘½ä»¤,å®Œæˆä¾èµ–æ³¨å…¥åˆå§‹åŒ–ã€‚

#### CLI å‘½ä»¤å®ç°

```go
// internal/cli/server.go

package cli

import (
    "os"
    "os/signal"
    "syscall"

    "github.com/redis/go-redis/v9"
    "github.com/spf13/cobra"
    "dnd-client/internal/api"
    "dnd-client/internal/repository"
    "dnd-client/internal/service"
    "dnd-client/internal/store/redis"
    "dnd-client/pkg/config"
    "dnd-client/pkg/logger"
)

// serverCmd å¯åŠ¨ HTTP æœåŠ¡å™¨
var serverCmd = &cobra.Command{
    Use:   "server",
    Short: "å¯åŠ¨ HTTP æœåŠ¡å™¨",
    Long:  `å¯åŠ¨ HTTP API æœåŠ¡å™¨`,
    RunE: func(cmd *cobra.Command, args []string) error {
        // 1. åŠ è½½é…ç½®
        cfg, err := config.Load()
        if err != nil {
            return err
        }

        // 2. åˆå§‹åŒ–æ—¥å¿—
        if err := logger.Init(cfg.Log); err != nil {
            return err
        }

        // 3. åˆå§‹åŒ– Redis Client
        redisClient := redis.NewClient(&redis.Options{
            Addr:     cfg.Redis.Host,
            Password: cfg.Redis.Password,
            DB:       cfg.Redis.DB,
        })
        defer redisClient.Close()

        // 4. åˆå§‹åŒ– Store å±‚ï¼ˆå®ç° Repository æ¥å£ï¼‰
        var sessionRepo repository.SessionRepository = redisstore.NewSessionStore(redisClient)

        // 5. åˆå§‹åŒ– Service å±‚
        sessionService := service.NewSessionService(sessionRepo)

        // 6. åˆ›å»º HTTP æœåŠ¡å™¨
        server := api.NewServer(cfg, sessionService)

        // 7. å¯åŠ¨æœåŠ¡å™¨ï¼ˆåå°ï¼‰
        go func() {
            if err := server.Start(); err != nil {
                logger.Fatal("HTTP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥", "error", err)
            }
        }()

        logger.Info("HTTP æœåŠ¡å™¨å·²å¯åŠ¨", "addr", fmt.Sprintf("%s:%d", cfg.HTTP.Host, cfg.HTTP.Port))

        // 8. ç­‰å¾…é€€å‡ºä¿¡å·
        quit := make(chan os.Signal, 1)
        signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
        <-quit

        logger.Info("æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­...")

        // 9. ä¼˜é›…å…³é—­ HTTP æœåŠ¡å™¨
        ctx := cmd.Context()
        if err := server.Shutdown(ctx); err != nil {
            logger.Error("HTTP æœåŠ¡å™¨å…³é—­å¤±è´¥", "error", err)
        }

        return nil
    },
}

func init() {
    rootCmd.AddCommand(serverCmd)
}
```

#### ä¾èµ–æ³¨å…¥æµç¨‹

```
1. Redis Client (åŸºç¡€è®¾æ–½)
   â†“
2. SessionStore (å®ç° Repository æ¥å£)
   â†“
3. SessionService (ä¾èµ– Repository æ¥å£)
   â†“
4. HTTP Server (ä¾èµ– Service)
```

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/cli/server.go` - server å‘½ä»¤

---

## å­—æ®µè¯´æ˜

### current_players å’Œ message_count

æ ¹æ®è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼Œè¿™ä¸¤ä¸ªå­—æ®µåœ¨ä¼šè¯åˆ—è¡¨å’Œè¯¦æƒ…å“åº”ä¸­å‡ºç°ï¼š

```json
{
  "id": "session-uuid-1",
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  "current_players": 3,    // å½“å‰ç©å®¶æ•°
  "message_count": 120,     // æ¶ˆæ¯æ€»æ•°
  ...
}
```

#### å®ç°æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šæš‚ä¸å®ç°ï¼ˆæ¨èï¼‰**
- åœ¨ä»»åŠ¡ä¸‰ä¸­ï¼Œè¿™ä¸¤ä¸ªå­—æ®µæš‚æ—¶è¿”å› 0 æˆ– null
- æ·»åŠ æ³¨é‡Šè¯´æ˜è¿™æ˜¯"é¢„ç•™å­—æ®µ"
- åœ¨åç»­ä»»åŠ¡ï¼ˆæ¶ˆæ¯ç®¡ç†ï¼‰ä¸­å®ç°

**æ–¹æ¡ˆBï¼šå®æ—¶è®¡ç®—**
- `current_players`: ä» WebSocket è¿æ¥æ•°è·å–
- `message_count`: ä» Redis ZCARD è·å–
- ç¼ºç‚¹ï¼šå¢åŠ  API å“åº”æ—¶é—´

#### å»ºè®®

```go
// toSessionResponse è½¬æ¢ä¸ºå“åº”æ ¼å¼
func toSessionResponse(session *models.Session) SessionResponse {
    return SessionResponse{
        ID:           session.ID,
        Name:         session.Name,
        // ...
        CurrentPlayers: 0,  // TODO: ä»»åŠ¡ä¸‰æš‚ä¸å®ç°ï¼Œåç»­ä»»åŠ¡å®Œæˆ
        MessageCount:   0,  // TODO: ä»»åŠ¡ä¸‰æš‚ä¸å®ç°ï¼Œåç»­ä»»åŠ¡å®Œæˆ
    }
}
```

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  E2E Tests (tests/e2e/)            â”‚  â† çœŸå® HTTP æœåŠ¡å™¨
â”‚  â€¢ å®Œæ•´çš„ API æµ‹è¯•                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Integration Tests (tests/integration/) â”‚  â† httptest
â”‚  â€¢ Handler æµ‹è¯•                     â”‚
â”‚  â€¢ Service æµ‹è¯•                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Unit Tests (tests/unit/)          â”‚  â† Mock
â”‚  â€¢ Service é€»è¾‘æµ‹è¯•                 â”‚
â”‚  â€¢ Repository Mock æµ‹è¯•             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service å±‚å•å…ƒæµ‹è¯•

```go
// tests/unit/service/session_test.go

package service_test

import (
    "context"
    "testing"

    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"

    "dnd-client/internal/models"
    "dnd-client/internal/service"
    // Mock å®šä¹‰
)

// MockSessionRepository Mock Repository
type MockSessionRepository struct {
    mock.Mock
}

func (m *MockSessionRepository) Create(ctx context.Context, session *models.Session) error {
    args := m.Called(ctx, session)
    return args.Error(0)
}

func (m *MockSessionRepository) Get(ctx context.Context, id string) (*models.Session, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*models.Session), args.Error(1)
}

func (m *MockSessionRepository) List(ctx context.Context) ([]*models.Session, error) {
    args := m.Called(ctx)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).([]*models.Session), args.Error(1)
}

func (m *MockSessionRepository) Update(ctx context.Context, session *models.Session) error {
    args := m.Called(ctx, session)
    return args.Error(0)
}

func (m *MockSessionRepository) Delete(ctx context.Context, id string) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}

func TestSessionService_CreateSession(t *testing.T) {
    // åˆ›å»º Mock
    mockRepo := new(MockSessionRepository)
    service := service.NewSessionService(mockRepo)

    // è®¾ç½® Mock æœŸæœ›
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.Session")).Return(nil)

    // æµ‹è¯•
    req := &service.CreateSessionRequest{
        Name:         "æµ‹è¯•ä¼šè¯",
        CreatorID:    "user-123",
        MCPServerURL: "http://localhost:9000",
        MaxPlayers:   5,
    }

    session, err := service.CreateSession(context.Background(), req)

    // æ–­è¨€
    assert.NoError(t, err)
    assert.NotNil(t, session)
    assert.Equal(t, "æµ‹è¯•ä¼šè¯", session.Name)
    assert.Equal(t, "user-123", session.CreatorID)

    // éªŒè¯ Mock è°ƒç”¨
    mockRepo.AssertExpectations(t)
}
```

### Handler å±‚é›†æˆæµ‹è¯•

```go
// tests/integration/api/session_test.go

package api_test

import (
    "net/http"
    "net/http/httptest"
    "strings"
    "testing"

    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"

    "dnd-client/internal/api/handler"
    "dnd-client/internal/service"
)

func TestCreateSession_Handler(t *testing.T) {
    // è®¾ç½® Gin æµ‹è¯•æ¨¡å¼
    gin.SetMode(gin.TestMode)

    // åˆ›å»ºæµ‹è¯• Routerï¼ˆéœ€è¦ Mock æˆ–çœŸå®ä¾èµ–ï¼‰
    // è¿™é‡Œä½¿ç”¨ Mock Service
    router := setupTestRouter()

    // æµ‹è¯•åˆ›å»ºä¼šè¯
    t.Run("åˆ›å»ºä¼šè¯æˆåŠŸ", func(t *testing.T) {
        reqBody := `{
            "name": "æµ‹è¯•ä¼šè¯",
            "creator_id": "user-123",
            "mcp_server_url": "http://localhost:9000",
            "max_players": 5
        }`

        req := httptest.NewRequest("POST", "/api/sessions", strings.NewReader(reqBody))
        req.Header.Set("Content-Type", "application/json")
        w := httptest.NewRecorder()

        router.ServeHTTP(w, req)

        assert.Equal(t, http.StatusCreated, w.Code)
        // æ›´å¤šæ–­è¨€...
    })
}
```

---

## éªŒæ”¶æ£€æŸ¥æ¸…å•ï¼ˆä¿®è®¢ç‰ˆï¼‰

### æ¶æ„ä¸€è‡´æ€§ âœ…

- [ ] Handler â†’ Service â†’ Repository â†’ Store ä¾èµ–å±‚æ¬¡æ¸…æ™°
- [ ] Repository æ¥å£åœ¨ `internal/repository` åŒ…ä¸­å®šä¹‰
- [ ] Store å®ç° Repository æ¥å£
- [ ] æ¥å£éµå¾ªå°æ¥å£åŸåˆ™ï¼ˆ1-3 ä¸ªæ–¹æ³•ï¼‰
- [ ] é”™è¯¯å“åº”æ ¼å¼ `details` å­—æ®µä¸ºå¯¹è±¡ç±»å‹

### ä»£ç è´¨é‡

- [ ] æ‰€æœ‰ä»£ç ç¬¦åˆ `doc/è§„èŒƒ.md` è¦æ±‚
- [ ] ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–
- [ ] ä½¿ç”¨ `go vet` æ£€æŸ¥
- [ ] ä½¿ç”¨ `golint` æ£€æŸ¥
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] å¤ç”¨ä»»åŠ¡ä¸€çš„æ¨¡å‹å’Œ storeï¼ˆä½†è°ƒæ•´ä¸ºå®ç°æ¥å£ï¼‰

### ç›®å½•ç»“æ„

- [ ] API ä»£ç åœ¨ `internal/api/` ç›®å½•
- [ ] Repository æ¥å£åœ¨ `internal/repository/` ç›®å½•
- [ ] Service ä»£ç åœ¨ `internal/service/` ç›®å½•
- [ ] æµ‹è¯•æ–‡ä»¶åœ¨ `tests/` ç›®å½•
- [ ] äºŒè¿›åˆ¶è¾“å‡ºåˆ° `bin/` ç›®å½•

### ä¾èµ–å…³ç³»

- [ ] Handler ä¾èµ– Serviceï¼ˆä¸ç›´æ¥ä¾èµ– Storeï¼‰
- [ ] Service ä¾èµ– Repository æ¥å£ï¼ˆä¸ä¾èµ–å…·ä½“å®ç°ï¼‰
- [ ] Store å®ç° Repository æ¥å£
- [ ] models ä¸ä¾èµ–ä»»ä½•å…¶ä»–åŒ…
- [ ] å•å‘ä¾èµ–ï¼Œæ— å¾ªç¯ä¾èµ–

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] HTTP æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- [ ] åˆ›å»ºä¼šè¯ API æ­£å¸¸
- [ ] è·å–ä¼šè¯è¯¦æƒ… API æ­£å¸¸
- [ ] åˆ—å‡ºä¼šè¯ API æ­£å¸¸
- [ ] æ›´æ–°ä¼šè¯ API æ­£å¸¸
- [ ] åˆ é™¤ä¼šè¯ API æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

### HTTP è§„èŒƒ

- [ ] çŠ¶æ€ç æ­£ç¡®ï¼ˆ201, 200, 204, 400, 404, 500ï¼‰
- [ ] å“åº”æ ¼å¼ç¬¦åˆè§„èŒƒ
- [ ] é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€ï¼ˆdetails ä¸ºå¯¹è±¡ï¼‰
- [ ] æ—¶é—´æ ¼å¼ç»Ÿä¸€ä½¿ç”¨ RFC3339
- [ ] å‚æ•°éªŒè¯å®Œæ•´

### æµ‹è¯•å®Œæ•´æ€§

- [ ] Service å±‚å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] Handler å±‚é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] E2E æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æµ‹è¯•å¯ä»¥ç‹¬ç«‹è¿è¡Œ

### æ€§èƒ½è¦æ±‚

- [ ] API å“åº”æ—¶é—´ < 10msï¼ˆä¸å« Redisï¼‰
- [ ] å¹¶å‘æ”¯æŒ 100 req/s
- [ ] å†…å­˜ä½¿ç”¨åˆç†

---

## å‚è€ƒèµ„æ–™

- `doc/è§„èŒƒ.md` - **ä»£ç è§„èŒƒï¼ˆæœ€é‡è¦ï¼‰**
- `doc/DND_MCP_Clientè¯¦ç»†è®¾è®¡.md` - **è¯¦ç»†è®¾è®¡ï¼ˆæ¶æ„æƒå¨ï¼‰**
- `doc/DND_MCP_Client_å¼€å‘è®¡åˆ’.md` - å¼€å‘è®¡åˆ’
- `doc/å¼€å‘ä»»åŠ¡ä¸€.md` - ä»»åŠ¡ä¸€æ–‡æ¡£
- `doc/å¼€å‘ä»»åŠ¡äºŒ.md` - ä»»åŠ¡äºŒæ–‡æ¡£
- https://gin-gonic.com/docs/ - Gin æ–‡æ¡£
- https://pkg.go.dev/net/http/httptest - httptest æ–‡æ¡£

---

## é™„å½•ï¼šæ¶æ„å¯¹æ¯”

### ä¿®è®¢å‰ vs ä¿®è®¢å

#### ä¿®è®¢å‰ï¼ˆåˆç¨¿ï¼‰

```
Handler
  â†“
Store (å…·ä½“å®ç°)
  â†“
Models
```

**é—®é¢˜**:
- âŒ ç¼ºå°‘ Service å±‚ï¼Œä¸šåŠ¡é€»è¾‘æ•£è½åœ¨ Handler
- âŒ ç¼ºå°‘ Repository æŠ½è±¡ï¼ŒHandler ç›´æ¥ä¾èµ– Store
- âŒ è¿åä¾èµ–å€’ç½®åŸåˆ™

#### ä¿®è®¢åï¼ˆä¸è®¾è®¡ä¸€è‡´ï¼‰

```
Handler (HTTP å±‚)
  â†“
Service (ä¸šåŠ¡é€»è¾‘å±‚)
  â†“
Repository (æ•°æ®è®¿é—®æ¥å£)
  â†“
Store (å­˜å‚¨å®ç°)
  â†“
Models (é¢†åŸŸæ¨¡å‹)
```

**ä¼˜åŠ¿**:
- âœ… å±‚æ¬¡æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
- âœ… éµå¾ªä¾èµ–å€’ç½®åŸåˆ™
- âœ… æ˜“äºæµ‹è¯•å’Œæ‰©å±•
- âœ… ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£å®Œå…¨ä¸€è‡´

---

## æ€»ç»“

æœ¬ä¿®è®¢ç‰ˆä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜:

1. **âœ… æ¶æ„ä¸€è‡´æ€§**: æ·»åŠ  Repository å’Œ Service å±‚ï¼Œä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£å®Œå…¨ä¸€è‡´
2. **âœ… æ¥å£å®šä¹‰**: éµå¾ª"åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£"åŸåˆ™
3. **âœ… é”™è¯¯å“åº”**: ä¿®æ­£ `details` å­—æ®µä¸ºå¯¹è±¡ç±»å‹
4. **âœ… èŒè´£åˆ†ç¦»**: Handler åªè´Ÿè´£ HTTPï¼ŒService è´Ÿè´£ä¸šåŠ¡é€»è¾‘
5. **âœ… å¯æµ‹è¯•æ€§**: æ¯å±‚éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

éµå¾ªè¿™äº›è®¾è®¡åŸåˆ™,å¯ä»¥ç¡®ä¿ä»£ç è´¨é‡é«˜ã€æ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•ã€‚
