---
name: refactor
description: 分析代码与设计文档的差异，判断是否需要重构并生成重构计划。不为重构而重构，只在必要时才重构。
disable-model-invocation: true
allowed-tools: Read, Glob, Grep
argument-hint: [scope|模块路径]
---

# 代码重构分析

分析当前代码与设计文档的一致性，判断是否需要重构，并生成可执行的重构计划。

## 输入

**重构范围**: $ARGUMENTS

（可以是具体模块路径如 `internal/service`，或留空分析整个项目）

## 核心原则

1. **必要性优先** - 不为重构而重构，只在以下情况才建议重构：
   - 设计文档变更，代码未同步
   - 代码违反现有设计规范
   - 存在明显的技术债务
   - 影响可维护性或扩展性

2. **最小改动** - 每次重构只解决一个问题，避免大规模改动

3. **可验证** - 每个重构步骤都能通过测试验证

## 分析流程

### 第一步：收集信息

```
1. 读取设计文档
   - docs/系统详细设计.md
   - docs/整体架构设计.md
   - docs/代码规范.md
   - docs/开发计划-*.md（如有）

2. 读取当前代码实现
   - 根据输入范围扫描相关代码
   - 记录代码结构和实现方式

3. 对比分析
   - 设计 vs 实现的差异
   - 是否有之前的设计文档（通过 git history 或文档版本）
```

### 第二步：判断是否需要重构

```
分析结果分类：

A. 无需重构 ✓
   - 代码与设计一致
   - 代码质量符合规范
   - 无明显技术债务
   → 输出"无需重构"结论，结束

B. 需要重构 ⚠️
   - 发现设计偏差
   - 发现代码问题
   → 进入第三步，生成重构计划
```

### 第三步：确定重构规模

```
规模分级：

| 级别 | 名称 | 影响范围 | 风险 |
|------|------|----------|------|
| L1 | 提取/内联 | 单文件内 | 低 |
| L2 | 重命名/移动 | 跨文件，不改变接口 | 低 |
| L3 | 接口调整 | 修改接口签名 | 中 |
| L4 | 模块重构 | 重写模块内部结构 | 中 |
| L5 | 架构调整 | 改变模块边界和依赖 | 高 |
```

### 第四步：生成重构计划

参考 plan skill 的任务格式，但专用于重构场景。

## 重构计划模板

```markdown
# 重构计划: [重构主题]

## 1. 重构必要性分析

### 1.1 当前状态
- 设计文档描述: [设计要求]
- 当前代码实现: [实际状态]
- 差异点: [列出差异]

### 1.2 重构理由
| 问题 | 影响 | 紧急程度 |
|------|------|----------|
| [问题1] | [影响] | 高/中/低 |

### 1.3 不重构的后果
- [如果不重构会怎样]

---

## 2. 重构目标

### 2.1 期望状态
[描述重构后的期望状态]

### 2.2 成功标准
- [ ] 代码与设计文档一致
- [ ] 所有测试通过
- [ ] 无新增技术债务

### 2.3 约束条件
- 保持 API 兼容性: 是/否
- 数据迁移需求: 是/否
- 其他约束: [...]

---

## 3. 重构规模评估

| 维度 | 评估 |
|------|------|
| 规模级别 | L1-L5 |
| 影响文件数 | N 个 |
| 影响接口数 | N 个 |
| 测试覆盖 | 需要更新/无需更新 |
| 风险等级 | 低/中/高 |

---

## 4. 重构步骤

### Step 1: [步骤名称]

**目标**: [这一步要达成什么]

**操作**:
```
| 类型 | 文件 | 改动说明 |
|------|------|----------|
| 修改 | path/to/file.go | [具体改动] |
```

**验证**:
```bash
[验证命令]
```

**回滚方案**: [如果出错如何回滚]

---

### Step 2: [步骤名称]
...

---

## 5. 测试策略

### 5.1 测试范围
- 需要运行的测试: [测试路径]
- 需要新增的测试: [如有]

### 5.2 验证命令
```powershell
# 单元测试
go test -v ./tests/unit/...

# 集成测试
go test -v ./tests/integration/...

# 完整测试
.\scripts\test-all.ps1
```

---

## 6. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| [风险1] | 高/中/低 | 高/中/低 | [措施] |

---

## 7. 执行建议

### 7.1 前置准备
- [ ] 确保所有测试通过
- [ ] 创建备份分支
- [ ] 通知相关开发者

### 7.2 执行顺序
1. [步骤1] → 验证 → 提交
2. [步骤2] → 验证 → 提交
3. ...

### 7.3 提交信息格式
```
refactor([模块]): [简短描述]

- [具体改动1]
- [具体改动2]
```
```

## 无需重构的输出模板

```markdown
# 重构分析报告: [范围]

## 结论: 无需重构 ✓

### 分析过程

1. **设计文档检查**
   - 读取: [文档列表]
   - 关键设计: [核心设计要求]

2. **代码实现检查**
   - 扫描范围: [文件/目录]
   - 代码结构: [简要描述]

3. **一致性对比**
   | 设计要求 | 代码实现 | 状态 |
   |----------|----------|------|
   | [要求1] | [实现1] | ✓ 一致 |
   | [要求2] | [实现2] | ✓ 一致 |

### 代码质量评估

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 架构一致性 | ✓ | 符合 Handler→Service→Store 模式 |
| 命名规范 | ✓ | 符合代码规范 |
| 错误处理 | ✓ | 使用统一错误处理 |
| 测试覆盖 | ✓ | 覆盖率达标 |

### 潜在改进点（非必须）

这些是可选的优化建议，不影响当前功能：
- [改进点1] - 优先级: 低
- [改进点2] - 优先级: 低

---

**结论**: 当前代码与设计文档一致，无技术债务，无需重构。
```

## 分析检查清单

分析完成后，确认以下问题：

- [ ] 是否读取了最新的设计文档？
- [ ] 是否扫描了相关代码？
- [ ] 是否对比了设计与实现的差异？
- [ ] 是否判断了重构必要性？
- [ ] 如果需要重构，是否评估了规模和风险？

## 与其他 Skill 的关系

```
design → 高层次设计
   ↓
refine → 详细设计
   ↓
plan   → 开发计划
   ↓
[实现] → 按计划开发
   ↓
refactor → 代码重构分析 ← 当前
   ↓
test    → 测试验证
```

## 输出位置

- 需要重构: `docs/重构计划-[主题].md`
- 无需重构: 直接输出报告，不生成文件

---

**当前分析范围**: $ARGUMENTS

开始分析...
