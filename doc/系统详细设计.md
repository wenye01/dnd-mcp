# DND MCP Client è¯¦ç»†è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.1
- **åˆ›å»ºæ—¥æœŸ**: 2025-02-03
- **æ›´æ–°æ—¥æœŸ**: 2025-02-04
- **åŸºäº**: DND_MCP_æ¶æ„è®¾è®¡_æ–¹æ¡ˆBä¿®è®¢.md
- **è®¾è®¡èŒƒå›´**: MCP Client ç»„ä»¶è¯¦ç»†è®¾è®¡
- **ä¸»è¦æ›´æ–°**:
  - æ·»åŠ æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡ï¼ˆæ”¯æŒå¤šç§è§¦å‘ç­–ç•¥ï¼‰
  - ç®€åŒ– API è®¾è®¡ï¼ˆåˆ é™¤åˆ†é¡µã€æ’åºç­‰å¤æ‚å‚æ•°ï¼‰
  - **[2025-02-04] æ·»åŠ ç®€åŒ–æ¶æ„å®æ–½è¯´æ˜**

---

## âš ï¸ é‡è¦ï¼šç®€åŒ–æ¶æ„å®æ–½è¯´æ˜

### å®æ–½çŠ¶æ€

æœ¬æ–‡æ¡£å®šä¹‰äº†**å®Œæ•´çš„åˆ†å±‚æ¶æ„**ï¼ˆHandler â†’ Service â†’ Repository â†’ Store â†’ Modelsï¼‰ï¼Œä½œä¸ºç³»ç»Ÿçš„æ¶æ„è®¾è®¡ç›®æ ‡ã€‚

ç„¶è€Œï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼ˆä»»åŠ¡ä¸‰ã€å››ã€äº”ï¼‰ï¼Œä¸ºäº†**å¿«é€Ÿè¿­ä»£å’Œäº¤ä»˜å¯è¿è¡Œçš„ç³»ç»Ÿ**ï¼Œé‡‡ç”¨äº†**ç®€åŒ–çš„æ¶æ„å®ç°**ï¼ˆHandler â†’ Store â†’ Modelsï¼‰ã€‚

### æ¶æ„å¯¹æ¯”

#### è®¾è®¡æ–‡æ¡£å®šä¹‰çš„å®Œæ•´æ¶æ„ï¼ˆç›®æ ‡æ¶æ„ï¼‰

```
Handler (HTTP å¤„ç†å™¨)
  â†“
Service (ä¸šåŠ¡é€»è¾‘å±‚)
  â”œâ”€ SessionService
  â”œâ”€ ChatService
  â””â”€ OrchestratorService
  â†“
Repository (æ•°æ®è®¿é—®æ¥å£)
  â”œâ”€ SessionRepository
  â””â”€ MessageRepository
  â†“
Store (å­˜å‚¨å®ç°)
  â”œâ”€ RedisStore (ä¸»å­˜å‚¨)
  â””â”€ PostgresStore (å¤‡ä»½)
  â†“
Models (é¢†åŸŸæ¨¡å‹)
```

**ç›®å½•ç»“æ„**:
```
internal/
â”œâ”€â”€ api/handler/       # Handler å±‚
â”œâ”€â”€ service/           # Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ session.go
â”‚   â”œâ”€â”€ chat.go
â”‚   â””â”€â”€ orchestrator/
â”œâ”€â”€ repository/        # Repository æ¥å£å±‚
â”‚   â”œâ”€â”€ session.go
â”‚   â””â”€â”€ message.go
â”œâ”€â”€ store/             # Store å®ç°å±‚
â”‚   â”œâ”€â”€ redis/
â”‚   â””â”€â”€ postgres/
â””â”€â”€ models/            # é¢†åŸŸæ¨¡å‹
```

#### å½“å‰å®ç°çš„ç®€åŒ–æ¶æ„ï¼ˆå®é™…æ¶æ„ï¼‰

```
Handler (HTTP å¤„ç†å™¨ï¼ŒåŒ…å«éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘)
  â†“
Store (å­˜å‚¨å®ç°ï¼Œç›´æ¥è¢« Handler è°ƒç”¨)
  â”œâ”€ RedisStore
  â””â”€ PostgresStore
  â†“
Models (é¢†åŸŸæ¨¡å‹)
```

**ç›®å½•ç»“æ„**:
```
internal/
â”œâ”€â”€ api/handler/       # Handler å±‚ï¼ˆåŒ…å«ä¸šåŠ¡é€»è¾‘ï¼‰
â”œâ”€â”€ store/             # Store å®ç°å±‚
â”‚   â””â”€â”€ redis/
â””â”€â”€ models/            # é¢†åŸŸæ¨¡å‹
```

### å·®å¼‚è¯´æ˜

| å±‚æ¬¡ | è®¾è®¡æ–‡æ¡£è¦æ±‚ | å½“å‰å®ç°ï¼ˆä»»åŠ¡ä¸‰/å››/äº”ï¼‰ |
|------|-------------|----------------------|
| **Handler** | âœ… æœ‰ï¼Œåªè´Ÿè´£ HTTP å±‚ | âœ… æœ‰ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘ |
| **Service** | âœ… æœ‰ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘ | âŒ **ç¼ºå¤±** |
| **Repository** | âœ… æœ‰ï¼ŒæŠ½è±¡æ•°æ®è®¿é—® | âŒ **ç¼ºå¤±** |
| **Store** | âœ… æœ‰ï¼Œå®ç° Repository æ¥å£ | âœ… æœ‰ï¼Œç›´æ¥è¢« Handler è°ƒç”¨ |
| **Models** | âœ… æœ‰ï¼Œæœ€åº•å±‚ | âœ… æœ‰ï¼Œæœ€åº•å±‚ |

### ç®€åŒ–çš„åŸå› 

1. **å¿«é€Ÿè¿­ä»£**: ä¼˜å…ˆäº¤ä»˜åŠŸèƒ½ï¼Œå¿«é€ŸéªŒè¯éœ€æ±‚
2. **ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•**: å½“å‰é˜¶æ®µä¸šåŠ¡é€»è¾‘ä¸å¤æ‚
3. **å•ä¸€å­˜å‚¨å®ç°**: åªä½¿ç”¨ Redisï¼ŒRepository æŠ½è±¡ä»·å€¼æœ‰é™
4. **é™ä½å­¦ä¹ æ›²çº¿**: ç®€åŒ–æ¶æ„æ›´æ˜“äºç†è§£å’Œè°ƒè¯•

### é€‚ç”¨åœºæ™¯

#### å½“å‰ç®€åŒ–æ¶æ„é€‚ç”¨äº âœ…

- å¿«é€ŸåŸå‹å¼€å‘
- åŠŸèƒ½éªŒè¯å’Œæ¼”ç¤º
- ä¸ªäººé¡¹ç›®æˆ–å°å‹å›¢é˜Ÿ
- MVPï¼ˆæœ€å°å¯è¡Œäº§å“ï¼‰

#### å®Œæ•´æ¶æ„é€‚ç”¨äº ğŸ¯

- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- é•¿æœŸç»´æŠ¤çš„é¡¹ç›®
- å›¢é˜Ÿåä½œå¼€å‘
- éœ€è¦é«˜å¯ç»´æŠ¤æ€§
- å¤šç§å­˜å‚¨å®ç°

### æ”¹è¿›è®¡åˆ’

#### é˜¶æ®µ1ï¼šä¿æŒç°çŠ¶ï¼ˆå½“å‰ - ä»»åŠ¡äº”ï¼‰

- âœ… ä¿æŒç®€åŒ–æ¶æ„
- âœ… å®ŒæˆåŠŸèƒ½å®ç°
- âœ… åœ¨æ–‡æ¡£ä¸­è¯´æ˜ç®€åŒ–å†³ç­–

#### é˜¶æ®µ2ï¼šé€æ­¥è¡¥å……ï¼ˆä»»åŠ¡å…­/ä¸ƒï¼‰

- âš ï¸ è¯„ä¼°ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦
- âš ï¸ å¦‚æœ LLM/MCP é›†æˆåé€»è¾‘å˜å¤æ‚ï¼Œæ·»åŠ  Service å±‚
- âš ï¸ å¦‚æœéœ€è¦å¤šç§å­˜å‚¨ï¼Œæ·»åŠ  Repository æ¥å£

#### é˜¶æ®µ3ï¼šå®Œæ•´é‡æ„ï¼ˆç”Ÿäº§å‰ï¼Œå¯é€‰ï¼‰

- ğŸ¯ è¡¥å…… Service å±‚
- ğŸ¯ è¡¥å…… Repository æ¥å£å±‚
- ğŸ¯ ç¬¦åˆè®¾è®¡æ–‡æ¡£çš„å®Œæ•´æ¶æ„
- ğŸ¯ æé«˜å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§

**è¯¦ç»†è¯´æ˜**: å‚è§ `doc/æ¶æ„ç®€åŒ–è¯´æ˜.md`

---

## ä¸€ã€Client æ¶æ„æ¦‚è§ˆ

### 1.1 å®šä½ä¸èŒè´£

```
MCP Client = è½»é‡çº§æœ‰çŠ¶æ€åè°ƒå±‚

æ ¸å¿ƒèŒè´£ï¼š
  â”œâ”€ ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤ï¼‰
  â”œâ”€ å¯¹è¯æ¶ˆæ¯ç®¡ç†ï¼ˆå­˜å‚¨ã€æ£€ç´¢ã€ä¸Šä¸‹æ–‡æ„å»ºï¼‰
  â”œâ”€ AI å¯¹è¯ç¼–æ’ï¼ˆLLM è°ƒç”¨ã€å·¥å…·æ‰§è¡Œï¼‰
  â”œâ”€ å®æ—¶é€šä¿¡ï¼ˆWebSocket æ¨é€ï¼‰
  â”œâ”€ æ•°æ®æŒä¹…åŒ–ï¼ˆRedis â†’ PostgreSQL å®šæœŸå¤‡ä»½ï¼‰
  â””â”€ MCP Server åè°ƒï¼ˆå·¥å…·è°ƒç”¨ã€äº‹ä»¶è®¢é˜…ï¼‰

éèŒè´£ï¼š
  â””â”€ æ¸¸æˆçŠ¶æ€ç®¡ç†ï¼ˆç”± MCP Server è´Ÿè´£ï¼‰
```

### 1.2 æŠ€æœ¯æ ˆ

```
è¯­è¨€: Go 1.21+

æ ¸å¿ƒä¾èµ–ï¼š
  â”œâ”€ Web æ¡†æ¶: gin-gonic/gin (HTTP) + gorilla/websocket (WebSocket)
  â”œâ”€ æ•°æ®åº“:
  â”‚   â”œâ”€ Redis: go-redis/redis/v9 (ä¸»å­˜å‚¨)
  â”‚   â””â”€ PostgreSQL: jackc/pgx/v5 (å¤‡ä»½å­˜å‚¨)
  â”œâ”€ MCP åè®®: è‡ªå®šä¹‰ MCP Client SDK
  â”œâ”€ LLM é›†æˆ: openai/openai-go (æˆ–å…¼å®¹æ¥å£)
  â””â”€ é…ç½®ç®¡ç†: spf13/viper

å¼€å‘å·¥å…·ï¼š
  â”œâ”€ ä¾èµ–ç®¡ç†: go modules
  â”œâ”€ ä»£ç ç”Ÿæˆ: go generate (wire ä¾èµ–æ³¨å…¥)
  â””â”€ æµ‹è¯•: testing + testify
```

---

## äºŒã€æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 2.1 ç»„ä»¶æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HTTP Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Session API  â”‚  â”‚  Chat API    â”‚  â”‚  System API  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  SessionService                             â”‚â”‚
â”‚  â”‚   â€¢ CreateSession()                                         â”‚â”‚
â”‚  â”‚   â€¢ GetSession()                                            â”‚â”‚
â”‚  â”‚   â€¢ ListSessions()                                          â”‚â”‚
â”‚  â”‚   â€¢ DeleteSession()                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  ChatService                                â”‚â”‚
â”‚  â”‚   â€¢ SendMessage()                                           â”‚â”‚
â”‚  â”‚   â€¢ GetMessages()                                           â”‚â”‚
â”‚  â”‚   â€¢ StreamMessage() (SSE)                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  OrchestratorService                        â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚â”‚
â”‚  â”‚   â”‚ Context Builder  â”‚  â”‚ Tool Coordinator â”‚              â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚â”‚
â”‚  â”‚   â”‚ LLM Manager      â”‚  â”‚ Event Handler    â”‚              â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  Repository Interface                      â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚â”‚
â”‚  â”‚   â”‚SessionRepositoryâ”‚  â”‚MessageRepositoryâ”‚                â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  Store Implementation                       â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚â”‚
â”‚  â”‚   â”‚ Redis Store    â”‚  â”‚ Postgres Store â”‚                 â”‚â”‚
â”‚  â”‚   â”‚ (ä¸»å­˜å‚¨)        â”‚  â”‚  (å¤‡ä»½)        â”‚                 â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Infrastructure Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Redis Client â”‚  â”‚ PGX Client   â”‚  â”‚ MCP Client   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ LLM Client   â”‚  â”‚ WS Manager   â”‚  â”‚ Event Bus    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
dnd-client/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go                 # åº”ç”¨å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/                       # HTTP handlers
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.go
â”‚   â”‚   â”‚   â”œâ”€â”€ cors.go
â”‚   â”‚   â”‚   â””â”€â”€ logging.go
â”‚   â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.go
â”‚   â”‚   â”‚   â”œâ”€â”€ system.go
â”‚   â”‚   â”‚   â””â”€â”€ websocket.go
â”‚   â”‚   â””â”€â”€ router.go
â”‚   â”œâ”€â”€ service/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â”œâ”€â”€ chat.go
â”‚   â”‚   â””â”€â”€ orchestrator/
â”‚   â”‚       â”œâ”€â”€ context_builder.go
â”‚   â”‚       â”œâ”€â”€ llm_manager.go
â”‚   â”‚       â”œâ”€â”€ tool_coordinator.go
â”‚   â”‚       â””â”€â”€ event_handler.go
â”‚   â”œâ”€â”€ repository/                # æ•°æ®è®¿é—®æ¥å£
â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â””â”€â”€ message.go
â”‚   â”œâ”€â”€ store/                     # å­˜å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ redis/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.go
â”‚   â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â”‚   â”œâ”€â”€ message.go
â”‚   â”‚   â”‚   â””â”€â”€ system.go
â”‚   â”‚   â””â”€â”€ postgres/
â”‚   â”‚       â”œâ”€â”€ client.go
â”‚   â”‚       â”œâ”€â”€ session.go
â”‚   â”‚       â”œâ”€â”€ message.go
â”‚   â”‚       â””â”€â”€ migrations/
â”‚   â”œâ”€â”€ domain/                    # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â”œâ”€â”€ message.go
â”‚   â”‚   â””â”€â”€ events.go
â”‚   â”œâ”€â”€ mcp/                       # MCP åè®®é›†æˆ
â”‚   â”‚   â”œâ”€â”€ client.go
â”‚   â”‚   â”œâ”€â”€ tools.go
â”‚   â”‚   â””â”€â”€ transport.go
â”‚   â”œâ”€â”€ llm/                       # LLM é›†æˆ
â”‚   â”‚   â”œâ”€â”€ client.go
â”‚   â”‚   â”œâ”€â”€ openai.go
â”‚   â”‚   â””â”€â”€ types.go
â”‚   â”œâ”€â”€ ws/                        # WebSocket ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ manager.go
â”‚   â”‚   â”œâ”€â”€ hub.go
â”‚   â”‚   â””â”€â”€ connection.go
â”‚   â””â”€â”€ persistence/               # æŒä¹…åŒ–ç®¡ç†
â”‚       â”œâ”€â”€ manager.go
â”‚       â”œâ”€â”€ worker.go
â”‚       â””â”€â”€ trigger/                # è§¦å‘å™¨ç­–ç•¥
â”‚           â”œâ”€â”€ trigger.go          # è§¦å‘å™¨æ¥å£
â”‚           â”œâ”€â”€ time.go             # æ—¶é—´è§¦å‘å™¨
â”‚           â””â”€â”€ message.go          # æ¶ˆæ¯é‡è§¦å‘å™¨ï¼ˆé¢„ç•™ï¼‰
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ config/                    # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ logger/                    # æ—¥å¿—
â”‚   â”‚   â””â”€â”€ logger.go
â”‚   â””â”€â”€ errors/                    # é”™è¯¯å®šä¹‰
â”‚       â””â”€â”€ errors.go
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ config.dev.yaml
â”œâ”€â”€ deployments/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.sh
â”‚   â””â”€â”€ migrate.sh
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ README.md
```

---

## ä¸‰ã€æ‰§è¡Œæµç¨‹è®¾è®¡

### 3.1 ä¼šè¯åˆ›å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¼šè¯åˆ›å»ºæµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: POST /api/sessions

å‚ä¸è€…:
  Frontend â†’ Handler â†’ SessionService â†’ Repository â†’ Store â†’ MCP Server

æµç¨‹æ­¥éª¤:

1. æ¥æ”¶è¯·æ±‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Handler.CreateSession                                       â”‚
   â”‚   è¾“å…¥: {                                                   â”‚
   â”‚     "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",                                â”‚
   â”‚     "creator_id": "user-123",                               â”‚
   â”‚     "mcp_server_url": "http://localhost:8080",             â”‚
   â”‚     "settings": {                                           â”‚
   â”‚       "max_players": 5,                                     â”‚
   â”‚       "ruleset": "dnd5e"                                    â”‚
   â”‚     }                                                       â”‚
   â”‚   }                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
2. å‚æ•°éªŒè¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ éªŒè¯å¿…å¡«å­—æ®µ                                               â”‚
   â”‚ â€¢ éªŒè¯ MCP Server URL å¯è®¿é—®æ€§                               â”‚
   â”‚ â€¢ éªŒè¯ settings æ ¼å¼                                         â”‚
   â”‚ â€¢ ç”Ÿæˆ UUID (session_id)                                    â”‚
   â”‚ â€¢ ç”Ÿæˆ WebSocket Key                                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. è°ƒç”¨æœåŠ¡å±‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SessionService.CreateSession                                â”‚
   â”‚   session := &domain.Session{                               â”‚
   â”‚     ID:           uuid,                                    â”‚
   â”‚     Name:         req.Name,                                â”‚
   â”‚     CreatorID:    req.CreatorID,                           â”‚
   â”‚     MCPServerURL: req.MCPServerURL,                        â”‚
   â”‚     WebSocketKey: websocketKey,                            â”‚
   â”‚     CreatedAt:    time.Now(),                              â”‚
   â”‚   }                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. ä¿å­˜åˆ° Redis
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.CreateSession                                   â”‚
   â”‚   Pipeline:                                                 â”‚
   â”‚     HSET session:{uuid}                                    â”‚
   â”‚       id "uuid"                                            â”‚
   â”‚       name "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹"                                  â”‚
   â”‚       creator_id "user-123"                                â”‚
   â”‚       mcp_server_url "http://localhost:8080"               â”‚
   â”‚       websocket_key "ws-xxx"                                â”‚
   â”‚       created_at "2025-02-03T10:00:00Z"                    â”‚
   â”‚                                                              â”‚
   â”‚     SADD sessions:all {uuid}                               â”‚
   â”‚                                                              â”‚
   â”‚   EXEC                                                      â”‚
   â”‚   è€—æ—¶: <1ms                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. åˆå§‹åŒ– MCP Server è¿æ¥
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MCPClient.Initialize                                       â”‚
   â”‚   â€¢ è¿æ¥åˆ° MCP Server                                       â”‚
   â”‚   â€¢ æ‰§è¡Œ initialize æ¡æ‰‹                                     â”‚
   â”‚   â€¢ è®¢é˜… Server äº‹ä»¶                                         â”‚
   â”‚   â€¢ éªŒè¯è¿æ¥æˆåŠŸ                                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. è¿”å›å“åº”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Response:                                                   â”‚
   â”‚   {                                                         â”‚
   â”‚     "id": "uuid-xxx",                                       â”‚
   â”‚     "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",                                â”‚
   â”‚     "creator_id": "user-123",                               â”‚
   â”‚     "mcp_server_url": "http://localhost:8080",             â”‚
   â”‚     "websocket_key": "ws-xxx",                              â”‚
   â”‚     "created_at": "2025-02-03T10:00:00Z",                  â”‚
   â”‚     "status": "active"                                      â”‚
   â”‚   }                                                         â”‚
   â”‚   HTTP Status: 201 Created                                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
7. (åå°) æ ‡è®°éœ€è¦æŒä¹…åŒ–
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PersistenceManager.MarkDirty                                â”‚
   â”‚   â€¢ å°† session_id åŠ å…¥ dirty é˜Ÿåˆ—                            â”‚
   â”‚   â€¢ ç­‰å¾…ä¸‹ä¸€æ¬¡æŒä¹…åŒ–å‘¨æœŸ                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: ~50ms (ä¸»è¦æ˜¯ MCP Server è¿æ¥æ—¶é—´)
Redis æ“ä½œè€—æ—¶: <1ms
```

### 3.2 èŠå¤©å¯¹è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      èŠå¤©å¯¹è¯æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: POST /api/sessions/{id}/chat

å‚ä¸è€…:
  Frontend â†’ Handler â†’ ChatService â†’ Orchestrator â†’ LLM/MCP Server

æµç¨‹æ­¥éª¤:

1. æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Handler.SendMessage                                         â”‚
   â”‚   è¾“å…¥: {                                                   â”‚
   â”‚     "session_id": "uuid-xxx",                               â”‚
   â”‚     "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",                             â”‚
   â”‚     "player_id": "player-123",                              â”‚
   â”‚     "stream": false                                         â”‚
   â”‚   }                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MessageRepository.Save                                      â”‚
   â”‚   userMsg := &domain.Message{                               â”‚
   â”‚     ID:        newUUID(),                                  â”‚
   â”‚     SessionID: sessionID,                                  â”‚
   â”‚     Role:      "user",                                     â”‚
   â”‚     Content:   "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",                            â”‚
   â”‚     PlayerID:  "player-123",                               â”‚
   â”‚     CreatedAt: time.Now(),                                 â”‚
   â”‚   }                                                         â”‚
   â”‚   RedisStore.SaveMessage(userMsg)                          â”‚
   â”‚   æ“ä½œ: ZADD msg:{session_id} {timestamp} {json}           â”‚
   â”‚   è€—æ—¶: <1ms                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ContextBuilder.Build                                        â”‚
   â”‚   æ­¥éª¤:                                                     â”‚
   â”‚   a) ä» Redis åŠ è½½å†å²æ¶ˆæ¯                                   â”‚
   â”‚      ZREVRANGE msg:{session_id} 0 49                        â”‚
   â”‚      è·å–æœ€è¿‘ 50 æ¡æ¶ˆæ¯                                      â”‚
   â”‚      è€—æ—¶: <1ms                                             â”‚
   â”‚                                                              â”‚
   â”‚   b) ä» MCP Server è·å–æ¸¸æˆçŠ¶æ€æ‘˜è¦                           â”‚
   â”‚      MCPClient.GetSessionState(session_id)                  â”‚
   â”‚      è¿”å›: {                                                â”‚
   â”‚        "location": "å¹½æš—æ£®æ—",                               â”‚
   â”‚        "characters": ["å‹‡è€…A", "å“¥å¸ƒæ—"],                   â”‚
   â”‚        "game_time": "ç¬¬3å¤© 10:30"                           â”‚
   â”‚      }                                                      â”‚
   â”‚      è€—æ—¶: 10-50ms                                          â”‚
   â”‚                                                              â”‚
   â”‚   c) ç»„è£… LLM ä¸Šä¸‹æ–‡                                         â”‚
   â”‚      context := []llm.Message{                              â”‚
   â”‚        {                                                     â”‚
   â”‚          Role:    "system",                                â”‚
   â”‚          Content: systemPrompt + stateSummary,             â”‚
   â”‚        },                                                    â”‚
   â”‚        // å†å²æ¶ˆæ¯...                                        â”‚
   â”‚        {                                                     â”‚
   â”‚          Role:    "user",                                  â”‚
   â”‚          Content: "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",                         â”‚
   â”‚        },                                                    â”‚
   â”‚      }                                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. è°ƒç”¨ LLM
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LLMManager.ChatCompletion                                   â”‚
   â”‚   request := llm.ChatCompletionRequest{                     â”‚
   â”‚     Model:    "gpt-4",                                     â”‚
   â”‚     Messages: context,                                      â”‚
   â”‚     Tools:    availableTools,                               â”‚
   â”‚   }                                                         â”‚
   â”‚   response := llmClient.Chat(ctx, request)                 â”‚
   â”‚   è€—æ—¶: 1-3s                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. åˆ¤æ–­å“åº”ç±»å‹
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æƒ…å†µ A: æœ‰ tool_calls (éœ€è¦è°ƒç”¨å·¥å…·)                          â”‚
   â”‚                                                              â”‚
   â”‚   a) è½¬æ¢ä¸º MCP å·¥å…·è°ƒç”¨                                      â”‚
   â”‚      ToolCoordinator.ConvertToMCP(tool_calls)               â”‚
   â”‚      è½¬æ¢:                                                   â”‚
   â”‚        {                                                     â”‚
   â”‚          "name": "resolve_attack",                          â”‚
   â”‚          "arguments": {                                     â”‚
   â”‚            "attacker": "player-123",                        â”‚
   â”‚            "target": "goblin-1",                            â”‚
   â”‚            "attack_type": "melee"                           â”‚
   â”‚          }                                                   â”‚
   â”‚        }                                                     â”‚
   â”‚                                                              â”‚
   â”‚   b) è°ƒç”¨ MCP Server æ‰§è¡Œå·¥å…·                                 â”‚
   â”‚      MCPClient.CallTool(session_id, tool_name, args)        â”‚
   â”‚      è€—æ—¶: 10-100ms                                         â”‚
   â”‚                                                              â”‚
   â”‚   c) ä¿å­˜ tool æ¶ˆæ¯åˆ° Redis                                   â”‚
   â”‚      toolMsg := &domain.Message{                            â”‚
   â”‚        Role:      "tool",                                  â”‚
   â”‚        Content:   "",                                      â”‚
   â”‚        ToolCalls: tool_calls,                              â”‚
   â”‚      }                                                       â”‚
   â”‚      RedisStore.SaveMessage(toolMsg)                        â”‚
   â”‚                                                              â”‚
   â”‚   d) ä¿å­˜ tool å“åº”æ¶ˆæ¯åˆ° Redis                               â”‚
   â”‚      toolResponse := &domain.Message{                       â”‚
   â”‚        Role:      "tool",                                  â”‚
   â”‚        Content:   result,                                  â”‚
   â”‚      }                                                       â”‚
   â”‚      RedisStore.SaveMessage(toolResponse)                   â”‚
   â”‚                                                              â”‚
   â”‚   e) å›åˆ°æ­¥éª¤ 4 ç»§ç»­è°ƒç”¨ LLMï¼ˆå¸¦å·¥å…·ç»“æœï¼‰                     â”‚
   â”‚                                                              â”‚
   â”‚ æƒ…å†µ B: æ—  tool_calls (çº¯æ–‡æœ¬å“åº”)                            â”‚
   â”‚                                                              â”‚
   â”‚   ä¿å­˜åŠ©æ‰‹å“åº”åˆ° Redis                                       â”‚
   â”‚   assistantMsg := &domain.Message{                          â”‚
   â”‚     Role:    "assistant",                                  â”‚
   â”‚     Content: response.Content,                             â”‚
   â”‚   }                                                         â”‚
   â”‚   RedisStore.SaveMessage(assistantMsg)                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. è¿”å›å“åº”ç»™å‰ç«¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Response:                                                   â”‚
   â”‚   {                                                         â”‚
   â”‚     "id": "msg-uuid-xxx",                                   â”‚
   â”‚     "role": "assistant",                                   â”‚
   â”‚     "content": "ä½ å†²å‘å“¥å¸ƒæ—ï¼ŒæŒ¥èˆç€æ‰‹ä¸­çš„é•¿å‰‘...",          â”‚
   â”‚     "tool_calls": [...],                                   â”‚
   â”‚     "state_changes": {                                      â”‚
   â”‚       "combat": "active",                                  â”‚
   â”‚       "turn": "player-123"                                 â”‚
   â”‚     },                                                      â”‚
   â”‚     "created_at": "2025-02-03T10:05:30Z"                   â”‚
   â”‚   }                                                         â”‚
   â”‚   HTTP Status: 200 OK                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: ~2-5ç§’ (ä¸»è¦æ˜¯ LLM è°ƒç”¨)
æ•°æ®è®¿é—®è€—æ—¶: ~2ms (Redis + MCP Server)

å¤šè½®å·¥å…·è°ƒç”¨å¾ªç¯:
  ç”¨æˆ·æ¶ˆæ¯ â†’ LLM â†’ tool_1 â†’ Server â†’ LLM â†’ tool_2 â†’ Server â†’ LLM â†’ æœ€ç»ˆå“åº”
```

### 3.3 æ•°æ®æŒä¹…åŒ–æµç¨‹ï¼ˆåå°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®æŒä¹…åŒ–æµç¨‹ï¼ˆåå°ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: æŒä¹…åŒ–è§¦å‘å™¨ï¼ˆæ”¯æŒå¤šç§ç­–ç•¥ï¼‰

å½“å‰å®ç°: æ—¶é—´è§¦å‘å™¨ï¼ˆæ¯ 30 ç§’ï¼‰
é¢„ç•™æ‰©å±•: æ¶ˆæ¯é‡è§¦å‘å™¨ã€æ‰‹åŠ¨è§¦å‘å™¨ã€ç»„åˆè§¦å‘å™¨

è§¦å‘å™¨è®¾è®¡:

  interface PersistenceTrigger {
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘æŒä¹…åŒ–
    ShouldTrigger(ctx context.Context) (bool, error)
    // é‡ç½®è§¦å‘å™¨çŠ¶æ€
    Reset(ctx context.Context) error
  }

  å®ç°çš„è§¦å‘å™¨:
    â€¢ TimeTrigger: æ—¶é—´é—´éš”è§¦å‘ï¼ˆå½“å‰ä½¿ç”¨ï¼‰
      - é…ç½®: interval = 30s
      - é€»è¾‘: æ¯éš” 30 ç§’è§¦å‘ä¸€æ¬¡

    â€¢ MessageCountTrigger: æ¶ˆæ¯æ•°é‡è§¦å‘ï¼ˆé¢„ç•™ï¼‰
      - é…ç½®: threshold = 100 æ¡æ¶ˆæ¯
      - é€»è¾‘: å½“æ–°å¢æ¶ˆæ¯è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘

    â€¢ ManualTrigger: æ‰‹åŠ¨è§¦å‘ï¼ˆé¢„ç•™ï¼‰
      - é…ç½®: é€šè¿‡ HTTP API è§¦å‘
      - é€»è¾‘: æ”¶åˆ°è§¦å‘ä¿¡å·æ—¶ç«‹å³æ‰§è¡Œ

    â€¢ CompositeTrigger: ç»„åˆè§¦å‘å™¨ï¼ˆé¢„ç•™ï¼‰
      - é…ç½®: å¤šä¸ªè§¦å‘å™¨çš„ç»„åˆ
      - é€»è¾‘: ä»»ä¸€è§¦å‘å™¨æ»¡è¶³æ¡ä»¶å³è§¦å‘

å‚ä¸è€…:
  Trigger â†’ PersistenceManager â†’ Repository â†’ PostgresStore

æµç¨‹æ­¥éª¤:

1. è§¦å‘å™¨æ£€æµ‹
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TimeTrigger.ShouldTrigger()                                â”‚
   â”‚   â€¢ æ£€æŸ¥è·ç¦»ä¸Šæ¬¡æŒä¹…åŒ–çš„æ—¶é—´                                â”‚
   â”‚   â€¢ å¦‚æœ >= 30 ç§’ï¼Œè¿”å› true                                â”‚
   â”‚   â€¢ å¦åˆ™è¿”å› false                                         â”‚
   â”‚                                                              â”‚
   â”‚ æ‰©å±•: æœªæ¥å¯ä»¥åŒæ—¶æ³¨å†Œå¤šä¸ªè§¦å‘å™¨                             â”‚
   â”‚   â€¢ ä»»ä¸€è§¦å‘å™¨è¿”å› true å³æ‰§è¡ŒæŒä¹…åŒ–                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼ (shouldTrigger = true)
2. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.GetSystemStatus                                â”‚
   â”‚   status = GET system:status                              â”‚
   â”‚   if status != "ready":                                    â”‚
   â”‚     è·³è¿‡æœ¬æ¬¡æŒä¹…åŒ–                                          â”‚
   â”‚     return                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. è®¾ç½®æŒä¹…åŒ–çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SET system:status "persistence_in_progress"                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. è·å–æ‰€æœ‰ä¼šè¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.GetAllSessionIDs                               â”‚
   â”‚   sessionIDs = SMEMBERS sessions:all                       â”‚
   â”‚   è¿”å›: [uuid-1, uuid-2, uuid-3, ...]                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. éå†æ¯ä¸ªä¼šè¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¯¹æ¯ä¸ª session_id:                                         â”‚
   â”‚   a) è¯»å–ä¼šè¯å…ƒæ•°æ®                                          â”‚
   â”‚      HGETALL session:{uuid}                                â”‚
   â”‚      è¿”å›: {id, name, creator_id, mcp_server_url, ...}      â”‚
   â”‚                                                              â”‚
   â”‚   b) è¯»å–è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯                                    â”‚
   â”‚      ZREVRANGE msg:{uuid} 0 -1 WITH SCORES                 â”‚
   â”‚      è¿”å›: [{message, score}, ...]                          â”‚
   â”‚                                                              â”‚
   â”‚   c) å†™å…¥ PostgreSQL                                        â”‚
   â”‚      PostgresStore.UpsertSession(session)                  â”‚
   â”‚      INSERT INTO client_sessions (...)                     â”‚
   â”‚      VALUES (...)                                          â”‚
   â”‚      ON CONFLICT (id) DO UPDATE SET ...                    â”‚
   â”‚                                                              â”‚
   â”‚      PostgresStore.BatchInsertMessages(messages)           â”‚
   â”‚      INSERT INTO client_messages (...)                     â”‚
   â”‚      VALUES (...)                                          â”‚
   â”‚      ON CONFLICT (id) DO NOTHING                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. æ›´æ–°ç³»ç»ŸçŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SET system:last_persistence {timestamp}                    â”‚
   â”‚ SET system:status "ready"                                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
7. é‡ç½®è§¦å‘å™¨
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TimeTrigger.Reset()                                        â”‚
   â”‚   â€¢ æ›´æ–°ä¸Šæ¬¡æŒä¹…åŒ–æ—¶é—´æˆ³                                    â”‚
   â”‚   â€¢ å‡†å¤‡ä¸‹ä¸€æ¬¡è§¦å‘æ£€æµ‹                                      â”‚
   â”‚                                                              â”‚
   â”‚ æ‰©å±•: é‡ç½®æ‰€æœ‰å·²æ³¨å†Œçš„è§¦å‘å™¨                                 â”‚
   â”‚   â€¢ MessageCountTrigger: é‡ç½®æ¶ˆæ¯è®¡æ•°                        â”‚
   â”‚   â€¢ ManualTrigger: æ¸…é™¤è§¦å‘ä¿¡å·                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
8. è®°å½•æ—¥å¿—
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ logger.Info(                                              â”‚
   â”‚   "æŒä¹…åŒ–å®Œæˆ",                                            â”‚
   â”‚     "trigger", "TimeTrigger",                             â”‚
   â”‚     "sessions", sessionCount,                             â”‚
   â”‚     "messages", messageCount,                             â”‚
   â”‚     "duration", duration.Since(start),                    â”‚
   â”‚ )                                                          â”‚
   â”‚   ç¤ºä¾‹: "æŒä¹…åŒ–å®Œæˆ: trigger=TimeTrigger, 5ä¸ªä¼šè¯, 1200æ¡æ¶ˆæ¯, è€—æ—¶450ms"
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: ~500ms (å‡è®¾ 5000 æ¡æ¶ˆæ¯)
æ€§èƒ½ä¼˜åŒ–:
  â€¢ ä½¿ç”¨ PostgreSQL æ‰¹é‡æ’å…¥ (COPY)
  â€¢ ä½¿ç”¨ Pipeline æ‰¹é‡è¯»å– Redis
  â€¢ å¯ä»¥ä½¿ç”¨ goroutine å¹¶è¡Œå¤„ç†å¤šä¸ªä¼šè¯

æ‰©å±•ç‚¹:
  â€¢ æ–°å¢è§¦å‘å™¨: å®ç° PersistenceTrigger æ¥å£
  â€¢ ç»„åˆè§¦å‘å™¨: æ³¨å†Œå¤šä¸ªè§¦å‘å™¨ï¼Œä»»ä¸€æ»¡è¶³å³è§¦å‘
  â€¢ è§¦å‘å™¨é…ç½®: é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€é…ç½®è§¦å‘å™¨å‚æ•°
```

### 3.4 WebSocket å®æ—¶é€šä¿¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WebSocket å®æ—¶é€šä¿¡æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: å‰ç«¯å»ºç«‹ WebSocket è¿æ¥

å‚ä¸è€…:
  Frontend â†’ WS Handler â†’ WS Manager â†’ Hub â†’ Connection

æµç¨‹æ­¥éª¤:

1. å»ºç«‹ WebSocket è¿æ¥
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Frontend:                                                  â”‚
   â”‚   ws://localhost:8080/ws/sessions/{session_id}?key=ws-xxx  â”‚
   â”‚                                                              â”‚
   â”‚ Handler:                                                   â”‚
   â”‚   â€¢ éªŒè¯ session_id å­˜åœ¨                                     â”‚
   â”‚   â€¢ éªŒè¯ websocket_key åŒ¹é…                                  â”‚
   â”‚   â€¢ å‡çº§ HTTP â†’ WebSocket                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
2. æ³¨å†Œè¿æ¥
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WSManager.RegisterConnection                               â”‚
   â”‚   conn := &Connection{                                     â”‚
   â”‚     ID:        connID,                                    â”‚
   â”‚     SessionID: sessionID,                                 â”‚
   â”‚     PlayerID:  playerID,                                  â”‚
   â”‚     WebSocket: ws,                                         â”‚
   â”‚     Send:      make(chan []byte, 256),                    â”‚
   â”‚   }                                                         â”‚
   â”‚   Hub.Register <- conn                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. å¯åŠ¨è¯»å†™ goroutine
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ go conn.readPump()   # è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯                       â”‚
   â”‚ go conn.writePump()  # å†™å…¥æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. æ¥æ”¶ MCP Server äº‹ä»¶
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ EventHandler.OnServerEvent                                 â”‚
   â”‚   äº‹ä»¶ç±»å‹:                                                  â”‚
   â”‚   â€¢ state_changed: æ¸¸æˆçŠ¶æ€å˜æ›´                              â”‚
   â”‚   â€¢ combat_updated: æˆ˜æ–—çŠ¶æ€æ›´æ–°                             â”‚
   â”‚   â€¢ character_moved: è§’è‰²ç§»åŠ¨                               â”‚
   â”‚   â€¢ dice_rolled: éª°å­æŠ•æ·ç»“æœ                                â”‚
   â”‚                                                              â”‚
   â”‚   æ¨é€åˆ°å‰ç«¯:                                               â”‚
   â”‚     Hub.Broadcast <- Event{                                â”‚
   â”‚       SessionID: sessionID,                                â”‚
   â”‚       Type:      "state_changed",                          â”‚
   â”‚       Data:      eventData,                                â”‚
   â”‚     }                                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. æ¨é€åˆ°å‰ç«¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ conn.writePump():                                         â”‚
   â”‚   select {                                                 â”‚
   â”‚   case message := <-conn.Send:                             â”‚
   â”‚     err := ws.WriteMessage(websocket.TextMessage, message) â”‚
   â”‚     if err != nil:                                         â”‚
   â”‚       Hub.Unregister <- conn                               â”‚
   â”‚     }                                                       â”‚
   â”‚   }                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ conn.readPump() æ£€æµ‹åˆ°é”™è¯¯                                  â”‚
   â”‚   Hub.Unregister <- conn                                   â”‚
   â”‚   close(conn.Send)                                         â”‚
   â”‚   ws.Close()                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®æ—¶æ¨é€çš„æ¶ˆæ¯ç±»å‹:
  â€¢ æ–°æ¶ˆæ¯é€šçŸ¥
  â€¢ æ¸¸æˆçŠ¶æ€å˜æ›´
  â€¢ æˆ˜æ–—äº‹ä»¶
  â€¢ ç³»ç»Ÿé€šçŸ¥
```

### 3.5 å¯åŠ¨åŠ è½½æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¯åŠ¨åŠ è½½æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: åº”ç”¨å¯åŠ¨

å‚ä¸è€…:
  Main â†’ DataLoader â†’ PostgresStore â†’ RedisStore â†’ HTTP Server

æµç¨‹æ­¥éª¤:

1. åŠ è½½é…ç½®
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ config.Load()                                             â”‚
   â”‚   è¯»å– configs/config.yaml                                â”‚
   â”‚   éªŒè¯é…ç½®æœ‰æ•ˆæ€§                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
2. åˆå§‹åŒ–ä¾èµ–
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ åˆå§‹åŒ– Logger                                             â”‚
   â”‚ â€¢ åˆå§‹åŒ– Redis Client                                       â”‚
   â”‚ â€¢ åˆå§‹åŒ– PostgreSQL Client                                  â”‚
   â”‚ â€¢ åˆå§‹åŒ– MCP Client                                         â”‚
   â”‚ â€¢ åˆå§‹åŒ– LLM Client                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. è®¾ç½®å¯åŠ¨çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.SetSystemStatus("starting")                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. åŠ è½½ä¼šè¯æ•°æ®
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ DataLoader.LoadSessions()                                 â”‚
   â”‚   a) ä» PostgreSQL æŸ¥è¯¢                                     â”‚
   â”‚      SELECT * FROM client_sessions                         â”‚
   â”‚      WHERE deleted_at IS NULL                              â”‚
   â”‚      ORDER BY created_at DESC                              â”‚
   â”‚                                                              â”‚
   â”‚   b) æ‰¹é‡å†™å…¥ Redis                                         â”‚
   â”‚      Pipeline:                                              â”‚
   â”‚        å¯¹æ¯ä¸ª session:                                      â”‚
   â”‚          HSET session:{uuid} {field} {value}               â”‚
   â”‚          SADD sessions:all {uuid}                          â”‚
   â”‚      Pipeline.Exec()                                       â”‚
   â”‚   è€—æ—¶: ~100ms (å‡è®¾ 5 ä¸ªä¼šè¯)                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. åŠ è½½æ¶ˆæ¯æ•°æ®
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ DataLoader.LoadMessages()                                 â”‚
   â”‚   a) å¯¹æ¯ä¸ª session_id ä» PostgreSQL æŸ¥è¯¢                   â”‚
   â”‚      SELECT * FROM client_messages                         â”‚
   â”‚      WHERE session_id = $1                                 â”‚
   â”‚      ORDER BY created_at ASC                               â”‚
   â”‚                                                              â”‚
   â”‚   b) æ‰¹é‡å†™å…¥ Redis                                         â”‚
   â”‚      Pipeline:                                              â”‚
   â”‚        å¯¹æ¯ä¸ª message:                                      â”‚
   â”‚          ZADD msg:{uuid} {timestamp} {json}                â”‚
   â”‚      Pipeline.Exec()                                       â”‚
   â”‚   è€—æ—¶: ~500ms (å‡è®¾ 5000 æ¡æ¶ˆæ¯)                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. è®¾ç½®å°±ç»ªçŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.SetSystemStatus("ready")                        â”‚
   â”‚ RedisStore.SetSystemStartupTime(time.Now())                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
7. å¯åŠ¨åå°æœåŠ¡
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ go PersistenceManager.Start()  # æ¯ 30 ç§’æŒä¹…åŒ–             â”‚
   â”‚ go HTTPServer.Serve()            # HTTP æœåŠ¡                â”‚
   â”‚ go WSServer.Serve()              # WebSocket æœåŠ¡           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
8. ç³»ç»Ÿå°±ç»ª
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ logger.Info("ç³»ç»Ÿå·²å¯åŠ¨ï¼Œå¼€å§‹æ¥æ”¶è¯·æ±‚")                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: <1ç§’
```

### 3.6 ä¼˜é›…å…³é—­æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¼˜é›…å…³é—­æµç¨‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘: SIGTERM / SIGINT ä¿¡å·

å‚ä¸è€…:
  OS â†’ Main â†’ HTTP Server â†’ WS Manager â†’ PersistenceManager

æµç¨‹æ­¥éª¤:

1. æ•è·ä¿¡å·
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ signal.Notify(sigChan, syscall.SIGTERM, syscall.SIGINT)    â”‚
   â”‚   <-sigChan                                                â”‚
   â”‚   logger.Info("æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...")                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
2. è®¾ç½®åœæ­¢çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ RedisStore.SetSystemStatus("stopping")                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
3. åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ HTTPServer.Shutdown():                                    â”‚
   â”‚   â€¢ åœæ­¢ç›‘å¬æ–°ç«¯å£                                          â”‚
   â”‚   â€¢ è®¾ç½® ctx.WithTimeout(10s)                              â”‚
   â”‚   â€¢ ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ                                        â”‚
   â”‚   â€¢ è¶…æ—¶åå¼ºåˆ¶å…³é—­                                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
4. å…³é—­ WebSocket è¿æ¥
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WSManager.Shutdown():                                     â”‚
   â”‚   â€¢ åœæ­¢æ¥å—æ–°è¿æ¥                                          â”‚
   â”‚   â€¢ å‘é€å…³é—­å¸§åˆ°æ‰€æœ‰å®¢æˆ·ç«¯                                   â”‚
   â”‚   â€¢ ç­‰å¾…å®¢æˆ·ç«¯å…³é—­è¿æ¥ï¼ˆæœ€å¤š 5 ç§’ï¼‰                           â”‚
   â”‚   â€¢ å…³é—­æ‰€æœ‰è¿æ¥                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
5. æ‰§è¡Œæœ€åæŒä¹…åŒ–
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PersistenceManager.Shutdown():                            â”‚
   â”‚   â€¢ æ‰§è¡Œå®Œæ•´æŒä¹…åŒ–æµç¨‹                                       â”‚
   â”‚   â€¢ éªŒè¯æŒä¹…åŒ–ç»“æœ                                          â”‚
   â”‚   â€¢ å…³é—­ PostgreSQL è¿æ¥                                    â”‚
   â”‚   â€¢ å…³é—­ Redis è¿æ¥                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
6. å…³é—­å…¶ä»–èµ„æº
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ å…³é—­ MCP Client è¿æ¥                                      â”‚
   â”‚ â€¢ å…³é—­ LLM Client è¿æ¥                                      â”‚
   â”‚ â€¢ åˆ·æ–°æ—¥å¿—ç¼“å†²                                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
7. è¿›ç¨‹é€€å‡º
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ logger.Info("ä¼˜é›…å…³é—­å®Œæˆ")                                  â”‚
   â”‚ os.Exit(0)                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: <15ç§’
è¶…æ—¶ä¿æŠ¤: 10 ç§’åå¼ºåˆ¶é€€å‡º
```

### 3.7 æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡ç›®æ ‡:
  â€¢ æ”¯æŒå¤šç§è§¦å‘ç­–ç•¥
  â€¢ æ˜“äºæ‰©å±•æ–°çš„è§¦å‘å™¨
  â€¢ æ”¯æŒè§¦å‘å™¨ç»„åˆ
  â€¢ é…ç½®åŒ–ç®¡ç†

è§¦å‘å™¨æ¥å£å®šä¹‰:

  type PersistenceTrigger interface {
    // ShouldTrigger åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘æŒä¹…åŒ–
    ShouldTrigger(ctx context.Context) (bool, error)

    // Reset é‡ç½®è§¦å‘å™¨çŠ¶æ€
    Reset(ctx context.Context) error

    // Name è¿”å›è§¦å‘å™¨åç§°
    Name() string
  }

å·²å®ç°çš„è§¦å‘å™¨:

1. TimeTrigger (æ—¶é—´è§¦å‘å™¨)
   â”œâ”€ æè¿°: æŒ‰å›ºå®šæ—¶é—´é—´éš”è§¦å‘
   â”œâ”€ é…ç½®å‚æ•°:
   â”‚   â””â”€ interval: time.Duration (å¦‚ 30s)
   â”œâ”€ è§¦å‘é€»è¾‘:
   â”‚   â””â”€ è·ç¦»ä¸Šæ¬¡æŒä¹…åŒ–æ—¶é—´ >= interval
   â””â”€ ä½¿ç”¨åœºæ™¯:
       â”œâ”€ å½“å‰é»˜è®¤ä½¿ç”¨
       â””â”€ é€‚åˆæ•°æ®é‡å°ã€è¦æ±‚å®šæ—¶å¤‡ä»½çš„åœºæ™¯

2. MessageCountTrigger (æ¶ˆæ¯é‡è§¦å‘å™¨ - é¢„ç•™)
   â”œâ”€ æè¿°: å½“æ–°å¢æ¶ˆæ¯è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘
   â”œâ”€ é…ç½®å‚æ•°:
   â”‚   â””â”€ threshold: int (å¦‚ 100 æ¡)
   â”œâ”€ è§¦å‘é€»è¾‘:
   â”‚   â””â”€ è‡ªä¸Šæ¬¡æŒä¹…åŒ–ä»¥æ¥æ–°å¢æ¶ˆæ¯æ•° >= threshold
   â”œâ”€ å®ç°è¦ç‚¹:
   â”‚   â”œâ”€ æ¯æ¬¡ä¿å­˜æ¶ˆæ¯æ—¶è®¡æ•° +1
   â”‚   â”œâ”€ æŒä¹…åŒ–å®Œæˆåé‡ç½®è®¡æ•°
   â”‚   â””â”€ è®¡æ•°å™¨å­˜å‚¨åœ¨ Redis (persistence:msg_count)
   â””â”€ ä½¿ç”¨åœºæ™¯:
       â”œâ”€ æ¶ˆæ¯é¢‘ç¹æ—¶åŠæ—¶æŒä¹…åŒ–
       â””â”€ é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±è¿‡å¤š

3. ManualTrigger (æ‰‹åŠ¨è§¦å‘å™¨ - é¢„ç•™)
   â”œâ”€ æè¿°: é€šè¿‡ API æ‰‹åŠ¨è§¦å‘æŒä¹…åŒ–
   â”œâ”€ é…ç½®å‚æ•°:
   â”‚   â””â”€ æ— 
   â”œâ”€ è§¦å‘é€»è¾‘:
   â”‚   â””â”€ æ”¶åˆ°è§¦å‘ä¿¡å·æ—¶ç«‹å³è¿”å› true
   â”œâ”€ å®ç°è¦ç‚¹:
   â”‚   â”œâ”€ ä½¿ç”¨ channel æ¥æ”¶è§¦å‘ä¿¡å·
   â”‚   â”‚   triggerChan chan struct{}
   â”‚   â”œâ”€ æä¾› HTTP API: POST /api/system/persistence/trigger
   â”‚   â””â”€ ç®¡ç†å‘˜å¯éšæ—¶è§¦å‘
   â””â”€ ä½¿ç”¨åœºæ™¯:
       â”œâ”€ å…³é”®æ“ä½œåç«‹å³æŒä¹…åŒ–
       â”œâ”€ ç³»ç»Ÿç»´æŠ¤å‰å¤‡ä»½
       â””â”€ è°ƒè¯•å’Œæµ‹è¯•

4. CompositeTrigger (ç»„åˆè§¦å‘å™¨ - é¢„ç•™)
   â”œâ”€ æè¿°: ç»„åˆå¤šä¸ªè§¦å‘å™¨ï¼Œä»»ä¸€æ»¡è¶³å³è§¦å‘
   â”œâ”€ é…ç½®å‚æ•°:
   â”‚   â””â”€ triggers: []PersistenceTrigger
   â”œâ”€ è§¦å‘é€»è¾‘:
   â”‚   â””â”€ ä»»ä¸€å­è§¦å‘å™¨ ShouldTrigger() è¿”å› true
   â”œâ”€ å®ç°è¦ç‚¹:
   â”‚   â”‚   func (c *CompositeTrigger) ShouldTrigger(ctx context.Context) (bool, error) {
   â”‚   â”‚     for _, trigger := range c.triggers {
   â”‚   â”‚       if shouldTrigger, err := trigger.ShouldTrigger(ctx); err != nil {
   â”‚   â”‚         return false, err
   â”‚   â”‚       } else if shouldTrigger {
   â”‚   â”‚         return true, nil
   â”‚   â”‚       }
   â”‚   â”‚     }
   â”‚   â”‚     return false, nil
   â”‚   â”‚   }
   â”‚   â””â”€ Reset æ—¶é‡ç½®æ‰€æœ‰å­è§¦å‘å™¨
   â””â”€ ä½¿ç”¨åœºæ™¯:
       â”œâ”€ æ—¶é—´ + æ¶ˆæ¯é‡åŒé‡ä¿éšœ
       â”œâ”€ å®šæ—¶ + æ‰‹åŠ¨æ··åˆæ¨¡å¼
       â””â”€ çµæ´»é…ç½®è§¦å‘ç­–ç•¥

è§¦å‘å™¨æ³¨å†Œå’Œç®¡ç†:

  type TriggerManager struct {
    triggers []PersistenceTrigger
  }

  // æ³¨å†Œè§¦å‘å™¨
  func (m *TriggerManager) Register(trigger PersistenceTrigger)

  // æ£€æŸ¥ä»»ä¸€è§¦å‘å™¨æ˜¯å¦æ»¡è¶³æ¡ä»¶
  func (m *TriggerManager) ShouldTrigger(ctx context.Context) (bool, error)

  // é‡ç½®æ‰€æœ‰è§¦å‘å™¨
  func (m *TriggerManager) ResetAll(ctx context.Context) error

  // è·å–è§¦å‘çš„è§¦å‘å™¨åç§°
  func (m *TriggerManager) GetTriggeredNames(ctx context.Context) []string

é…ç½®ç¤ºä¾‹ (config.yaml):

  persistence:
    type: composite              # ç»„åˆè§¦å‘å™¨
    triggers:
      - type: time              # æ—¶é—´è§¦å‘å™¨
        interval: 30s

      - type: message           # æ¶ˆæ¯é‡è§¦å‘å™¨
        threshold: 100

      # - type: manual          # æ‰‹åŠ¨è§¦å‘å™¨ï¼ˆå¯é€‰ï¼‰

æ‰©å±•æ–°çš„è§¦å‘å™¨:

  1. å®ç° PersistenceTrigger æ¥å£
     type CustomTrigger struct {
       // è‡ªå®šä¹‰å­—æ®µ
     }

     func (t *CustomTrigger) ShouldTrigger(ctx context.Context) (bool, error) {
       // è‡ªå®šä¹‰è§¦å‘é€»è¾‘
       return true, nil
     }

     func (t *CustomTrigger) Reset(ctx context.Context) error {
       // é‡ç½®é€»è¾‘
       return nil
     }

     func (t *CustomTrigger) Name() string {
       return "CustomTrigger"
     }

  2. æ³¨å†Œåˆ° TriggerManager
     manager.Register(&CustomTrigger{...})

  3. åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼ˆå¦‚éœ€ï¼‰

å½“å‰å®ç°:

  â€¢ ä»…ä½¿ç”¨ TimeTrigger
  â€¢ æ¯ 30 ç§’è§¦å‘ä¸€æ¬¡
  â€¢ é…ç½®: PERSISTENCE_TYPE=time, PERSISTENCE_INTERVAL=30s

æœªæ¥æ‰©å±•:

  â€¢ å®ç° MessageCountTrigger
  â€¢ å®ç° ManualTrigger (æ·»åŠ  HTTP API)
  â€¢ å®ç° CompositeTrigger æ”¯æŒå¤šè§¦å‘å™¨ç»„åˆ
  â€¢ æ·»åŠ æ›´å¤šè§¦å‘å™¨ç±»å‹ï¼ˆå¦‚: å†…å­˜ä½¿ç”¨é‡ã€æ—¶é—´æ®µç­‰ï¼‰
```

---

## å››ã€ç»„ä»¶äº¤äº’è®¾è®¡

### 4.1 ç»„ä»¶äº¤äº’çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»„ä»¶äº¤äº’çŸ©é˜µ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å‰ç«¯    â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ HTTP/WebSocket
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP Layer                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚SessionHandlerâ”‚  â”‚ ChatHandler  â”‚  â”‚WSHandler     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Service Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ SessionService   â”‚  â”‚  ChatService     â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚           â”‚                     â”‚                               â”‚
â”‚           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚           â”‚         â”‚  OrchestratorService    â”‚               â”‚
â”‚           â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
â”‚           â”‚         â”‚  â”‚ ContextBuilder     â”‚ â”‚               â”‚
â”‚           â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚
â”‚           â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
â”‚           â”‚         â”‚  â”‚ LLMManager        â”‚ â”‚               â”‚
â”‚           â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚
â”‚           â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
â”‚           â”‚         â”‚  â”‚ ToolCoordinator    â”‚ â”‚               â”‚
â”‚           â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚
â”‚           â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â–¼                     â–¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚
           â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Repository Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚SessionRepository â”‚  â”‚MessageRepository â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚
            â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Store Layer                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  RedisStore      â”‚  â”‚  PostgresStore   â”‚                    â”‚
â”‚  â”‚  (ä¸»å­˜å‚¨)         â”‚  â”‚  (å¤‡ä»½)          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚
            â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Infrastructure Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Redis   â”‚  â”‚PostgreSQLâ”‚  â”‚   MCP    â”‚  â”‚   LLM    â”‚       â”‚
â”‚  â”‚  Client  â”‚  â”‚  Client  â”‚  â”‚  Client  â”‚  â”‚  Client  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç»„ä»¶é€šä¿¡æ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç»„ä»¶é€šä¿¡æ–¹å¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. åŒæ­¥è°ƒç”¨ (å‡½æ•°è°ƒç”¨)
   Handler â†’ Service â†’ Repository â†’ Store
   ç‰¹ç‚¹:
   â€¢ ç›´æ¥å‡½æ•°è°ƒç”¨
   â€¢ ç­‰å¾…ç»“æœè¿”å›
   â€¢ ç”¨äºè¯·æ±‚-å“åº”æ¨¡å¼

2. å¼‚æ­¥é€šä¿¡ (Channel)
   Orchestrator â†’ LLM Manager (streaming)
   MCP Server â†’ Event Handler â†’ WS Manager
   ç‰¹ç‚¹:
   â€¢ ä½¿ç”¨ Go channel
   â€¢ éé˜»å¡é€šä¿¡
   â€¢ ç”¨äºå®æ—¶æ¨é€

3. å®šæ—¶è§¦å‘ (Ticker)
   Timer â†’ PersistenceManager
   ç‰¹ç‚¹:
   â€¢ time.Ticker
   â€¢ å›ºå®šé—´éš”è§¦å‘
   â€¢ ç”¨äºåå°ä»»åŠ¡

4. äº‹ä»¶é©±åŠ¨ (Event Bus)
   MCP Server â†’ Event Handler â†’ Multiple Subscribers
   ç‰¹ç‚¹:
   â€¢ å‘å¸ƒ-è®¢é˜…æ¨¡å¼
   â€¢ ä¸€å¯¹å¤šé€šä¿¡
   â€¢ ç”¨äºçŠ¶æ€å˜æ›´é€šçŸ¥
```

### 4.3 å…³é”®äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                äº¤äº’1: ç”¨æˆ·èŠå¤©è¯·æ±‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend
    â”‚ POST /api/sessions/{id}/chat
    â–¼
ChatHandler.SendMessage()
    â”‚
    â”œâ”€â†’ ChatService.SendMessage()
    â”‚       â”‚
    â”‚       â”œâ”€â†’ MessageRepository.Save() â”€â”€â†’ RedisStore.SaveMessage()
    â”‚       â”‚       (<1ms)
    â”‚       â”‚
    â”‚       â”œâ”€â†’ OrchestratorService.ProcessMessage()
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â†’ ContextBuilder.Build()
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â”œâ”€â†’ MessageRepository.GetHistory()
    â”‚       â”‚       â”‚       â”‚       â””â”€â†’ RedisStore.GetMessages()
    â”‚       â”‚       â”‚       â”‚           (<1ms)
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â””â”€â†’ MCPClient.GetSessionState()
    â”‚       â”‚       â”‚           (10-50ms)
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â†’ LLMManager.ChatCompletion()
    â”‚       â”‚       â”‚       â””â”€â†’ LLM Client (äº‘ç«¯)
    â”‚       â”‚       â”‚           (1-3s)
    â”‚       â”‚       â”‚
    â”‚       â”‚       â””â”€â†’ (å¦‚æœæœ‰ tool_calls)
    â”‚       â”‚               ToolCoordinator.ExecuteTools()
    â”‚       â”‚                   â”‚
    â”‚       â”‚                   â””â”€â†’ MCPClient.CallTool()
    â”‚       â”‚                       (10-100ms)
    â”‚       â”‚
    â”‚       â””â”€â†’ MessageRepository.Save() â”€â”€â†’ RedisStore.SaveMessage()
    â”‚
    â””â”€â†’ Response JSON
            (<1ms)

æ€»è€—æ—¶: 2-5ç§’ (ä¸»è¦æ˜¯ LLM)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                äº¤äº’2: MCP Server äº‹ä»¶æ¨é€                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MCP Server
    â”‚ å‘é€é¢†åŸŸäº‹ä»¶
    â–¼
MCPClient.ReceiveEvent()
    â”‚
    â”œâ”€â†’ EventHandler.OnEvent()
    â”‚       â”‚
    â”‚       â”œâ”€â†’ è§£æäº‹ä»¶ç±»å‹
    â”‚       â”‚
    â”‚       â”œâ”€â†’ è½¬æ¢ä¸ºå‰ç«¯äº‹ä»¶æ ¼å¼
    â”‚       â”‚
    â”‚       â””â”€â†’ WSManager.Broadcast()
    â”‚               â”‚
    â”‚               â””â”€â†’ Hub.Broadcast <- Event
    â”‚                       â”‚
    â”‚                       â”œâ”€â†’ connection1.Send <- Event
    â”‚                       â”œâ”€â†’ connection2.Send <- Event
    â”‚                       â””â”€â†’ connection3.Send <- Event
    â”‚
    â””â”€â†’ WebSocket æ¨é€åˆ°å‰ç«¯
            (<1ms)

æ€»è€—æ—¶: <1ms
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                äº¤äº’3: æ•°æ®æŒä¹…åŒ–ï¼ˆåå°ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timer (æ¯30ç§’)
    â”‚
    â–¼
PersistenceManager.Run()
    â”‚
    â”œâ”€â†’ RedisStore.GetSystemStatus()
    â”‚
    â”œâ”€â†’ RedisStore.GetAllSessionIDs()
    â”‚
    â”œâ”€â†’ å¯¹æ¯ä¸ª session_id:
    â”‚       â”‚
    â”‚       â”œâ”€â†’ RedisStore.GetSession() â”€â”€â†’ HGETALL session:{uuid}
    â”‚       â”‚
    â”‚       â”œâ”€â†’ RedisStore.GetMessages() â”€â”€â†’ ZREVRANGE msg:{uuid}
    â”‚       â”‚
    â”‚       â”œâ”€â†’ PostgresStore.UpsertSession()
    â”‚       â”‚       â””â”€â†’ PostgreSQL: UPSERT client_sessions
    â”‚       â”‚
    â”‚       â””â”€â†’ PostgresStore.BatchInsertMessages()
    â”‚               â””â”€â†’ PostgreSQL: INSERT client_messages
    â”‚
    â”œâ”€â†’ RedisStore.SetSystemStatus("ready")
    â”‚
    â””â”€â†’ logger.Info("æŒä¹…åŒ–å®Œæˆ")

æ€»è€—æ—¶: ~500ms
```

---

## äº”ã€å¯¹å¤– API è®¾è®¡

### 5.1 REST API å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REST API è®¾è®¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Base URL: http://localhost:8080/api
Content-Type: application/json
```

#### 5.1.1 ä¼šè¯ç®¡ç† API

**1. åˆ›å»ºä¼šè¯**

```
POST /api/sessions

æè¿°: åˆ›å»ºä¸€ä¸ªæ–°çš„æ¸¸æˆä¼šè¯

è¯·æ±‚ä½“:
{
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",           // å¿…å¡«ï¼Œä¼šè¯åç§°
  "creator_id": "user-123",          // å¿…å¡«ï¼Œåˆ›å»ºè€…ID
  "mcp_server_url": "http://localhost:9000",  // å¿…å¡«ï¼ŒMCP Server URL
  "max_players": 5,                  // å¯é€‰ï¼Œæœ€å¤§ç©å®¶æ•°ï¼Œé»˜è®¤4
  "settings": {                      // å¯é€‰ï¼Œä¼šè¯é…ç½®
    "ruleset": "dnd5e",             // è§„åˆ™é›†
    "starting_level": 1,            // èµ·å§‹ç­‰çº§
    "allow_characters": true        // æ˜¯å¦å…è®¸è‡ªå®šä¹‰è§’è‰²
  }
}

å“åº”: 201 Created
{
  "id": "session-uuid-xxx",         // ä¼šè¯ID
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  "creator_id": "user-123",
  "mcp_server_url": "http://localhost:9000",
  "websocket_key": "ws-key-xxx",    // WebSocketè¿æ¥å¯†é’¥
  "max_players": 5,
  "settings": {...},
  "created_at": "2025-02-03T10:00:00Z",
  "updated_at": "2025-02-03T10:00:00Z",
  "status": "active"                // active | archived
}

é”™è¯¯å“åº”:
  400 Bad Request - å‚æ•°éªŒè¯å¤±è´¥
  503 Service Unavailable - MCP Server è¿æ¥å¤±è´¥
```

**2. è·å–ä¼šè¯è¯¦æƒ…**

```
GET /api/sessions/{session_id}

æè¿°: è·å–æŒ‡å®šä¼šè¯çš„è¯¦ç»†ä¿¡æ¯

è·¯å¾„å‚æ•°:
  session_id: ä¼šè¯ID (UUID)

å“åº”: 200 OK
{
  "id": "session-uuid-xxx",
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  "creator_id": "user-123",
  "mcp_server_url": "http://localhost:9000",
  "max_players": 5,
  "current_players": 3,              // å½“å‰ç©å®¶æ•°
  "settings": {...},
  "created_at": "2025-02-03T10:00:00Z",
  "updated_at": "2025-02-03T10:05:00Z",
  "status": "active",
  "message_count": 120               // æ¶ˆæ¯æ€»æ•°
}

é”™è¯¯å“åº”:
  404 Not Found - ä¼šè¯ä¸å­˜åœ¨
```

**3. åˆ—å‡ºæ‰€æœ‰ä¼šè¯**

```
GET /api/sessions

æŸ¥è¯¢å‚æ•°:
  status: çŠ¶æ€è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰ï¼Œactive | archivedï¼Œé»˜è®¤ active

ç¤ºä¾‹:
  GET /api/sessions
  GET /api/sessions?status=archived

å“åº”: 200 OK
[
  {
    "id": "session-uuid-1",
    "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
    "creator_id": "user-123",
    "current_players": 3,
    "message_count": 120,
    "created_at": "2025-02-03T10:00:00Z",
    "updated_at": "2025-02-03T10:05:00Z",
    "status": "active"
  },
  {
    "id": "session-uuid-2",
    "name": "ç¬¬äºŒä¸ªæˆ˜å½¹",
    "creator_id": "user-456",
    "current_players": 2,
    "message_count": 85,
    "created_at": "2025-02-02T15:30:00Z",
    "updated_at": "2025-02-03T09:20:00Z",
    "status": "active"
  }
]

è¯´æ˜:
  â€¢ ç›´æ¥è¿”å›ä¼šè¯æ•°ç»„ï¼Œæ— åˆ†é¡µ
  â€¢ æŒ‰ created_at å€’åºæ’åˆ—
  â€¢ é€‚ç”¨äºä¼šè¯æ•°é‡è¾ƒå°‘çš„åœºæ™¯ï¼ˆ< 100 ä¸ªï¼‰
```

**4. æ›´æ–°ä¼šè¯**

```
PATCH /api/sessions/{session_id}

æè¿°: æ›´æ–°ä¼šè¯ä¿¡æ¯

è¯·æ±‚ä½“:
{
  "name": "æ–°çš„ä¼šè¯åç§°",              // å¯é€‰
  "max_players": 6,                   // å¯é€‰
  "settings": {                       // å¯é€‰
    "ruleset": "dnd5e"
  }
}

å“åº”: 200 OK
{
  "id": "session-uuid-xxx",
  "name": "æ–°çš„ä¼šè¯åç§°",
  // ... å…¶ä»–å­—æ®µ
}

é”™è¯¯å“åº”:
  404 Not Found - ä¼šè¯ä¸å­˜åœ¨
  400 Bad Request - å‚æ•°éªŒè¯å¤±è´¥
```

**5. åˆ é™¤ä¼šè¯**

```
DELETE /api/sessions/{session_id}

æè¿°: åˆ é™¤æŒ‡å®šä¼šè¯ï¼ˆè½¯åˆ é™¤ï¼‰

è·¯å¾„å‚æ•°:
  session_id: ä¼šè¯ID (UUID)

å“åº”: 204 No Content

é”™è¯¯å“åº”:
  404 Not Found - ä¼šè¯ä¸å­˜åœ¨
```

#### 5.1.2 èŠå¤©æ¶ˆæ¯ API

**6. å‘é€æ¶ˆæ¯**

```
POST /api/sessions/{session_id}/chat

æè¿°: å‘é€ç”¨æˆ·æ¶ˆæ¯å¹¶è·å– AI å“åº”

è¯·æ±‚ä½“:
{
  "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",        // å¿…å¡«ï¼Œæ¶ˆæ¯å†…å®¹
  "player_id": "player-123",         // å¿…å¡«ï¼Œç©å®¶ID
  "stream": false                    // å¯é€‰ï¼Œæ˜¯å¦ä½¿ç”¨æµå¼å“åº”ï¼Œé»˜è®¤false
}

å“åº”: 200 OK
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",              // user | assistant | system | tool
  "content": "ä½ å†²å‘å“¥å¸ƒæ—ï¼ŒæŒ¥èˆç€æ‰‹ä¸­çš„é•¿å‰‘...",
  "tool_calls": [                   // å¦‚æœæœ‰å·¥å…·è°ƒç”¨
    {
      "id": "call-xxx",
      "name": "resolve_attack",
      "arguments": {
        "attacker": "player-123",
        "target": "goblin-1",
        "attack_type": "melee"
      },
      "result": {                   // å·¥å…·æ‰§è¡Œç»“æœ
        "success": true,
        "damage": 8,
        "events": [...]
      }
    }
  ],
  "state_changes": {                // çŠ¶æ€å˜æ›´æ‘˜è¦
    "combat": "active",
    "turn": "player-123"
  },
  "player_id": "player-123",
  "created_at": "2025-02-03T10:05:30Z"
}

é”™è¯¯å“åº”:
  404 Not Found - ä¼šè¯ä¸å­˜åœ¨
  400 Bad Request - å‚æ•°éªŒè¯å¤±è´¥
  503 Service Unavailable - LLM æˆ– MCP Server ä¸å¯ç”¨
```

**7. è·å–æ¶ˆæ¯å†å²**

```
GET /api/sessions/{session_id}/messages

æè¿°: è·å–ä¼šè¯çš„æ¶ˆæ¯å†å²

æŸ¥è¯¢å‚æ•°:
  limit: è¿”å›æ¶ˆæ¯æ•°é‡ï¼ˆå¯é€‰ï¼‰ï¼Œé»˜è®¤ 50ï¼Œæœ€å¤§ 100
  role: è§’è‰²è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰ï¼Œuser | assistant | system | tool
  since: èµ·å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰ï¼ŒRFC3339 æ ¼å¼ï¼Œå¦‚ "2025-02-03T10:00:00Z"

ç¤ºä¾‹:
  GET /api/sessions/{id}/messages
  GET /api/sessions/{id}/messages?limit=20
  GET /api/sessions/{id}/messages?role=user&limit=10
  GET /api/sessions/{id}/messages?since=2025-02-03T10:00:00Z

å“åº”: 200 OK
[
  {
    "id": "msg-uuid-1",
    "session_id": "session-uuid-xxx",
    "role": "user",
    "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
    "player_id": "player-123",
    "created_at": "2025-02-03T10:05:00Z"
  },
  {
    "id": "msg-uuid-2",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "ä½ å†²å‘å“¥å¸ƒæ—...",
    "created_at": "2025-02-03T10:05:30Z"
  }
]

è¯´æ˜:
  â€¢ ç›´æ¥è¿”å›æ¶ˆæ¯æ•°ç»„ï¼Œæ— åˆ†é¡µ
  â€¢ æŒ‰ created_at å‡åºæ’åˆ—ï¼ˆä»æ—§åˆ°æ–°ï¼‰
  â€¢ é€‚ç”¨äºå¿«é€ŸåŠ è½½æœ€è¿‘çš„æ¶ˆæ¯
```

**8. è·å–å•æ¡æ¶ˆæ¯**

```
GET /api/sessions/{session_id}/messages/{message_id}

æè¿°: è·å–æŒ‡å®šæ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯

è·¯å¾„å‚æ•°:
  session_id: ä¼šè¯ID
  message_id: æ¶ˆæ¯ID

å“åº”: 200 OK
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",
  "content": "ä½ å†²å‘å“¥å¸ƒæ—...",
  "tool_calls": [...],
  "created_at": "2025-02-03T10:05:30Z"
}
```

#### 5.1.3 ç³»ç»Ÿ API

**9. è·å–ç³»ç»ŸçŠ¶æ€**

```
GET /api/system/health

æè¿°: è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€

å“åº”: 200 OK
{
  "status": "healthy",              // healthy | degrading | unhealthy
  "version": "1.0.0",
  "uptime": 3600,                   // è¿è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰
  "components": {
    "redis": {
      "status": "healthy",
      "latency_ms": 0.5
    },
    "postgres": {
      "status": "healthy",
      "latency_ms": 5
    },
    "mcp_server": {
      "status": "healthy",
      "connected_sessions": 5
    },
    "llm": {
      "status": "healthy",
      "provider": "openai"
    }
  },
  "last_persistence": "2025-02-03T10:30:00Z"
}
```

**10. è·å–ç³»ç»Ÿç»Ÿè®¡**

```
GET /api/system/stats

æè¿°: è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯

å“åº”: 200 OK
{
  "sessions": {
    "total": 45,
    "active": 30,
    "archived": 15
  },
  "messages": {
    "total": 15000,
    "last_24h": 1200
  },
  "performance": {
    "avg_response_time_ms": 250,
    "p95_response_time_ms": 500,
    "p99_response_time_ms": 1000
  },
  "resources": {
    "memory_used_mb": 256,
    "goroutines": 150
  }
}
```

### 5.2 WebSocket API å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WebSocket API è®¾è®¡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WebSocket URL: ws://localhost:8080/ws/sessions/{session_id}?key={websocket_key}

è¿æ¥å‚æ•°:
  session_id: ä¼šè¯ID
  key: WebSocketå¯†é’¥ï¼ˆä»åˆ›å»ºä¼šè¯APIè·å–ï¼‰
```

#### 5.2.1 å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨æ¶ˆæ¯

**1. è®¢é˜…äº‹ä»¶**

```json
{
  "type": "subscribe",
  "data": {
    "events": ["state_changed", "combat_updated", "character_moved"]
  }
}
```

**2. å–æ¶ˆè®¢é˜…**

```json
{
  "type": "unsubscribe",
  "data": {
    "events": ["combat_updated"]
  }
}
```

**3. å¿ƒè·³**

```json
{
  "type": "ping",
  "data": {
    "timestamp": "2025-02-03T10:00:00Z"
  }
}
```

#### 5.2.2 æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯æ¶ˆæ¯

**1. æ–°æ¶ˆæ¯é€šçŸ¥**

```json
{
  "type": "new_message",
  "data": {
    "id": "msg-uuid-xxx",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "ä½ å†²å‘å“¥å¸ƒæ—...",
    "created_at": "2025-02-03T10:05:30Z"
  }
}
```

**2. æ¸¸æˆçŠ¶æ€å˜æ›´**

```json
{
  "type": "state_changed",
  "data": {
    "session_id": "session-uuid-xxx",
    "changes": {
      "location": "å¹½æš—æ£®æ—",
      "game_time": "ç¬¬3å¤© 10:30",
      "combat": "active"
    },
    "timestamp": "2025-02-03T10:05:00Z"
  }
}
```

**3. æˆ˜æ–—äº‹ä»¶**

```json
{
  "type": "combat_updated",
  "data": {
    "session_id": "session-uuid-xxx",
    "combat_id": "combat-uuid-xxx",
    "action": "attack",
    "attacker": "player-123",
    "target": "goblin-1",
    "result": {
      "hit": true,
      "damage": 8
    },
    "timestamp": "2025-02-03T10:05:00Z"
  }
}
```

**4. éª°å­æŠ•æ·ç»“æœ**

```json
{
  "type": "dice_rolled",
  "data": {
    "session_id": "session-uuid-xxx",
    "player_id": "player-123",
    "roll_type": "attack",
    "formula": "1d20+5",
    "result": 18,
    "critical": false,
    "timestamp": "2025-02-03T10:05:00Z"
  }
}
```

**5. å¿ƒè·³å“åº”**

```json
{
  "type": "pong",
  "data": {
    "timestamp": "2025-02-03T10:00:00Z"
  }
}
```

**6. é”™è¯¯é€šçŸ¥**

```json
{
  "type": "error",
  "data": {
    "code": "MCP_SERVER_ERROR",
    "message": "MCP Server è¿æ¥å¤±è´¥",
    "timestamp": "2025-02-03T10:00:00Z"
  }
}
```

#### 5.2.3 WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸ

```
1. å»ºç«‹è¿æ¥
   Client â†’ Server: WebSocket æ¡æ‰‹è¯·æ±‚
   Server â†’ Client: WebSocket æ¡æ‰‹å“åº”
   Server â†’ Client: {type: "connected", data: {session_id, ...}}

2. ä¿æŒè¿æ¥
   Client â†’ Server: {type: "ping"} (æ¯30ç§’)
   Server â†’ Client: {type: "pong"}

3. æ¥æ”¶å®æ—¶äº‹ä»¶
   Server â†’ Client: {type: "state_changed", ...}
   Server â†’ Client: {type: "combat_updated", ...}

4. å…³é—­è¿æ¥
   Client â†’ Server: Close å¸§
   Server â†’ Client: Close å¸§
```

### 5.3 API é”™è¯¯ç å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é”™è¯¯ç å®šä¹‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTP çŠ¶æ€ç :
  200 OK              - è¯·æ±‚æˆåŠŸ
  201 Created         - èµ„æºåˆ›å»ºæˆåŠŸ
  204 No Content      - åˆ é™¤æˆåŠŸ
  400 Bad Request     - è¯·æ±‚å‚æ•°é”™è¯¯
  404 Not Found       - èµ„æºä¸å­˜åœ¨
  500 Internal Server Error - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
  503 Service Unavailable - æœåŠ¡ä¸å¯ç”¨

ä¸šåŠ¡é”™è¯¯ç :

é”™è¯¯ç æ ¼å¼: {SERVICE}_{ERROR_TYPE}_{SPECIFIC_ERROR}

ç¤ºä¾‹:
  SESSION_NOT_FOUND       - ä¼šè¯ä¸å­˜åœ¨
  MESSAGE_INVALID_CONTENT - æ¶ˆæ¯å†…å®¹æ— æ•ˆ
  LLM_RATE_LIMIT_EXCEEDED - LLM è°ƒç”¨é¢‘ç‡è¶…é™
  MCP_SERVER_UNAVAILABLE  - MCP Server ä¸å¯ç”¨
  REDIS_CONNECTION_FAILED - Redis è¿æ¥å¤±è´¥

é”™è¯¯å“åº”æ ¼å¼:
{
  "error": {
    "code": "SESSION_NOT_FOUND",
    "message": "æŒ‡å®šçš„ä¼šè¯ä¸å­˜åœ¨",
    "details": {
      "session_id": "invalid-uuid"
    },
    "timestamp": "2025-02-03T10:00:00Z",
    "request_id": "req-uuid-xxx"
  }
}
```

---

## å…­ã€æ•°æ®åº“å­˜å‚¨è®¾è®¡

### 6.1 Redis æ•°æ®ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Redis æ•°æ®ç»“æ„è®¾è®¡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ä¼šè¯å…ƒæ•°æ® (Hash)
   Key: session:{uuid}
   Type: Hash
   TTL: æ°¸ä¹…
   Fields:
     â€¢ id: UUID
     â€¢ name: string (ä¼šè¯åç§°)
     â€¢ creator_id: string (åˆ›å»ºè€…ID)
     â€¢ mcp_server_url: string (MCP Server URL)
     â€¢ websocket_key: string (WebSocketå¯†é’¥)
     â€¢ max_players: integer (æœ€å¤§ç©å®¶æ•°)
     â€¢ settings: JSON string (ä¼šè¯é…ç½®)
     â€¢ created_at: RFC3339 timestamp
     â€¢ updated_at: RFC3339 timestamp
     â€¢ status: string (active | archived)

   ç¤ºä¾‹:
   HGETALL session:123e4567-e89b-12d3-a456-426614174000
   {
     "id": "123e4567-e89b-12d3-a456-426614174000",
     "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
     "creator_id": "user-123",
     "mcp_server_url": "http://localhost:9000",
     "websocket_key": "ws-key-abc123",
     "max_players": "5",
     "settings": "{\"ruleset\":\"dnd5e\"}",
     "created_at": "2025-02-03T10:00:00Z",
     "updated_at": "2025-02-03T10:00:00Z",
     "status": "active"
   }

2. ä¼šè¯ç´¢å¼• (Set)
   Key: sessions:all
   Type: Set
   TTL: æ°¸ä¹…
   Members: æ‰€æœ‰æ´»è·ƒçš„ session UUID

   ç”¨é€”: å¿«é€Ÿåˆ—å‡ºæ‰€æœ‰ä¼šè¯

   ç¤ºä¾‹:
   SMEMBERS sessions:all
   ["123e4567-e89b-12d3-a456-426614174000", "789e0123-e89b-12d3-a456-426614174001"]

3. å¯¹è¯æ¶ˆæ¯ (Sorted Set)
   Key: msg:{session_uuid}
   Type: ZSET (æœ‰åºé›†åˆ)
   TTL: æ°¸ä¹…
   Score: Unix timestamp (æ¯«ç§’)
   Member: JSONåºåˆ—åŒ–çš„æ¶ˆæ¯å¯¹è±¡

   æ¶ˆæ¯ç»“æ„:
   {
     "id": "msg-uuid-xxx",
     "session_id": "session-uuid-xxx",
     "role": "user | assistant | system | tool",
     "content": "æ¶ˆæ¯å†…å®¹",
     "tool_calls": [              // å¯é€‰ï¼Œå·¥å…·è°ƒç”¨åˆ—è¡¨
       {
         "id": "call-xxx",
         "name": "resolve_attack",
         "arguments": {...}
       }
     ],
     "player_id": "player-123",   // å¯é€‰ï¼Œç©å®¶ID
     "created_at": "2025-02-03T10:00:00Z"
   }

   æ“ä½œ:
   â€¢ ZADD msg:{session_id} {timestamp} {json}  - æ·»åŠ æ¶ˆæ¯
   â€¢ ZREVRANGE msg:{session_id} 0 49          - è·å–æœ€è¿‘50æ¡
   â€¢ ZCARD msg:{session_id}                   - æ¶ˆæ¯æ€»æ•°
   â€¢ ZRANGEBYSCORE msg:{session_id} {min} {max} - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢

   ç¤ºä¾‹:
   ZADD msg:123e4567-e89b-12d3-a456-426614174000 1706926800000 '{"id":"msg-1","role":"user","content":"æ”»å‡»å“¥å¸ƒæ—"}'

4. ç³»ç»Ÿå…ƒæ•°æ® (String)
   Key: system:*
   Type: String
   TTL: æ°¸ä¹…

   a. system:status
      å€¼: starting | ready | persistence_in_progress | stopping

   b. system:last_persistence
      å€¼: Unix timestamp (ç§’)

   c. system:startup_time
      å€¼: Unix timestamp (ç§’)

   d. system:version
      å€¼: "1.0.0"

   ç¤ºä¾‹:
   SET system:status "ready"
   GET system:status
   > "ready"

5. WebSocket è¿æ¥ç´¢å¼• (Hash)
   Key: ws:connections:{session_uuid}
   Type: Hash
   TTL: åŠ¨æ€ï¼ˆè¿æ¥æ–­å¼€æ—¶åˆ é™¤ï¼‰
   Fields:
     â€¢ {connection_id}: JSON string (è¿æ¥ä¿¡æ¯)

   ç”¨é€”: è·Ÿè¸ªæ´»è·ƒçš„ WebSocket è¿æ¥

   ç¤ºä¾‹:
   HGETALL ws:connections:123e4567-e89b-12d3-a456-426614174000
   {
     "conn-1": "{\"player_id\":\"player-123\",\"connected_at\":\"2025-02-03T10:00:00Z\"}",
     "conn-2": "{\"player_id\":\"player-456\",\"connected_at\":\"2025-02-03T10:01:00Z\"}"
   }

6. æŒä¹…åŒ–æ ‡è®° (Set)
   Key: persistence:dirty
   Type: Set
   TTL: æ°¸ä¹…
   Members: éœ€è¦æŒä¹…åŒ–çš„ session UUID

   ç”¨é€”: æ ‡è®°è‡ªä¸Šæ¬¡æŒä¹…åŒ–ä»¥æ¥æœ‰å˜æ›´çš„ä¼šè¯

   ç¤ºä¾‹:
   SADD persistence:dirty 123e4567-e89b-12d3-a456-426614174000

7. é€Ÿç‡é™åˆ¶ (String)
   Key: ratelimit:{user_id}:{endpoint}
   Type: String
   TTL: åŠ¨æ€ï¼ˆå¦‚60ç§’ï¼‰
   Value: è¯·æ±‚è®¡æ•°

   ç”¨é€”: API é€Ÿç‡é™åˆ¶

   ç¤ºä¾‹:
   SET ratelimit:user-123:chat 10 EX 60
   INCR ratelimit:user-123:chat
```

### 6.2 PostgreSQL æ•°æ®ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PostgreSQL æ•°æ®ç»“æ„è®¾è®¡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. client_sessions (ä¼šè¯å…ƒæ•°æ®è¡¨)

   Columns:
     â€¢ id: UUID (PK)                           - ä¼šè¯ID
     â€¢ created_at: TIMESTAMP (NOT NULL)         - åˆ›å»ºæ—¶é—´
     â€¢ updated_at: TIMESTAMP (NOT NULL)         - æ›´æ–°æ—¶é—´
     â€¢ deleted_at: TIMESTAMP (NULLABLE)         - åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰
     â€¢ name: VARCHAR(255) (NOT NULL)            - ä¼šè¯åç§°
     â€¢ creator_id: VARCHAR(255) (NOT NULL)      - åˆ›å»ºè€…ID
     â€¢ mcp_server_url: VARCHAR(512) (NOT NULL)  - MCP Server URL
     â€¢ websocket_key: VARCHAR(255) (NOT NULL)   - WebSocketå¯†é’¥
     â€¢ max_players: INTEGER (NULLABLE)          - æœ€å¤§ç©å®¶æ•°
     â€¢ settings: JSONB (NULLABLE)               - ä¼šè¯é…ç½®
     â€¢ status: VARCHAR(20) (NOT NULL)           - çŠ¶æ€

   Indexes:
     â€¢ idx_sessions_created_at (created_at DESC)
     â€¢ idx_sessions_updated_at (updated_at DESC)
     â€¢ idx_sessions_deleted_at (deleted_at)
     â€¢ idx_sessions_creator_id (creator_id)
     â€¢ idx_sessions_status (status)

   Constraints:
     â€¢ PRIMARY KEY (id)
     â€¢ CHECK (deleted_at IS NULL OR updated_at >= deleted_at)

   SQL:
   CREATE TABLE client_sessions (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     created_at TIMESTAMP NOT NULL DEFAULT NOW(),
     updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
     deleted_at TIMESTAMP,
     name VARCHAR(255) NOT NULL,
     creator_id VARCHAR(255) NOT NULL,
     mcp_server_url VARCHAR(512) NOT NULL,
     websocket_key VARCHAR(255) NOT NULL,
     max_players INTEGER,
     settings JSONB,
     status VARCHAR(20) NOT NULL DEFAULT 'active',
     CHECK (deleted_at IS NULL OR updated_at >= deleted_at)
   );

   CREATE INDEX idx_sessions_created_at ON client_sessions(created_at DESC);
   CREATE INDEX idx_sessions_updated_at ON client_sessions(updated_at DESC);
   CREATE INDEX idx_sessions_deleted_at ON client_sessions(deleted_at);
   CREATE INDEX idx_sessions_creator_id ON client_sessions(creator_id);
   CREATE INDEX idx_sessions_status ON client_sessions(status);

2. client_messages (å¯¹è¯æ¶ˆæ¯è¡¨)

   Columns:
     â€¢ id: UUID (PK)                          - æ¶ˆæ¯ID
     â€¢ session_id: UUID (FK)                  - ä¼šè¯ID
     â€¢ created_at: TIMESTAMP (NOT NULL)        - åˆ›å»ºæ—¶é—´
     â€¢ role: VARCHAR(20) (NOT NULL)           - è§’è‰²
     â€¢ content: TEXT (NULLABLE)               - æ¶ˆæ¯å†…å®¹
     â€¢ tool_calls: JSONB (NULLABLE)           - å·¥å…·è°ƒç”¨
     â€¢ player_id: VARCHAR(255) (NULLABLE)     - ç©å®¶ID

   Indexes:
     â€¢ idx_messages_session_time (session_id, created_at DESC)
     â€¢ idx_messages_role (role)
     â€¢ idx_messages_player (player_id)

   Constraints:
     â€¢ PRIMARY KEY (id)
     â€¢ FOREIGN KEY (session_id)
       REFERENCES client_sessions(id)
       ON DELETE CASCADE
     â€¢ UNIQUE (id) - é˜²æ­¢é‡å¤æ’å…¥
     â€¢ CHECK (role IN ('system', 'user', 'assistant', 'tool'))

   SQL:
   CREATE TABLE client_messages (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     session_id UUID NOT NULL,
     created_at TIMESTAMP NOT NULL DEFAULT NOW(),
     role VARCHAR(20) NOT NULL,
     content TEXT,
     tool_calls JSONB,
     player_id VARCHAR(255),
     CONSTRAINT fk_session
       FOREIGN KEY (session_id)
       REFERENCES client_sessions(id)
       ON DELETE CASCADE,
     CONSTRAINT valid_role
       CHECK (role IN ('system', 'user', 'assistant', 'tool'))
   );

   CREATE INDEX idx_messages_session_time
     ON client_messages(session_id, created_at DESC);
   CREATE INDEX idx_messages_role
     ON client_messages(role);
   CREATE INDEX idx_messages_player
     ON client_messages(player_id);

3. persistence_snapshots (æŒä¹…åŒ–å¿«ç…§è¡¨)

   Columns:
     â€¢ id: UUID (PK)                          - å¿«ç…§ID
     â€¢ created_at: TIMESTAMP (NOT NULL)        - åˆ›å»ºæ—¶é—´
     â€¢ session_count: INTEGER (NOT NULL)       - ä¼šè¯æ•°é‡
     â€¢ message_count: INTEGER (NOT NULL)       - æ¶ˆæ¯æ•°é‡
     â€¢ duration_ms: INTEGER (NOT NULL)         - æŒä¹…åŒ–è€—æ—¶
     â€¢ status: VARCHAR(20) (NOT NULL)         - çŠ¶æ€

   Indexes:
     â€¢ idx_snapshots_created_at (created_at DESC)

   SQL:
   CREATE TABLE persistence_snapshots (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     created_at TIMESTAMP NOT NULL DEFAULT NOW(),
     session_count INTEGER NOT NULL,
     message_count INTEGER NOT NULL,
     duration_ms INTEGER NOT NULL,
     status VARCHAR(20) NOT NULL
   );

   CREATE INDEX idx_snapshots_created_at
     ON persistence_snapshots(created_at DESC);

4. system_events (ç³»ç»Ÿäº‹ä»¶è¡¨)

   Columns:
     â€¢ id: UUID (PK)                          - äº‹ä»¶ID
     â€¢ created_at: TIMESTAMP (NOT NULL)        - åˆ›å»ºæ—¶é—´
     â€¢ event_type: VARCHAR(50) (NOT NULL)      - äº‹ä»¶ç±»å‹
     â€¢ level: VARCHAR(20) (NOT NULL)          - æ—¥å¿—çº§åˆ«
     â€¢ message: TEXT (NOT NULL)               - äº‹ä»¶æ¶ˆæ¯
     â€¢ data: JSONB (NULLABLE)                 - é™„åŠ æ•°æ®

   Indexes:
     â€¢ idx_events_created_at (created_at DESC)
     â€¢ idx_events_type (event_type)
     â€¢ idx_events_level (level)

   SQL:
   CREATE TABLE system_events (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     created_at TIMESTAMP NOT NULL DEFAULT NOW(),
     event_type VARCHAR(50) NOT NULL,
     level VARCHAR(20) NOT NULL,
     message TEXT NOT NULL,
     data JSONB
   );

   CREATE INDEX idx_events_created_at
     ON system_events(created_at DESC);
   CREATE INDEX idx_events_type
     ON system_events(event_type);
   CREATE INDEX idx_events_level
     ON system_events(level);

5. æ•°æ®åº“è¿ç§»

   è¿ç§»æ–‡ä»¶: /migrations/
   æ ¼å¼: {version}_{description}.sql

   ç¤ºä¾‹:
   /migrations/
     001_initial_schema.sql
     002_add_persistence_snapshots.sql
     003_add_system_events.sql

   è¿ç§»å·¥å…·: golang-migrate
   æ‰§è¡Œ:
     migrate -path migrations -database "postgres://..." up
```

### 6.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®ä¸€è‡´æ€§ä¿è¯ç­–ç•¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Redis ä½œä¸ºä¸»å­˜å‚¨
   â€¢ æ‰€æœ‰è¯»å†™æ“ä½œå…ˆè®¿é—® Redis
   â€¢ ä¿è¯ <1ms å“åº”æ—¶é—´
   â€¢ ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œ

2. PostgreSQL ä½œä¸ºå¤‡ä»½
   â€¢ å®šæœŸä» Redis æŒä¹…åŒ–åˆ° PG
   â€¢ ä½¿ç”¨ UPSERT é¿å…é‡å¤
   â€¢ ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§

3. æŒä¹…åŒ–ç­–ç•¥
   a. å®šæœŸæŒä¹…åŒ–ï¼ˆæ¯30ç§’ï¼‰
      â€¢ éå†æ‰€æœ‰ä¼šè¯
      â€¢ æ‰¹é‡å†™å…¥ PostgreSQL
      â€¢ è®°å½•æŒä¹…åŒ–å¿«ç…§

   b. å…³é”®æ“ä½œç«‹å³æŒä¹…åŒ–
      â€¢ ä¼šè¯åˆ›å»º
      â€¢ ä¼šè¯åˆ é™¤
      â€¢ ç«‹å³æ ‡è®°ä¸º dirty

4. æ•°æ®æ¢å¤
   a. ç³»ç»Ÿå¯åŠ¨æ—¶
      â€¢ ä» PostgreSQL åŠ è½½æ•°æ®
      â€¢ å†™å…¥ Redis
      â€¢ éªŒè¯æ•°æ®å®Œæ•´æ€§

   b. å´©æºƒæ¢å¤
      â€¢ åŠ è½½ä¸Šä¸€æ¬¡æŒä¹…åŒ–ç‚¹
      â€¢ å¯èƒ½ä¸¢å¤± 30 ç§’æ•°æ®

5. æ•°æ®æ ¡éªŒ
   a. å®šæœŸæ ¡éªŒ
      â€¢ å¯¹æ¯” Redis å’Œ PG æ•°æ®é‡
      â€¢ æ£€æµ‹ä¸ä¸€è‡´æƒ…å†µ

   b. ä¿®å¤ç­–ç•¥
      â€¢ ä»¥ Redis ä¸ºå‡†ï¼ˆä¸»å­˜å‚¨ï¼‰
      â€¢ é‡æ–°æŒä¹…åŒ–åˆ° PG

6. å¹‚ç­‰æ€§ä¿è¯
   â€¢ æ‰€æœ‰å†™æ“ä½œæ”¯æŒå¹‚ç­‰
   â€¢ ä½¿ç”¨ UUID å”¯ä¸€æ ‡è¯†
   â€¢ ON CONFLICT DO NOTHING
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 Redis ä¼˜åŒ–

```
1. ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œ
   â€¢ å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
   â€¢ ä¸€æ¬¡æ€§å‘é€å¤šä¸ªå‘½ä»¤

2. åˆç†è®¾ç½® TTL
   â€¢ ä¸´æ—¶æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´
   â€¢ é¿å…å†…å­˜æ— é™å¢é•¿

3. ä½¿ç”¨è¿æ¥æ± 
   â€¢ å¤ç”¨è¿æ¥
   â€¢ å‡å°‘è¿æ¥å»ºç«‹å¼€é”€

4. å‹ç¼©å­˜å‚¨
   â€¢ JSON æ•°æ®å‹ç¼©
   â€¢ å‡å°‘ Redis å†…å­˜å ç”¨
```

### 7.2 PostgreSQL ä¼˜åŒ–

```
1. æ‰¹é‡æ’å…¥
   â€¢ ä½¿ç”¨ COPY å‘½ä»¤
   â€¢ æˆ–ä½¿ç”¨ VALUES (), (), ()

2. ç´¢å¼•ä¼˜åŒ–
   â€¢ ä¸ºæŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
   â€¢ å®šæœŸ ANALYZE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

3. è¿æ¥æ± 
   â€¢ ä½¿ç”¨ pgx è¿æ¥æ± 
   â€¢ å¤ç”¨æ•°æ®åº“è¿æ¥

4. åˆ†åŒºè¡¨
   â€¢ æŒ‰æ—¶é—´åˆ†åŒº client_messages
   â€¢ æå‡æŸ¥è¯¢æ€§èƒ½
```

### 7.3 åº”ç”¨å±‚ä¼˜åŒ–

```
1. å¹¶è¡Œå¤„ç†
   â€¢ ä½¿ç”¨ goroutine å¹¶è¡Œå¤„ç†ä¼šè¯
   â€¢ åŠ å¿«æŒä¹…åŒ–é€Ÿåº¦

2. ç¼“å­˜ç­–ç•¥
   â€¢ ç¼“å­˜ä¼šè¯å…ƒæ•°æ®
   â€¢ ç¼“å­˜ MCP Server çŠ¶æ€

3. æµå¼å“åº”
   â€¢ æ”¯æŒ SSE æµå¼è¿”å›
   â€¢ æå‡ LLM å“åº”ä½“éªŒ

4. é™æµä¿æŠ¤
   â€¢ API é€Ÿç‡é™åˆ¶
   â€¢ é˜²æ­¢èµ„æºè€—å°½
```

---

## å…«ã€ç›‘æ§å’Œæ—¥å¿—

### 8.1 ç›‘æ§æŒ‡æ ‡

```
1. ç³»ç»ŸæŒ‡æ ‡
   â€¢ CPU ä½¿ç”¨ç‡
   â€¢ å†…å­˜ä½¿ç”¨é‡
   â€¢ Goroutine æ•°é‡
   â€¢ GC æš‚åœæ—¶é—´

2. ä¸šåŠ¡æŒ‡æ ‡
   â€¢ è¯·æ±‚æ€»æ•°
   â€¢ å“åº”æ—¶é—´ (P50, P95, P99)
   â€¢ é”™è¯¯ç‡
   â€¢ æ´»è·ƒä¼šè¯æ•°

3. æ•°æ®åº“æŒ‡æ ‡
   â€¢ Redis å‘½ä»¤è€—æ—¶
   â€¢ PostgreSQL æŸ¥è¯¢è€—æ—¶
   â€¢ è¿æ¥æ± ä½¿ç”¨ç‡

4. å¤–éƒ¨æœåŠ¡æŒ‡æ ‡
   â€¢ LLM è°ƒç”¨æ¬¡æ•°å’Œè€—æ—¶
   â€¢ MCP Server è°ƒç”¨æ¬¡æ•°å’Œè€—æ—¶
```

### 8.2 æ—¥å¿—è§„èŒƒ

```
1. æ—¥å¿—çº§åˆ«
   â€¢ Debug: è¯¦ç»†è°ƒè¯•ä¿¡æ¯
   â€¢ Info: ä¸€èˆ¬ä¿¡æ¯
   â€¢ Warn: è­¦å‘Šä¿¡æ¯
   â€¢ Error: é”™è¯¯ä¿¡æ¯
   â€¢ Fatal: è‡´å‘½é”™è¯¯

2. æ—¥å¿—æ ¼å¼
   {
     "level": "info",
     "time": "2025-02-03T10:00:00Z",
     "msg": "ä¼šè¯åˆ›å»ºæˆåŠŸ",
     "session_id": "xxx",
     "duration_ms": 50
   }

3. ç»“æ„åŒ–æ—¥å¿—
   â€¢ ä½¿ç”¨ JSON æ ¼å¼
   â€¢ åŒ…å«è¯·æ±‚ ID
   â€¢ åŒ…å«å…³é”®ä¸šåŠ¡å­—æ®µ

4. æ—¥å¿—èšåˆ
   â€¢ é›†ä¸­æ”¶é›†åˆ°æ—¥å¿—ç³»ç»Ÿ
   â€¢ æ”¯æŒæ£€ç´¢å’Œåˆ†æ
```

---

## ä¹ã€éƒ¨ç½²é…ç½®

### 9.1 ç¯å¢ƒå˜é‡

```
# åº”ç”¨é…ç½®
APP_NAME=dnd-client
APP_VERSION=1.0.0
APP_ENV=production

# HTTP æœåŠ¡
HTTP_HOST=0.0.0.0
HTTP_PORT=8080
HTTP_READ_TIMEOUT=30s
HTTP_WRITE_TIMEOUT=30s

# WebSocket
WS_READ_BUFFER_SIZE=1024
WS_WRITE_BUFFER_SIZE=1024
WS_PING_PERIOD=30s
WS_PONG_WAIT=10s

# Redis
REDIS_HOST=localhost:6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_POOL_SIZE=10
REDIS_MIN_IDLE_CONNS=5

# PostgreSQL
POSTGRES_HOST=localhost:5432
POSTGRES_USER=dnd
POSTGRES_PASSWORD=password
POSTGRES_DBNAME=dnd_client
POSTGRES_SSLMODE=disable
POSTGRES_POOL_SIZE=5
POSTGRES_MAX_CONN_LIFETIME=1h
POSTGRES_MAX_CONN_IDLETIME=30m

# LLM
LLM_PROVIDER=openai
LLM_API_KEY=sk-xxx
LLM_MODEL=gpt-4
LLM_MAX_TOKENS=4096
LLM_TEMPERATURE=0.7
LLM_TIMEOUT=30s

# æŒä¹…åŒ–è§¦å‘å™¨é…ç½®
PERSISTENCE_TYPE=time              # è§¦å‘å™¨ç±»å‹: time | message | manual | composite
PERSISTENCE_INTERVAL=30s           # æ—¶é—´è§¦å‘å™¨é—´éš”
PERSISTENCE_MESSAGE_THRESHOLD=100  # æ¶ˆæ¯é‡è§¦å‘å™¨é˜ˆå€¼ï¼ˆé¢„ç•™ï¼‰
PERSISTENCE_BATCH_SIZE=100         # æ‰¹é‡å¤„ç†å¤§å°
PERSISTENCE_TIMEOUT=10s            # æŒä¹…åŒ–è¶…æ—¶æ—¶é—´

# æ—¥å¿—
LOG_LEVEL=info
LOG_FORMAT=json
LOG_OUTPUT=stdout
```

### 9.2 æœ¬åœ°éƒ¨ç½²

#### Windows ç¯å¢ƒ

1. å®‰è£…ä¾èµ–:
   - Go 1.21+
   - Redis 7.0+ (æ¨è: https://github.com/tporadowski/redis/releases)
   - PostgreSQL 15+ (æ¨è: https://www.enterprisedb.com/downloads/postgres-postgresql-downloads)

2. å¯åŠ¨æœåŠ¡:

```powershell
# å¯åŠ¨ Redis
net start Redis

# å¯åŠ¨ PostgreSQL
net start postgresql-x64-15
```

3. é…ç½®ç¯å¢ƒå˜é‡:

```powershell
$env:REDIS_HOST="localhost:6379"
$env:POSTGRES_HOST="localhost:5432"
$env:POSTGRES_USER="dnd"
$env:POSTGRES_PASSWORD="password"
$env:POSTGRES_DBNAME="dnd_client"
```

4. è¿è¡Œåº”ç”¨:

```powershell
.\bin\dnd-client.exe
```

#### Linux/Mac ç¯å¢ƒ

1. å®‰è£…ä¾èµ–:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install golang redis-server postgresql

# macOS
brew install go redis postgresql
```

2. å¯åŠ¨æœåŠ¡:

```bash
# å¯åŠ¨ Redis
sudo systemctl start redis
# æˆ–
redis-server

# å¯åŠ¨ PostgreSQL
sudo systemctl start postgresql
```

3. é…ç½®æ•°æ®åº“:

```bash
# åˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“
sudo -u postgres psql
CREATE USER dnd WITH PASSWORD 'password';
CREATE DATABASE dnd_client OWNER dnd;
GRANT ALL PRIVILEGES ON DATABASE dnd_client TO dnd;
\q
```

4. è¿è¡Œåº”ç”¨:

```bash
./bin/dnd-client
```

---

## åã€æµ‹è¯•ç­–ç•¥

### 10.1 å•å…ƒæµ‹è¯•

```
1. Repository å±‚æµ‹è¯•
   â€¢ Mock Redis å’Œ PostgreSQL
   â€¢ æµ‹è¯•æ•°æ®è®¿é—®é€»è¾‘

2. Service å±‚æµ‹è¯•
   â€¢ Mock Repository
   â€¢ æµ‹è¯•ä¸šåŠ¡é€»è¾‘

3. Handler å±‚æµ‹è¯•
   â€¢ ä½¿ç”¨ httptest
   â€¢ æµ‹è¯• HTTP æ¥å£
```

### 10.2 é›†æˆæµ‹è¯•

```
1. æ•°æ®åº“é›†æˆæµ‹è¯•
   â€¢ ä½¿ç”¨ testcontainers
   â€¢ å¯åŠ¨çœŸå®çš„ Redis å’Œ PostgreSQL

2. MCP Server é›†æˆæµ‹è¯•
   â€¢ Mock MCP Server
   â€¢ æµ‹è¯•åè®®äº¤äº’

3. ç«¯åˆ°ç«¯æµ‹è¯•
   â€¢ æµ‹è¯•å®Œæ•´æµç¨‹
   â€¢ ä» HTTP è¯·æ±‚åˆ°æ•°æ®åº“
```

### 10.3 æ€§èƒ½æµ‹è¯•

```
1. åŸºå‡†æµ‹è¯•
   â€¢ ä½¿ç”¨ Go benchmark
   â€¢ æµ‹è¯•å…³é”®å‡½æ•°æ€§èƒ½

2. å‹åŠ›æµ‹è¯•
   â€¢ ä½¿ç”¨ vegeta æˆ– k6
   â€¢ æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚

3. è´Ÿè½½æµ‹è¯•
   â€¢ æµ‹è¯•ç³»ç»Ÿå®¹é‡
   â€¢ æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† DND MCP Client çš„è®¾è®¡ï¼ŒåŒ…æ‹¬:

1. **æ‰§è¡Œæµç¨‹**: 7 ä¸ªæ ¸å¿ƒæµç¨‹çš„è¯¦ç»†æ­¥éª¤ï¼ˆæ–°å¢æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡ï¼‰
2. **ç»„ä»¶äº¤äº’**: æ¸…æ™°çš„æ¶æ„å±‚æ¬¡å’Œé€šä¿¡æ–¹å¼
3. **API è®¾è®¡**: ç®€æ´çš„ REST API å’Œ WebSocket API è®¾è®¡
4. **æ•°æ®å­˜å‚¨**: Redis å’Œ PostgreSQL æ•°æ®ç»“æ„è®¾è®¡

æ ¸å¿ƒç‰¹ç‚¹:

- âœ… è½»é‡çº§æœ‰çŠ¶æ€è®¾è®¡
- âœ… Redis ä¸»å­˜å‚¨ (<1ms å“åº”)
- âœ… PostgreSQL å®šæœŸå¤‡ä»½
- âœ… **çµæ´»çš„æŒä¹…åŒ–è§¦å‘æœºåˆ¶**ï¼ˆæ”¯æŒæ—¶é—´ã€æ¶ˆæ¯é‡ã€æ‰‹åŠ¨ã€ç»„åˆè§¦å‘ï¼‰
- âœ… **ç®€æ´çš„ API è®¾è®¡**ï¼ˆæ— åˆ†é¡µï¼Œé€‚åˆä¸­å°è§„æ¨¡åœºæ™¯ï¼‰
- âœ… å®æ—¶ WebSocket æ¨é€
- âœ… ä¼˜é›…çš„æ•…éšœå¤„ç†
- âœ… æ˜“äºæ‰©å±•çš„æ¶æ„è®¾è®¡

é€‚ç”¨åœºæ™¯:

- å•å®ä¾‹éƒ¨ç½²
- 4-5 ä¸ªå¹¶å‘ä¼šè¯
- å¯æ¥å— 30 ç§’æ•°æ®ä¸¢å¤±
- è¿½æ±‚å¿«é€Ÿå“åº”æ—¶é—´
- API è°ƒç”¨é‡ä¸­ç­‰ï¼ˆä¸éœ€è¦å¤æ‚åˆ†é¡µï¼‰

è®¾è®¡äº®ç‚¹:

1. **æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡**
   
   - æ¥å£åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
   - æ”¯æŒå¤šç§è§¦å‘ç­–ç•¥ï¼ˆæ—¶é—´ã€æ¶ˆæ¯é‡ã€æ‰‹åŠ¨ã€ç»„åˆï¼‰
   - å½“å‰å®ç°ï¼šæ—¶é—´è§¦å‘å™¨ï¼ˆ30ç§’ï¼‰
   - é¢„ç•™æ‰©å±•ï¼šæ¶ˆæ¯é‡è§¦å‘å™¨ã€æ‰‹åŠ¨è§¦å‘å™¨
   - é…ç½®åŒ–ç®¡ç†ï¼Œçµæ´»åˆ‡æ¢è§¦å‘ç­–ç•¥

2. **API è®¾è®¡ç®€åŒ–**
   
   - åˆ é™¤å¤æ‚çš„åˆ†é¡µã€æ’åºå‚æ•°
   - ç›´æ¥è¿”å›æ•°ç»„ï¼Œç»“æ„ç®€å•
   - é€‚åˆä¸­å°è§„æ¨¡åœºæ™¯ï¼ˆ< 100 ä¸ªä¼šè¯ï¼‰
   - æå‡å¼€å‘æ•ˆç‡å’Œæ˜“ç”¨æ€§

3. **å¯æ‰©å±•æ€§**
   
   - è§¦å‘å™¨æ¥å£é¢„ç•™æ‰©å±•ç‚¹
   - æ–°å¢è§¦å‘å™¨æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
   - æ”¯æŒè§¦å‘å™¨ç»„åˆï¼Œçµæ´»é…ç½®

ç‰ˆæœ¬è¯´æ˜:

- v1.1: æ·»åŠ æŒä¹…åŒ–è§¦å‘å™¨è®¾è®¡ï¼Œç®€åŒ– API å‚æ•°
- v1.0: åˆå§‹ç‰ˆæœ¬
