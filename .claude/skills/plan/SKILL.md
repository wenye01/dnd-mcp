---
name: plan
description: 将详细设计转化为增量开发计划。按需求分解为任务，每个任务是完整的垂直切片（数据层→业务层→接口层→测试层），可独立开发、测试、验证。相关任务组成里程碑。
disable-model-invocation: true
allowed-tools: Read, Glob, Grep, Write, Edit
argument-hint: [design-doc]
---

# 增量开发计划

将详细设计文档转化为任务驱动的增量开发计划。每个任务是完整的垂直切片，可独立开发、测试、验证。

## 输入

**设计文档**: $ARGUMENTS

（通常是 `/refine` 输出的详细设计书）

## 核心概念

### 任务（Task）- 开发的最小单位

```
任务 = 完整的垂直切片

每个任务必须包含：
  ├─ 数据层: 模型定义、存储实现
  ├─ 业务层: 服务逻辑、业务规则
  ├─ 接口层: HTTP Handler、路由注册
  └─ 测试层: 单元测试 + 集成测试

任务特性：
  ├─ 可独立开发 - 不依赖其他未完成任务
  ├─ 可独立测试 - 有完整的测试用例
  ├─ 可独立验证 - 能通过 API 或测试验证功能
  └─ 有明确产出 - 完成后有一个可验证的功能点
```

### 里程碑（Milestone）- 阶段性交付

```
里程碑 = 一组相关任务的集合

里程碑特性：
  ├─ 有业务主题 - 如"会话管理"、"消息系统"
  ├─ 有交付价值 - 完成后可交付给用户使用
  ├─ 有验收标准 - 明确的里程碑级验收条件
  └─ 可部署 - 能部署到测试/生产环境
```

### 计划结构

```
计划
  ├─ Milestone 1: [主题]
  │   ├─ Task 1-1: [功能点A]
  │   ├─ Task 1-2: [功能点B]
  │   └─ Task 1-3: [功能点C]
  │
  ├─ Milestone 2: [主题]
  │   ├─ Task 2-1: [功能点D]
  │   └─ Task 2-2: [功能点E]
  │
  └─ ...
```

## 任务定义规范

### 任务模板

```markdown
### Task [ID]: [任务名称]

**一句话描述**: [做什么，产出什么]

#### 需求来源
- 设计文档章节: [链接/章节号]
- 需求ID: [如 R1, R2]

#### 实现范围

**数据层**:
- 模型: [要定义的数据结构]
- 存储: [要实现的存储方法]

**业务层**:
- 服务: [要实现的服务方法]
- 规则: [要实现的业务规则]

**接口层**:
- 端点: [要暴露的 API 端点]
- 请求: [请求结构]
- 响应: [响应结构]

**测试层**:
- 单元测试: [测试场景]
- 集成测试: [测试场景]

#### 约束条件
- 前置任务: [依赖的任务ID，无则为 -]
- 技术约束: [必须遵循的技术规范]
- 边界条件: [需要处理的边界情况]

#### 验收标准
- [ ] 实现完成: 代码已编写，无编译错误
- [ ] 测试通过: 单元测试 + 集成测试通过
- [ ] 功能验证: 能通过 API 调用验证功能
- [ ] 代码质量: 通过静态检查

#### 文件清单
| 操作 | 文件路径 | 说明 |
|------|----------|------|
| 新增 | internal/models/xxx.go | 模型定义 |
| 新增 | internal/store/xxx.go | 存储实现 |
| 新增 | internal/service/xxx.go | 服务实现 |
| 新增 | internal/api/handler/xxx.go | 接口实现 |
| 新增 | tests/unit/xxx_test.go | 单元测试 |
| 新增 | tests/integration/xxx_test.go | 集成测试 |
```

### 任务粒度指南

```
合适的任务粒度：
  ✓ 一个 API 端点的完整实现
  ✓ 一个业务用例的完整实现
  ✓ 一个数据实体的 CRUD 操作

不合适的任务粒度：
  ✗ 太大: "实现用户模块"（应拆分为多个任务）
  ✗ 太小: "定义 User 结构体"（不是一个完整切片）
  ✗ 横向: "实现所有数据库操作"（应该是垂直切片）
```

## 里程碑定义规范

### 里程碑模板

```markdown
## Milestone [N]: [里程碑名称]

### 目标
[一句话描述本里程碑交付的业务价值]

### 范围
- 包含: [功能范围]
- 不包含: [明确排除的内容]

### 任务清单
| ID | 任务名称 | 依赖 | 状态 |
|----|----------|------|------|
| T1-1 | [任务名] | - | 待开发 |
| T1-2 | [任务名] | T1-1 | 待开发 |
| T1-3 | [任务名] | - | 待开发 |

### 验收标准
- [ ] 所有任务完成
- [ ] 所有测试通过
- [ ] 集成测试验证完整流程
- [ ] 可部署到测试环境

### 交付物
- [ ] 可运行的服务
- [ ] 测试报告
- [ ] 更新的文档（如有）
```

## 执行流程

### 第一步：分析设计文档

```
1. 读取详细设计文档
2. 识别所有功能点
3. 提取数据模型、接口定义、业务流程
4. 标注功能间的依赖关系
```

### 第二步：拆分任务

```
对每个功能点：

1. 确定任务边界
   - 这个功能点能否独立验证？
   - 需要哪些层次的支持？

2. 检查依赖
   - 是否依赖其他未拆分的任务？
   - 依赖的任务是否已拆分？

3. 定义实现范围
   - 数据层: 需要什么模型和存储？
   - 业务层: 需要什么服务和规则？
   - 接口层: 需要什么端点？
   - 测试层: 需要什么测试？

4. 编写任务定义
```

### 第三步：组织里程碑

```
1. 按业务主题分组任务
2. 确定里程碑顺序（考虑依赖关系）
3. 为每个里程碑定义验收标准
4. 生成任务依赖图
```

### 第四步：生成计划文档

```
输出: docs/开发计划-[主题].md

结构:
  ├─ 概述
  ├─ 里程碑总览
  ├─ 任务依赖图
  ├─ 详细任务定义
  │   ├─ Milestone 1
  │   │   ├─ Task 1-1
  │   │   ├─ Task 1-2
  │   │   └─ ...
  │   ├─ Milestone 2
  │   └─ ...
  ├─ 风险评估
  └─ 执行建议
```

## 输出文档模板

```markdown
# 开发计划: [项目/功能名称]

## 1. 概述

### 1.1 目标
[开发计划的总体目标]

### 1.2 输入
- 设计文档: [链接]
- 需求规格: [链接]

### 1.3 约束
- 技术栈: Go 1.24+, Redis, PostgreSQL
- 架构模式: Handler → Service → Store
- 测试要求: 单元测试 + 集成测试

---

## 2. 里程碑总览

| 里程碑 | 主题 | 任务数 | 核心交付 |
|--------|------|--------|----------|
| M1 | [主题] | 3 | [交付物] |
| M2 | [主题] | 4 | [交付物] |
| M3 | [主题] | 2 | [交付物] |

### 依赖关系

```
M1 ──> M2 ──> M3
       │
       └──> M4
```

---

## 3. 任务依赖图

```
                    T1-1 (基础设施)
                        │
            ┌───────────┼───────────┐
            │           │           │
            v           v           v
         T1-2        T1-3        T1-4
         (功能A)     (功能B)     (功能C)
            │           │
            v           v
         T2-1 ──────> T2-2
         (功能D)     (功能E)
```

---

## 4. Milestone 1: [名称]

### 4.1 目标
[本里程碑的业务目标]

### 4.2 范围
- 包含: ...
- 不包含: ...

### 4.3 任务清单

| ID | 任务名称 | 依赖 | 复杂度 |
|----|----------|------|--------|
| T1-1 | [任务名] | - | S |
| T1-2 | [任务名] | T1-1 | M |
| T1-3 | [任务名] | T1-1 | S |

### 4.4 验收标准
- [ ] 所有任务完成并通过测试
- [ ] 端到端流程验证通过
- [ ] 可部署到测试环境

---

## 5. 详细任务定义

### Task T1-1: [任务名称]

**一句话描述**: [做什么，产出什么]

#### 需求来源
- 设计文档: 第X章第Y节
- 需求ID: R1

#### 实现范围

**数据层**:
- 模型: `Session` 结构体，包含 ID, Name, CreatedAt 等字段
- 存储: `SessionStore` 接口，实现 Create, Get, List, Delete 方法

**业务层**:
- 服务: `SessionService.Create()`, `SessionService.Get()` 等
- 规则: 会话名称不能为空，ID 自动生成

**接口层**:
- 端点: `POST /api/sessions`, `GET /api/sessions/:id`
- 请求: `CreateSessionRequest{ name: string }`
- 响应: `SessionResponse{ id, name, created_at }`

**测试层**:
- 单元测试: 测试 Session 模型方法、Service 业务逻辑
- 集成测试: 测试 API 端点的完整流程

#### 约束条件
- 前置任务: 无
- 技术约束: 使用 Redis 作为存储，key 格式为 `session:{id}`
- 边界条件: 处理会话不存在、名称重复等情况

#### 验收标准
- [ ] 实现完成: 代码已编写，无编译错误
- [ ] 测试通过: `go test ./tests/unit/... ./tests/integration/...` 通过
- [ ] 功能验证: `curl -X POST http://localhost:8080/api/sessions` 返回正确响应
- [ ] 代码质量: 无 go vet 错误

#### 文件清单
| 操作 | 文件路径 | 说明 |
|------|----------|------|
| 新增 | internal/models/session.go | Session 模型 |
| 新增 | internal/store/interface.go | Store 接口定义 |
| 新增 | internal/store/redis/session.go | Redis 实现 |
| 新增 | internal/service/session.go | Session 服务 |
| 新增 | internal/api/handler/session.go | HTTP Handler |
| 新增 | tests/unit/models/session_test.go | 模型单元测试 |
| 新增 | tests/integration/session_test.go | 集成测试 |

---

### Task T1-2: [任务名称]
...

---

## 6. 风险评估

| 风险 | 影响任务 | 概率 | 影响 | 缓解措施 |
|------|----------|------|------|----------|
| [风险] | T1-X | 中 | 高 | [措施] |

---

## 7. 执行建议

### 7.1 开发流程
1. 按任务依赖顺序执行
2. 每完成一个任务运行测试验证
3. 每完成一个里程碑进行集成验收

### 7.2 验证命令
```powershell
# 运行单个任务的测试
go test -v ./tests/unit/models/session_test.go
go test -v ./tests/integration/session_test.go

# 运行里程碑的所有测试
.\scripts\test.ps1

# 完整测试
.\scripts\test-all.ps1
```

### 7.3 提交策略
- 每完成一个任务提交一次
- 提交信息格式: `feat(M1): 完成 T1-1 会话创建功能`
```

## 完成检查

计划完成后，确认以下问题可回答：

- [ ] 每个任务是否是完整的垂直切片？
- [ ] 每个任务是否可独立验证？
- [ ] 任务依赖是否清晰？
- [ ] 里程碑验收标准是否明确？
- [ ] 文件清单是否完整？

全部可回答 → 计划完成，可开始实现

## 与其他 Skill 的关系

```
elicit     → 需求澄清
    ↓
design     → 高层次设计
    ↓
refine     → 详细设计
    ↓
plan       → 开发计划  ← 当前
    ↓
[实现]     → 按任务逐个开发
    ↓
test       → 测试验证
```

## 输出位置

`docs/开发计划-[主题].md`

---

**当前设计文档**: $ARGUMENTS

开始生成开发计划...
