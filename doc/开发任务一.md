# 开发任务一：项目脚手架 + Redis 基础存储

## 文档信息

- **任务编号**: Task-1
- **任务名称**: 项目脚手架 + Redis 基础存储
- **预估时间**: 2天
- **基于文档**: DND_MCP_Client详细设计.md v1.1、DND_MCP_Client_开发计划.md v1.0
- **必须遵守**: doc/规范.md

---

## 任务概述

### 目标

搭建项目基础架构，实现基于 Redis 的会话和消息存储，提供命令行工具进行测试。

### 可演示功能

```bash
# 创建会话
./bin/dnd-client session create --name "测试会话" --creator "user-123"

# 查看会话
./bin/dnd-client session get <session-id>

# 保存消息
./bin/dnd-client message save --session <session-id> --content "你好"

# 查看消息
./bin/dnd-client message list --session <session-id>
```

### 验收标准

- ✅ 项目可以编译运行
- ✅ 使用 Redis 存储会话和消息
- ✅ 提供 CLI 工具测试所有功能
- ✅ 测试覆盖率 > 80%

---

## 需求详细拆解

### 需求 1.1：项目脚手架搭建

#### 需求描述

创建标准的 Go 项目结构，初始化模块管理，配置基础开发环境。

#### 详细约束

**1. 目录结构规范**

必须严格遵循 `doc/规范.md` 的项目结构要求：

```
dnd-client/
├── cmd/
│   └── client/
│       └── main.go                 # 主程序入口，仅包含启动逻辑
├── internal/                       # 私有代码，不被外部导入
│   ├── models/                     # 领域模型
│   │   ├── session.go
│   │   └── message.go
│   ├── store/                      # 数据存储层
│   │   ├── redis/
│   │   │   ├── client.go          # Redis 客户端
│   │   │   ├── session.go         # 会话存储
│   │   │   ├── message.go         # 消息存储
│   │   │   └── system.go          # 系统元数据
│   │   └── interface.go           # 存储接口定义
│   ├── config/                     # 配置管理
│   │   └── config.go
│   └── cli/                       # 命令行工具
│       ├── session.go
│       ├── message.go
│       └── root.go
├── pkg/                           # 公共库，可被外部导入
│   └── errors/                    # 错误定义
│       └── errors.go
├── tests/                         # 测试文件（按规范要求）
│   ├── unit/                      # 单元测试
│   │   ├── models/
│   │   └── store/
│   ├── integration/               # 集成测试
│   │   └── store/
│   └── testutil/                  # 测试工具
│       └── setup.go
├── scripts/                       # 构建和部署脚本
│   ├── build.sh
│   ├── init-redis.sh
│   └── test.sh
├── doc/                          # 开发文档
│   ├── 规范.md
│   ├── DND_MCP_Client详细设计.md
│   ├── DND_MCP_Client_开发计划.md
│   ├── 开发任务一.md
│   └── development_progress.md    # 开发进度文件（按规范命名）
├── go.mod
├── go.sum
├── .env.example                  # 环境变量示例
├── .gitignore
└── README.md
```

**2. 依赖方向约束**

严格遵循 `doc/规范.md` 的依赖原则：

- ✅ 单向依赖：上层依赖下层，禁止下层依赖上层
- ✅ 依赖方向：`cli → store → models`
- ✅ `internal` 包不被外部导入
- ✅ `pkg` 包可被外部使用

**3. 命名规范约束**

- **包命名**：使用小写，单个单词（如 `models`, `store`, `config`）
- **文件命名**：使用小写，下划线分隔（如 `session.go`, `message.go`）
- **接口命名**：方法名 + er 后缀（如 `SessionStore`, `MessageStore`）

**4. Go Modules 初始化**

```bash
# 初始化模块
go mod github.com/dnd-mcp/client

# 核心依赖版本
require (
    github.com/redis/go-redis/v9 v9.5.1
    github.com/spf13/cobra v1.8.0
    github.com/spf13/viper v1.18.2
    github.com/google/uuid v1.6.0
)
```

#### 技术要求

1. **Go 版本**: 1.21+
2. **依赖管理**: 使用 Go Modules
3. **构建工具**: 提供 `scripts/build.sh` 脚本
4. **环境配置**: 使用 `.env` 文件管理环境变量

#### 文件清单

- [ ] `go.mod` - Go 模块定义
- [ ] `go.sum` - 依赖版本锁定
- [ ] `.env.example` - 环境变量示例
- [ ] `.gitignore` - Git 忽略规则
- [ ] `README.md` - 项目说明
- [ ] `cmd/client/main.go` - 主程序入口
- [ ] `scripts/build.sh` - 构建脚本
- [ ] `doc/development_progress.md` - 开发进度跟踪

#### 测试要求

- [ ] 项目可以正常编译：`go build ./cmd/client`
- [ ] 执行 `go mod tidy` 无错误
- [ ] 目录结构符合规范要求

---

### 需求 1.2：Redis 连接和配置管理

#### 需求描述

实现 Redis 客户端连接管理和应用配置加载，支持环境变量和配置文件。

#### 详细约束

**1. 配置管理规范**

遵循 `doc/规范.md` 的配置要求：

- 使用 `pkg/config` 包（公共库，可被外部使用）
- 支持环境变量优先，配置文件兜底
- 必须提供默认值
- 配置结构体必须有详细注释

**2. Redis 客户端规范**

- 使用 `go-redis/v9` 客户端
- 实现连接池
- 支持 Ping 检查
- 正确处理连接错误

**3. 错误处理规范**

遵循 `doc/规范.md` 的错误处理原则：

- 不忽略错误，所有错误都必须处理
- 使用 `fmt.Errorf` 添加错误上下文
- 使用 `%w` 动词包装错误，保留原始错误类型
- 错误应该返回，不是记录日志后返回 nil

#### 技术要求

**配置结构**

```go
// pkg/config/config.go

// Config 应用配置
type Config struct {
    Redis    RedisConfig    `mapstructure:"redis"`
    Log      LogConfig      `mapstructure:"log"`
    Server   ServerConfig   `mapstructure:"server"`
}

// RedisConfig Redis 配置
type RedisConfig struct {
    Host         string `mapstructure:"host" env:"REDIS_HOST" default:"localhost:6379"`
    Password     string `mapstructure:"password" env:"REDIS_PASSWORD" default:""`
    DB           int    `mapstructure:"db" env:"REDIS_DB" default:"0"`
    PoolSize     int    `mapstructure:"pool_size" env:"REDIS_POOL_SIZE" default:"10"`
    MinIdleConns int    `mapstructure:"min_idle_conns" env:"REDIS_MIN_IDLE_CONNS" default:"5"`
}

// LogConfig 日志配置
type LogConfig struct {
    Level  string `mapstructure:"level" env:"LOG_LEVEL" default:"info"`
    Format string `mapstructure:"format" env:"LOG_FORMAT" default:"json"`
}
```

**Redis 客户端接口**

```go
// internal/store/redis/client.go

// Client Redis 客户端接口
type Client interface {
    // Ping 检查连接状态
    Ping(ctx context.Context) error

    // Close 关闭连接
    Close() error

    // Client 返回原生客户端
    Client() *redis.Client
}
```

#### 文件清单

- [ ] `pkg/config/config.go` - 配置管理
- [ ] `internal/store/redis/client.go` - Redis 客户端
- [ ] `.env.example` - 环境变量示例更新

#### 测试要求

**单元测试**

- [ ] `tests/unit/store/redis/client_test.go`
  - 测试配置加载
  - 测试环境变量覆盖
  - 测试默认值

**集成测试**

- [ ] `tests/integration/store/redis/client_integration_test.go`
  - 测试 Redis 连接（使用 testcontainers 或 Docker）
  - 测试 Ping 返回 PONG
  - 测试连接池
  - 测试错误处理

---

### 需求 1.3：Redis 存储会话

#### 需求描述

实现会话的 Redis 存储，包括创建、查询、列表、删除等操作。

#### 详细约束

**1. 数据结构约束**

严格遵循 `DND_MCP_Client详细设计.md` 的 Redis 数据结构设计：

```redis
# 会话元数据 (Hash)
Key: session:{uuid}
Type: Hash
TTL: 永久
Fields:
  - id: UUID
  - name: string
  - creator_id: string
  - mcp_server_url: string
  - websocket_key: string
  - max_players: integer
  - settings: JSON string
  - created_at: RFC3339 timestamp
  - updated_at: RFC3339 timestamp
  - status: string (active | archived)

# 会话索引 (Set)
Key: sessions:all
Type: Set
TTL: 永久
Members: 所有活跃的 session UUID
```

**2. 接口设计约束**

遵循 `doc/规范.md` 的接口设计原则：

- 小接口原则：接口包含 1-3 个方法
- 单一职责：一个接口只做一件事
- 在使用方定义接口，而非实现方

```go
// internal/store/interface.go

// SessionStore 会话存储接口
type SessionStore interface {
    // Create 创建会话
    Create(ctx context.Context, session *models.Session) error

    // Get 获取会话
    Get(ctx context.Context, id string) (*models.Session, error)

    // List 列出所有会话
    List(ctx context.Context) ([]*models.Session, error)

    // Update 更新会话
    Update(ctx context.Context, session *models.Session) error

    // Delete 删除会话（软删除）
    Delete(ctx context.Context, id string) error
}
```

**3. 模型定义约束**

遵循 `doc/规范.md` 的结构体定义规范：

```go
// internal/models/session.go

// Session 会话模型
type Session struct {
    ID           string            `json:"id"`
    Name         string            `json:"name"`
    CreatorID    string            `json:"creator_id"`
    MCPServerURL string            `json:"mcp_server_url"`
    WebSocketKey string            `json:"websocket_key"`
    MaxPlayers   int               `json:"max_players"`
    Settings     map[string]interface{} `json:"settings"`
    CreatedAt    time.Time         `json:"created_at"`
    UpdatedAt    time.Time         `json:"updated_at"`
    Status       string            `json:"status"`
}
```

**4. 错误处理约束**

- 为常见错误定义类型（如 `ErrSessionNotFound`）
- 实现 `Error()` 方法
- 使用 `errors.As` 进行类型判断

**5. 代码组织约束**

遵循 `doc/规范.md` 的文件结构顺序：

1. 包声明
2. 导入包（标准库 → 第三方库 → 项目内部包）
3. 常量定义
4. 类型定义
5. 接口定义
6. 全局变量（慎用）
7. 工具函数
8. 类型方法

#### 技术要求

**Redis 操作要求**

- 使用 Pipeline 批量操作，减少网络往返
- 正确设置 Hash 字段
- 维护 sessions:all 索引
- 支持软删除（设置 deleted_at）

**性能要求**

- 单次操作耗时 < 1ms
- 批量操作使用 Pipeline

#### 文件清单

- [ ] `internal/models/session.go` - 会话模型
- [ ] `internal/store/interface.go` - 存储接口定义
- [ ] `internal/store/redis/session.go` - Redis 会话存储实现
- [ ] `pkg/errors/errors.go` - 错误定义

#### 测试要求

**单元测试**

- [ ] `tests/unit/store/redis/session_test.go`
  - Mock Redis 客户端
  - 测试 Create 操作
  - 测试 Get 操作
  - 测试 List 操作
  - 测试 Update 操作
  - 测试 Delete 操作
  - 测试错误处理

**集成测试**

- [ ] `tests/integration/store/redis/session_integration_test.go`
  - 使用真实 Redis（testcontainers 或 Docker）
  - 测试完整 CRUD 流程
  - 验证 Redis 数据结构正确
  - 测试并发安全性

**黑盒测试**

- [ ] `tests/e2e/session_cli_test.go`
  - 从命令行工具角度测试
  - 验证用户使用场景

---

### 需求 1.4：Redis 存储消息

#### 需求描述

实现消息的 Redis 存储，使用 Sorted Set 按时间戳排序。

#### 详细约束

**1. 数据结构约束**

严格遵循 `DND_MCP_Client详细设计.md` 的 Redis 数据结构设计：

```redis
# 对话消息 (Sorted Set)
Key: msg:{session_uuid}
Type: ZSET (有序集合)
TTL: 永久
Score: Unix timestamp (毫秒)
Member: JSON序列化的消息对象

消息结构:
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "user | assistant | system | tool",
  "content": "消息内容",
  "tool_calls": [],
  "player_id": "player-123",
  "created_at": "2025-02-03T10:00:00Z"
}
```

**2. 接口设计约束**

```go
// internal/store/interface.go

// MessageStore 消息存储接口
type MessageStore interface {
    // Create 保存消息
    Create(ctx context.Context, message *models.Message) error

    // Get 获取消息
    Get(ctx context.Context, sessionID, messageID string) (*models.Message, error)

    // List 获取会话消息列表
    List(ctx context.Context, sessionID string, limit int) ([]*models.Message, error)

    // ListByRole 按角色获取消息
    ListByRole(ctx context.Context, sessionID, role string, limit int) ([]*models.Message, error)

    // ListSince 按时间范围获取消息
    ListSince(ctx context.Context, sessionID string, since time.Time, limit int) ([]*models.Message, error)
}
```

**3. 模型定义约束**

```go
// internal/models/message.go

// Message 消息模型
type Message struct {
    ID        string              `json:"id"`
    SessionID string              `json:"session_id"`
    Role      string              `json:"role"`
    Content   string              `json:"content"`
    ToolCalls []ToolCall          `json:"tool_calls,omitempty"`
    PlayerID  string              `json:"player_id,omitempty"`
    CreatedAt time.Time           `json:"created_at"`
}

// ToolCall 工具调用
type ToolCall struct {
    ID       string                 `json:"id"`
    Name     string                 `json:"name"`
    Arguments map[string]interface{} `json:"arguments"`
}
```

**4. Redis 操作约束**

- 使用 `ZADD` 添加消息，score 为时间戳毫秒
- 使用 `ZREVRANGE` 获取最近消息（倒序）
- 使用 `ZRANGEBYSCORE` 按时间范围查询
- 使用 `ZCARD` 获取消息总数

#### 技术要求

**性能要求**

- 单次操作耗时 < 1ms
- 批量操作使用 Pipeline
- 支持至少 10000 条消息/会话

**数据一致性**

- 使用 UUID 保证唯一性
- 时间戳精度到毫秒
- JSON 序列化使用标准库

#### 文件清单

- [ ] `internal/models/message.go` - 消息模型
- [ ] `internal/store/redis/message.go` - Redis 消息存储实现
- [ ] `pkg/errors/errors.go` - 错误定义更新

#### 测试要求

**单元测试**

- [ ] `tests/unit/store/redis/message_test.go`
  - Mock Redis 客户端
  - 测试 Create 操作
  - 测试 Get 操作
  - 测试 List 操作（不同参数）
  - 测试 ListByRole 操作
  - 测试 ListSince 操作
  - 测试错误处理

**集成测试**

- [ ] `tests/integration/store/redis/message_integration_test.go`
  - 使用真实 Redis
  - 测试完整 CRUD 流程
  - 验证 Sorted Set 数据结构正确
  - 测试时间排序正确
  - 测试大量消息性能

**黑盒测试**

- [ ] `tests/e2e/message_cli_test.go`
  - 从命令行工具角度测试
  - 验证用户使用场景

---

### 需求 1.5：命令行工具测试

#### 需求描述

提供命令行工具用于测试会话和消息的增删改查功能。

#### 详细约束

**1. CLI 框架选择**

使用 `cobra` 库，符合 `doc/规范.md` 的依赖选择原则：
- 选择社区活跃、维护良好的库
- 避免引入不必要的依赖

**2. 命令结构**

```
dnd-client
├── session
│   ├── create    创建会话
│   ├── get       获取会话
│   ├── list      列出会话
│   ├── update    更新会话
│   └── delete    删除会话
└── message
    ├── save      保存消息
    ├── get       获取消息
    └── list      列出消息
```

**3. 输出格式规范**

- 默认使用表格格式输出
- 支持 JSON 格式（`--output json`）
- 错误信息使用 stderr
- 成功操作使用 stdout

**4. 参数验证规范**

遵循 `doc/规范.md` 的验证原则：
- 验证所有输入
- 提供清晰的错误提示
- 使用早期返回避免深层嵌套

**5. 日志记录规范**

遵循 `doc/规范.md` 的日志规范：
- 在 API 层或主程序记录日志
- 使用结构化日志
- 包含关键上下文（请求ID、用户ID等）

#### 技术要求

**命令实现示例**

```go
// internal/cli/session.go

// sessionCreateCmd 创建会话命令
var sessionCreateCmd = &cobra.Command{
    Use:   "create",
    Short: "创建新会话",
    Long:  `创建一个新的游戏会话`,
    Example: `
  dnd-client session create --name "我的战役" --creator "user-123" --mcp-url "http://localhost:9000"
`,
    RunE: func(cmd *cobra.Command, args []string) error {
        // 参数验证
        if name == "" {
            return fmt.Errorf("--name 参数必填")
        }
        if creatorID == "" {
            return fmt.Errorf("--creator 参数必填")
        }
        if mcpURL == "" {
            return fmt.Errorf("--mcp-url 参数必填")
        }

        // 调用存储层
        session := &models.Session{
            ID:           uuid.New().String(),
            Name:         name,
            CreatorID:    creatorID,
            MCPServerURL: mcpURL,
            // ...
        }

        if err := sessionStore.Create(cmd.Context(), session); err != nil {
            return fmt.Errorf("创建会话失败: %w", err)
        }

        // 输出结果
        printSession(session)
        return nil
    },
}
```

#### 文件清单

- [ ] `internal/cli/root.go` - 根命令
- [ ] `internal/cli/session.go` - 会话命令
- [ ] `internal/cli/message.go` - 消息命令
- [ ] `cmd/client/main.go` - 主程序入口

#### 测试要求

**单元测试**

- [ ] `tests/unit/cli/session_test.go`
  - 测试命令参数解析
  - 测试参数验证
  - Mock 存储层

**集成测试**

- [ ] `tests/integration/cli/session_integration_test.go`
  - 测试完整命令流程
  - 验证输出格式

**黑盒测试**

- [ ] `tests/e2e/cli_test.go`
  - 从用户角度测试所有命令
  - 验证使用场景
  - 测试错误提示

---

## 测试策略总览

### 测试覆盖率要求

遵循 `doc/规范.md` 的测试要求：
- 核心业务逻辑测试覆盖率 80% 以上
- 使用接口和 Mock 避免依赖具体实现
- 测试应该是独立的，不依赖执行顺序

### 测试类型

**1. 单元测试**

- 位置：`tests/unit/`
- 目标：测试单个函数和类
- 策略：使用 Mock 隔离依赖

**2. 集成测试**

- 位置：`tests/integration/`
- 目标：测试多个组件协作
- 策略：使用真实 Redis（testcontainers 或 Docker）

**3. 黑盒测试**

- 位置：`tests/e2e/`
- 目标：从使用者角度测试
- 策略：通过命令行工具测试

### 测试辅助工具

```go
// tests/testutil/setup.go

// SetupTestRedis 创建测试 Redis 客户端
func SetupTestRedis(t *testing.T) *redis.Client {
    // 使用 testcontainers 或本地 Docker
}

// CleanupTestRedis 清理测试数据
func CleanupTestRedis(t *testing.T, client *redis.Client) {
    // 清空所有测试数据
}
```

---

## 开发步骤建议

### Step 1: 项目初始化（需求 1.1）

1. 创建目录结构
2. 初始化 Go Modules
3. 配置 `.gitignore`
4. 创建构建脚本
5. 编写 `README.md`
6. 创建 `doc/development_progress.md`

### Step 2: 配置和 Redis 连接（需求 1.2）

1. 实现配置管理
2. 实现 Redis 客户端
3. 编写单元测试
4. 编写集成测试

### Step 3: 会话存储（需求 1.3）

1. 定义会话模型
2. 定义存储接口
3. 实现 Redis 存储
4. 编写单元测试
5. 编写集成测试

### Step 4: 消息存储（需求 1.4）

1. 定义消息模型
2. 定义存储接口
3. 实现 Redis 存储
4. 编写单元测试
5. 编写集成测试

### Step 5: 命令行工具（需求 1.5）

1. 实现 CLI 框架
2. 实现会话命令
3. 实现消息命令
4. 编写单元测试
5. 编写集成测试
6. 编写黑盒测试

---

## 验收检查清单

### 代码质量

- [ ] 所有代码符合 `doc/规范.md` 要求
- [ ] 使用 `gofmt` 格式化
- [ ] 使用 `go vet` 检查
- [ ] 使用 `golint` 检查
- [ ] 代码审查通过

### 功能完整性

- [ ] 项目可以正常编译和运行
- [ ] Redis 连接正常
- [ ] 会话 CRUD 功能正常
- [ ] 消息 CRUD 功能正常
- [ ] CLI 工具所有命令正常

### 测试完整性

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] 黑盒测试全部通过
- [ ] 测试可以独立运行

### 文档完整性

- [ ] `README.md` 完整
- [ ] `doc/development_progress.md` 更新
- [ ] 代码注释完整
- [ ] 示例代码可运行

---

## 依赖清单

### Go 依赖

```go
require (
    github.com/redis/go-redis/v9 v9.5.1
    github.com/spf13/cobra v1.8.0
    github.com/spf13/viper v1.18.2
    github.com/google/uuid v1.6.0
)
```

### 外部依赖

- Redis 7.0+（使用 Docker 运行）

### 可选依赖（用于测试）

```go
require (
    github.com/testcontainers/testcontainers-go v0.26.0
    github.com/stretchr/testify v1.9.0
)
```

---

## 风险和注意事项

### 风险

1. **Redis 连接失败**
   - 缓解：提供详细的错误提示和配置说明
2. **数据结构不一致**
   - 缓解：严格遵循设计文档，编写集成测试验证
3. **并发安全问题**
   - 缓解：使用 Redis 事务和 Pipeline

### 注意事项

1. 严格遵循 `doc/规范.md` 的所有要求
2. 保持代码简洁、清晰、易读
3. 优先选择简单直接的实现
4. 不为了解耦而做出复杂架构
5. 保持代码风格一致
6. 定期重构，及时清理冗余代码
7. 小步提交，频繁集成

---

## 参考资料

- `doc/规范.md` - 代码规范
- `doc/DND_MCP_Client详细设计.md` - 详细设计
- `doc/DND_MCP_Client_开发计划.md` - 开发计划
- https://redis.io/docs/data-types/ - Redis 数据类型
- https://github.com/spf13/cobra - Cobra 文档
