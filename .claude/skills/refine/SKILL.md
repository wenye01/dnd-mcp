---
name: refine
description: 将高层次设计按粒度迭代细化为详细设计书。每轮细化所有模块的同一层级，完成后进行一致性和完整性审视。
disable-model-invocation: true
allowed-tools: Read, Glob, Grep, Write, Edit
argument-hint: [design-doc]
---

# 迭代式细化设计

将高层次设计迭代细化为完整设计书，每轮聚焦一个粒度层级，完成后自动审视。

## 输入

**设计文档**: $ARGUMENTS

## 迭代轮次

| 轮次 | 粒度 | 目标 |
|------|------|------|
| 1 | 数据结构 | 定义所有核心实体和字段 |
| 2 | 接口定义 | 定义所有 API 端点和契约 |
| 3 | 业务流程 | 完善处理逻辑和流程分支 |
| 4 | 存储与异常 | 存储方案、错误码、边界处理 |
| 5 | 测试规范 | 测试场景和验收标准 |

## 执行逻辑

```
读取/创建详细设计书 → 确定当前轮次 → 细化该轮内容 → 保存 → 报告进度

第5轮完成后 → 执行审视流程
```

## 审视流程

完成5轮细化后，自动执行以下检查：

### 1. 设计一致性检查

- 每个细化项是否可追溯到原始设计
- 是否有超出原始设计范围的添加
- 是否有遗漏的设计要求

### 2. 模块间一致性检查

- 跨模块引用的数据结构是否一致
- 模块间的接口契约是否匹配
- 数据流向是否闭环
- ID/Key 格式是否统一

### 3. 完整性检查

- 每个 API 是否有对应的请求/响应定义
- 每个数据结构是否有存储方案
- 每个流程是否有错误处理
- 每个模块是否有测试规范

### 4. 冲突检测

- 同名字段在不同模块中类型是否一致
- 错误码是否有重复
- API 路径是否有冲突
- 存储键名是否有冲突

### 审视输出

```markdown
## 设计审视报告

### 一致性
- [ ] 追溯完整 / 发现问题: ...
- [ ] 范围正确 / 超出范围: ...

### 模块间
- [ ] 数据结构一致 / 冲突: ...
- [ ] 接口契约匹配 / 不匹配: ...
- [ ] 数据流闭环 / 断裂: ...

### 完整性
- [ ] API 完整 / 缺失: ...
- [ ] 存储完整 / 缺失: ...
- [ ] 错误处理完整 / 缺失: ...

### 冲突
- [ ] 无冲突 / 发现冲突: ...

### 修正建议
1. [问题描述] → [修正方案]
2. ...

### 下一步
- 有问题 → 执行 /refine [doc] --fix 修正
- 无问题 → 设计完成，可开始实现
```

## 输出格式

迭代中：
```
第N/5轮完成: [粒度名称]

已细化:
- 模块A
- 模块B
- ...

下一轮: /refine [设计文档]
```

完成后：
```
细化完成 → 执行审视 → 输出审视报告
```

---

开始细化: $ARGUMENTS
