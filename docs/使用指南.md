# DND MCP Client 使用指南

## 快速开始

### 1. 环境准备

确保已安装以下软件:
- Go 1.21+
- Redis 7.0+ (本地安装)
- PostgreSQL 15+ (本地安装，可选)

### 2. 启动 Redis 和 PostgreSQL

#### Windows 环境

启动 Redis:

```powershell
# 方法1: 如果已安装为服务
net start Redis

# 方法2: 手动启动
cd C:\Tools\Redis-8.4.0-Windows-x64-msys2-with-Service
.\redis-server.exe
```

启动 PostgreSQL (可选，用于持久化):

```powershell
# 检查 PostgreSQL 服务状态
sc query postgresql-x64-15

# 如果未运行，启动服务
net start postgresql-x64-15
```

#### Linux/Mac 环境

```bash
# 启动 Redis
redis-server

# 启动 PostgreSQL (可选)
sudo systemctl start postgresql
# 或
sudo service postgresql start
```

### 3. 编译项目

#### Windows 环境

```powershell
# 下载依赖
go mod tidy

# 使用 PowerShell 脚本构建 (推荐)
.\scripts\build.ps1

# 或手动构建
go build ./cmd/server
```

#### Linux/Mac 环境

```bash
# 下载依赖
go mod tidy

# 使用脚本构建
chmod +x ./scripts/build.sh
./scripts/build.sh

# 或手动构建
go build -o bin/dnd-server ./cmd/server
```

### 4. 配置环境变量 (可选)

项目使用默认配置,你也可以通过环境变量或配置文件自定义:

#### 配置文件方式 (推荐)

创建 `config.yaml`:

```yaml
server:
  host: "0.0.0.0"
  port: 8080

redis:
  host: "localhost:6379"
  password: ""
  db: 0

postgres:
  host: "localhost:5432"
  user: "dnd"
  password: "password"
  dbname: "dnd_client"

llm:
  provider: "mock"  # 或 "openai"
  api_key: ""      # OpenAI API key (可选)

log:
  level: "info"
  format: "json"
```

#### 环境变量方式

```bash
# Linux/Mac
export REDIS_HOST=localhost:6379
export POSTGRES_HOST=localhost:5432
export LLM_PROVIDER=mock

# Windows PowerShell
$env:REDIS_HOST="localhost:6379"
$env:POSTGRES_HOST="localhost:5432"
$env:LLM_PROVIDER="mock"
```

### 5. 启动服务

```bash
# 使用配置文件
./bin/dnd-server --config config.yaml

# 或使用默认配置
./bin/dnd-server
```

服务将在 `http://localhost:8080` 启动。

## 使用 HTTP API

服务启动后，可以使用 curl 或任何 HTTP 客户端调用 API（类似前端调用方式）。

### 会话管理

#### 创建会话

```bash
curl -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "我的第一个战役",
    "creator_id": "user-123",
    "mcp_server_url": "http://localhost:9000"
  }'

# 返回
{
  "id": "session-uuid-xxx",
  "name": "我的第一个战役",
  "creator_id": "user-123",
  "mcp_server_url": "http://localhost:9000",
  "status": "active",
  "created_at": "2025-02-03T10:00:00Z"
}
```

#### 查看会话列表

```bash
curl http://localhost:8080/api/sessions

# 返回
[
  {
    "id": "session-uuid-xxx",
    "name": "我的第一个战役",
    "creator_id": "user-123",
    "status": "active",
    "created_at": "2025-02-03T10:00:00Z"
  }
]
```

#### 获取单个会话

```bash
curl http://localhost:8080/api/sessions/{session-id}
```

#### 更新会话

```bash
curl -X PATCH http://localhost:8080/api/sessions/{session-id} \
  -H "Content-Type: application/json" \
  -d '{
    "name": "更新后的战役名称"
  }'
```

#### 删除会话

```bash
curl -X DELETE http://localhost:8080/api/sessions/{session-id}
```

### 消息管理

#### 保存消息

```bash
# 用户消息
curl -X POST http://localhost:8080/api/sessions/{session-id}/messages \
  -H "Content-Type: application/json" \
  -d '{
    "role": "user",
    "content": "你好,我要开始游戏了",
    "player_id": "player-123"
  }'

# 助手消息
curl -X POST http://localhost:8080/api/sessions/{session-id}/messages \
  -H "Content-Type: application/json" \
  -d '{
    "role": "assistant",
    "content": "欢迎来到 D&D 世界!"
  }'

# 系统消息
curl -X POST http://localhost:8080/api/sessions/{session-id}/messages \
  -H "Content-Type: application/json" \
  -d '{
    "role": "system",
    "content": "游戏开始"
  }'
```

#### 查看消息列表

```bash
# 获取所有消息 (默认50条)
curl http://localhost:8080/api/sessions/{session-id}/messages

# 限制返回数量
curl http://localhost:8080/api/sessions/{session-id}/messages?limit=10

# 返回
[
  {
    "id": "msg-uuid-xxx",
    "session_id": "session-uuid-xxx",
    "role": "user",
    "content": "你好,我要开始游戏了",
    "player_id": "player-123",
    "created_at": "2025-02-03T10:05:00Z"
  }
]
```

#### 获取单条消息

```bash
curl http://localhost:8080/api/sessions/{session-id}/messages/{message-id}
```

### 聊天 API（AI 对话）

#### 发送聊天消息

```bash
curl -X POST http://localhost:8080/api/sessions/{session-id}/chat \
  -H "Content-Type: application/json" \
  -d '{
    "content": "告诉我一个关于勇者的故事",
    "player_id": "player-123"
  }'

# 返回 AI 响应
{
  "id": "msg-uuid-xxx",
  "role": "assistant",
  "content": "很久以前，在一个遥远的王国...",
  "created_at": "2025-02-03T10:10:00Z"
}
```

### 系统管理 API

#### 健康检查

```bash
curl http://localhost:8080/api/system/health

# 返回
{
  "status": "healthy",
  "components": {
    "redis": {"status": "healthy"},
    "postgres": {"status": "healthy"}
  }
}
```

#### 持久化管理

```bash
# 触发备份 (Redis → PostgreSQL)
curl -X POST http://localhost:8080/api/system/persistence/backup

# 返回
{
  "status": "success",
  "stats": {
    "sessions_backed_up": 10,
    "messages_backed_up": 150,
    "duration_seconds": 0.52
  }
}

# 触发恢复 (PostgreSQL → Redis)
curl -X POST http://localhost:8080/api/system/persistence/restore

# 查看持久化状态
curl http://localhost:8080/api/system/persistence/status

# 返回
{
  "last_backup_time": "2025-02-03T10:30:00Z",
  "last_restore_time": "2025-02-03T11:00:00Z",
  "backup_count": 5,
  "status": "healthy"
}
```

## 测试

### 单元测试

#### Windows 环境

```powershell
# 使用 PowerShell 脚本 (推荐)
.\scripts\test.ps1

# 或手动运行
go test ./tests/unit/... -v

# 查看测试覆盖率
go test ./tests/unit/... -cover
```

#### Linux/Mac 环境

```bash
# 使用脚本 (推荐)
./scripts/test.sh

# 或手动运行
go test ./tests/unit/... -v

# 查看测试覆盖率
go test ./tests/unit/... -cover
```

### 集成测试

集成测试需要真实的 Redis 和 PostgreSQL 服务:

#### Windows 环境

```powershell
# 确保 Redis 和 PostgreSQL 正在运行
net start Redis
net start postgresql-x64-15

# 设置环境变量
$env:INTEGRATION_TEST="1"

# 运行集成测试
go test ./tests/integration/... -tags=integration -v

# 或使用测试脚本
.\scripts\test-local.ps1
```

#### Linux/Mac 环境

```bash
# 确保 Redis 和 PostgreSQL 正在运行
sudo systemctl status redis
sudo systemctl status postgresql

# 设置环境变量
export INTEGRATION_TEST=1

# 运行集成测试
go test ./tests/integration/... -tags=integration -v

# 或使用测试脚本
./scripts/test-local.sh
```

### 端到端测试（使用 curl）

端到端测试模拟真实的 API 调用场景（类似前端）:

```bash
# 1. 启动服务
./bin/dnd-server

# 2. 创建会话
SESSION_RESPONSE=$(curl -s -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试会话",
    "creator_id": "user-001",
    "mcp_server_url": "http://localhost:9000"
  }')

# 提取会话 ID
SESSION_ID=$(echo $SESSION_RESPONSE | jq -r '.id')

# 3. 添加消息
curl -X POST http://localhost:8080/api/sessions/$SESSION_ID/messages \
  -H "Content-Type: application/json" \
  -d '{
    "role": "user",
    "content": "你好，这是一条测试消息"
  }'

# 4. 查看消息列表
curl http://localhost:8080/api/sessions/$SESSION_ID/messages

# 5. 触发备份
curl -X POST http://localhost:8080/api/system/persistence/backup

# 6. 查看系统状态
curl http://localhost:8080/api/system/health
```

## 项目结构

```
dnd-client/
├── cmd/                    # 主程序入口
│   └── server/
│       └── main.go         # HTTP Server 入口
├── internal/              # 私有代码
│   ├── models/            # 领域模型 (Session, Message)
│   ├── store/             # 数据存储层
│   │   ├── redis/        # Redis 实现
│   │   ├── postgres/     # PostgreSQL 实现
│   │   └── interface.go  # 存储接口
│   ├── api/              # HTTP handlers
│   │   ├── handler/      # 请求处理器
│   │   ├── middleware/   # 中间件
│   │   └── router.go     # 路由配置
│   ├── service/          # 业务逻辑层
│   ├── persistence/      # 持久化管理
│   └── config/           # 配置管理
├── pkg/                  # 公共库
│   ├── errors/           # 错误定义
│   └── logger/           # 日志
├── tests/                # 测试文件
│   ├── unit/            # 单元测试
│   └── integration/     # 集成测试
├── scripts/             # 构建和测试脚本
│   ├── build.ps1       # Windows PowerShell 构建脚本
│   ├── build.sh        # Linux/Mac 构建脚本
│   ├── test.ps1        # Windows PowerShell 测试脚本
│   ├── test.sh         # Linux/Mac 测试脚本
│   └── e2e-test.sh     # 端到端测试脚本 (curl)
├── doc/                # 开发文档
├── configs/            # 配置文件示例
│   └── config.yaml     # 默认配置
└── bin/
    └── dnd-server      # 编译后的可执行文件
```

## Redis 数据结构

### 会话存储

```
Key: session:{uuid}
Type: Hash
Fields:
  - id: 会话ID
  - name: 会话名称
  - creator_id: 创建者ID
  - mcp_server_url: MCP Server URL
  - websocket_key: WebSocket密钥
  - max_players: 最大玩家数
  - settings: 设置 (JSON)
  - created_at: 创建时间
  - updated_at: 更新时间
  - status: 状态

Key: sessions:all
Type: Set
Members: 所有会话ID
```

### 消息存储

```
Key: msg:{session_uuid}
Type: Sorted Set
Score: 时间戳 (毫秒)
Member: 消息 (JSON)
```

## 常见问题

### 1. 服务启动失败

**错误**: `bind: address already in use`

**解决**:
- 检查端口 8080 是否被占用: `netstat -ano | findstr :8080`
- 修改配置文件中的端口号
- 停止占用端口的进程

### 2. Redis 连接失败

**错误**: `redis 连接失败: dial tcp: connection refused`

**解决**:
- 检查 Redis 是否正在运行: `redis-cli ping`
- 检查配置文件中的 Redis 地址
- 确保 Redis 端口正确 (默认 6379)

### 3. API 返回 404

**错误**: `404 Not Found`

**解决**:
- 检查 URL 路径是否正确
- 使用 `curl http://localhost:8080/api/sessions` 测试基础 API
- 查看服务日志确认路由注册

### 4. PostgreSQL 连接失败

**错误**: `connection refused` 或 `password authentication failed`

**解决**:
- 检查 PostgreSQL 是否运行: `psql -U dnd -d dnd_client -h localhost`
- 确认数据库用户和密码配置正确
- 运行数据库迁移: `curl -X POST http://localhost:8080/api/system/migrate`

## 开发文档

- [规范](规范.md) - 代码规范
- [详细设计](DND_MCP_Client详细设计.md) - 技术设计
- [开发计划](DND_MCP_Client_开发计划.md) - 开发路线图
- [开发任务一](开发任务一.md) - 当前任务详情

## 下一步

根据开发计划，接下来是:

- 任务2: PostgreSQL 持久化
- 任务3: HTTP API - 会话管理
- 任务4: HTTP API - 消息管理
- 任务5: WebSocket 实时通信

详见 [开发计划](DND_MCP_Client_开发计划.md)
