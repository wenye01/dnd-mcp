# å¼€å‘ä»»åŠ¡äºŒï¼šPostgreSQL æŒä¹…åŒ–

## æ–‡æ¡£ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: Task-2
- **ä»»åŠ¡åç§°**: PostgreSQL æŒä¹…åŒ–
- **é¢„ä¼°æ—¶é—´**: 2å¤©
- **å‰ç½®ä»»åŠ¡**: Task-1ï¼ˆé¡¹ç›®è„šæ‰‹æ¶ + Redis åŸºç¡€å­˜å‚¨ï¼‰
- **åŸºäºæ–‡æ¡£**: DND_MCP_Clientè¯¦ç»†è®¾è®¡.md v1.1ã€DND_MCP_Client_å¼€å‘è®¡åˆ’.md v1.0
- **å¿…é¡»éµå®ˆ**: doc/è§„èŒƒ.md

---

## ä»»åŠ¡æ¦‚è¿°

### ç›®æ ‡

åœ¨ä»»åŠ¡ä¸€çš„åŸºç¡€ä¸Šï¼Œå®ç° PostgreSQL å¤‡ä»½å­˜å‚¨ï¼Œæ”¯æŒä» Redis å¤‡ä»½æ•°æ®åˆ° PostgreSQLï¼Œä»¥åŠä» PostgreSQL æ¢å¤æ•°æ®åˆ° Redisã€‚

### åŸºäºä»»åŠ¡ä¸€çš„æˆæœ

ä»»åŠ¡ä¸€å·²å®Œæˆçš„åŸºç¡€è®¾æ–½ï¼š

- âœ… æ ‡å‡†çš„ Go é¡¹ç›®ç»“æ„ï¼ˆç¬¦åˆ `doc/è§„èŒƒ.md`ï¼‰
- âœ… Redis å­˜å‚¨å®ç°ï¼ˆ`internal/store/redis/`ï¼‰
- âœ… é¢†åŸŸæ¨¡å‹ï¼ˆ`internal/models/`ï¼‰- æœ€åº•å±‚
- âœ… é…ç½®ç®¡ç†ï¼ˆ`pkg/config/`ï¼‰
- âœ… é”™è¯¯å®šä¹‰ï¼ˆ`pkg/errors/`ï¼‰
- âœ… å‘½ä»¤è¡Œæ¡†æ¶ï¼ˆ`internal/cli/`ï¼‰
- âœ… æµ‹è¯•æ¡†æ¶ï¼ˆ`tests/`ï¼‰

### ä»»åŠ¡äºŒæ–°å¢åŠŸèƒ½

- ğŸ“¦ PostgreSQL å­˜å‚¨å±‚ï¼ˆ`internal/store/postgres/`ï¼‰
- ğŸ”„ æŒä¹…åŒ–æœåŠ¡å±‚ï¼ˆ`internal/persistence/`ï¼‰- åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£
- ğŸ—„ï¸ æ•°æ®åº“è¿ç§»å·¥å…·ï¼ˆ`scripts/migrations/`ï¼‰
- ğŸ’¾ å¤‡ä»½/æ¢å¤ CLI å‘½ä»¤

### å¯æ¼”ç¤ºåŠŸèƒ½

```bash
# æ‰§è¡Œæ•°æ®åº“è¿ç§»
./bin/dnd-client migrate up

# å¤‡ä»½æ‰€æœ‰æ•°æ®åˆ° PostgreSQL
./bin/dnd-client backup --all

# å¤‡ä»½æŒ‡å®šä¼šè¯
./bin/dnd-client backup --session <session-id>

# ä» PostgreSQL æ¢å¤æ•°æ®
./bin/dnd-client restore --all

# æ¢å¤æŒ‡å®šä¼šè¯
./bin/dnd-client restore --session <session-id>

# æŸ¥çœ‹å¤‡ä»½è®°å½•
./bin/dnd-client backup list
```

### éªŒæ”¶æ ‡å‡†

- âœ… æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®åˆ›å»º
- âœ… å¯ä»¥å¤‡ä»½ä¼šè¯å’Œæ¶ˆæ¯åˆ° PostgreSQL
- âœ… å¯ä»¥ä» PostgreSQL æ¢å¤æ•°æ®åˆ° Redis
- âœ… æä¾›å‘½ä»¤è¡Œå·¥å…·æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… ä¸¥æ ¼éµå¾ª `doc/è§„èŒƒ.md` çš„æ‰€æœ‰è¦æ±‚

---

## è§„èŒƒè¦æ±‚å¯¹ç…§æ£€æŸ¥

### ç›®å½•ç»“æ„è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` çš„è¦æ±‚ï¼š

```
dnd-client/
â”œâ”€â”€ cmd/                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ bin/                    # äºŒè¿›åˆ¶è¾“å‡ºä»¶ä½ç½®ï¼ˆç¼–è¯‘è¾“å‡ºï¼‰âš ï¸
â”œâ”€â”€ internal/               # å®ç°ä»£ç ï¼Œä¸å¯¹å¤–æš´éœ²
â”‚   â”œâ”€â”€ models/            # é¢†åŸŸæ¨¡å‹ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œæœ€åº•å±‚ï¼‰
â”‚   â”œâ”€â”€ store/             # å­˜å‚¨å®ç°å±‚
â”‚   â”‚   â”œâ”€â”€ redis/         # Redis å®ç°ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼‰
â”‚   â”‚   â””â”€â”€ postgres/      # PostgreSQL å®ç°ï¼ˆä»»åŠ¡äºŒæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ persistence/       # æŒä¹…åŒ–æœåŠ¡å±‚ï¼ˆä»»åŠ¡äºŒæ–°å¢ï¼‰
â”‚   â””â”€â”€ cli/               # CLI å‘½ä»¤ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡äºŒæ‰©å±•ï¼‰
â”œâ”€â”€ pkg/                    # å…¬å…±åº“ï¼Œå¯è¢«å¤–éƒ¨é¡¹ç›®å¯¼å…¥
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡äºŒæ‰©å±•ï¼‰
â”‚   â””â”€â”€ errors/            # é”™è¯¯å®šä¹‰ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œä»»åŠ¡äºŒæ‰©å±•ï¼‰
â”œâ”€â”€ scripts/                # æ„å»ºå’Œéƒ¨ç½²è„šæœ¬ï¼Œæ•°æ®åº“è¿ç§»ç›¸å…³è„šæœ¬
â”‚   â”œâ”€â”€ build.sh          # æ„å»ºè„šæœ¬ï¼ˆä»»åŠ¡ä¸€å·²åˆ›å»ºï¼‰
â”‚   â””â”€â”€ migrations/        # æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼ˆä»»åŠ¡äºŒæ–°å¢ï¼‰âš ï¸ ä¸åœ¨ internal/
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶ï¼ˆä»»åŠ¡ä¸€å·²åˆ›å»ºï¼Œä»»åŠ¡äºŒæ‰©å±•ï¼‰âš ï¸ æ‰€æœ‰æµ‹è¯•åœ¨è¿™é‡Œ
â”‚   â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/       # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ e2e/               # é»‘ç›’æµ‹è¯•
â””â”€â”€ doc/                    # å¼€å‘æ–‡æ¡£
```

### ä¾èµ–æ–¹å‘è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` çš„ä¾èµ–åŸåˆ™ï¼šå•å‘ä¾èµ–ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚

```
cli (å‘½ä»¤è¡Œ)
  â†“
persistence (æŒä¹…åŒ–æœåŠ¡) - åœ¨è¿™é‡Œå®šä¹‰æ¥å£ï¼ˆä½¿ç”¨æ–¹ï¼‰
  â†“
store (å­˜å‚¨å®ç°: redis, postgres)
  â†“
models (é¢†åŸŸæ¨¡å‹) - æœ€åº•å±‚ï¼Œä¸ä¾èµ–ä»»ä½•äºº
```

**å…³é”®ç‚¹**ï¼š
- âœ… persistence ä¾èµ– storeï¼ˆå…·ä½“å®ç°ï¼‰
- âœ… store ä¾èµ– modelsï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰
- âœ… æ¥å£åœ¨ persistence ä¸­å®šä¹‰ï¼ˆä½¿ç”¨æ–¹ï¼‰ï¼Œä¸åœ¨ store ä¸­å®šä¹‰ï¼ˆå®ç°æ–¹ï¼‰
- âœ… models ä¸ä¾èµ–ä»»ä½•å…¶ä»–åŒ…

### æ¥å£è®¾è®¡è§„èŒƒ

éµå¾ª `doc/è§„èŒƒ.md` çš„æ¥å£è®¾è®¡åŸåˆ™ï¼š
- âœ… å°æ¥å£åŸåˆ™ï¼šæ¥å£åŒ…å« 1-3 ä¸ªæ–¹æ³•
- âœ… å•ä¸€èŒè´£ï¼šä¸€ä¸ªæ¥å£åªåšä¸€ä»¶äº‹
- âœ… **åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£ï¼Œè€Œéå®ç°æ–¹**ï¼ˆpersistence å®šä¹‰æ¥å£ï¼Œstore å®ç°æ¥å£ï¼‰

---

## éœ€æ±‚è¯¦ç»†æ‹†è§£

### éœ€æ±‚ 2.1ï¼šPostgreSQL è¿æ¥å’Œæ•°æ®åº“è¿ç§»

#### éœ€æ±‚æè¿°

å®ç° PostgreSQL å®¢æˆ·ç«¯è¿æ¥ç®¡ç†ï¼Œå¹¶åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ã€‚**æ³¨æ„ï¼šSQL è¿ç§»æ–‡ä»¶å¿…é¡»åœ¨ `scripts/migrations/` ç›®å½•ä¸‹ï¼Œä¸åœ¨ `internal/` ä¸‹ã€‚**

#### è¯¦ç»†çº¦æŸ

**1. ç›®å½•ç»“æ„çº¦æŸ**

ä¸¥æ ¼éµå¾ª `doc/è§„èŒƒ.md`ï¼š

```
internal/
â”œâ”€â”€ store/
â”‚   â””â”€â”€ postgres/              # PostgreSQL å­˜å‚¨å®ç°
â”‚       â”œâ”€â”€ client.go         # PostgreSQL å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ session.go        # ä¼šè¯å­˜å‚¨å®ç°
â”‚       â””â”€â”€ message.go        # æ¶ˆæ¯å­˜å‚¨å®ç°

scripts/                        # âš ï¸ æ•°æ®åº“è¿ç§»è„šæœ¬åœ¨è¿™é‡Œï¼Œä¸åœ¨ internal/ ä¸‹
â””â”€â”€ migrations/
    â”œâ”€â”€ 000001_initial_schema.up.sql
    â””â”€â”€ 000001_initial_schema.down.sql
```

**è§„èŒƒè¦æ±‚**ï¼š
- âŒ **ä¸åœ¨** `internal/store/postgres/migrations/`ï¼ˆè¿åè§„èŒƒï¼‰
- âœ… **å¿…é¡»åœ¨** `scripts/migrations/`ï¼ˆç¬¦åˆè§„èŒƒï¼‰

**2. PostgreSQL å®¢æˆ·ç«¯è§„èŒƒ**

- ä½¿ç”¨ `pgx/v5` é©±åŠ¨ï¼ˆPostgreSQL å®˜æ–¹æ¨èï¼‰
- å®ç°è¿æ¥æ± 
- æ”¯æŒ Ping æ£€æŸ¥
- æ­£ç¡®å¤„ç†è¿æ¥é”™è¯¯
- **ä¸åœ¨** `internal/` ä¸‹åŒ…å«é…ç½®æˆ– SQL æ–‡ä»¶

**3. æ•°æ®åº“è¿ç§»è§„èŒƒ**

- è¿ç§»æ–‡ä»¶ä½ç½®ï¼š`scripts/migrations/`
- ä½¿ç”¨ SQL è¿ç§»æ–‡ä»¶ï¼ˆä¸ä½¿ç”¨ ORMï¼‰
- æä¾› up å’Œ down è„šæœ¬
- è¿ç§»æ–‡ä»¶å‘½åï¼š`{version}_{description}.up/down.sql`
- æ”¯æŒç‰ˆæœ¬æ§åˆ¶

**4. è¡¨ç»“æ„çº¦æŸ**

ä¸¥æ ¼éµå¾ª `DND_MCP_Clientè¯¦ç»†è®¾è®¡.md` çš„ PostgreSQL æ•°æ®ç»“æ„è®¾è®¡ï¼š

```sql
-- scripts/migrations/000001_initial_schema.up.sql

-- client_sessions (ä¼šè¯å…ƒæ•°æ®è¡¨)
CREATE TABLE client_sessions (
    id UUID PRIMARY KEY,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    deleted_at TIMESTAMP,
    name VARCHAR(255) NOT NULL,
    creator_id VARCHAR(255) NOT NULL,
    mcp_server_url VARCHAR(512) NOT NULL,
    websocket_key VARCHAR(255) NOT NULL,
    max_players INTEGER,
    settings JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'active'
);

CREATE INDEX idx_sessions_created_at ON client_sessions(created_at DESC);
CREATE INDEX idx_sessions_updated_at ON client_sessions(updated_at DESC);
CREATE INDEX idx_sessions_deleted_at ON client_sessions(deleted_at);

-- client_messages (å¯¹è¯æ¶ˆæ¯è¡¨)
CREATE TABLE client_messages (
    id UUID PRIMARY KEY,
    session_id UUID NOT NULL,
    created_at TIMESTAMP NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT,
    tool_calls JSONB,
    player_id VARCHAR(255),
    CONSTRAINT fk_session
        FOREIGN KEY(session_id)
        REFERENCES client_sessions(id)
        ON DELETE CASCADE,
    CONSTRAINT valid_role
        CHECK (role IN ('system', 'user', 'assistant', 'tool'))
);

CREATE INDEX idx_messages_session_time
    ON client_messages(session_id, created_at DESC);
CREATE INDEX idx_messages_role ON client_messages(role);

-- persistence_snapshots (æŒä¹…åŒ–å¿«ç…§è¡¨)
CREATE TABLE persistence_snapshots (
    id UUID PRIMARY KEY,
    created_at TIMESTAMP NOT NULL,
    session_count INTEGER NOT NULL,
    message_count INTEGER NOT NULL,
    duration_ms INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL
);

CREATE INDEX idx_snapshots_created_at
    ON persistence_snapshots(created_at DESC);

-- schema_migrations (è¿ç§»å†å²è¡¨)
CREATE TABLE schema_migrations (
    version BIGINT PRIMARY KEY,
    applied_at TIMESTAMP NOT NULL
);
```

**5. é…ç½®æ‰©å±•è§„èŒƒ**

åŸºäºä»»åŠ¡ä¸€çš„é…ç½®ï¼Œåœ¨ `pkg/config/config.go` ä¸­æ‰©å±•ï¼š

```go
// pkg/config/config.go

// Config åº”ç”¨é…ç½®
type Config struct {
    Redis    RedisConfig    `mapstructure:"redis"`
    Postgres PostgresConfig `mapstructure:"postgres"` // ä»»åŠ¡äºŒæ–°å¢
    Log      LogConfig      `mapstructure:"log"`
}

// PostgresConfig PostgreSQL é…ç½®
type PostgresConfig struct {
    Host            string        `mapstructure:"host" env:"POSTGRES_HOST" default:"localhost:5432"`
    User            string        `mapstructure:"user" env:"POSTGRES_USER" default:"dnd"`
    Password        string        `mapstructure:"password" env:"POSTGRES_PASSWORD" default:"password"`
    DBName          string        `mapstructure:"dbname" env:"POSTGRES_DBNAME" default:"dnd_client"`
    SSLMode         string        `mapstructure:"sslmode" env:"POSTGRES_SSLMODE" default:"disable"`
    PoolSize        int           `mapstructure:"pool_size" env:"POSTGRES_POOL_SIZE" default:"5"`
    MaxConnLifetime time.Duration `mapstructure:"max_conn_lifetime" env:"POSTGRES_MAX_CONN_LIFETIME" default:"1h"`
    MaxConnIdleTime time.Duration `mapstructure:"max_conn_idletime" env:"POSTGRES_MAX_CONN_IDLETIME" default:"30m"`
}
```

#### æŠ€æœ¯è¦æ±‚

**PostgreSQL å®¢æˆ·ç«¯**

```go
// internal/store/postgres/client.go

// Package postgres æä¾› PostgreSQL å­˜å‚¨å®ç°
package postgres

import (
    "context"
    "github.com/jackc/pgx/v5/pgxpool"
)

// Client PostgreSQL å®¢æˆ·ç«¯
type Client struct {
    pool *pgxpool.Pool
}

// NewClient åˆ›å»º PostgreSQL å®¢æˆ·ç«¯
func NewClient(config config.PostgresConfig) (*Client, error) {
    // å®ç°è¿æ¥æ± åˆ›å»º
}

// Ping æ£€æŸ¥è¿æ¥çŠ¶æ€
func (c *Client) Ping(ctx context.Context) error {
    return c.pool.Ping(ctx)
}

// Close å…³é—­è¿æ¥
func (c *Client) Close() error {
    c.pool.Close()
    return nil
}

// Pool è¿”å›è¿æ¥æ± 
func (c *Client) Pool() *pgxpool.Pool {
    return c.pool
}
```

**è¿ç§»ç®¡ç†å™¨**

```go
// internal/store/postgres/migrate.go

// Package postgres æä¾›æ•°æ®åº“è¿ç§»åŠŸèƒ½
package postgres

import (
    "context"
    "io/fs"
)

// Migrator æ•°æ®åº“è¿ç§»å™¨
type Migrator struct {
    client *Client
    fs     fs.FS // ç”¨äºè¯»å– scripts/migrations/
}

// NewMigrator åˆ›å»ºè¿ç§»å™¨
func NewMigrator(client *Client, migrationsFS fs.FS) *Migrator {
    return &Migrator{
        client: client,
        fs:     migrationsFS,
    }
}

// Up æ‰§è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
func (m *Migrator) Up(ctx context.Context) error {
    // 1. è¯»å– scripts/migrations/ ç›®å½•
    // 2. æŸ¥è¯¢å½“å‰ç‰ˆæœ¬
    // 3. æ‰§è¡Œå¾…æ‰§è¡Œçš„è¿ç§»
}

// Down å›æ»šæœ€åä¸€æ¬¡è¿ç§»
func (m *Migrator) Down(ctx context.Context) error {
    // å®ç°å›æ»šé€»è¾‘
}

// Status æŸ¥çœ‹è¿ç§»çŠ¶æ€
func (m *Migrator) Status(ctx context.Context) ([]Migration, error) {
    // æŸ¥è¯¢è¿ç§»çŠ¶æ€
}

// Migration è¿ç§»è®°å½•
type Migration struct {
    Version   int64
    Name      string
    Applied   bool
    AppliedAt time.Time
}
```

#### æ–‡ä»¶æ¸…å•

- [ ] `pkg/config/config.go` - é…ç½®æ‰©å±•ï¼ˆæ·»åŠ  PostgreSQLï¼‰
- [ ] `internal/store/postgres/client.go` - PostgreSQL å®¢æˆ·ç«¯
- [ ] `internal/store/postgres/migrate.go` - è¿ç§»ç®¡ç†å™¨
- [ ] `scripts/migrations/000001_initial_schema.up.sql` - åˆå§‹åŒ–è¡¨ç»“æ„ âš ï¸
- [ ] `scripts/migrations/000001_initial_schema.down.sql` - å›æ»šè„šæœ¬ âš ï¸
- [ ] `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹æ›´æ–°
- [ ] `pkg/errors/errors.go` - é”™è¯¯å®šä¹‰æ›´æ–°

#### æµ‹è¯•è¦æ±‚

**æµ‹è¯•ä½ç½®è§„èŒƒ**ï¼šæ‰€æœ‰æµ‹è¯•å¿…é¡»åœ¨ `tests/` ç›®å½•ä¸‹

**å•å…ƒæµ‹è¯•**

- [ ] `tests/unit/store/postgres/client_test.go`
  - Mock pgxpool.Pool
  - æµ‹è¯•è¿æ¥é…ç½®
  - æµ‹è¯• Ping åŠŸèƒ½
  - æµ‹è¯•é”™è¯¯å¤„ç†

- [ ] `tests/unit/store/postgres/migrate_test.go`
  - æµ‹è¯•è¿ç§»æ–‡ä»¶è§£æ
  - æµ‹è¯•ç‰ˆæœ¬ç®¡ç†

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/store/postgres/client_integration_test.go`
  - ä½¿ç”¨ testcontainers å¯åŠ¨ PostgreSQL
  - æµ‹è¯•è¿æ¥å»ºç«‹
  - æµ‹è¯•è¿æ¥æ± 
  - æµ‹è¯• Ping è¿”å›æ­£å¸¸

- [ ] `tests/integration/store/postgres/migrate_integration_test.go`
  - æµ‹è¯•æ‰§è¡Œ up è¿ç§»
  - éªŒè¯è¡¨ç»“æ„åˆ›å»º
  - æµ‹è¯•æ‰§è¡Œ down è¿ç§»
  - æµ‹è¯•è¿ç§»å¹‚ç­‰æ€§

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/migrate_cli_test.go`
  - æµ‹è¯• `migrate up` å‘½ä»¤
  - æµ‹è¯• `migrate down` å‘½ä»¤
  - æµ‹è¯• `migrate status` å‘½ä»¤

---

### éœ€æ±‚ 2.2ï¼šä» Redis å¤‡ä»½ä¼šè¯åˆ° PostgreSQL

#### éœ€æ±‚æè¿°

å®ç°ä¼šè¯æ•°æ®ä» Redis åˆ° PostgreSQL çš„å¤‡ä»½åŠŸèƒ½ã€‚**æ¥å£åœ¨ `internal/persistence/interface.go` å®šä¹‰ï¼ˆä½¿ç”¨æ–¹ï¼‰ï¼Œå®ç°åœ¨ `internal/store/postgres/session.go`ï¼ˆå®ç°æ–¹ï¼‰ã€‚**

#### è¯¦ç»†çº¦æŸ

**1. æ¥å£å®šä¹‰è§„èŒƒ**

éµå¾ª `doc/è§„èŒƒ.md`ï¼š**åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£ï¼Œè€Œéå®ç°æ–¹**

```go
// internal/persistence/interface.go

// Package persistence æä¾›æŒä¹…åŒ–æœåŠ¡
package persistence

import "dnd-client/internal/models"

// SessionWriter ä¼šè¯å†™å…¥æ¥å£ï¼ˆåœ¨ä½¿ç”¨æ–¹å®šä¹‰ï¼‰
type SessionWriter interface {
    // Create åˆ›å»ºä¼šè¯
    Create(ctx context.Context, session *models.Session) error

    // BatchCreate æ‰¹é‡åˆ›å»ºä¼šè¯
    BatchCreate(ctx context.Context, sessions []*models.Session) error

    // Update æ›´æ–°ä¼šè¯
    Update(ctx context.Context, session *models.Session) error
}

// SessionReader ä¼šè¯è¯»å–æ¥å£
type SessionReader interface {
    // Get è·å–ä¼šè¯
    Get(ctx context.Context, id string) (*models.Session, error)

    // List åˆ—å‡ºæ‰€æœ‰ä¼šè¯
    List(ctx context.Context) ([]*models.Session, error)
}
```

**2. PostgreSQL å®ç°æ¥å£**

```go
// internal/store/postgres/session.go

// Package postgres æä¾› PostgreSQL å­˜å‚¨
package postgres

import (
    "context"
    "dnd-client/internal/models"
    "dnd-client/internal/persistence" // å¯¼å…¥ä½¿ç”¨æ–¹çš„æ¥å£
)

// PostgresSessionStore PostgreSQL ä¼šè¯å­˜å‚¨
type PostgresSessionStore struct {
    client *Client
}

// ç¡®ä¿ PostgresSessionStore å®ç°äº† SessionWriter å’Œ SessionReader æ¥å£
var _ persistence.SessionWriter = (*PostgresSessionStore)(nil)
var _ persistence.SessionReader = (*PostgresSessionStore)(nil)

// NewPostgresSessionStore åˆ›å»º PostgreSQL ä¼šè¯å­˜å‚¨
func NewPostgresSessionStore(client *Client) *PostgresSessionStore {
    return &PostgresSessionStore{client: client}
}

// Create åˆ›å»ºä¼šè¯ï¼ˆå®ç° persistence.SessionWriter æ¥å£ï¼‰
func (s *PostgresSessionStore) Create(ctx context.Context, session *models.Session) error {
    // ä½¿ç”¨ UPSERT: INSERT ... ON CONFLICT DO UPDATE
}

// BatchCreate æ‰¹é‡åˆ›å»ºä¼šè¯
func (s *PostgresSessionStore) BatchCreate(ctx context.Context, sessions []*models.Session) error {
    // ä½¿ç”¨ COPY æˆ–æ‰¹é‡ INSERT
}

// Update æ›´æ–°ä¼šè¯
func (s *PostgresSessionStore) Update(ctx context.Context, session *models.Session) error {
    // å®ç°æ›´æ–°é€»è¾‘
}

// Get è·å–ä¼šè¯ï¼ˆå®ç° persistence.SessionReader æ¥å£ï¼‰
func (s *PostgresSessionStore) Get(ctx context.Context, id string) (*models.Session, error) {
    // å®ç°æŸ¥è¯¢é€»è¾‘
}

// List åˆ—å‡ºæ‰€æœ‰ä¼šè¯
func (s *PostgresSessionStore) List(ctx context.Context) ([]*models.Session, error) {
    // å®ç°åˆ—è¡¨æŸ¥è¯¢
}
```

**3. å¤‡ä»½æœåŠ¡å®ç°**

```go
// internal/persistence/backup.go

// Package persistence æä¾›æŒä¹…åŒ–æœåŠ¡
package persistence

// BackupService å¤‡ä»½æœåŠ¡
type BackupService struct {
    redisReader    SessionReader    // Redis ä¼šè¯è¯»å–
    postgresWriter SessionWriter    // PostgreSQL ä¼šè¯å†™å…¥
}

// NewBackupService åˆ›å»ºå¤‡ä»½æœåŠ¡
func NewBackupService(redisReader SessionReader, postgresWriter SessionWriter) *BackupService {
    return &BackupService{
        redisReader:    redisReader,
        postgresWriter: postgresWriter,
    }
}

// BackupSessions å¤‡ä»½ä¼šè¯
func (s *BackupService) BackupSessions(ctx context.Context) error {
    // 1. ä» Redis è¯»å–ä¼šè¯
    sessions, err := s.redisReader.List(ctx)
    if err != nil {
        return err
    }

    // 2. æ‰¹é‡å†™å…¥ PostgreSQL
    return s.postgresWriter.BatchCreate(ctx, sessions)
}
```

**4. UPSERT ç­–ç•¥**

- ä½¿ç”¨ PostgreSQL çš„ `INSERT ... ON CONFLICT DO UPDATE`
- ä»¥ `id` ä¸ºä¸»é”®ï¼Œå†²çªæ—¶æ›´æ–°
- ä¿æŒ updated_at å­—æ®µåŒæ­¥

**5. æ•°æ®æ˜ å°„çº¦æŸ**

Redis Hash å­—æ®µ â†’ PostgreSQL åˆ—ï¼š

| Redis Field | PostgreSQL Column | ç±»å‹è½¬æ¢ |
|------------|-------------------|---------|
| id | id | UUID |
| name | name | VARCHAR |
| creator_id | creator_id | VARCHAR |
| mcp_server_url | mcp_server_url | VARCHAR |
| websocket_key | websocket_key | VARCHAR |
| max_players | max_players | INTEGER |
| settings | settings | JSONB |
| created_at | created_at | TIMESTAMP |
| updated_at | updated_at | TIMESTAMP |
| status | status | VARCHAR |
| deleted_at | deleted_at | TIMESTAMP |

#### æŠ€æœ¯è¦æ±‚

**SQL å®ç°**

```sql
-- Upsert ä¼šè¯
INSERT INTO client_sessions (
    id, created_at, updated_at, deleted_at,
    name, creator_id, mcp_server_url, websocket_key,
    max_players, settings, status
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
)
ON CONFLICT (id) DO UPDATE SET
    updated_at = EXCLUDED.updated_at,
    deleted_at = EXCLUDED.deleted_at,
    name = EXCLUDED.name,
    max_players = EXCLUDED.max_players,
    settings = EXCLUDED.settings,
    status = EXCLUDED.status;
```

**æ€§èƒ½è¦æ±‚**

- æ‰¹é‡å¤‡ä»½ 100 ä¸ªä¼šè¯è€—æ—¶ < 1 ç§’
- å•ä¸ªä¼šè¯å¤‡ä»½è€—æ—¶ < 10ms
- ä½¿ç”¨è¿æ¥æ± å¤ç”¨è¿æ¥

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/persistence/interface.go` - æ¥å£å®šä¹‰ï¼ˆä½¿ç”¨æ–¹ï¼‰âš ï¸
- [ ] `internal/persistence/backup.go` - å¤‡ä»½æœåŠ¡
- [ ] `internal/store/postgres/session.go` - PostgreSQL ä¼šè¯å­˜å‚¨å®ç°
- [ ] `internal/store/postgres/client.go` - PostgreSQL å®¢æˆ·ç«¯æ‰©å±•

#### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•**

- [ ] `tests/unit/persistence/backup_test.go`
  - Mock SessionReader å’Œ SessionWriter
  - æµ‹è¯•å¤‡ä»½é€»è¾‘
  - æµ‹è¯•é”™è¯¯å¤„ç†

- [ ] `tests/unit/store/postgres/session_test.go`
  - Mock pgxpool.Pool
  - æµ‹è¯• Createï¼ˆUPSERTï¼‰
  - æµ‹è¯• BatchCreate
  - æµ‹è¯• Get
  - æµ‹è¯• List
  - æµ‹è¯• Update

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/persistence/backup_integration_test.go`
  - ä½¿ç”¨çœŸå® Redis å’Œ PostgreSQL
  - æµ‹è¯•å®Œæ•´å¤‡ä»½æµç¨‹
  - éªŒè¯æ•°æ®æ­£ç¡®æ€§

- [ ] `tests/integration/store/postgres/session_integration_test.go`
  - ä½¿ç”¨çœŸå® PostgreSQL
  - æµ‹è¯• UPSERT é€»è¾‘
  - æµ‹è¯•æ•°æ®æŒä¹…åŒ–
  - æµ‹è¯•å¹¶å‘å®‰å…¨æ€§

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/backup_session_test.go`
  - æµ‹è¯• `backup --session` å‘½ä»¤
  - éªŒè¯ PostgreSQL æ•°æ®æ­£ç¡®
  - æµ‹è¯•é‡å¤å¤‡ä»½ï¼ˆUPSERTï¼‰

---

### éœ€æ±‚ 2.3ï¼šä» Redis å¤‡ä»½æ¶ˆæ¯åˆ° PostgreSQL

#### éœ€æ±‚æè¿°

å®ç°æ¶ˆæ¯æ•°æ®ä» Redis åˆ° PostgreSQL çš„å¤‡ä»½åŠŸèƒ½ï¼Œä½¿ç”¨æ‰¹é‡æ’å…¥æå‡æ€§èƒ½ã€‚

#### è¯¦ç»†çº¦æŸ

**1. æ¥å£å®šä¹‰æ‰©å±•**

åœ¨ `internal/persistence/interface.go` ä¸­æ‰©å±•æ¥å£ï¼š

```go
// MessageWriter æ¶ˆæ¯å†™å…¥æ¥å£
type MessageWriter interface {
    // Create åˆ›å»ºæ¶ˆæ¯
    Create(ctx context.Context, message *models.Message) error

    // BatchCreate æ‰¹é‡åˆ›å»ºæ¶ˆæ¯
    BatchCreate(ctx context.Context, messages []*models.Message) error
}

// MessageReader æ¶ˆæ¯è¯»å–æ¥å£
type MessageReader interface {
    // Get è·å–æ¶ˆæ¯
    Get(ctx context.Context, sessionID, messageID string) (*models.Message, error)

    // List è·å–æ¶ˆæ¯åˆ—è¡¨
    List(ctx context.Context, sessionID string, limit int) ([]*models.Message, error)

    // ListByRole æŒ‰è§’è‰²è·å–æ¶ˆæ¯
    ListByRole(ctx context.Context, sessionID, role string, limit int) ([]*models.Message, error)
}
```

**2. PostgreSQL å®ç°**

```go
// internal/store/postgres/message.go

// PostgresMessageStore PostgreSQL æ¶ˆæ¯å­˜å‚¨
type PostgresMessageStore struct {
    client *Client
}

var _ persistence.MessageWriter = (*PostgresMessageStore)(nil)
var _ persistence.MessageReader = (*PostgresMessageStore)(nil)

// Create åˆ›å»ºæ¶ˆæ¯ï¼ˆå®ç° persistence.MessageWriterï¼‰
func (s *PostgresMessageStore) Create(ctx context.Context, message *models.Message) error {
    // å®ç°æ’å…¥é€»è¾‘
}

// BatchCreate æ‰¹é‡åˆ›å»ºæ¶ˆæ¯
func (s *PostgresMessageStore) BatchCreate(ctx context.Context, messages []*models.Message) error {
    // ä½¿ç”¨ COPY æˆ–æ‰¹é‡ INSERT
    // ON CONFLICT DO NOTHING é¿å…é‡å¤
}
```

**3. å»é‡ç­–ç•¥**

- ä½¿ç”¨ `ON CONFLICT DO NOTHING` é¿å…é‡å¤
- ä»¥ `id` ä¸ºä¸»é”®
- æ¶ˆæ¯ä¸å¯å˜ï¼Œä¸æ›´æ–°å·²å­˜åœ¨çš„æ¶ˆæ¯

**4. æ‰¹é‡æ’å…¥ä¼˜åŒ–**

- ä½¿ç”¨ PostgreSQL çš„ `COPY` å‘½ä»¤ï¼ˆæ€§èƒ½æœ€ä½³ï¼‰
- æˆ–ä½¿ç”¨æ‰¹é‡ `INSERT`ï¼ˆ`VALUES (), (), ()`ï¼‰
- æ¯æ‰¹ 100-1000 æ¡æ¶ˆæ¯

#### æŠ€æœ¯è¦æ±‚

**SQL å®ç°**

```sql
-- æ‰¹é‡æ’å…¥æ¶ˆæ¯
INSERT INTO client_messages (
    id, session_id, created_at, role, content, tool_calls, player_id
) VALUES
    ($1, $2, $3, $4, $5, $6, $7),
    ($8, $9, $10, $11, $12, $13, $14),
    -- ...
ON CONFLICT (id) DO NOTHING;
```

**COPY å®ç°**

```go
// ä½¿ç”¨ pgx CopyFrom
copyCount, err := pgx.CopyFrom(
    ctx,
    conn,
    []string{"client_messages"},
    []string{"id", "session_id", "created_at", "role", "content", "tool_calls", "player_id"},
    pgx.CopyFromSlice(len(messages), func(i int) ([]interface{}, error) {
        msg := messages[i]
        return []interface{}{
            msg.ID,
            msg.SessionID,
            msg.CreatedAt,
            msg.Role,
            msg.Content,
            msg.ToolCallsJSON,
            msg.PlayerID,
        }, nil
    }),
)
```

**æ€§èƒ½è¦æ±‚**

- æ‰¹é‡å¤‡ä»½ 1000 æ¡æ¶ˆæ¯è€—æ—¶ < 100ms
- å•æ¡æ¶ˆæ¯å¤‡ä»½è€—æ—¶ < 1ms
- æ”¯æŒè‡³å°‘ 10000 æ¡æ¶ˆæ¯/ä¼šè¯

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/persistence/interface.go` - æ¥å£æ‰©å±•
- [ ] `internal/persistence/backup.go` - å¤‡ä»½æœåŠ¡æ‰©å±•
- [ ] `internal/store/postgres/message.go` - PostgreSQL æ¶ˆæ¯å­˜å‚¨å®ç°

#### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•**

- [ ] `tests/unit/store/postgres/message_test.go`
  - Mock pgxpool.Pool
  - æµ‹è¯• Create
  - æµ‹è¯• BatchCreateï¼ˆCOPY å‘½ä»¤ï¼‰
  - æµ‹è¯• Get
  - æµ‹è¯• Listï¼ˆä¸åŒå‚æ•°ï¼‰
  - æµ‹è¯• ListByRole
  - æµ‹è¯•é”™è¯¯å¤„ç†

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/store/postgres/message_integration_test.go`
  - ä½¿ç”¨çœŸå® PostgreSQL
  - æµ‹è¯•æ‰¹é‡æ’å…¥æ€§èƒ½
  - æµ‹è¯•æ•°æ®å»é‡ï¼ˆON CONFLICTï¼‰
  - æµ‹è¯•äº‹åŠ¡æ­£ç¡®æ€§
  - éªŒè¯æ•°æ®å®Œæ•´æ€§

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/backup_message_test.go`
  - æµ‹è¯• `backup --all` å‘½ä»¤
  - éªŒè¯å¤§é‡æ¶ˆæ¯æ€§èƒ½
  - éªŒè¯æ•°æ®æ­£ç¡®æ€§

---

### éœ€æ±‚ 2.4ï¼šä» PostgreSQL æ¢å¤ä¼šè¯åˆ° Redis

#### éœ€æ±‚æè¿°

å®ç°ä¼šè¯æ•°æ®ä» PostgreSQL åˆ° Redis çš„æ¢å¤åŠŸèƒ½ã€‚

#### è¯¦ç»†çº¦æŸ

**1. æ¢å¤æœåŠ¡å®ç°**

```go
// internal/persistence/restore.go

// Package persistence æä¾›æŒä¹…åŒ–æœåŠ¡
package persistence

// RestoreService æ¢å¤æœåŠ¡
type RestoreService struct {
    postgresReader SessionReader    // PostgreSQL ä¼šè¯è¯»å–
    redisWriter    SessionWriter    // Redis ä¼šè¯å†™å…¥
}

// NewRestoreService åˆ›å»ºæ¢å¤æœåŠ¡
func NewRestoreService(postgresReader SessionReader, redisWriter SessionWriter) *RestoreService {
    return &RestoreService{
        postgresReader: postgresReader,
        redisWriter:    redisWriter,
    }
}

// RestoreSessions æ¢å¤ä¼šè¯
func (s *RestoreService) RestoreSessions(ctx context.Context, force bool) error {
    // 1. ä» PostgreSQL æŸ¥è¯¢
    sessions, err := s.postgresReader.List(ctx)
    if err != nil {
        return fmt.Errorf("æŸ¥è¯¢ PostgreSQL å¤±è´¥: %w", err)
    }

    // 2. æ‰¹é‡å†™å…¥ Redis
    for _, session := range sessions {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¦‚æœ force=falseï¼‰
        if !force {
            _, err := s.redisWriter.Get(ctx, session.ID)
            if err == nil {
                continue // å·²å­˜åœ¨ï¼Œè·³è¿‡
            }
        }

        // å†™å…¥ Redis
        if err := s.redisWriter.Create(ctx, session); err != nil {
            return fmt.Errorf("å†™å…¥ Redis å¤±è´¥: %w", err)
        }
    }

    return nil
}
```

**2. Redis å®ç°æ¥å£**

```go
// internal/store/redis/session.go

// RedisSessionStore Redis ä¼šè¯å­˜å‚¨
type RedisSessionStore struct {
    client *redis.Client
}

var _ persistence.SessionWriter = (*RedisSessionStore)(nil)
var _ persistence.SessionReader = (*RedisSessionStore)(nil)

// Create åˆ›å»ºä¼šè¯ï¼ˆå®ç° persistence.SessionWriterï¼‰
func (s *RedisSessionStore) Create(ctx context.Context, session *models.Session) error {
    // ä½¿ç”¨ HSET å’Œ Pipeline
}

// Get è·å–ä¼šè¯ï¼ˆå®ç° persistence.SessionReaderï¼‰
func (s *RedisSessionStore) Get(ctx context.Context, id string) (*models.Session, error) {
    // ä½¿ç”¨ HGETALL
}

// List åˆ—å‡ºä¼šè¯
func (s *RedisSessionStore) List(ctx context.Context) ([]*models.Session, error) {
    // ä½¿ç”¨ SMEMBERS å’Œ HGETALL
}
```

**3. è½¯åˆ é™¤è¿‡æ»¤**

- åªæ¢å¤ deleted_at ä¸º NULL çš„ä¼šè¯
- åœ¨ PostgreSQL æŸ¥è¯¢æ—¶è¿‡æ»¤ï¼š`WHERE deleted_at IS NULL`

**4. è¦†ç›–ç­–ç•¥**

- é»˜è®¤ä¸è¦†ç›– Redis ä¸­å·²å­˜åœ¨çš„æ•°æ®
- å¯é€‰å‚æ•° `--force` å¼ºåˆ¶è¦†ç›–

#### æŠ€æœ¯è¦æ±‚

**æ€§èƒ½è¦æ±‚**

- æ¢å¤ 100 ä¸ªä¼šè¯è€—æ—¶ < 500ms
- ä½¿ç”¨ Redis Pipeline ä¼˜åŒ–

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/persistence/restore.go` - æ¢å¤æœåŠ¡
- [ ] `internal/store/redis/session.go` - Redis ä¼šè¯å­˜å‚¨ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œéœ€éªŒè¯æ¥å£å®ç°ï¼‰
- [ ] `internal/cli/restore.go` - æ¢å¤ CLI å‘½ä»¤

#### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•**

- [ ] `tests/unit/persistence/restore_test.go`
  - Mock SessionReader å’Œ SessionWriter
  - æµ‹è¯•æ¢å¤é€»è¾‘
  - æµ‹è¯• force å‚æ•°
  - æµ‹è¯•è½¯åˆ é™¤è¿‡æ»¤

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/persistence/restore_integration_test.go`
  - æµ‹è¯•å®Œæ•´æ¢å¤æµç¨‹
  - éªŒè¯ Redis æ•°æ®æ­£ç¡®
  - æµ‹è¯• force å‚æ•°
  - æµ‹è¯•è½¯åˆ é™¤è¿‡æ»¤

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/restore_session_test.go`
  - æµ‹è¯• `restore --all` å‘½ä»¤
  - æµ‹è¯• `restore --session` å‘½ä»¤
  - éªŒè¯æ•°æ®å®Œæ•´æ€§

---

### éœ€æ±‚ 2.5ï¼šä» PostgreSQL æ¢å¤æ¶ˆæ¯åˆ° Redis

#### éœ€æ±‚æè¿°

å®ç°æ¶ˆæ¯æ•°æ®ä» PostgreSQL åˆ° Redis çš„æ¢å¤åŠŸèƒ½ã€‚

#### è¯¦ç»†çº¦æŸ

**1. æ¢å¤æœåŠ¡æ‰©å±•**

```go
// internal/persistence/restore.go

// RestoreMessages æ¢å¤æ¶ˆæ¯
func (s *RestoreService) RestoreMessages(ctx context.Context, sessionID string, force bool) error {
    // 1. ä» PostgreSQL æŸ¥è¯¢
    messages, err := s.postgresReader.List(ctx, sessionID, 0) // 0 = æ— é™åˆ¶
    if err != nil {
        return fmt.Errorf("æŸ¥è¯¢ PostgreSQL å¤±è´¥: %w", err)
    }

    // 2. æ‰¹é‡å†™å…¥ Redis
    for _, msg := range messages {
        if err := s.redisWriter.Create(ctx, msg); err != nil {
            return fmt.Errorf("å†™å…¥ Redis å¤±è´¥: %w", err)
        }
    }

    return nil
}
```

**2. Redis æ¶ˆæ¯å­˜å‚¨å®ç°**

```go
// internal/store/redis/message.go

// RedisMessageStore Redis æ¶ˆæ¯å­˜å‚¨
type RedisMessageStore struct {
    client *redis.Client
}

var _ persistence.MessageWriter = (*RedisMessageStore)(nil)
var _ persistence.MessageReader = (*RedisMessageStore)(nil)

// Create åˆ›å»ºæ¶ˆæ¯ï¼ˆå®ç° persistence.MessageWriterï¼‰
func (s *RedisMessageStore) Create(ctx context.Context, message *models.Message) error {
    // ä½¿ç”¨ ZADD
}
```

**3. æ‰¹é‡æ“ä½œä¼˜åŒ–**

- ä½¿ç”¨ Redis Pipeline
- æ¯æ‰¹å¤„ç† 1000 æ¡æ¶ˆæ¯
- æŒ‰ session_id åˆ†ç»„å¤„ç†

#### æŠ€æœ¯è¦æ±‚

**æ€§èƒ½è¦æ±‚**

- æ¢å¤ 1000 æ¡æ¶ˆæ¯è€—æ—¶ < 200ms
- ä½¿ç”¨ Pipeline ä¼˜åŒ–

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/persistence/restore.go` - æ¢å¤æœåŠ¡æ‰©å±•
- [ ] `internal/store/redis/message.go` - Redis æ¶ˆæ¯å­˜å‚¨ï¼ˆä»»åŠ¡ä¸€å·²å®Œæˆï¼Œéœ€éªŒè¯æ¥å£å®ç°ï¼‰

#### æµ‹è¯•è¦æ±‚

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/persistence/restore_message_integration_test.go`
  - æµ‹è¯•å®Œæ•´æ¢å¤æµç¨‹
  - éªŒè¯ Redis æ•°æ®æ­£ç¡®
  - æµ‹è¯•æ—¶é—´æ’åºæ­£ç¡®
  - æµ‹è¯•å¤§é‡æ¶ˆæ¯æ€§èƒ½

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/restore_message_test.go`
  - æµ‹è¯• `restore --session` å‘½ä»¤
  - éªŒè¯æ•°æ®å®Œæ•´æ€§

---

### éœ€æ±‚ 2.6ï¼šå‘½ä»¤è¡Œå·¥å…·æµ‹è¯•æŒä¹…åŒ–

#### éœ€æ±‚æè¿°

æ‰©å±•å‘½ä»¤è¡Œå·¥å…·ï¼Œæ·»åŠ å¤‡ä»½ã€æ¢å¤ã€è¿ç§»ç­‰æŒä¹…åŒ–ç›¸å…³å‘½ä»¤ã€‚

#### è¯¦ç»†çº¦æŸ

**1. å‘½ä»¤ç»“æ„æ‰©å±•**

åŸºäºä»»åŠ¡ä¸€çš„ CLI æ¡†æ¶ï¼Œæ–°å¢å‘½ä»¤ï¼š

```
dnd-client
â”œâ”€â”€ migrate              # æ–°å¢ï¼šæ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ up              æ‰§è¡Œè¿ç§»
â”‚   â”œâ”€â”€ down            å›æ»šè¿ç§»
â”‚   â””â”€â”€ status          æŸ¥çœ‹è¿ç§»çŠ¶æ€
â”œâ”€â”€ backup              # æ–°å¢ï¼šå¤‡ä»½æ•°æ®
â”‚   â”œâ”€â”€ --all           å¤‡ä»½æ‰€æœ‰æ•°æ®
â”‚   â”œâ”€â”€ --session       å¤‡ä»½æŒ‡å®šä¼šè¯
â”‚   â””â”€â”€ list            æŸ¥çœ‹å¤‡ä»½è®°å½•
â””â”€â”€ restore             # æ–°å¢ï¼šæ¢å¤æ•°æ®
    â”œâ”€â”€ --all           æ¢å¤æ‰€æœ‰æ•°æ®
    â”œâ”€â”€ --session       æ¢å¤æŒ‡å®šä¼šè¯
    â””â”€â”€ --force         å¼ºåˆ¶è¦†ç›–
```

**2. å‘½ä»¤å®ç°**

```go
// internal/cli/migrate.go

// migrateCmd è¿ç§»å‘½ä»¤
var migrateCmd = &cobra.Command{
    Use:   "migrate",
    Short: "æ•°æ®åº“è¿ç§»",
    Long:  `æ‰§è¡Œæ•°æ®åº“è¿ç§»æ“ä½œ`,
}

var migrateUpCmd = &cobra.Command{
    Use:   "up",
    Short: "æ‰§è¡Œè¿ç§»",
    RunE: func(cmd *cobra.Command, args []string) error {
        // è·å–è¿ç§»å™¨
        migrator := getMigrator()

        // æ‰§è¡Œè¿ç§»
        if err := migrator.Up(cmd.Context()); err != nil {
            return fmt.Errorf("æ‰§è¡Œè¿ç§»å¤±è´¥: %w", err)
        }

        fmt.Println("è¿ç§»æ‰§è¡ŒæˆåŠŸ")
        return nil
    },
}

func init() {
    rootCmd.AddCommand(migrateCmd)
    migrateCmd.AddCommand(migrateUpCmd)
    migrateCmd.AddCommand(migrateDownCmd)
    migrateCmd.AddCommand(migrateStatusCmd)
}
```

```go
// internal/cli/backup.go

// backupCmd å¤‡ä»½å‘½ä»¤
var backupCmd = &cobra.Command{
    Use:   "backup",
    Short: "å¤‡ä»½æ•°æ®åˆ° PostgreSQL",
    Long:  `ä» Redis å¤‡ä»½ä¼šè¯å’Œæ¶ˆæ¯åˆ° PostgreSQL`,
    RunE: func(cmd *cobra.Command, args []string) error {
        // å‚æ•°è§£æ
        all, _ := cmd.Flags().GetBool("all")
        sessionID, _ := cmd.Flags().GetString("session")
        list, _ := cmd.Flags().GetBool("list")

        if list {
            return listBackups(cmd.Context())
        }

        if all {
            return backupAll(cmd.Context())
        }

        if sessionID != "" {
            return backupSession(cmd.Context(), sessionID)
        }

        return fmt.Errorf("è¯·æŒ‡å®š --all æˆ– --session å‚æ•°")
    },
}

func init() {
    rootCmd.AddCommand(backupCmd)
    backupCmd.Flags().BoolP("all", "a", false, "å¤‡ä»½æ‰€æœ‰æ•°æ®")
    backupCmd.Flags().StringP("session", "s", "", "å¤‡ä»½æŒ‡å®šä¼šè¯")
    backupCmd.Flags().Bool("list", false, "æŸ¥çœ‹å¤‡ä»½è®°å½•")
}
```

```go
// internal/cli/restore.go

// restoreCmd æ¢å¤å‘½ä»¤
var restoreCmd = &cobra.Command{
    Use:   "restore",
    Short: "ä» PostgreSQL æ¢å¤æ•°æ®",
    Long:  `ä» PostgreSQL æ¢å¤ä¼šè¯å’Œæ¶ˆæ¯åˆ° Redis`,
    RunE: func(cmd *cobra.Command, args []string) error {
        // å‚æ•°è§£æ
        all, _ := cmd.Flags().GetBool("all")
        sessionID, _ := cmd.Flags().GetString("session")
        force, _ := cmd.Flags().GetBool("force")

        if all {
            return restoreAll(cmd.Context(), force)
        }

        if sessionID != "" {
            return restoreSession(cmd.Context(), sessionID, force)
        }

        return fmt.Errorf("è¯·æŒ‡å®š --all æˆ– --session å‚æ•°")
    },
}

func init() {
    rootCmd.AddCommand(restoreCmd)
    restoreCmd.Flags().BoolP("all", "a", false, "æ¢å¤æ‰€æœ‰æ•°æ®")
    restoreCmd.Flags().StringP("session", "s", "", "æ¢å¤æŒ‡å®šä¼šè¯")
    restoreCmd.Flags().Bool("force", false, "å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ•°æ®")
}
```

**3. è¾“å‡ºæ ¼å¼è§„èŒƒ**

- é»˜è®¤ä½¿ç”¨è¡¨æ ¼æ ¼å¼
- æ”¯æŒ JSON æ ¼å¼ï¼ˆ`--output json`ï¼‰
- æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆå¤§æ•°æ®é‡æ—¶ï¼‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆè€—æ—¶ã€æ•°é‡ç­‰ï¼‰

**4. é”™è¯¯å¤„ç†è§„èŒƒ**

éµå¾ª `doc/è§„èŒƒ.md` çš„é”™è¯¯å¤„ç†åŸåˆ™ï¼š
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- é”™è¯¯åº”è¯¥è¿”å›ï¼Œä¸æ˜¯è®°å½•æ—¥å¿—åè¿”å› nil
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•

#### æ–‡ä»¶æ¸…å•

- [ ] `internal/cli/migrate.go` - è¿ç§»å‘½ä»¤
- [ ] `internal/cli/backup.go` - å¤‡ä»½å‘½ä»¤
- [ ] `internal/cli/restore.go` - æ¢å¤å‘½ä»¤
- [ ] `internal/persistence/backup.go` - å¤‡ä»½æœåŠ¡
- [ ] `internal/persistence/restore.go` - æ¢å¤æœåŠ¡

#### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•**

- [ ] `tests/unit/cli/migrate_test.go`
  - æµ‹è¯•å‘½ä»¤å‚æ•°è§£æ
  - Mock è¿ç§»å™¨

- [ ] `tests/unit/cli/backup_test.go`
  - æµ‹è¯•å‘½ä»¤å‚æ•°è§£æ
  - Mock å¤‡ä»½æœåŠ¡

- [ ] `tests/unit/cli/restore_test.go`
  - æµ‹è¯•å‘½ä»¤å‚æ•°è§£æ
  - Mock æ¢å¤æœåŠ¡

**é›†æˆæµ‹è¯•**

- [ ] `tests/integration/cli/backup_integration_test.go`
  - æµ‹è¯•å®Œæ•´å¤‡ä»½æµç¨‹
  - éªŒè¯æ•°æ®æ­£ç¡®æ€§

- [ ] `tests/integration/cli/restore_integration_test.go`
  - æµ‹è¯•å®Œæ•´æ¢å¤æµç¨‹
  - éªŒè¯æ•°æ®å®Œæ•´æ€§

**é»‘ç›’æµ‹è¯•**

- [ ] `tests/e2e/backup_restore_test.go`
  - æµ‹è¯•æ‰€æœ‰å¤‡ä»½å‘½ä»¤
  - æµ‹è¯•æ‰€æœ‰æ¢å¤å‘½ä»¤
  - æµ‹è¯•å®Œæ•´å¤‡ä»½æ¢å¤æµç¨‹
  - éªŒè¯æ•°æ®ä¸€è‡´æ€§

---

## ä¾èµ–å…³ç³»å›¾

### æ¨¡å—ä¾èµ–

éµå¾ª `doc/è§„èŒƒ.md` çš„ä¾èµ–åŸåˆ™ï¼š

```
cli (å‘½ä»¤è¡Œå±‚)
  â†“
persistence (æŒä¹…åŒ–æœåŠ¡å±‚) - å®šä¹‰æ¥å£ï¼ˆä½¿ç”¨æ–¹ï¼‰
  â†“
store (å­˜å‚¨å®ç°å±‚: postgres, redis) - å®ç°æ¥å£
  â†“
models (é¢†åŸŸæ¨¡å‹) - æœ€åº•å±‚
```

### æ¥å£å®šä¹‰ä½ç½®

```go
// internal/persistence/interface.go - ä½¿ç”¨æ–¹å®šä¹‰æ¥å£
type SessionWriter interface {
    Create(ctx context.Context, session *models.Session) error
    BatchCreate(ctx context.Context, sessions []*models.Session) error
}

// internal/store/postgres/session.go - å®ç°æ–¹å®ç°æ¥å£
type PostgresSessionStore struct { ... }
func (s *PostgresSessionStore) Create(...) error { ... }

// internal/store/redis/session.go - å®ç°æ–¹å®ç°æ¥å£
type RedisSessionStore struct { ... }
func (s *RedisSessionStore) Create(...) error { ... }
```

### é…ç½®å’Œé”™è¯¯

```
pkg/
â”œâ”€â”€ config/      # é…ç½®ç®¡ç†ï¼ˆå¯è¢«å¤–éƒ¨å¯¼å…¥ï¼‰
â””â”€â”€ errors/      # é”™è¯¯å®šä¹‰ï¼ˆå¯è¢«å¤–éƒ¨å¯¼å…¥ï¼‰
```

---

## æµ‹è¯•ç­–ç•¥æ€»è§ˆ

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

éµå¾ª `doc/è§„èŒƒ.md` çš„æµ‹è¯•è¦æ±‚ï¼š
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•è¦†ç›–ç‡ 80% ä»¥ä¸Š
- ä½¿ç”¨æ¥å£å’Œ Mock é¿å…ä¾èµ–å…·ä½“å®ç°
- æµ‹è¯•åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–æ‰§è¡Œé¡ºåº
- **æµ‹è¯•å¿…é¡»åœ¨ tests/ ç›®å½•ä¸‹**

### æµ‹è¯•ç±»å‹

**1. å•å…ƒæµ‹è¯•**

- ä½ç½®ï¼š`tests/unit/`
- ç›®æ ‡ï¼šæµ‹è¯•å•ä¸ªå‡½æ•°å’Œç±»
- ç­–ç•¥ï¼šä½¿ç”¨ Mock éš”ç¦»ä¾èµ–ï¼ˆPostgreSQL, Redisï¼‰

**2. é›†æˆæµ‹è¯•**

- ä½ç½®ï¼š`tests/integration/`
- ç›®æ ‡ï¼šæµ‹è¯•å¤šä¸ªç»„ä»¶åä½œ
- ç­–ç•¥ï¼šä½¿ç”¨çœŸå® PostgreSQL å’Œ Redisï¼ˆtestcontainers æˆ– Dockerï¼‰

**3. é»‘ç›’æµ‹è¯•**

- ä½ç½®ï¼š`tests/e2e/`
- ç›®æ ‡ï¼šä»ä½¿ç”¨è€…è§’åº¦æµ‹è¯•
- ç­–ç•¥ï¼šé€šè¿‡å‘½ä»¤è¡Œå·¥å…·æµ‹è¯•å®Œæ•´æµç¨‹

### æµ‹è¯•æ•°æ®å‡†å¤‡

```go
// tests/testutil/fixtures.go

// Package testutil æä¾›æµ‹è¯•å·¥å…·
package testutil

import "dnd-client/internal/models"

// CreateTestSessions åˆ›å»ºæµ‹è¯•ä¼šè¯æ•°æ®
func CreateTestSessions(count int) []*models.Session {
    sessions := make([]*models.Session, count)
    for i := 0; i < count; i++ {
        sessions[i] = &models.Session{
            ID:        uuid.New().String(),
            Name:      fmt.Sprintf("æµ‹è¯•ä¼šè¯-%d", i),
            CreatorID: fmt.Sprintf("user-%d", i),
            // ...
        }
    }
    return sessions
}

// CreateTestMessages åˆ›å»ºæµ‹è¯•æ¶ˆæ¯æ•°æ®
func CreateTestMessages(sessionID string, count int) []*models.Message {
    messages := make([]*models.Message, count)
    for i := 0; i < count; i++ {
        messages[i] = &models.Message{
            ID:        uuid.New().String(),
            SessionID: sessionID,
            Role:      "user",
            Content:   fmt.Sprintf("æµ‹è¯•æ¶ˆæ¯-%d", i),
            // ...
        }
    }
    return messages
}
```

---

## å¼€å‘æ­¥éª¤å»ºè®®

### Step 1: PostgreSQL è¿æ¥å’Œè¿ç§»ï¼ˆéœ€æ±‚ 2.1ï¼‰

1. æ‰©å±• `pkg/config/config.go`ï¼Œæ·»åŠ  PostgreSQL é…ç½®
2. å®ç° `internal/store/postgres/client.go`
3. åœ¨ `scripts/migrations/` åˆ›å»ºè¿ç§»æ–‡ä»¶ âš ï¸ æ³¨æ„è·¯å¾„
4. å®ç° `internal/store/postgres/migrate.go` è¿ç§»ç®¡ç†å™¨
5. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
6. å®ç° `internal/cli/migrate.go` å‘½ä»¤

### Step 2: å®šä¹‰æ¥å£ï¼ˆéœ€æ±‚ 2.2 å‰ç½®ï¼‰

1. åœ¨ `internal/persistence/interface.go` å®šä¹‰æ¥å£ âš ï¸ ä½¿ç”¨æ–¹å®šä¹‰
2. å®šä¹‰ SessionWriter å’Œ SessionReader æ¥å£
3. å®šä¹‰ MessageWriter å’Œ MessageReader æ¥å£
4. ç¼–å†™æ¥å£æµ‹è¯•

### Step 3: å¤‡ä»½ä¼šè¯ï¼ˆéœ€æ±‚ 2.2ï¼‰

1. å®ç° `internal/store/postgres/session.go`ï¼ˆå®ç°æ¥å£ï¼‰
2. å®ç° `internal/persistence/backup.go`ï¼ˆä½¿ç”¨æ¥å£ï¼‰
3. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. æµ‹è¯• UPSERT é€»è¾‘

### Step 4: å¤‡ä»½æ¶ˆæ¯ï¼ˆéœ€æ±‚ 2.3ï¼‰

1. å®ç° `internal/store/postgres/message.go`ï¼ˆå®ç°æ¥å£ï¼‰
2. æ‰©å±• `internal/persistence/backup.go`ï¼ˆä½¿ç”¨æ¥å£ï¼‰
3. ä¼˜åŒ–æ‰¹é‡æ’å…¥æ€§èƒ½
4. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. æµ‹è¯• COPY å‘½ä»¤æ€§èƒ½

### Step 5: æ¢å¤ä¼šè¯ï¼ˆéœ€æ±‚ 2.4ï¼‰

1. éªŒè¯ `internal/store/redis/session.go` å®ç°æ¥å£
2. å®ç° `internal/persistence/restore.go`
3. ç¼–å†™é›†æˆæµ‹è¯•
4. å®ç° `internal/cli/restore.go` å‘½ä»¤

### Step 6: æ¢å¤æ¶ˆæ¯ï¼ˆéœ€æ±‚ 2.5ï¼‰

1. éªŒè¯ `internal/store/redis/message.go` å®ç°æ¥å£
2. æ‰©å±• `internal/persistence/restore.go`
3. ä¼˜åŒ–æ‰¹é‡æ¢å¤æ€§èƒ½
4. ç¼–å†™é›†æˆæµ‹è¯•

### Step 7: CLI å·¥å…·å®Œå–„ï¼ˆéœ€æ±‚ 2.6ï¼‰

1. å®ç° `internal/cli/backup.go` å‘½ä»¤
2. æ‰©å±• `internal/cli/restore.go` å‘½ä»¤
3. æ·»åŠ è¿›åº¦æ˜¾ç¤º
4. æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
5. ç¼–å†™é»‘ç›’æµ‹è¯•

---

## éªŒæ”¶æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡

- [ ] æ‰€æœ‰ä»£ç ç¬¦åˆ `doc/è§„èŒƒ.md` è¦æ±‚
- [ ] ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–
- [ ] ä½¿ç”¨ `go vet` æ£€æŸ¥
- [ ] ä½¿ç”¨ `golint` æ£€æŸ¥
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] å¤ç”¨ä»»åŠ¡ä¸€çš„æ¨¡å‹å’Œé…ç½®

### ç›®å½•ç»“æ„

- [ ] SQL æ–‡ä»¶åœ¨ `scripts/migrations/` è€Œé `internal/` âš ï¸
- [ ] æµ‹è¯•æ–‡ä»¶åœ¨ `tests/` ç›®å½• âš ï¸
- [ ] æ¥å£åœ¨ `persistence` åŒ…ï¼ˆä½¿ç”¨æ–¹ï¼‰âš ï¸
- [ ] å®ç°åœ¨ `store/postgres` åŒ…ï¼ˆå®ç°æ–¹ï¼‰âš ï¸
- [ ] äºŒè¿›åˆ¶è¾“å‡ºåˆ° `bin/` ç›®å½•ï¼ˆè€Œéè¾“å‡ºåˆ°å…¶ä»–ä½ç½®ï¼‰âš ï¸
- [ ] `scripts/build.sh` æ­£ç¡®é…ç½®è¾“å‡ºåˆ° `bin/`

### ä¾èµ–å…³ç³»

- [ ] ä¾èµ–æ–¹å‘æ­£ç¡®ï¼špersistence â†’ store â†’ models
- [ ] models ä¸ä¾èµ–ä»»ä½•å…¶ä»–åŒ…
- [ ] æ¥å£åœ¨ä½¿ç”¨æ–¹å®šä¹‰
- [ ] å•å‘ä¾èµ–ï¼Œæ— å¾ªç¯ä¾èµ–

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] PostgreSQL è¿æ¥æ­£å¸¸
- [ ] æ•°æ®åº“è¿ç§»æ­£å¸¸æ‰§è¡Œ
- [ ] ä¼šè¯å¤‡ä»½åŠŸèƒ½æ­£å¸¸
- [ ] æ¶ˆæ¯å¤‡ä»½åŠŸèƒ½æ­£å¸¸
- [ ] ä¼šè¯æ¢å¤åŠŸèƒ½æ­£å¸¸
- [ ] æ¶ˆæ¯æ¢å¤åŠŸèƒ½æ­£å¸¸
- [ ] CLI å·¥å…·æ‰€æœ‰å‘½ä»¤æ­£å¸¸

### æ•°æ®ä¸€è‡´æ€§

- [ ] å¤‡ä»½æ•°æ®ä¸ Redis ä¸€è‡´
- [ ] æ¢å¤æ•°æ®ä¸ PostgreSQL ä¸€è‡´
- [ ] è½¯åˆ é™¤æ­£ç¡®è¿‡æ»¤
- [ ] UPSERT é€»è¾‘æ­£ç¡®
- [ ] äº‹åŠ¡æ­£ç¡®å›æ»š

### æ€§èƒ½è¦æ±‚

- [ ] ä¼šè¯å¤‡ä»½æ€§èƒ½è¾¾æ ‡
- [ ] æ¶ˆæ¯å¤‡ä»½æ€§èƒ½è¾¾æ ‡
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨ Pipeline/COPY
- [ ] è¿æ¥æ± é…ç½®åˆç†

### æµ‹è¯•å®Œæ•´æ€§

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] é»‘ç›’æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æµ‹è¯•å¯ä»¥ç‹¬ç«‹è¿è¡Œ
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

### æ–‡æ¡£å®Œæ•´æ€§

- [ ] `doc/development_progress.md` æ›´æ–°
- [ ] è¿ç§»æ–‡ä»¶æœ‰æ³¨é‡Š
- [ ] ä»£ç æ³¨é‡Šå®Œæ•´
- [ ] ç¤ºä¾‹å‘½ä»¤å¯è¿è¡Œ

---

## ä¾èµ–æ¸…å•

### Go ä¾èµ–

åœ¨ä»»åŠ¡ä¸€çš„åŸºç¡€ä¸Šæ–°å¢ï¼š

```go
require (
    github.com/jackc/pgx/v5 v5.5.0           // PostgreSQL é©±åŠ¨
    github.com/jackc/pgx/v5/pgxpool v5.5.0   // è¿æ¥æ± 
)
```

### å¤–éƒ¨ä¾èµ–

- PostgreSQL 15+ï¼ˆä½¿ç”¨ Docker è¿è¡Œï¼‰
- Redis 7.0+ï¼ˆä»»åŠ¡ä¸€å·²æœ‰ï¼‰

### å¯é€‰ä¾èµ–ï¼ˆç”¨äºæµ‹è¯•ï¼‰

```go
require (
    github.com/testcontainers/testcontainers-go v0.26.0
    github.com/testcontainers/testcontainers-go-modules/postgresql v0.26.0
)
```

---

## é£é™©å’Œæ³¨æ„äº‹é¡¹

### å…³é”®è§„èŒƒçº¦æŸ âš ï¸

1. **SQL æ–‡ä»¶ä½ç½®**
   - âŒ **ç¦æ­¢**ï¼š`internal/store/postgres/migrations/`
   - âœ… **å¿…é¡»**ï¼š`scripts/migrations/`
   - åŸå› ï¼šè§„èŒƒè¦æ±‚ `internal/` ä¸åº”åŒ…å« SQL æ–‡ä»¶

2. **æ¥å£å®šä¹‰ä½ç½®**
   - âŒ **ç¦æ­¢**ï¼šåœ¨ `store` åŒ…ï¼ˆå®ç°æ–¹ï¼‰å®šä¹‰æ¥å£
   - âœ… **å¿…é¡»**ï¼šåœ¨ `persistence` åŒ…ï¼ˆä½¿ç”¨æ–¹ï¼‰å®šä¹‰æ¥å£
   - åŸå› ï¼šè§„èŒƒè¦æ±‚"åœ¨ä½¿ç”¨æ–¹å®šä¹‰æ¥å£ï¼Œè€Œéå®ç°æ–¹"

3. **æµ‹è¯•æ–‡ä»¶ä½ç½®**
   - âŒ **ç¦æ­¢**ï¼šæµ‹è¯•æ–‡ä»¶æ•£è½åœ¨å„åŒ…ä¸­
   - âœ… **å¿…é¡»**ï¼šæ‰€æœ‰æµ‹è¯•åœ¨ `tests/` ç›®å½•
   - åŸå› ï¼šè§„èŒƒè¦æ±‚ `tests/ - æµ‹è¯•æ–‡ä»¶ï¼Œå•å…ƒæµ‹è¯•ï¼Œé›†æˆæµ‹è¯•ç­‰éœ€è¦åœ¨è¿™`

4. **ä¾èµ–æ–¹å‘**
   - âŒ **ç¦æ­¢**ï¼šmodels ä¾èµ–å…¶ä»–åŒ…
   - âŒ **ç¦æ­¢**ï¼šstore ä¾èµ– persistence
   - âœ… **å¿…é¡»**ï¼špersistence â†’ store â†’ models
   - åŸå› ï¼šè§„èŒƒè¦æ±‚å•å‘ä¾èµ–ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚

5. **äºŒè¿›åˆ¶è¾“å‡ºä½ç½®**
   - âŒ **ç¦æ­¢**ï¼šè¾“å‡ºåˆ° `cmd/`ã€`dist/`ã€`build/` æˆ–å…¶ä»–ä½ç½®
   - âœ… **å¿…é¡»**ï¼šè¾“å‡ºåˆ° `bin/` ç›®å½•
   - åŸå› ï¼šè§„èŒƒè¦æ±‚ `bin/ - äºŒè¿›åˆ¶è¾“å‡ºä»¶ä½ç½®`
   - å®ç°ï¼š`scripts/build.sh` å¿…é¡»é…ç½® `-o bin/dnd-client`

### é£é™©

1. **PostgreSQL è¿æ¥å¤±è´¥**
   - ç¼“è§£ï¼šæä¾›è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œé…ç½®è¯´æ˜
   - å›é€€ï¼šä½¿ç”¨æœ¬åœ° SQLite æµ‹è¯•

2. **æ•°æ®ä¸ä¸€è‡´**
   - ç¼“è§£ï¼šä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
   - éªŒè¯ï¼šç¼–å†™é›†æˆæµ‹è¯•éªŒè¯æ•°æ®ä¸€è‡´æ€§

3. **æ€§èƒ½ä¸è¾¾æ ‡**
   - ç¼“è§£ï¼šä½¿ç”¨ COPY å’Œæ‰¹é‡æ“ä½œ
   - ä¼˜åŒ–ï¼šä½¿ç”¨ Pipeline å‡å°‘ç½‘ç»œå¾€è¿”

4. **è¿ç§»å†²çª**
   - ç¼“è§£ï¼šå®ç°ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
   - å›é€€ï¼šæä¾› down è„šæœ¬

### æ³¨æ„äº‹é¡¹

1. ä¸¥æ ¼éµå¾ª `doc/è§„èŒƒ.md` çš„æ‰€æœ‰è¦æ±‚
2. å¤ç”¨ä»»åŠ¡ä¸€çš„æ¥å£å®šä¹‰å’Œæ¨¡å‹å®šä¹‰
3. æ¥å£åœ¨ `persistence` åŒ…å®šä¹‰ï¼Œ`store` åŒ…å®ç°
4. **ç¡®ä¿ `scripts/build.sh` è¾“å‡ºåˆ° `bin/` ç›®å½•** âš ï¸
5. ä¿æŒä»£ç ç®€æ´ã€æ¸…æ™°ã€æ˜“è¯»
6. ä¼˜å…ˆé€‰æ‹©ç®€å•ç›´æ¥çš„å®ç°
7. ä¸ä¸ºäº†è§£è€¦è€Œåšå‡ºå¤æ‚æ¶æ„
8. ä¿æŒä»£ç é£æ ¼ä¸€è‡´
9. å®šæœŸé‡æ„ï¼ŒåŠæ—¶æ¸…ç†å†—ä½™ä»£ç 
10. å°æ­¥æäº¤ï¼Œé¢‘ç¹é›†æˆ
11. æ³¨æ„è½¯åˆ é™¤çš„å¤„ç†
12. æ³¨æ„æ—¶åŒºå’Œæ—¶é—´æ ¼å¼ç»Ÿä¸€

---

## ä¸ä»»åŠ¡ä¸€çš„å¯¹æ¥

### æ¥å£å¤ç”¨åŸåˆ™

ä»»åŠ¡äºŒé‡æ–°å®šä¹‰æ¥å£ï¼ˆåœ¨ä½¿ç”¨æ–¹ï¼‰ï¼š

```go
// ä»»åŠ¡ä¸€ï¼šRedis ç›´æ¥å®ç°ï¼ˆæ— æ¥å£æŠ½è±¡ï¼‰
// internal/store/redis/session.go

// ä»»åŠ¡äºŒï¼šåœ¨ persistence å®šä¹‰æ¥å£ï¼ˆä½¿ç”¨æ–¹ï¼‰
// internal/persistence/interface.go
type SessionWriter interface { ... }
type SessionReader interface { ... }

// ä»»åŠ¡äºŒï¼šRedis å’Œ PostgreSQL éƒ½å®ç°æ¥å£
// internal/store/redis/session.go
type RedisSessionStore struct { ... }
func (s *RedisSessionStore) Create(...) error { ... }

// internal/store/postgres/session.go
type PostgresSessionStore struct { ... }
func (s *PostgresSessionStore) Create(...) error { ... }
```

### æ¨¡å‹å®Œå…¨å¤ç”¨

ä»»åŠ¡äºŒå®Œå…¨å¤ç”¨ä»»åŠ¡ä¸€çš„æ¨¡å‹å®šä¹‰ï¼š

```go
// ä»»åŠ¡ä¸€å·²å®šä¹‰
// internal/models/session.go
type Session struct {
    ID           string
    Name         string
    // ...
}

// ä»»åŠ¡äºŒç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹
```

### é…ç½®æ‰©å±•

åœ¨ä»»åŠ¡ä¸€çš„é…ç½®åŸºç¡€ä¸Šæ·»åŠ  PostgreSQL é…ç½®ï¼š

```go
// ä»»åŠ¡ä¸€çš„ Config
// pkg/config/config.go
type Config struct {
    Redis RedisConfig
    // ä»»åŠ¡äºŒæ·»åŠ 
    Postgres PostgresConfig
    Log      LogConfig
}
```

---

## æ€§èƒ½åŸºå‡†

### å¤‡ä»½æ€§èƒ½

| æ“ä½œ | æ•°æ®é‡ | é¢„æœŸè€—æ—¶ |
|------|--------|----------|
| å¤‡ä»½ä¼šè¯ | 100 ä¸ª | < 1s |
| å¤‡ä»½æ¶ˆæ¯ | 1000 æ¡ | < 100ms |
| å¤‡ä»½æ¶ˆæ¯ | 10000 æ¡ | < 1s |
| å®Œæ•´å¤‡ä»½ | 100 ä¼šè¯ + 10000 æ¶ˆæ¯ | < 5s |

### æ¢å¤æ€§èƒ½

| æ“ä½œ | æ•°æ®é‡ | é¢„æœŸè€—æ—¶ |
|------|--------|----------|
| æ¢å¤ä¼šè¯ | 100 ä¸ª | < 500ms |
| æ¢å¤æ¶ˆæ¯ | 1000 æ¡ | < 200ms |
| æ¢å¤æ¶ˆæ¯ | 10000 æ¡ | < 2s |
| å®Œæ•´æ¢å¤ | 100 ä¼šè¯ + 10000 æ¶ˆæ¯ | < 3s |

### æ•°æ®åº“æ€§èƒ½

- å•æ¬¡æŸ¥è¯¢ < 5ms
- å•æ¬¡æ’å…¥ < 1ms
- COPY 1000 æ¡ < 50ms
- è¿æ¥æ± å¤ç”¨ç‡ > 90%

---

## å‚è€ƒèµ„æ–™

- `doc/è§„èŒƒ.md` - **ä»£ç è§„èŒƒï¼ˆæœ€é‡è¦ï¼‰**
- `doc/DND_MCP_Clientè¯¦ç»†è®¾è®¡.md` - è¯¦ç»†è®¾è®¡
- `doc/DND_MCP_Client_å¼€å‘è®¡åˆ’.md` - å¼€å‘è®¡åˆ’
- `doc/å¼€å‘ä»»åŠ¡ä¸€.md` - ä»»åŠ¡ä¸€æ–‡æ¡£
- https://pgx.tech/postgresql/ - pgx æ–‡æ¡£
- https://www.postgresql.org/docs/ - PostgreSQL æ–‡æ¡£

---

## é™„å½•ï¼šæ„å»ºé…ç½®è¯´æ˜

### æ„å»ºè„šæœ¬è§„èŒƒ

ä»»åŠ¡ä¸€å·²ç»åˆ›å»ºäº† `scripts/build.sh`ï¼Œä»»åŠ¡äºŒéœ€è¦ç¡®ä¿è¯¥è„šæœ¬ç¬¦åˆä»¥ä¸‹è¦æ±‚ï¼š

```bash
#!/bin/bash
# scripts/build.sh

set -e

echo "å¼€å§‹æ„å»º dnd-client..."

# åˆ›å»º bin ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p bin

# ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¾“å‡ºåˆ° bin/ ç›®å½• âš ï¸
go build -o bin/dnd-client ./cmd/client

echo "æ„å»ºå®Œæˆï¼šbin/dnd-client"
```

### .gitignore é…ç½®

ç¡®ä¿ `bin/` ç›®å½•è¢«æ­£ç¡®å¿½ç•¥ï¼š

```gitignore
# äºŒè¿›åˆ¶è¾“å‡ºä»¶
bin/
*.exe
*.exe~
*.dll
*.so
*.dylib

# ç¼–è¯‘ä¸­é—´æ–‡ä»¶
*.o
*.a
```

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æ„å»ºé¡¹ç›®
./scripts/build.sh

# è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶
./bin/dnd-client --help
./bin/dnd-client migrate up
./bin/dnd-client backup --all
```

### äº¤å‰ç¼–è¯‘ï¼ˆå¯é€‰ï¼‰

å¦‚éœ€æ”¯æŒå¤šå¹³å°ï¼Œå¯åœ¨ `scripts/build.sh` ä¸­æ·»åŠ ï¼š

```bash
# Linux
GOOS=linux GOARCH=amd64 go build -o bin/dnd-client-linux-amd64 ./cmd/client

# Windows
GOOS=windows GOARCH=amd64 go build -o bin/dnd-client-windows-amd64.exe ./cmd/client

# macOS
GOOS=darwin GOARCH=amd64 go build -o bin/dnd-client-darwin-amd64 ./cmd/client
GOOS=darwin GOARCH=arm64 go build -o bin/dnd-client-darwin-arm64 ./cmd/client
```

**é‡è¦**ï¼šæ— è®ºä½•ç§ç¼–è¯‘æ–¹å¼ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶éƒ½å¿…é¡»è¾“å‡ºåˆ° `bin/` ç›®å½•ã€‚
