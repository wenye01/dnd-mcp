# DND MCP Client 使用指南

## 快速开始

### 1. 环境准备

确保已安装以下软件:
- Go 1.21+
- Redis 7.0+
- Docker Desktop (Windows)

### 2. 启动 Redis

#### Windows 环境

使用 PowerShell 脚本 (推荐):

```powershell
.\scripts\start-redis.ps1
```

或手动启动:

```powershell
docker run -d --name dnd-redis -p 6379:6379 redis:7-alpine
```

#### Linux/Mac 环境

```bash
docker run -d --name dnd-redis -p 6379:6379 redis:7-alpine
```

或使用本地 Redis:

```bash
redis-server
```

### 3. 编译项目

#### Windows 环境

```powershell
# 下载依赖
go mod tidy

# 使用 PowerShell 脚本构建 (推荐)
.\scripts\build.ps1

# 或手动构建
go build ./cmd/client
```

#### Linux/Mac 环境

```bash
# 下载依赖
go mod tidy

# 使用脚本构建
chmod +x ./scripts/build.sh
./scripts/build.sh

# 或手动构建
go build -o bin/dnd-client ./cmd/client
```

### 4. 配置环境变量 (可选)

项目使用默认配置,你也可以通过环境变量自定义:

#### Windows (PowerShell)

```powershell
$env:REDIS_HOST="localhost:6379"
$env:REDIS_DB="0"
$env:LOG_LEVEL="info"
```

#### Windows (CMD)

```cmd
set REDIS_HOST=localhost:6379
set REDIS_DB=0
set LOG_LEVEL=info
```

#### Linux/Mac

```bash
export REDIS_HOST=localhost:6379
export REDIS_DB=0
export LOG_LEVEL=info
```

## 使用 CLI 工具

### 会话管理

#### 创建会话

```bash
# 基本用法
./client.exe session create --name "我的第一个战役" --creator "user-123" --mcp-url "http://localhost:9000"

# 完整用法 (指定最大玩家数)
./client.exe session create \
  --name "我的第一个战役" \
  --creator "user-123" \
  --mcp-url "http://localhost:9000" \
  --max-players 6 \
  --output json
```

#### 查看会话

```bash
# 获取单个会话
./client.exe session get <session-id>

# 列出所有会话
./client.exe session list

# 使用 JSON 格式输出
./client.exe session list --output json
```

#### 删除会话

```bash
./client.exe session delete <session-id>
```

### 消息管理

#### 保存消息

```bash
# 用户消息
./client.exe message save \
  --session <session-id> \
  --content "你好,我要开始游戏了" \
  --player-id "player-123"

# 系统消息
./client.exe message save \
  --session <session-id> \
  --content "游戏开始" \
  --role system

# 助手消息
./client.exe message save \
  --session <session-id> \
  --content "欢迎来到 D&D 世界!" \
  --role assistant
```

#### 查看消息

```bash
# 获取消息列表 (默认50条)
./client.exe message list --session <session-id>

# 获取指定数量的消息
./client.exe message list --session <session-id> --limit 10

# 获取单条消息
./client.exe message get <message-id> --session <session-id>

# 使用 JSON 格式输出
./client.exe message list --session <session-id> --output json
```

## 测试

### Windows 环境

#### 运行单元测试

```powershell
# 使用 PowerShell 脚本 (推荐)
.\scripts\test.ps1

# 或手动运行
go test ./tests/unit/... -v

# 查看测试覆盖率
go test ./tests/unit/... -cover
```

#### 运行集成测试

集成测试需要真实的 Redis 服务:

```powershell
# 设置环境变量
$env:INTEGRATION_TEST="1"

# 运行集成测试
go test ./tests/integration/... -tags=integration -v

# 或使用测试脚本
.\scripts\test.ps1
```

### Linux/Mac 环境

#### 运行单元测试

```bash
# 使用脚本 (推荐)
./scripts/test.sh

# 或手动运行
go test ./tests/unit/... -v

# 查看测试覆盖率
go test ./tests/unit/... -cover
```

#### 运行集成测试

```bash
# 设置环境变量
export INTEGRATION_TEST=1

# 运行集成测试
go test ./tests/integration/... -tags=integration -v

# 或使用测试脚本
./scripts/test.sh
```

## 项目结构

```
dnd-client/
├── cmd/                    # 主程序入口
│   └── client/
│       └── main.go
├── internal/              # 私有代码
│   ├── models/           # 领域模型 (Session, Message)
│   ├── store/            # 数据存储层
│   │   ├── redis/       # Redis 实现
│   │   └── interface.go # 存储接口
│   └── cli/             # 命令行工具
├── pkg/                  # 公共库
│   ├── config/          # 配置管理
│   └── errors/          # 错误定义
├── tests/               # 测试文件
│   ├── unit/           # 单元测试
│   └── integration/    # 集成测试
├── scripts/            # 构建和测试脚本
│   ├── build.ps1      # Windows PowerShell 构建脚本
│   ├── build.sh       # Linux/Mac 构建脚本
│   ├── test.ps1       # Windows PowerShell 测试脚本
│   ├── test.sh        # Linux/Mac 测试脚本
│   └── start-redis.ps1 # Windows Redis 启动脚本
├── doc/               # 开发文档
└── client.exe         # 编译后的可执行文件 (Windows)
```

## Redis 数据结构

### 会话存储

```
Key: session:{uuid}
Type: Hash
Fields:
  - id: 会话ID
  - name: 会话名称
  - creator_id: 创建者ID
  - mcp_server_url: MCP Server URL
  - websocket_key: WebSocket密钥
  - max_players: 最大玩家数
  - settings: 设置 (JSON)
  - created_at: 创建时间
  - updated_at: 更新时间
  - status: 状态

Key: sessions:all
Type: Set
Members: 所有会话ID
```

### 消息存储

```
Key: msg:{session_uuid}
Type: Sorted Set
Score: 时间戳 (毫秒)
Member: 消息 (JSON)
```

## 常见问题

### 1. Redis 连接失败

**错误**: `redis 连接失败: dial tcp: connection refused`

**解决**:
- 检查 Redis 是否正在运行: `redis-cli ping`
- 检查 Redis 地址配置: `REDIS_HOST` 环境变量
- 确保 Redis 端口正确 (默认 6379)

### 2. 找不到会话

**错误**: `session not found`

**解决**:
- 检查会话ID是否正确
- 使用 `./client.exe session list` 查看所有会话
- 确认会话未被删除

### 3. 消息列表为空

**解决**:
- 确认会话ID正确
- 检查是否已保存消息到该会话
- 使用 `--limit` 参数调整查询数量

## 开发文档

- [规范](规范.md) - 代码规范
- [详细设计](DND_MCP_Client详细设计.md) - 技术设计
- [开发计划](DND_MCP_Client_开发计划.md) - 开发路线图
- [开发任务一](开发任务一.md) - 当前任务详情

## 下一步

任务一已完成,接下来是:

- 任务2: PostgreSQL 持久化
- 任务3: HTTP API - 会话管理
- 任务4: HTTP API - 消息管理

详见 [开发计划](DND_MCP_Client_开发计划.md)
