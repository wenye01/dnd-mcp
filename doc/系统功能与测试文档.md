# DND MCP Client - ç³»ç»ŸåŠŸèƒ½ä¸æµ‹è¯•æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2026-02-04
- **è¦†ç›–èŒƒå›´**: ä»»åŠ¡ä¸€è‡³ä»»åŠ¡äº”
- **çŠ¶æ€**: ç³»ç»Ÿå·²å®Œæˆ,å¾…æµ‹è¯•éªŒè¯

---

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [åŠŸèƒ½è¯¦ç»†è¯´æ˜](#åŠŸèƒ½è¯¦ç»†è¯´æ˜)
4. [API æ¥å£æ–‡æ¡£](#api-æ¥å£æ–‡æ¡£)
5. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)
6. [æµ‹è¯•æ•°æ®å‡†å¤‡](#æµ‹è¯•æ•°æ®å‡†å¤‡)
7. [æµ‹è¯•æ‰§è¡Œè®¡åˆ’](#æµ‹è¯•æ‰§è¡Œè®¡åˆ’)

---

## ç³»ç»Ÿæ¦‚è¿°

### ç³»ç»Ÿå®šä½

DND MCP Client æ˜¯ä¸€ä¸ª**è½»é‡çº§æœ‰çŠ¶æ€çš„åè°ƒå±‚**,ç”¨äºç®¡ç† DND æ¸¸æˆä¼šè¯ã€å¤„ç† AI å¯¹è¯ã€æ”¯æŒ WebSocket å®æ—¶é€šä¿¡ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **ä¼šè¯ç®¡ç†** - åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ¸¸æˆä¼šè¯
2. **æ¶ˆæ¯ç®¡ç†** - å‘é€æ¶ˆæ¯ã€è·å–å†å²ã€AI å¯¹è¯é›†æˆ
3. **æ•°æ®æŒä¹…åŒ–** - Redis ä¸»å­˜å‚¨ + PostgreSQL å¤‡ä»½
4. **å®æ—¶é€šä¿¡** - WebSocket äº‹ä»¶æ¨é€å’Œè®¢é˜…
5. **å‘½ä»¤è¡Œå·¥å…·** - å®Œæ•´çš„ CLI ç®¡ç†æ¥å£

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Go 1.24+
- **Web æ¡†æ¶**: Gin v1.11.0
- **WebSocket**: Gorilla WebSocket v1.5.3
- **æ•°æ®åº“**:
  - Redis 7+ (ä¸»å­˜å‚¨)
  - PostgreSQL 15+ (å¤‡ä»½å­˜å‚¨)
- **Redis å®¢æˆ·ç«¯**: go-redis/v9
- **PostgreSQL å®¢æˆ·ç«¯**: pgx/v5
- **CLI æ¡†æ¶**: Cobra

---

## æ¶æ„è®¾è®¡

### âš ï¸ é‡è¦è¯´æ˜:å½“å‰é‡‡ç”¨ç®€åŒ–æ¶æ„

ä¸ºäº†å¿«é€Ÿè¿­ä»£å’Œäº¤ä»˜å¯è¿è¡Œçš„ç³»ç»Ÿ,å½“å‰å®ç°é‡‡ç”¨äº†**ç®€åŒ–çš„æ¶æ„è®¾è®¡**,ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰çš„å®Œæ•´æ¶æ„å­˜åœ¨å·®å¼‚ã€‚

#### å®é™…å®ç°çš„ç®€åŒ–æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer (Handler)                      â”‚
â”‚                  (åŒ…å«éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Store Layer (å­˜å‚¨å®ç°)                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚           RedisStore (å…·ä½“å®ç°)               â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Models Layer (é¢†åŸŸæ¨¡å‹)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®å½•ç»“æ„**:
```
internal/
â”œâ”€â”€ api/handler/     # HTTP + WebSocket Handlers (åŒ…å«ä¸šåŠ¡é€»è¾‘)
â”œâ”€â”€ store/redis/     # Redis å­˜å‚¨å®ç°
â””â”€â”€ models/          # é¢†åŸŸæ¨¡å‹
```

#### è®¾è®¡æ–‡æ¡£å®šä¹‰çš„å®Œæ•´æ¶æ„(ç›®æ ‡æ¶æ„)

```
Handler
  â†“
Service (ä¸šåŠ¡é€»è¾‘å±‚)
  â†“
Repository (æ•°æ®è®¿é—®æ¥å£)
  â†“
Store (å­˜å‚¨å®ç°)
  â†“
Models
```

#### ç®€åŒ–çš„åŸå› 

1. **å¿«é€Ÿè¿­ä»£**: ä¼˜å…ˆäº¤ä»˜åŠŸèƒ½,å¿«é€ŸéªŒè¯éœ€æ±‚
2. **ä¸šåŠ¡é€»è¾‘ç®€å•**: å½“å‰é˜¶æ®µä¸šåŠ¡é€»è¾‘ä¸å¤æ‚
3. **å•ä¸€å­˜å‚¨å®ç°**: åªä½¿ç”¨ Redis,Repository æŠ½è±¡ä»·å€¼æœ‰é™
4. **é™ä½å­¦ä¹ æ›²çº¿**: ç®€åŒ–æ¶æ„æ›´æ˜“äºç†è§£å’Œè°ƒè¯•

#### ç®€åŒ–çš„å½±å“

**ä¼˜ç‚¹** âœ…:
- å¼€å‘é€Ÿåº¦å¿«,ä»£ç ç®€æ´
- è°ƒç”¨é“¾è·¯çŸ­,æ˜“äºè¿½è¸ª
- é€‚åˆå¿«é€ŸåŸå‹å¼€å‘

**ç¼ºç‚¹** âŒ:
- ä¸šåŠ¡é€»è¾‘æ•£è½åœ¨ Handler ä¸­
- è¿åä¾èµ–å€’ç½®åŸåˆ™(Handler ä¾èµ–å…·ä½“ Store)
- éš¾ä»¥å•å…ƒæµ‹è¯•(éš¾ä»¥ Mock Store å±‚)
- ä¸ç¬¦åˆè®¾è®¡æ–‡æ¡£æ¶æ„

#### æœªæ¥æ”¹è¿›è®¡åˆ’

**çŸ­æœŸ(å½“å‰)**:
- âœ… ä¿æŒç®€åŒ–æ¶æ„,åŠŸèƒ½å®Œæ•´

**ä¸­æœŸ(ä»»åŠ¡å…­/ä¸ƒ)**:
- âš ï¸ è¯„ä¼°ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦
- âš ï¸ å¦‚æœ LLM/MCP é›†æˆåé€»è¾‘å˜å¤æ‚,æ·»åŠ  Service å±‚
- âš ï¸ å¦‚æœéœ€è¦å¤šç§å­˜å‚¨,æ·»åŠ  Repository æ¥å£

**é•¿æœŸ(ç”Ÿäº§å‰)**:
- ğŸ¯ è¡¥å…… Service å±‚,å°è£…ä¸šåŠ¡é€»è¾‘
- ğŸ¯ è¡¥å…… Repository å±‚,æŠ½è±¡æ•°æ®è®¿é—®
- ğŸ¯ ç¬¦åˆè®¾è®¡æ–‡æ¡£çš„å®Œæ•´æ¶æ„

**è¯¦ç»†è¯´æ˜**: å‚è§ `doc/æ¶æ„ç®€åŒ–è¯´æ˜.md`

---

## åŠŸèƒ½è¯¦ç»†è¯´æ˜

### ä»»åŠ¡ä¸€: é¡¹ç›®è„šæ‰‹æ¶ + Redis åŸºç¡€å­˜å‚¨

#### 1.1 é¡¹ç›®ç»“æ„

**æ ‡å‡† Go é¡¹ç›®ç›®å½•ç»“æ„**:
```
dnd-client/
â”œâ”€â”€ cmd/client/main.go          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ models/                 # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ session.go
â”‚   â”‚   â””â”€â”€ message.go
â”‚   â”œâ”€â”€ store/                  # æ•°æ®å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ interface.go        # å­˜å‚¨æ¥å£
â”‚   â”‚   â””â”€â”€ redis/             # Redis å®ç°
â”‚   â”‚       â”œâ”€â”€ client.go
â”‚   â”‚       â”œâ”€â”€ session.go
â”‚   â”‚       â””â”€â”€ message.go
â”‚   â””â”€â”€ cli/                   # å‘½ä»¤è¡Œå·¥å…·
â”‚       â”œâ”€â”€ root.go
â”‚       â”œâ”€â”€ session.go
â”‚       â””â”€â”€ message.go
â”œâ”€â”€ pkg/                       # å…¬å…±åº“
â”‚   â”œâ”€â”€ config/               # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ errors/               # é”™è¯¯å®šä¹‰
â”œâ”€â”€ tests/                    # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/                 # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ integration/          # é›†æˆæµ‹è¯•
â”œâ”€â”€ scripts/                  # æ„å»ºå’Œæµ‹è¯•è„šæœ¬
â””â”€â”€ doc/                     # æ–‡æ¡£
```

#### 1.2 é…ç½®ç®¡ç†

**ä½ç½®**: `pkg/config/config.go`

**æ”¯æŒçš„ç¯å¢ƒå˜é‡**:
```bash
# Redis é…ç½®
REDIS_HOST=localhost:6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_POOL_SIZE=10

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=json

# HTTP æœåŠ¡å™¨é…ç½®
HTTP_HOST=0.0.0.0
HTTP_PORT=8080
HTTP_READ_TIMEOUT=30s
HTTP_WRITE_TIMEOUT=30s
```

#### 1.3 é¢†åŸŸæ¨¡å‹

**Session ä¼šè¯æ¨¡å‹** (`internal/models/session.go`):
```go
type Session struct {
    ID           string                 // ä¼šè¯ID (UUID)
    Name         string                 // ä¼šè¯åç§°
    CreatorID    string                 // åˆ›å»ºè€…ID
    MCPServerURL string                 // MCP Server URL
    WebSocketKey string                 // WebSocket å¯†é’¥
    MaxPlayers   int                    // æœ€å¤§ç©å®¶æ•°
    Settings     map[string]interface{} // ä¼šè¯é…ç½®
    Status       string                 // çŠ¶æ€: active | archived
    CreatedAt    time.Time              // åˆ›å»ºæ—¶é—´
    UpdatedAt    time.Time              // æ›´æ–°æ—¶é—´
    DeletedAt    *time.Time             // åˆ é™¤æ—¶é—´(è½¯åˆ é™¤)
}
```

**Message æ¶ˆæ¯æ¨¡å‹** (`internal/models/message.go`):
```go
type Message struct {
    ID        string            // æ¶ˆæ¯ID (UUID)
    SessionID string            // ä¼šè¯ID
    Role      string            // è§’è‰²: user | assistant | system | tool
    Content   string            // æ¶ˆæ¯å†…å®¹
    PlayerID  string            // ç©å®¶ID (ä»… user æ¶ˆæ¯)
    ToolCalls []ToolCall        // å·¥å…·è°ƒç”¨
    CreatedAt time.Time         // åˆ›å»ºæ—¶é—´
}
```

#### 1.4 Redis å­˜å‚¨

**ä¼šè¯å­˜å‚¨** (`internal/store/redis/session.go`):
- **æ•°æ®ç»“æ„**:
  - `session:{id}` - Hash (ä¼šè¯å…ƒæ•°æ®)
  - `sessions:all` - Set (ä¼šè¯ç´¢å¼•)
- **æ“ä½œ**: Create, Get, List, Update, Delete
- **æ€§èƒ½**: ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œ

**æ¶ˆæ¯å­˜å‚¨** (`internal/store/redis/message.go`):
- **æ•°æ®ç»“æ„**: `session:{id}:messages` - Sorted Set (æŒ‰æ—¶é—´æ’åº)
- **æ“ä½œ**: Create, Get, List, ListByRole, ListSince
- **æŸ¥è¯¢**: æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€è§’è‰²è¿‡æ»¤

#### 1.5 å‘½ä»¤è¡Œå·¥å…·

**ä¼šè¯ç®¡ç†**:
```bash
# åˆ›å»ºä¼šè¯
./bin/dnd-client.exe session create \
  --name "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹" \
  --creator "user-123" \
  --mcp-url "http://localhost:9000"

# è·å–ä¼šè¯
./bin/dnd-client.exe session get <session-id>

# åˆ—å‡ºä¼šè¯
./bin/dnd-client.exe session list

# åˆ é™¤ä¼šè¯
./bin/dnd-client.exe session delete <session-id>
```

**æ¶ˆæ¯ç®¡ç†**:
```bash
# ä¿å­˜æ¶ˆæ¯
./bin/dnd-client.exe message save \
  --session <session-id> \
  --content "ä½ å¥½,ä¸–ç•Œ!" \
  --player-id "player-123"

# è·å–æ¶ˆæ¯
./bin/dnd-client.exe message get <session-id> <message-id>

# åˆ—å‡ºæ¶ˆæ¯
./bin/dnd-client.exe message list \
  --session <session-id> \
  --limit 10
```

---

### ä»»åŠ¡äºŒ: PostgreSQL æŒä¹…åŒ–

#### 2.1 æ•°æ®åº“è¿ç§»

**è¿ç§»ç®¡ç†** (`internal/store/postgres/migrate.go`):
```bash
# æ‰§è¡Œè¿ç§»
./bin/dnd-client.exe migrate up

# å›æ»šè¿ç§»
./bin/dnd-client.exe migrate down

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
./bin/dnd-client.exe migrate status
```

**è¿ç§»æ–‡ä»¶** (`scripts/migrations/`):
- `000001_initial_schema.up.sql` - åˆå§‹åŒ–è¡¨ç»“æ„
- `000001_initial_schema.down.sql` - å›æ»šè¡¨ç»“æ„

**æ•°æ®åº“è¡¨**:
1. `client_sessions` - ä¼šè¯å…ƒæ•°æ®è¡¨ (æ”¯æŒè½¯åˆ é™¤)
2. `client_messages` - å¯¹è¯æ¶ˆæ¯è¡¨
3. `persistence_snapshots` - æŒä¹…åŒ–å¿«ç…§è¡¨
4. `schema_migrations` - è¿ç§»å†å²è¡¨

#### 2.2 å¤‡ä»½å’Œæ¢å¤

**å¤‡ä»½æ•°æ®**:
```bash
# å¤‡ä»½æ‰€æœ‰æ•°æ®
./bin/dnd-client.exe backup --all

# å¤‡ä»½æŒ‡å®šä¼šè¯
./bin/dnd-client.exe backup --session <session-id>

# æŸ¥çœ‹å¤‡ä»½è®°å½•
./bin/dnd-client.exe backup --list
```

**æ¢å¤æ•°æ®**:
```bash
# æ¢å¤æ‰€æœ‰æ•°æ®
./bin/dnd-client.exe restore --all

# æ¢å¤æŒ‡å®šä¼šè¯
./bin/dnd-client.exe restore --session <session-id>

# å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ•°æ®
./bin/dnd-client.exe restore --all --force
```

**æ€§èƒ½æŒ‡æ ‡**:
- ä¼šè¯å¤‡ä»½: ~1000 ä¸ªä¼šè¯/ç§’
- æ¶ˆæ¯å¤‡ä»½: ~5000 æ¡æ¶ˆæ¯/ç§’ (ä½¿ç”¨ COPY FROM)
- ä¼šè¯æ¢å¤: ~1200 ä¸ªä¼šè¯/ç§’
- æ¶ˆæ¯æ¢å¤: ~6000 æ¡æ¶ˆæ¯/ç§’ (ä½¿ç”¨ Pipeline)

---

### ä»»åŠ¡ä¸‰: HTTP API - ä¼šè¯ç®¡ç†

#### 3.1 HTTP æœåŠ¡å™¨

**ä½ç½®**: `internal/api/server.go`

**å¯åŠ¨æœåŠ¡å™¨**:
```bash
./bin/dnd-client.exe server start
```

**æœåŠ¡å™¨ç‰¹æ€§**:
- Gin Web æ¡†æ¶
- ä¸­é—´ä»¶: æ—¥å¿—ã€æ¢å¤ã€CORS
- ä¼˜é›…å…³é—­
- é…ç½®åŒ–çš„è¶…æ—¶è®¾ç½®

#### 3.2 ä¼šè¯ CRUD API

**åˆ›å»ºä¼šè¯**:
```http
POST /api/sessions
Content-Type: application/json

{
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  "creator_id": "user-123",
  "mcp_server_url": "http://localhost:9000",
  "max_players": 5,
  "settings": {
    "ruleset": "dnd5e"
  }
}

Response 201 Created:
{
  "id": "session-uuid-xxx",
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  "creator_id": "user-123",
  "mcp_server_url": "http://localhost:9000",
  "websocket_key": "ws-key-xxx",
  "max_players": 5,
  "settings": {...},
  "created_at": "2025-02-03T10:00:00Z",
  "updated_at": "2025-02-03T10:00:00Z",
  "status": "active"
}
```

**è·å–ä¼šè¯åˆ—è¡¨**:
```http
GET /api/sessions

Response 200 OK:
[
  {
    "id": "session-uuid-xxx",
    "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
    ...
  }
]
```

**è·å–ä¼šè¯è¯¦æƒ…**:
```http
GET /api/sessions/{id}

Response 200 OK:
{
  "id": "session-uuid-xxx",
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæˆ˜å½¹",
  ...
}
```

**æ›´æ–°ä¼šè¯**:
```http
PATCH /api/sessions/{id}
Content-Type: application/json

{
  "name": "æ›´æ–°åçš„æˆ˜å½¹åç§°",
  "status": "active"
}

Response 200 OK:
{
  "id": "session-uuid-xxx",
  "name": "æ›´æ–°åçš„æˆ˜å½¹åç§°",
  ...
}
```

**åˆ é™¤ä¼šè¯**:
```http
DELETE /api/sessions/{id}

Response 204 No Content
```

#### 3.3 ä¸­é—´ä»¶

**æ—¥å¿—ä¸­é—´ä»¶** (`internal/api/middleware/logger.go`):
- è®°å½•æ‰€æœ‰ HTTP è¯·æ±‚
- è®°å½•å“åº”çŠ¶æ€ç å’Œè€—æ—¶

**æ¢å¤ä¸­é—´ä»¶** (`internal/api/middleware/recovery.go`):
- æ•è· panic
- è¿”å› 500 é”™è¯¯
- è®°å½•é”™è¯¯æ—¥å¿—

**CORS ä¸­é—´ä»¶** (`internal/api/middleware/cors.go`):
- æ”¯æŒè·¨åŸŸè¯·æ±‚
- å¯é…ç½®

---

### ä»»åŠ¡å››: HTTP API - æ¶ˆæ¯ç®¡ç†

#### 4.1 å‘é€æ¶ˆæ¯ API

**ä½ç½®**: `internal/api/handler/message.go`

**å‘é€æ¶ˆæ¯**:
```http
POST /api/sessions/{id}/chat
Content-Type: application/json

{
  "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
  "player_id": "player-123",
  "stream": false
}

Response 200 OK:
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",
  "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
  "created_at": "2025-02-03T10:05:30Z"
}
```

**å®ç°æµç¨‹**:
1. éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Redis
3. è°ƒç”¨ Mock LLM è·å–åŠ©æ‰‹å“åº”
4. ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯åˆ° Redis
5. è¿”å›åŠ©æ‰‹å“åº”

**Mock LLM** (`internal/llm/mock.go`):
- æ¥å£åŒ–è®¾è®¡: `LLMClient`
- å›ºå®šå“åº”: "è¿™æ˜¯ Mock LLM çš„å“åº”"
- å¯é…ç½®åˆ‡æ¢

#### 4.2 è·å–æ¶ˆæ¯å†å² API

**è·å–æ¶ˆæ¯å†å²**:
```http
GET /api/sessions/{id}/messages?limit=20&role=user&since=2025-02-03T10:00:00Z

Response 200 OK:
[
  {
    "id": "msg-uuid-1",
    "session_id": "session-uuid-xxx",
    "role": "user",
    "content": "æˆ‘è¦æ”»å‡»å“¥å¸ƒæ—",
    "player_id": "player-123",
    "created_at": "2025-02-03T10:05:00Z"
  },
  {
    "id": "msg-uuid-2",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
    "created_at": "2025-02-03T10:05:30Z"
  }
]
```

**æŸ¥è¯¢å‚æ•°**:
- `limit`: è¿”å›æ¶ˆæ¯æ•°é‡ (é»˜è®¤ 50, æœ€å¤§ 100)
- `role`: è§’è‰²è¿‡æ»¤ (user|assistant|system|tool)
- `since`: èµ·å§‹æ—¶é—´ (RFC3339 æ ¼å¼)

**æ’åº**: æŒ‰æ—¶é—´å‡åºæ’åˆ— (ä»æ—§åˆ°æ–°)

#### 4.3 è·å–å•æ¡æ¶ˆæ¯ API

**è·å–å•æ¡æ¶ˆæ¯**:
```http
GET /api/sessions/{id}/messages/{messageId}

Response 200 OK:
{
  "id": "msg-uuid-xxx",
  "session_id": "session-uuid-xxx",
  "role": "assistant",
  "content": "è¿™æ˜¯ Mock LLM çš„å“åº”",
  "created_at": "2025-02-03T10:05:30Z"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": {
    "code": "MESSAGE_NOT_FOUND",
    "message": "æ¶ˆæ¯ä¸å­˜åœ¨"
  }
}
```

---

### ä»»åŠ¡äº”: WebSocket å®æ—¶é€šä¿¡

#### 5.1 WebSocket è¿æ¥

**è¿æ¥ URL**:
```
ws://localhost:8080/ws/sessions/{session-id}?key={ws-key}
```

**è¿æ¥å‚æ•°**:
- `session-id`: è·¯å¾„å‚æ•°,ä¼šè¯ID
- `key`: æŸ¥è¯¢å‚æ•°,WebSocket å¯†é’¥ (ä»åˆ›å»ºä¼šè¯APIè·å–)

**è¿æ¥éªŒè¯**:
1. éªŒè¯ session_id å­˜åœ¨
2. éªŒè¯ key ä¸ä¼šè¯çš„ websocket_key åŒ¹é…
3. éªŒè¯ä¼šè¯çŠ¶æ€ä¸º active

**è¿æ¥æˆåŠŸå“åº”**:
```json
{
  "type": "connected",
  "data": {
    "session_id": "session-uuid-xxx",
    "connection_id": "conn-uuid-xxx",
    "player_id": "player-123"
  }
}
```

#### 5.2 å®¢æˆ·ç«¯æ¶ˆæ¯ç±»å‹

**è®¢é˜…äº‹ä»¶**:
```json
{
  "type": "subscribe",
  "data": {
    "events": ["state_changed", "combat_updated", "dice_rolled"]
  }
}
```

**å–æ¶ˆè®¢é˜…**:
```json
{
  "type": "unsubscribe",
  "data": {
    "events": ["dice_rolled"]
  }
}
```

**å¿ƒè·³ ping**:
```json
{
  "type": "ping",
  "data": {
    "timestamp": "2025-02-04T10:00:00Z"
  }
}
```

#### 5.3 æœåŠ¡å™¨æ¶ˆæ¯ç±»å‹

**è¿æ¥æˆåŠŸ** (`connected`):
```json
{
  "type": "connected",
  "data": {
    "session_id": "session-uuid-xxx",
    "connection_id": "conn-uuid-xxx",
    "player_id": "player-123"
  }
}
```

**æ–°æ¶ˆæ¯é€šçŸ¥** (`new_message`):
```json
{
  "type": "new_message",
  "data": {
    "message_id": "msg-uuid-xxx",
    "session_id": "session-uuid-xxx",
    "role": "assistant",
    "content": "è¿™æ˜¯ AI çš„å“åº”",
    "player_id": "player-123",
    "timestamp": "2025-02-04T10:05:00Z"
  }
}
```

**çŠ¶æ€å˜æ›´äº‹ä»¶** (`state_changed`):
```json
{
  "type": "state_changed",
  "data": {
    "session_id": "session-uuid-xxx",
    "changes": {
      "location": "å¹½æš—æ£®æ—",
      "game_time": "ç¬¬3å¤© 10:30",
      "combat": "active"
    },
    "timestamp": "2025-02-04T10:05:00Z"
  }
}
```

**æˆ˜æ–—äº‹ä»¶** (`combat_updated`):
```json
{
  "type": "combat_updated",
  "data": {
    "session_id": "session-uuid-xxx",
    "combat_id": "combat-uuid-xxx",
    "action": "attack",
    "attacker": "player-123",
    "target": "goblin-1",
    "result": {
      "hit": true,
      "damage": 8
    },
    "timestamp": "2025-02-04T10:05:00Z"
  }
}
```

**éª°å­äº‹ä»¶** (`dice_rolled`):
```json
{
  "type": "dice_rolled",
  "data": {
    "session_id": "session-uuid-xxx",
    "player_id": "player-123",
    "roll_type": "d20",
    "result": 18,
    "details": "ç©å®¶æŠ•æ· d20 éª°å­",
    "timestamp": "2025-02-04T10:05:00Z"
  }
}
```

**å¿ƒè·³å“åº”** (`pong`):
```json
{
  "type": "pong",
  "data": {
    "timestamp": "2025-02-04T10:00:00Z"
  }
}
```

**é”™è¯¯é€šçŸ¥** (`error`):
```json
{
  "type": "error",
  "data": {
    "code": "INVALID_MESSAGE",
    "message": "Invalid message format",
    "timestamp": "2025-02-04T10:00:00Z"
  }
}
```

#### 5.4 Hub-Connection æ¶æ„

**Hub è¿æ¥ç®¡ç†å™¨** (`internal/ws/hub.go`):
- ç®¡ç†æ‰€æœ‰ WebSocket è¿æ¥
- ç»´æŠ¤ä¼šè¯è¿æ¥ç´¢å¼•
- äº‹ä»¶å¹¿æ’­åˆ°è®¢é˜…è¿æ¥
- çº¿ç¨‹å®‰å…¨çš„å¹¶å‘æ§åˆ¶

**Connection è¿æ¥å°è£…** (`internal/ws/connection.go`):
- è¯»å†™åˆ†ç¦»çš„ goroutine
- è®¢é˜…ç®¡ç†
- å¿ƒè·³å¤„ç†
- é”™è¯¯å¤„ç†å’Œå…³é—­

**Mock äº‹ä»¶ç”Ÿæˆå™¨** (`internal/ws/mock.go`):
- æ¯ 10 ç§’éšæœºç”Ÿæˆäº‹ä»¶
- æ”¯æŒä¸‰ç§äº‹ä»¶ç±»å‹
- å¯é…ç½®å¯åŠ¨/å…³é—­

---

## API æ¥å£æ–‡æ¡£

### REST API æ€»è§ˆ

| æ–¹æ³• | è·¯å¾„ | æè¿° | ä»»åŠ¡ |
|------|------|------|------|
| POST | /api/sessions | åˆ›å»ºä¼šè¯ | ä¸‰ |
| GET | /api/sessions | è·å–ä¼šè¯åˆ—è¡¨ | ä¸‰ |
| GET | /api/sessions/:id | è·å–ä¼šè¯è¯¦æƒ… | ä¸‰ |
| PATCH | /api/sessions/:id | æ›´æ–°ä¼šè¯ | ä¸‰ |
| DELETE | /api/sessions/:id | åˆ é™¤ä¼šè¯ | ä¸‰ |
| POST | /api/sessions/:id/chat | å‘é€æ¶ˆæ¯ | å›› |
| GET | /api/sessions/:id/messages | è·å–æ¶ˆæ¯å†å² | å›› |
| GET | /api/sessions/:id/messages/:messageId | è·å–å•æ¡æ¶ˆæ¯ | å›› |
| GET | /ws/sessions/:id | WebSocket è¿æ¥ | äº” |
| POST | /api/sessions/:id/broadcast | å¹¿æ’­äº‹ä»¶(æµ‹è¯•) | äº” |
| GET | /test/ws/connections | è·å–è¿æ¥ä¿¡æ¯(æµ‹è¯•) | äº” |
| POST | /test/ws/broadcast | å¹¿æ’­æµ‹è¯•(å…¨å±€) | äº” |

### é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰é”™è¯¯å“åº”éµå¾ªç»Ÿä¸€æ ¼å¼:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "é”™è¯¯æè¿°ä¿¡æ¯"
  }
}
```

**å¸¸è§é”™è¯¯ç **:
- `INVALID_REQUEST` - è¯·æ±‚å‚æ•°é”™è¯¯
- `SESSION_NOT_FOUND` - ä¼šè¯ä¸å­˜åœ¨
- `MESSAGE_NOT_FOUND` - æ¶ˆæ¯ä¸å­˜åœ¨
- `INVALID_KEY` - WebSocket å¯†é’¥æ— æ•ˆ
- `INTERNAL_ERROR` - å†…éƒ¨æœåŠ¡å™¨é”™è¯¯

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç¯å¢ƒå‡†å¤‡

#### 1. å¯åŠ¨ä¾èµ–æœåŠ¡

**å¯åŠ¨ Redis**:
```bash
# Windows (PowerShell)
.\scripts\start-redis.ps1

# Linux/Mac (Docker)
docker run -d --name dnd-redis -p 6379:6379 redis:7-alpine

# éªŒè¯è¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›: PONG
```

**å¯åŠ¨ PostgreSQL**:
```bash
# Docker
docker run -d --name dnd-postgres \
  -e POSTGRES_USER=dnd \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=dnd_client \
  -p 5432:5432 \
  postgres:15-alpine

# æ‰§è¡Œè¿ç§»
./bin/dnd-client.exe migrate up
```

#### 2. å¯åŠ¨æœåŠ¡å™¨

```bash
# å¯åŠ¨ HTTP + WebSocket æœåŠ¡å™¨
./bin/dnd-client.exe server start

# éªŒè¯æœåŠ¡å™¨
curl http://localhost:8080/health
# åº”è¯¥è¿”å›: {"status":"ok"}
```

### ä»»åŠ¡ä¸€æµ‹è¯•ç”¨ä¾‹

#### TC1.1: åˆ›å»ºä¼šè¯

**æ­¥éª¤**:
```bash
./bin/dnd-client.exe session create \
  --name "æµ‹è¯•ä¼šè¯1" \
  --creator "user-001" \
  --mcp-url "http://localhost:9000"
```

**é¢„æœŸç»“æœ**:
- å‘½ä»¤æ‰§è¡ŒæˆåŠŸ,è¿”å›ä¼šè¯ID
- ä¼šè¯IDä¸ºæœ‰æ•ˆçš„ UUID æ ¼å¼
- ä¼šè¯åŒ…å« websocket_key

**éªŒè¯**:
```bash
# ä¿å­˜è¿”å›çš„ session_id
SESSION_ID="<è¿”å›çš„session_id>"

# éªŒè¯ä¼šè¯å­˜åœ¨
./bin/dnd-client.exe session get $SESSION_ID
# åº”è¯¥æ˜¾ç¤ºåˆšåˆ›å»ºçš„ä¼šè¯ä¿¡æ¯
```

#### TC1.2: åˆ—å‡ºä¼šè¯

**æ­¥éª¤**:
```bash
./bin/dnd-client.exe session list
```

**é¢„æœŸç»“æœ**:
- æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯åˆ—è¡¨
- è‡³å°‘åŒ…å« TC1.1 åˆ›å»ºçš„ä¼šè¯
- è¡¨æ ¼æ ¼å¼è¾“å‡ºåŒ…å«: ID, Name, Creator, Status

#### TC1.3: ä¿å­˜æ¶ˆæ¯

**æ­¥éª¤**:
```bash
./bin/dnd-client.exe message save \
  --session $SESSION_ID \
  --content "æµ‹è¯•æ¶ˆæ¯å†…å®¹" \
  --player-id "player-001"
```

**é¢„æœŸç»“æœ**:
- æ¶ˆæ¯ä¿å­˜æˆåŠŸ
- è¿”å›æ¶ˆæ¯ID

**éªŒè¯**:
```bash
# åˆ—å‡ºæ¶ˆæ¯
./bin/dnd-client.exe message list --session $SESSION_ID --limit 10
# åº”è¯¥åŒ…å«åˆšä¿å­˜çš„æ¶ˆæ¯
```

#### TC1.4: è·å–æ¶ˆæ¯

**æ­¥éª¤**:
```bash
# ä½¿ç”¨ TC1.3 ä¿å­˜çš„æ¶ˆæ¯ID
MESSAGE_ID="<è¿”å›çš„message_id>"

./bin/dnd-client.exe message get $SESSION_ID $MESSAGE_ID
```

**é¢„æœŸç»“æœ**:
- æ˜¾ç¤ºæ¶ˆæ¯è¯¦æƒ…
- åŒ…å«: ID, Role, Content, CreatedAt

### ä»»åŠ¡äºŒæµ‹è¯•ç”¨ä¾‹

#### TC2.1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

**æ­¥éª¤**:
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
./bin/dnd-client.exe migrate status

# æ‰§è¡Œè¿ç§»
./bin/dnd-client.exe migrate up
```

**é¢„æœŸç»“æœ**:
- è¿ç§»æˆåŠŸæ‰§è¡Œ
- çŠ¶æ€æ˜¾ç¤º "æ•°æ®åº“å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
- PostgreSQL ä¸­åˆ›å»ºäº†æ‰€æœ‰è¡¨

**éªŒè¯**:
```bash
# è¿æ¥ PostgreSQL éªŒè¯è¡¨
psql -h localhost -U dnd -d dnd_client -c "\dt"
# åº”è¯¥æ˜¾ç¤º:
# client_sessions, client_messages, persistence_snapshots, schema_migrations
```

#### TC2.2: å¤‡ä»½æ‰€æœ‰æ•°æ®

**å‰ç½®æ¡ä»¶**: ä»»åŠ¡ä¸€æµ‹è¯•å·²å®Œæˆ,æœ‰æµ‹è¯•æ•°æ®

**æ­¥éª¤**:
```bash
./bin/dnd-client.exe backup --all
```

**é¢„æœŸç»“æœ**:
- å¤‡ä»½æˆåŠŸ
- æ˜¾ç¤ºå¤‡ä»½æ‘˜è¦:
  - ä¼šè¯æ•°é‡ > 0
  - æ¶ˆæ¯æ•°é‡ > 0
  - è€—æ—¶ç»Ÿè®¡

**éªŒè¯**:
```sql
-- æŸ¥è¯¢ PostgreSQL
SELECT COUNT(*) FROM client_sessions;
-- åº”è¯¥å¤§äº 0

SELECT COUNT(*) FROM client_messages;
-- åº”è¯¥å¤§äº 0
```

#### TC2.3: æ¢å¤æ‰€æœ‰æ•°æ®

**å‰ç½®æ¡ä»¶**: å·²æ¸…ç©º Redis

**æ­¥éª¤**:
```bash
# æ¸…ç©º Redis
redis-cli FLUSHALL

# æ¢å¤æ•°æ®
./bin/dnd-client.exe restore --all
```

**é¢„æœŸç»“æœ**:
- æ¢å¤æˆåŠŸ
- æ˜¾ç¤ºæ¢å¤æ‘˜è¦:
  - ä¼šè¯æ•°é‡
  - æ¶ˆæ¯æ•°é‡

**éªŒè¯**:
```bash
# éªŒè¯ä¼šè¯æ¢å¤
./bin/dnd-client.exe session list
# åº”è¯¥æ˜¾ç¤ºå¤‡ä»½çš„æ‰€æœ‰ä¼šè¯

# éªŒè¯æ¶ˆæ¯æ¢å¤
./bin/dnd-client.exe message list --session $SESSION_ID --limit 100
# åº”è¯¥æ˜¾ç¤ºå¤‡ä»½çš„æ‰€æœ‰æ¶ˆæ¯
```

### ä»»åŠ¡ä¸‰æµ‹è¯•ç”¨ä¾‹

#### TC3.1: åˆ›å»ºä¼šè¯ (HTTP)

**æ­¥éª¤**:
```bash
curl -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "HTTPæµ‹è¯•ä¼šè¯",
    "creator_id": "user-002",
    "mcp_server_url": "http://localhost:9000",
    "max_players": 5
  }'
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 201 Created
- è¿”å› JSON åŒ…å«:
  - `id`: ä¼šè¯UUID
  - `name`: "HTTPæµ‹è¯•ä¼šè¯"
  - `websocket_key`: WebSocket å¯†é’¥
  - `status`: "active"

**éªŒè¯**:
```bash
# ä¿å­˜è¿”å›çš„ session_id å’Œ websocket_key
HTTP_SESSION_ID="<è¿”å›çš„id>"
WS_KEY="<è¿”å›çš„websocket_key>"

# è·å–ä¼šè¯è¯¦æƒ…
curl http://localhost:8080/api/sessions/$HTTP_SESSION_ID
# åº”è¯¥è¿”å›å®Œæ•´çš„ä¼šè¯ä¿¡æ¯
```

#### TC3.2: è·å–ä¼šè¯åˆ—è¡¨ (HTTP)

**æ­¥éª¤**:
```bash
curl http://localhost:8080/api/sessions
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å› JSON æ•°ç»„
- åŒ…å«è‡³å°‘ 1 ä¸ªä¼šè¯

#### TC3.3: æ›´æ–°ä¼šè¯ (HTTP)

**æ­¥éª¤**:
```bash
curl -X PATCH http://localhost:8080/api/sessions/$HTTP_SESSION_ID \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æ›´æ–°åçš„ä¼šè¯åç§°"
  }'
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å›æ›´æ–°åçš„ä¼šè¯ä¿¡æ¯
- `name` å­—æ®µä¸º "æ›´æ–°åçš„ä¼šè¯åç§°"

#### TC3.4: åˆ é™¤ä¼šè¯ (HTTP)

**æ­¥éª¤**:
```bash
# å…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶ä¼šè¯ç”¨äºåˆ é™¤
TEMP_SESSION_ID=$(curl -s -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{"name":"ä¸´æ—¶ä¼šè¯","creator_id":"user-003","mcp_server_url":"http://localhost:9000"}' \
  | jq -r '.id')

# åˆ é™¤ä¼šè¯
curl -X DELETE http://localhost:8080/api/sessions/$TEMP_SESSION_ID
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 204 No Content
- å“åº”ä½“ä¸ºç©º

**éªŒè¯**:
```bash
# å°è¯•è·å–å·²åˆ é™¤çš„ä¼šè¯
curl http://localhost:8080/api/sessions/$TEMP_SESSION_ID
# åº”è¯¥è¿”å› 404 Not Found
```

#### TC3.5: é”™è¯¯å¤„ç† - ä¼šè¯ä¸å­˜åœ¨

**æ­¥éª¤**:
```bash
curl http://localhost:8080/api/sessions/00000000-0000-0000-0000-000000000000
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 404 Not Found
- è¿”å›é”™è¯¯å“åº”:
  ```json
  {
    "error": {
      "code": "SESSION_NOT_FOUND",
      "message": "ä¼šè¯ä¸å­˜åœ¨"
    }
  }
  ```

### ä»»åŠ¡å››æµ‹è¯•ç”¨ä¾‹

#### TC4.1: å‘é€æ¶ˆæ¯

**æ­¥éª¤**:
```bash
curl -X POST http://localhost:8080/api/sessions/$HTTP_SESSION_ID/chat \
  -H "Content-Type: application/json" \
  -d '{
    "content": "ä½ å¥½,è¿™æ˜¯æµ‹è¯•æ¶ˆæ¯",
    "player_id": "player-002"
  }'
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å›åŠ©æ‰‹æ¶ˆæ¯:
  - `role`: "assistant"
  - `content`: "è¿™æ˜¯ Mock LLM çš„å“åº”"

**éªŒè¯**:
```bash
# è·å–æ¶ˆæ¯å†å²
curl "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/messages?limit=10"
# åº”è¯¥åŒ…å«:
# - ç”¨æˆ·æ¶ˆæ¯ (role: "user", content: "ä½ å¥½,è¿™æ˜¯æµ‹è¯•æ¶ˆæ¯")
# - åŠ©æ‰‹æ¶ˆæ¯ (role: "assistant", content: "è¿™æ˜¯ Mock LLM çš„å“åº”")
```

#### TC4.2: è·å–æ¶ˆæ¯å†å²

**æ­¥éª¤**:
```bash
curl "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/messages?limit=10"
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å› JSON æ•°ç»„
- æŒ‰æ—¶é—´å‡åºæ’åˆ— (ä»æ—§åˆ°æ–°)

#### TC4.3: æ¶ˆæ¯è¿‡æ»¤ - æŒ‰è§’è‰²

**æ­¥éª¤**:
```bash
curl "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/messages?role=user&limit=10"
```

**é¢„æœŸç»“æœ**:
- åªè¿”å› `role` ä¸º "user" çš„æ¶ˆæ¯
- ä¸åŒ…å« assistant æ¶ˆæ¯

#### TC4.4: æ¶ˆæ¯è¿‡æ»¤ - æŒ‰æ—¶é—´

**æ­¥éª¤**:
```bash
curl "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/messages?since=2025-02-04T10:00:00Z"
```

**é¢„æœŸç»“æœ**:
- åªè¿”å›æŒ‡å®šæ—¶é—´ä¹‹åçš„æ¶ˆæ¯

#### TC4.5: è·å–å•æ¡æ¶ˆæ¯

**æ­¥éª¤**:
```bash
# å…ˆå‘é€ä¸€æ¡æ¶ˆæ¯,è·å–æ¶ˆæ¯ID
MESSAGE_ID=$(curl -s -X POST http://localhost:8080/api/sessions/$HTTP_SESSION_ID/chat \
  -H "Content-Type: application/json" \
  -d '{"content":"å•æ¡æ¶ˆæ¯æµ‹è¯•","player_id":"player-003"}' \
  | jq -r '.id')

# è·å–å•æ¡æ¶ˆæ¯
curl "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/messages/$MESSAGE_ID"
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å›æ¶ˆæ¯è¯¦æƒ…

#### TC4.6: é”™è¯¯å¤„ç† - å‚æ•°éªŒè¯

**æ­¥éª¤**:
```bash
curl -X POST http://localhost:8080/api/sessions/$HTTP_SESSION_ID/chat \
  -H "Content-Type: application/json" \
  -d '{"player_id":"player-004"}'
# ç¼ºå°‘ content å­—æ®µ
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 400 Bad Request
- è¿”å›é”™è¯¯å“åº”:
  ```json
  {
    "error": {
      "code": "INVALID_REQUEST",
      "message": "è¯·æ±‚å‚æ•°é”™è¯¯: ..."
    }
  }
  ```

### ä»»åŠ¡äº”æµ‹è¯•ç”¨ä¾‹

#### TC5.1: å»ºç«‹ WebSocket è¿æ¥

**ä½¿ç”¨ websocat æµ‹è¯•** (éœ€å®‰è£…: `cargo install websocat`):

```bash
websocat "ws://localhost:8080/ws/sessions/$HTTP_SESSION_ID?key=$WS_KEY"
```

**æˆ–ä½¿ç”¨ JavaScript (Node.js)**:

```javascript
const WebSocket = require('ws');

const ws = new WebSocket(`ws://localhost:8080/ws/sessions/${process.env.HTTP_SESSION_ID}?key=${process.env.WS_KEY}`);

ws.on('open', () => {
  console.log('âœ“ WebSocket è¿æ¥æˆåŠŸ');
});

ws.on('message', (data) => {
  const message = JSON.parse(data);
  console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

  if (message.type === 'connected') {
    console.log('âœ“ è¿æ¥ç¡®è®¤:', message.data);
  }
});

ws.on('error', (error) => {
  console.error('âœ— è¿æ¥é”™è¯¯:', error);
});

ws.on('close', () => {
  console.log('è¿æ¥å·²å…³é—­');
});
```

**é¢„æœŸç»“æœ**:
- è¿æ¥æˆåŠŸå»ºç«‹
- æ”¶åˆ° `connected` æ¶ˆæ¯
- åŒ…å« `connection_id`

#### TC5.2: è®¢é˜…äº‹ä»¶

**æ­¥éª¤**:
```javascript
// è¿æ¥æˆåŠŸåå‘é€è®¢é˜…æ¶ˆæ¯
ws.send(JSON.stringify({
  type: 'subscribe',
  data: {
    events: ['state_changed', 'combat_updated', 'dice_rolled']
  }
}));
```

**é¢„æœŸç»“æœ**:
- è®¢é˜…æˆåŠŸ
- åç»­ä¼šæ”¶åˆ°è®¢é˜…ç±»å‹çš„äº‹ä»¶

#### TC5.3: å¿ƒè·³æµ‹è¯•

**æ­¥éª¤**:
```javascript
// æ¯ 30 ç§’å‘é€å¿ƒè·³
setInterval(() => {
  ws.send(JSON.stringify({
    type: 'ping',
    data: {
      timestamp: new Date().toISOString()
    }
  }));
}, 30000);

// ç›‘å¬ pong å“åº”
ws.on('message', (data) => {
  const message = JSON.parse(data);
  if (message.type === 'pong') {
    console.log('âœ“ æ”¶åˆ° pong å“åº”');
  }
});
```

**é¢„æœŸç»“æœ**:
- æ”¶åˆ° `pong` å“åº”
- è¿æ¥ä¿æŒæ´»è·ƒ

#### TC5.4: å–æ¶ˆè®¢é˜…

**æ­¥éª¤**:
```javascript
ws.send(JSON.stringify({
  type: 'unsubscribe',
  data: {
    events: ['dice_rolled']
  }
}));
```

**é¢„æœŸç»“æœ**:
- å–æ¶ˆè®¢é˜…æˆåŠŸ
- ä¸å†æ”¶åˆ° `dice_rolled` äº‹ä»¶

#### TC5.5: å¹¿æ’­æµ‹è¯•äº‹ä»¶

**æ­¥éª¤**:
```bash
curl -X POST "http://localhost:8080/api/sessions/$HTTP_SESSION_ID/broadcast" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "state_changed",
    "data": {
      "changes": {
        "location": "æµ‹è¯•åœ°ç‚¹",
        "game_time": "ç¬¬1å¤© 10:00"
      }
    }
  }'
```

**é¢„æœŸç»“æœ**:
- WebSocket å®¢æˆ·ç«¯æ”¶åˆ° `state_changed` äº‹ä»¶
- åŒ…å«æ­£ç¡®çš„æ•°æ®

#### TC5.6: è·å–è¿æ¥ä¿¡æ¯

**æ­¥éª¤**:
```bash
curl "http://localhost:8080/test/ws/connections?session_id=$HTTP_SESSION_ID"
```

**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç : 200 OK
- è¿”å›è¿æ¥ä¿¡æ¯:
  ```json
  {
    "session_id": "...",
    "connections": [
      {
        "connection_id": "...",
        "session_id": "...",
        "player_id": "...",
        "subscriptions": {...}
      }
    ],
    "count": 1
  }
  ```

#### TC5.7: é”™è¯¯å¤„ç† - æ— æ•ˆçš„ WebSocket Key

**æ­¥éª¤**:
```javascript
const ws = new WebSocket('ws://localhost:8080/ws/sessions/invalid-session-id?key=invalid-key');

ws.on('error', (error) => {
  console.log('é¢„æœŸé”™è¯¯:', error);
});
```

**é¢„æœŸç»“æœ**:
- è¿æ¥è¢«æ‹’ç»
- æ”¶åˆ°é”™è¯¯æ¶ˆæ¯æˆ–è¿æ¥å…³é—­

### ç»¼åˆæµ‹è¯•ç”¨ä¾‹

#### TC6.1: å®Œæ•´æµç¨‹æµ‹è¯•

**ç›®æ ‡**: æµ‹è¯•ä»åˆ›å»ºä¼šè¯åˆ° WebSocket é€šä¿¡çš„å®Œæ•´æµç¨‹

**æ­¥éª¤**:

1. **åˆ›å»ºä¼šè¯**:
```bash
SESSION_ID=$(curl -s -X POST http://localhost:8080/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "å®Œæ•´æµç¨‹æµ‹è¯•",
    "creator_id": "user-999",
    "mcp_server_url": "http://localhost:9000"
  }' | jq -r '.id, .websocket_key')

echo "Session ID: $SESSION_ID"
```

2. **å‘é€å¤šæ¡æ¶ˆæ¯**:
```bash
for i in {1..5}; do
  curl -X POST "http://localhost:8080/api/sessions/$SESSION_ID/chat" \
    -H "Content-Type: application/json" \
    -d "{
      \"content\": \"æµ‹è¯•æ¶ˆæ¯ $i\",
      \"player_id\": \"player-999\"
    }"
  echo ""
done
```

3. **éªŒè¯æ¶ˆæ¯å†å²**:
```bash
curl "http://localhost:8080/api/sessions/$SESSION_ID/messages?limit=20" | jq '.'
```

4. **å»ºç«‹ WebSocket è¿æ¥å¹¶è®¢é˜…**:
```javascript
const ws = new WebSocket(`ws://localhost:8080/ws/sessions/${process.env.SESSION_ID}?key=${process.env.WS_KEY}`);

ws.on('open', () => {
  // è®¢é˜…äº‹ä»¶
  ws.send(JSON.stringify({
    type: 'subscribe',
    data: { events: ['new_message', 'state_changed'] }
  }));
});

ws.on('message', (data) => {
  console.log('æ”¶åˆ°:', data);
});
```

5. **å‘é€æ–°æ¶ˆæ¯å¹¶è§‚å¯Ÿ WebSocket æ¨é€**:
```bash
curl -X POST "http://localhost:8080/api/sessions/$SESSION_ID/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "è§¦å‘WebSocketæ¨é€çš„æ¶ˆæ¯",
    "player_id": "player-999"
  }'
```

**é¢„æœŸç»“æœ**:
- æ‰€æœ‰æ­¥éª¤æˆåŠŸæ‰§è¡Œ
- WebSocket æ”¶åˆ°æ–°æ¶ˆæ¯é€šçŸ¥
- æ•°æ®ä¸€è‡´æ€§è‰¯å¥½

#### TC6.2: æ•°æ®æŒä¹…åŒ–æµ‹è¯•

**ç›®æ ‡**: æµ‹è¯•ä» Redis å¤‡ä»½åˆ° PostgreSQL çš„å®Œæ•´æµç¨‹

**æ­¥éª¤**:

1. **åˆ›å»ºæµ‹è¯•æ•°æ®**:
```bash
# åˆ›å»ºå¤šä¸ªä¼šè¯å’Œæ¶ˆæ¯
for i in {1..10}; do
  SESSION_ID=$(curl -s -X POST http://localhost:8080/api/sessions \
    -H "Content-Type: application/json" \
    -d "{
      \"name\": \"æŒä¹…åŒ–æµ‹è¯•ä¼šè¯$i\",
      \"creator_id\": \"user-$i\",
      \"mcp_server_url\": \"http://localhost:9000\"
    }" | jq -r '.id')

  # æ¯ä¸ªä¼šè¯å‘é€ 5 æ¡æ¶ˆæ¯
  for j in {1..5}; do
    curl -s -X POST "http://localhost:8080/api/sessions/$SESSION_ID/chat" \
      -H "Content-Type: application/json" \
      -d "{
        \"content\": \"ä¼šè¯$iæ¶ˆæ¯$j\",
        \"player_id\": \"player-$i\"
      }" > /dev/null
  done

  echo "åˆ›å»ºä¼šè¯ $i: $SESSION_ID"
done
```

2. **å¤‡ä»½åˆ° PostgreSQL**:
```bash
./bin/dnd-client.exe backup --all
```

3. **éªŒè¯ PostgreSQL æ•°æ®**:
```sql
-- æ£€æŸ¥ä¼šè¯æ•°é‡
SELECT COUNT(*) FROM client_sessions;
-- åº”è¯¥ >= 10

-- æ£€æŸ¥æ¶ˆæ¯æ•°é‡
SELECT COUNT(*) FROM client_messages;
-- åº”è¯¥ >= 50

-- æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
SELECT s.id, s.name, COUNT(m.id) as message_count
FROM client_sessions s
LEFT JOIN client_messages m ON s.id = m.session_id
GROUP BY s.id, s.name
ORDER BY s.id;
```

4. **æ¸…ç©º Redis**:
```bash
redis-cli FLUSHALL
```

5. **ä» PostgreSQL æ¢å¤**:
```bash
./bin/dnd-client.exe restore --all
```

6. **éªŒè¯æ¢å¤ç»“æœ**:
```bash
# éªŒè¯ä¼šè¯æ¢å¤
curl http://localhost:8080/api/sessions | jq 'length'
# åº”è¯¥ >= 10

# éªŒè¯æ¶ˆæ¯æ¢å¤
for i in {1..10}; do
  SESSION_ID=$(redis-cli KEYS "session:*" | head -1 | cut -d':' -f2)
  MESSAGE_COUNT=$(curl -s "http://localhost:8080/api/sessions/$SESSION_ID/messages" | jq 'length')
  echo "Session $SESSION_ID: $MESSAGE_COUNT messages"
done
```

**é¢„æœŸç»“æœ**:
- å¤‡ä»½æˆåŠŸ,æ•°æ®ä¸€è‡´
- æ¢å¤æˆåŠŸ,æ— æ•°æ®ä¸¢å¤±
- æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ

---

## æµ‹è¯•æ•°æ®å‡†å¤‡

### æ ‡å‡†æµ‹è¯•æ•°æ®é›†

#### ä¼šè¯æ•°æ®

```json
[
  {
    "name": "å¹½æš—æ£®æ—å†’é™©",
    "creator_id": "dm-001",
    "mcp_server_url": "http://localhost:9000",
    "max_players": 5,
    "settings": {
      "ruleset": "dnd5e",
      "starting_level": 1
    }
  },
  {
    "name": "åœ°ä¸‹åŸæ¢é™©",
    "creator_id": "dm-002",
    "mcp_server_url": "http://localhost:9001",
    "max_players": 4,
    "settings": {
      "ruleset": "dnd5e",
      "starting_level": 3
    }
  }
]
```

#### æ¶ˆæ¯æ•°æ®

```json
[
  {
    "role": "user",
    "content": "æˆ‘ä»¬è¦è¿›å…¥å¹½æš—æ£®æ—",
    "player_id": "player-001"
  },
  {
    "role": "assistant",
    "content": "å¥½çš„,ä½ åœ¨æ£®æ—è¾¹ç¼˜,çœ‹åˆ°ä¸€æ¡å°å¾„é€šå‘æ·±å¤„ã€‚",
    "player_id": ""
  },
  {
    "role": "user",
    "content": "æˆ‘å†³å®šå‘å‰æ¢ç´¢",
    "player_id": "player-001"
  },
  {
    "role": "user",
    "content": "æˆ‘ä¹Ÿè·Ÿä¸Š",
    "player_id": "player-002"
  }
]
```

### å‹åŠ›æµ‹è¯•æ•°æ®

**å¤§é‡ä¼šè¯åˆ›å»ºè„šæœ¬**:
```bash
#!/bin/bash
# åˆ›å»º 100 ä¸ªä¼šè¯

for i in {1..100}; do
  curl -s -X POST http://localhost:8080/api/sessions \
    -H "Content-Type: application/json" \
    -d "{
      \"name\": \"å‹åŠ›æµ‹è¯•ä¼šè¯$i\",
      \"creator_id\": \"user-$i\",
      \"mcp_server_url\": \"http://localhost:9000\"
    }" > /dev/null

  if [ $((i % 10)) -eq 0 ]; then
    echo "å·²åˆ›å»º $i ä¸ªä¼šè¯"
  fi
done

echo "å®Œæˆ! å…±åˆ›å»º 100 ä¸ªä¼šè¯"
```

**å¤§é‡æ¶ˆæ¯å‘é€è„šæœ¬**:
```bash
#!/bin/bash
# ä¸ºæ¯ä¸ªä¼šè¯å‘é€ 100 æ¡æ¶ˆæ¯

SESSION_IDS=$(curl -s http://localhost:8080/api/sessions | jq -r '.[].id')

for SESSION_ID in $SESSION_IDS; do
  echo "ä¸ºä¼šè¯ $SESSION_ID å‘é€æ¶ˆæ¯..."

  for j in {1..100}; do
    curl -s -X POST "http://localhost:8080/api/sessions/$SESSION_ID/chat" \
      -H "Content-Type: application/json" \
      -d "{
        \"content\": \"æ¶ˆæ¯$j\",
        \"player_id\": \"player-$(shuf -i1-10 -n1)\"
      }" > /dev/null
  done

  echo "ä¼šè¯ $SESSION_ID å®Œæˆ"
done
```

---

## æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€: å•å…ƒæµ‹è¯• (å¯é€‰)

**ç›®æ ‡**: éªŒè¯ç‹¬ç«‹æ¨¡å—åŠŸèƒ½

**èŒƒå›´**:
- [ ] é…ç½®åŠ è½½æµ‹è¯•
- [ ] é¢†åŸŸæ¨¡å‹æµ‹è¯•
- [ ] Redis å­˜å‚¨æµ‹è¯•
- [ ] PostgreSQL å­˜å‚¨æµ‹è¯•
- [ ] LLM Client æµ‹è¯•
- [ ] WebSocket Hub æµ‹è¯•

**å·¥å…·**: Go testing + testify

**æ‰§è¡Œ**:
```bash
go test ./...
```

### é˜¶æ®µäºŒ: é›†æˆæµ‹è¯•

**ç›®æ ‡**: éªŒè¯æ¨¡å—é—´åä½œ

**é¡ºåº**:
1. **ä»»åŠ¡ä¸€æµ‹è¯•** - åŸºç¡€å­˜å‚¨å’Œ CLI
2. **ä»»åŠ¡äºŒæµ‹è¯•** - æŒä¹…åŒ–
3. **ä»»åŠ¡ä¸‰æµ‹è¯•** - HTTP API (ä¼šè¯)
4. **ä»»åŠ¡å››æµ‹è¯•** - HTTP API (æ¶ˆæ¯)
5. **ä»»åŠ¡äº”æµ‹è¯•** - WebSocket
6. **ç»¼åˆæµ‹è¯•** - ç«¯åˆ°ç«¯æµç¨‹

**æ‰§è¡Œ**: æ‰‹åŠ¨æµ‹è¯•æˆ–è‡ªåŠ¨åŒ–è„šæœ¬

### é˜¶æ®µä¸‰: æ€§èƒ½æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

**åœºæ™¯**:
1. **ä¼šè¯ç®¡ç†æ€§èƒ½**
   - åˆ›å»º 100 ä¸ªä¼šè¯
   - æŸ¥è¯¢ 100 ä¸ªä¼šè¯
   - æ›´æ–° 100 ä¸ªä¼šè¯

2. **æ¶ˆæ¯ç®¡ç†æ€§èƒ½**
   - å‘é€ 1000 æ¡æ¶ˆæ¯
   - æŸ¥è¯¢ 1000 æ¡æ¶ˆæ¯

3. **æŒä¹…åŒ–æ€§èƒ½**
   - å¤‡ä»½ 100 ä¸ªä¼šè¯ + 1000 æ¡æ¶ˆæ¯
   - æ¢å¤ 100 ä¸ªä¼šè¯ + 1000 æ¡æ¶ˆæ¯

4. **WebSocket æ€§èƒ½**
   - 100 ä¸ªå¹¶å‘è¿æ¥
   - æ¯ç§’ 100 æ¡æ¶ˆæ¯å¹¿æ’­

**å·¥å…·**: Apache Bench (ab) æˆ– wrk

**ç¤ºä¾‹**:
```bash
# ä¼šè¯åˆ›å»ºæ€§èƒ½æµ‹è¯•
ab -n 100 -c 10 -p session.json -T application/json \
  http://localhost:8080/api/sessions

# æ¶ˆæ¯å‘é€æ€§èƒ½æµ‹è¯•
ab -n 1000 -c 50 -p message.json -T application/json \
  http://localhost:8080/api/sessions/{id}/chat
```

### é˜¶æ®µå››: å‹åŠ›æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæé™å’Œç¨³å®šæ€§

**åœºæ™¯**:
1. **å¹¶å‘ä¼šè¯åˆ›å»º** - 1000 ä¸ªå¹¶å‘è¯·æ±‚
2. **å¤§é‡æ¶ˆæ¯å‘é€** - 10000 æ¡æ¶ˆæ¯
3. **é•¿è¿æ¥ä¿æŒ** - 100 ä¸ª WebSocket è¿æ¥æŒç»­ 1 å°æ—¶
4. **å†…å­˜æ³„æ¼æ£€æµ‹** - é•¿æ—¶é—´è¿è¡Œ

**å·¥å…·**: wrk, JMeter, æˆ–è‡ªå®šä¹‰è„šæœ¬

### é˜¶æ®µäº”: å®‰å…¨æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿå®‰å…¨æ€§

**åœºæ™¯**:
1. **è¾“å…¥éªŒè¯** - SQL æ³¨å…¥ã€XSS
2. **è®¤è¯æˆæƒ** - æ— æ•ˆå¯†é’¥ã€è¶Šæƒè®¿é—®
3. **æ‹’ç»æœåŠ¡** - å¤§è¯·æ±‚ã€æ…¢é€Ÿæ”»å‡»
4. **æ•°æ®æ³„éœ²** - æ•æ„Ÿä¿¡æ¯æš´éœ²

---

## æµ‹è¯•ç»“æœè®°å½•

### æµ‹è¯•æ‰§è¡Œè®°å½•è¡¨

| ç”¨ä¾‹ID | ç”¨ä¾‹åç§° | æ‰§è¡Œæ—¥æœŸ | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
|--------|---------|---------|--------|------|------|
| TC1.1 | åˆ›å»ºä¼šè¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC1.2 | åˆ—å‡ºä¼šè¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC1.3 | ä¿å­˜æ¶ˆæ¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC1.4 | è·å–æ¶ˆæ¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC2.1 | æ‰§è¡Œè¿ç§» | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC2.2 | å¤‡ä»½æ•°æ® | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC2.3 | æ¢å¤æ•°æ® | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC3.1 | åˆ›å»ºä¼šè¯(HTTP) | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC3.2 | è·å–ä¼šè¯åˆ—è¡¨(HTTP) | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC3.3 | æ›´æ–°ä¼šè¯(HTTP) | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC3.4 | åˆ é™¤ä¼šè¯(HTTP) | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC3.5 | é”™è¯¯å¤„ç†-ä¼šè¯ä¸å­˜åœ¨ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.1 | å‘é€æ¶ˆæ¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.2 | è·å–æ¶ˆæ¯å†å² | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.3 | æ¶ˆæ¯è¿‡æ»¤-æŒ‰è§’è‰² | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.4 | æ¶ˆæ¯è¿‡æ»¤-æŒ‰æ—¶é—´ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.5 | è·å–å•æ¡æ¶ˆæ¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC4.6 | é”™è¯¯å¤„ç†-å‚æ•°éªŒè¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.1 | å»ºç«‹WebSocketè¿æ¥ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.2 | è®¢é˜…äº‹ä»¶ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.3 | å¿ƒè·³æµ‹è¯• | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.4 | å–æ¶ˆè®¢é˜… | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.5 | å¹¿æ’­æµ‹è¯•äº‹ä»¶ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.6 | è·å–è¿æ¥ä¿¡æ¯ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC5.7 | é”™è¯¯å¤„ç†-æ— æ•ˆå¯†é’¥ | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC6.1 | å®Œæ•´æµç¨‹æµ‹è¯• | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |
| TC6.2 | æ•°æ®æŒä¹…åŒ–æµ‹è¯• | | | â˜ é€šè¿‡ â˜ å¤±è´¥ | |

### ç¼ºé™·è®°å½•è¡¨

| ç¼ºé™·ID | ç”¨ä¾‹ID | ç¼ºé™·æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | ä¿®å¤äºº | ä¿®å¤æ—¥æœŸ |
|--------|--------|---------|---------|------|--------|---------|
| BUG-001 | | | â˜ ä¸¥é‡ â˜ ä¸€èˆ¬ â˜ è½»å¾® | â˜ æ–°å»º â˜ æ‰“å¼€ â˜ ä¿®å¤ | | |

---

## é™„å½•

### A. ç¯å¢ƒé…ç½®æ–‡ä»¶

**.env.example**:
```bash
# Redis é…ç½®
REDIS_HOST=localhost:6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_POOL_SIZE=10

# PostgreSQL é…ç½®
POSTGRES_HOST=localhost:5432
POSTGRES_USER=dnd
POSTGRES_PASSWORD=password
POSTGRES_DBNAME=dnd_client
POSTGRES_POOL_SIZE=10

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=json

# HTTP æœåŠ¡å™¨é…ç½®
HTTP_HOST=0.0.0.0
HTTP_PORT=8080
HTTP_READ_TIMEOUT=30s
HTTP_WRITE_TIMEOUT=30s
HTTP_SHUTDOWN_TIMEOUT=10s

# WebSocket é…ç½®
WS_READ_BUFFER_SIZE=1024
WS_WRITE_BUFFER_SIZE=1024
WS_PING_PERIOD=30s
```

### B. å¸¸ç”¨å‘½ä»¤

**å¯åŠ¨æ‰€æœ‰æœåŠ¡**:
```bash
# å¯åŠ¨ Redis
redis-server --daemonize yes

# å¯åŠ¨ PostgreSQL (Docker)
docker start dnd-postgres

# å¯åŠ¨ DND MCP Client æœåŠ¡å™¨
./bin/dnd-client.exe server start
```

**æ¸…ç†æ‰€æœ‰æ•°æ®**:
```bash
# æ¸…ç©º Redis
redis-cli FLUSHALL

# åˆ é™¤ PostgreSQL æ•°æ®
psql -h localhost -U dnd -d dnd_client -c "TRUNCATE client_sessions, client_messages CASCADE;"
```

**æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€**:
```bash
# Redis ä¿¡æ¯
redis-cli INFO

# PostgreSQL è¿æ¥æ•°
psql -h localhost -U dnd -d dnd_client -c "SELECT count(*) FROM pg_stat_activity;"

# æœåŠ¡å™¨å¥åº·æ£€æŸ¥
curl http://localhost:8080/health
```

### C. æµ‹è¯•å·¥å…·å®‰è£…

**websocat (WebSocket æµ‹è¯•)**:
```bash
# Linux/Mac
cargo install websocat

# Windows
# ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶: https://github.com/vi/websocat/releases
```

**jq (JSON å¤„ç†)**:
```bash
# Linux/Mac
sudo apt-get install jq  # Debian/Ubuntu
brew install jq          # macOS

# Windows (Chocolatey)
choco install jq
```

**ab (Apache Bench)**:
```bash
# Linux/Mac
sudo apt-get install apache2-utils  # Debian/Ubuntu
brew install apache2                 # macOS (é€šå¸¸è‡ªå¸¦)

# Windows
# ä½¿ç”¨ WSL æˆ–ä¸‹è½½ Apache HTTP Server
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† DND MCP Client ç³»ç»Ÿå‰äº”ä¸ªä»»åŠ¡çš„:
1. âœ… **åŠŸèƒ½è¯¦ç»†è¯´æ˜** - å®Œæ•´çš„åŠŸèƒ½åˆ—è¡¨å’Œå®ç°ç»†èŠ‚
2. âœ… **API æ¥å£æ–‡æ¡£** - REST API å’Œ WebSocket API è§„èŒƒ
3. âœ… **æµ‹è¯•ç”¨ä¾‹** - 35+ è¯¦ç»†æµ‹è¯•ç”¨ä¾‹
4. âœ… **æµ‹è¯•æ•°æ®å‡†å¤‡** - æ ‡å‡†æµ‹è¯•æ•°æ®å’Œå‹åŠ›æµ‹è¯•è„šæœ¬
5. âœ… **æµ‹è¯•æ‰§è¡Œè®¡åˆ’** - 5 ä¸ªé˜¶æ®µçš„æµ‹è¯•ç­–ç•¥

### æ¶æ„è°ƒæ•´è¯´æ˜

**é‡è¦**: å½“å‰å®ç°é‡‡ç”¨ç®€åŒ–æ¶æ„ (Handler â†’ Store â†’ Models),ä¸è®¾è®¡æ–‡æ¡£å®šä¹‰çš„å®Œæ•´æ¶æ„ (Handler â†’ Service â†’ Repository â†’ Store â†’ Models) å­˜åœ¨å·®å¼‚ã€‚

**ç®€åŒ–åŸå› **:
- å¿«é€Ÿè¿­ä»£,ä¼˜å…ˆäº¤ä»˜åŠŸèƒ½
- ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•
- å•ä¸€å­˜å‚¨å®ç° (Redis)
- é™ä½å­¦ä¹ æ›²çº¿

**æœªæ¥æ”¹è¿›**:
- **çŸ­æœŸ**: ä¿æŒç®€åŒ–æ¶æ„
- **ä¸­æœŸ**: è¯„ä¼°ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦,å†³å®šæ˜¯å¦è¡¥å…… Service/Repository å±‚
- **é•¿æœŸ**: è¡¥å……å®Œæ•´æ¶æ„,ç¬¦åˆè®¾è®¡æ–‡æ¡£

è¯¦ç»†è¯´æ˜: `doc/æ¶æ„ç®€åŒ–è¯´æ˜.md`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-04
**ç»´æŠ¤è€…**: DND MCP Client å¼€å‘å›¢é˜Ÿ
**çŠ¶æ€**: âœ… å®Œæˆ
